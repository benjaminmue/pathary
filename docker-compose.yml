name: pathary

services:
  app:
    container_name: pathary-app
    build:
      context: ./
      dockerfile: ./build/Dockerfile
      target: production
      args:
        - USER_ID=${USER_ID:-3000}
    ports:
      - "${HTTP_PORT:-80}:8080"
    environment:
      APPLICATION_URL: "${APPLICATION_URL:-http://localhost}"
      XDEBUG_MODE: "${XDEBUG_MODE:-off}"
      XDEBUG_HOST: "${XDEBUG_HOST:-host.docker.internal}"
      XDEBUG_PORT: "${XDEBUG_PORT:-9003}"
      TMDB_API_KEY: "${TMDB_API_KEY:-XXXXX}"
      TMDB_ENABLE_IMAGE_CACHING: "${TMDB_ENABLE_IMAGE_CACHING:-0}"
      DATABASE_MODE: "mysql"
      DATABASE_MYSQL_HOST: "pathary-mysql"
      DATABASE_MYSQL_PORT: "3306"
      DATABASE_MYSQL_NAME: "${MYSQL_DATABASE:-pathary}"
      DATABASE_MYSQL_USER: "${MYSQL_USER:-pathary}"
      # ⚠️ WARNING: Change default database password in production!
      # Set MYSQL_PASSWORD environment variable or use .env file
      DATABASE_MYSQL_PASSWORD: "${MYSQL_PASSWORD:-pathary}"
      DATABASE_DISABLE_AUTO_MIGRATION: "${DATABASE_DISABLE_AUTO_MIGRATION:-false}"
    networks:
      - pathary-network
    depends_on:
      mysql:
        condition: service_healthy

  mysql:
    container_name: pathary-mysql
    image: mysql:8.0
    environment:
      # ⚠️ WARNING: Change these default credentials in production!
      # These defaults are for local development only and pose a security risk.
      # Set environment variables or use .env file: MYSQL_ROOT_PASSWORD, MYSQL_PASSWORD
      MYSQL_ROOT_PASSWORD: "${MYSQL_ROOT_PASSWORD:-root}"
      MYSQL_DATABASE: "${MYSQL_DATABASE:-pathary}"
      MYSQL_USER: "${MYSQL_USER:-pathary}"
      MYSQL_PASSWORD: "${MYSQL_PASSWORD:-pathary}"
    volumes:
      - mysql-data:/var/lib/mysql
    ports:
      - "${MYSQL_PORT:-3306}:3306"
    networks:
      - pathary-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

networks:
  pathary-network:
    driver: bridge

volumes:
  mysql-data:
