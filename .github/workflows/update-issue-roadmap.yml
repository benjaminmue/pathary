name: Update Open Issues

on:
  issues:
    types: [opened, closed, reopened, labeled, unlabeled, deleted]
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: write
  issues: read

jobs:
  update-roadmap:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Fetch open issues and generate open issues list
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Fetch all open issues with labels
          gh issue list \
            --repo benjaminmue/pathary \
            --state open \
            --limit 1000 \
            --json number,title,labels,url,createdAt \
            --jq 'sort_by(.createdAt) | reverse' > issues.json

          # Start building the open issues list with current timestamp
          CURRENT_DATE=$(date -u +"%Y-%m-%d %H:%M:%S UTC")

          cat > OPEN_ISSUES.md << EOF
          # Pathary Open Issues

          This file is automatically generated from open GitHub issues, sorted by priority and type.

          **Last updated:** $CURRENT_DATE

          ## Quick Stats

          EOF

          # Count issues by priority
          P0_COUNT=$(jq -r '[.[] | select(.labels[].name == "priority-p0")] | length' issues.json)
          P1_COUNT=$(jq -r '[.[] | select(.labels[].name == "priority-p1")] | length' issues.json)
          P2_COUNT=$(jq -r '[.[] | select(.labels[].name == "priority-p2")] | length' issues.json)
          P3_COUNT=$(jq -r '[.[] | select(.labels[].name == "priority-p3")] | length' issues.json)
          TOTAL_COUNT=$(jq 'length' issues.json)

          cat >> OPEN_ISSUES.md << EOF
          - **Total Open Issues:** $TOTAL_COUNT
          - **P0 (Critical):** $P0_COUNT
          - **P1 (High):** $P1_COUNT
          - **P2 (Medium):** $P2_COUNT
          - **P3 (Low):** $P3_COUNT

          ---

          EOF

          # Function to format issue section
          format_priority_section() {
            local priority=$1
            local priority_label=$2
            local emoji=$3

            # Get issues for this priority
            local issues=$(jq -r --arg priority "$priority" \
              '[.[] | select(.labels[].name == $priority)] | sort_by(.labels | map(select(.name | test("^(security|bug|enhancement|documentation|performance|refactor|chore)$"))) | .[0].name)' \
              issues.json)

            local count=$(echo "$issues" | jq 'length')

            if [ "$count" -gt 0 ]; then
              echo "" >> OPEN_ISSUES.md
              echo "## $emoji $priority_label ($count issues)" >> OPEN_ISSUES.md
              echo "" >> OPEN_ISSUES.md

              # Group by type
              for type in security bug enhancement documentation performance refactor chore; do
                local type_issues=$(echo "$issues" | jq -r --arg type "$type" \
                  '[.[] | select(.labels[].name == $type)]')
                local type_count=$(echo "$type_issues" | jq 'length')

                if [ "$type_count" -gt 0 ]; then
                  # Capitalize type name
                  local type_display=$(echo "$type" | sed 's/^./\U&/')
                  echo "### $type_display" >> OPEN_ISSUES.md
                  echo "" >> OPEN_ISSUES.md

                  # List issues
                  echo "$type_issues" | jq -r '.[] | "- [#\(.number)](\(.url)) \(.title)"' >> OPEN_ISSUES.md
                  echo "" >> OPEN_ISSUES.md
                fi
              done
            fi
          }

          # Generate sections for each priority
          format_priority_section "priority-p0" "Priority 0: Critical" "ðŸ”´"
          format_priority_section "priority-p1" "Priority 1: High" "ðŸŸ "
          format_priority_section "priority-p2" "Priority 2: Medium" "ðŸŸ¡"
          format_priority_section "priority-p3" "Priority 3: Low" "âšª"

          # Add footer
          cat >> OPEN_ISSUES.md << 'EOF'

          ---

          ## How to Use This List

          1. **Start with P0 issues** - These are critical and should be addressed immediately
          2. **Work through by priority** - Move from P0 â†’ P1 â†’ P2 â†’ P3
          3. **Within each priority** - Security issues take precedence, then bugs, then enhancements
          4. **This file updates automatically** - Every time an issue is created, labeled, or closed
          5. **For strategic planning** - See ROADMAP.md for implementation ideas and next steps

          ## Legend

          - **Priority Levels:**
            - ðŸ”´ **P0 (Critical)**: Urgent security vulnerabilities, critical bugs, blockers
            - ðŸŸ  **P1 (High)**: Important security issues, major bugs, high-impact features
            - ðŸŸ¡ **P2 (Medium)**: Standard enhancements, minor bugs, quality improvements
            - âšª **P3 (Low)**: Nice-to-have features, minor improvements, cleanup tasks

          - **Issue Types:**
            - **Security**: Security vulnerabilities and hardening
            - **Bug**: Broken functionality that needs fixing
            - **Enhancement**: New features or improvements
            - **Documentation**: Docs updates
            - **Performance**: Speed and efficiency improvements
            - **Refactor**: Code cleanup and restructuring
            - **Chore**: Maintenance tasks

          EOF

          # Cleanup
          rm issues.json

      - name: Commit and push open issues list
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add OPEN_ISSUES.md

          # Only commit if there are changes
          if git diff --staged --quiet; then
            echo "No changes to OPEN_ISSUES.md"
          else
            git commit -m "Update OPEN_ISSUES.md with current issues

          ðŸ¤– Auto-generated by GitHub Actions"
            git push
          fi
