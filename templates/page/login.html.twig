{% extends 'base.html.twig' %}

{% set showFooter = false %}

{% block title %}
    Login
{% endblock %}

{% block stylesheets %}
    <link rel="stylesheet" href="{{ applicationUrl }}/css/login.css">
{% endblock %}

{% block scripts %}
    <script src="{{ applicationUrl }}/js/login-bg.js"></script>
    <script src="{{ applicationUrl }}/js/login.js"></script>
{% endblock %}

{% block body %}
    <div class="login-container">
        <!-- Centered Logo with Circle Background -->
        <div class="login-logo-wrapper">
            <div class="login-logo-circle">
                <div class="login-logo-container">
                    <img src="{{ applicationUrl }}/images/pathary-logo.svg"
                         alt="{{ applicationName ?? 'Pathary' }} logo"
                         class="login-logo">
                </div>
            </div>
        </div>

        <!-- Login Card -->
        <div class="login-card">
            <div id="loginForm">
                <h1 class="text-center">{{ applicationName ?? 'Pathary' }}</h1>

                <div class="form-floating">
                    <input type="email"
                           value="{{ defaultEmail }}"
                           class="form-control"
                           id="email"
                           placeholder="name@example.com"
                           onkeydown="submitCredentialsOnEnter(event)"
                           autocomplete="email"
                           required>
                    <label for="email">Email address</label>
                </div>

                <div class="form-floating">
                    <input type="password"
                           value="{{ defaultPassword }}"
                           class="form-control"
                           id="password"
                           placeholder="Password"
                           onkeydown="submitCredentialsOnEnter(event)"
                           autocomplete="current-password"
                           required>
                    <label for="password">Password</label>
                </div>

                <div class="form-check">
                    <input type="checkbox"
                           class="form-check-input"
                           id="rememberMe"
                           value="true"
                           {{ defaultRememberMe == 'true' ? 'checked' : '' }}>
                    <label class="form-check-label" for="rememberMe">Remember me</label>
                </div>

                <div id="loginErrors"></div>

                {% if redirect != false %}
                    <div class="alert alert-danger" role="alert" id="forbiddenPageAlert">
                        Sign in to access page
                    </div>
                    <input type="hidden" value="{{ redirect }}" name="redirect">
                {% endif %}

                <button class="w-100 btn btn-lg btn-primary mb-3" type="button" onclick="submitCredentials()">
                    Sign in
                </button>

                {% if registrationEnabled == true %}
                    <div class="text-center">
                        <a href="{{ applicationUrl }}/create-user">Create new user</a>
                    </div>
                {% endif %}
            </div>

            <div id="totpForm" class="d-none">
                <h1 class="text-center">Verification</h1>

                <!-- Mode Switch -->
                <div class="text-center mb-3">
                    <div class="btn-group" role="group" aria-label="Verification mode">
                        <input type="radio" class="btn-check" name="verificationMode" id="modeAuthenticator" value="totp" checked autocomplete="off" onchange="switchVerificationMode('totp')">
                        <label class="btn btn-outline-primary" for="modeAuthenticator">Authenticator code</label>

                        <input type="radio" class="btn-check" name="verificationMode" id="modeRecovery" value="recovery" autocomplete="off" onchange="switchVerificationMode('recovery')">
                        <label class="btn btn-outline-primary" for="modeRecovery">Recovery code</label>
                    </div>
                </div>

                <!-- Authenticator Code Input -->
                <div id="authenticatorModeContent">
                    <p class="text-center">Enter the 6-digit code from your authenticator app.</p>

                    <input type="text"
                           class="form-control form-control-lg text-center mb-3"
                           placeholder="000000"
                           maxlength="6"
                           autocomplete="one-time-code"
                           inputmode="numeric"
                           pattern="[0-9]*"
                           id="totpCode"
                           onkeydown="submitCredentialsOnEnter(event)"
                           required>
                </div>

                <!-- Recovery Code Input -->
                <div id="recoveryModeContent" class="d-none">
                    <p class="text-center">Enter one of your recovery codes.</p>
                    <p class="text-center text-muted small">Format: XXXX-XXXX-XX (case-insensitive, spaces/dashes optional)</p>

                    <input type="text"
                           class="form-control form-control-lg text-center mb-3"
                           placeholder="XXXX-XXXX-XX"
                           maxlength="12"
                           autocomplete="off"
                           id="recoveryCode"
                           onkeydown="submitCredentialsOnEnter(event)"
                           oninput="formatRecoveryCodeInput(event)">
                </div>

                <div id="totpErrors"></div>

                <button class="w-100 btn btn-lg btn-primary mb-3" type="button" onclick="submitCredentials()">
                    Continue
                </button>

                <!-- Help Section -->
                <div class="alert alert-info small">
                    <strong>Help:</strong>
                    <ul class="mb-0 ps-3">
                        <li><strong>No access to your authenticator app?</strong> Select "Recovery code" and enter one recovery code.</li>
                        <li>Each recovery code works once.</li>
                        <li>After login, go to <strong>Profile â†’ Security</strong> to regenerate codes.</li>
                    </ul>
                </div>

                <div class="text-center">
                    <a href="{{ applicationUrl }}/login">Back to login</a>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
