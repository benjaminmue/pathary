<div class="card admin-card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-people me-2"></i>User Management</span>
        <button class="btn btn-sm btn-primary" onclick="showCreateUserModal()">
            <i class="bi bi-plus-circle me-1"></i>Create User
        </button>
    </div>
    <div class="card-body">
        <p class="text-muted">
            Manage user accounts, permissions, and view user activity.
        </p>

        <!-- Users List -->
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Admin</th>
                        <th>Ratings</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="usersTableBody">
                    <tr>
                        <td colspan="7" class="text-center text-muted">
                            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                            Loading users...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Create User Modal -->
<div class="modal fade" id="createUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-person-plus me-2"></i>Create New User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createUserForm">
                    <div class="mb-3">
                        <label for="createUserName" class="form-label">Username</label>
                        <input type="text" class="form-control" id="createUserName" required
                               pattern="[a-zA-Z0-9]+" title="Only letters and numbers allowed">
                        <div class="form-text">Letters and numbers only</div>
                    </div>

                    <div class="mb-3">
                        <label for="createUserEmail" class="form-label">Email</label>
                        <input type="email" class="form-control" id="createUserEmail" required>
                    </div>

                    <div class="mb-3" id="passwordFieldsContainer">
                        <div class="mb-3">
                            <label for="createUserPassword" class="form-label">Password</label>
                            <input type="password" class="form-control" id="createUserPassword" minlength="10">
                            <div class="form-text">Minimum 10 characters, must include uppercase, lowercase, number, and special character</div>
                        </div>

                        <div class="mb-3">
                            <label for="createUserPasswordConfirm" class="form-label">Confirm Password</label>
                            <input type="password" class="form-control" id="createUserPasswordConfirm">
                        </div>
                    </div>

                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="createUserIsAdmin">
                        <label class="form-check-label" for="createUserIsAdmin">
                            <i class="bi bi-shield-check me-1"></i>Grant admin privileges
                        </label>
                    </div>

                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="createUserSendWelcome" checked onchange="togglePasswordFields()">
                        <label class="form-check-label" for="createUserSendWelcome">
                            <i class="bi bi-envelope me-1"></i>Send welcome email
                        </label>
                        <div class="form-text">User will create their own password via email invitation (no password required)</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="createUserBtn" onclick="createUser(this)">
                    <i class="bi bi-check-circle me-1"></i>Create User
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit User Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-pencil me-2"></i>Edit User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editUserForm">
                    <input type="hidden" id="editUserId">

                    <div class="mb-3">
                        <label for="editUserName" class="form-label">Username</label>
                        <input type="text" class="form-control" id="editUserName" required
                               pattern="[a-zA-Z0-9]+" title="Only letters and numbers allowed">
                    </div>

                    <div class="mb-3">
                        <label for="editUserEmail" class="form-label">Email</label>
                        <input type="email" class="form-control" id="editUserEmail" required>
                    </div>

                    <div class="mb-3">
                        <label for="editUserPassword" class="form-label">New Password (leave blank to keep current)</label>
                        <input type="password" class="form-control" id="editUserPassword" minlength="10">
                        <div class="form-text">Only fill if you want to change the password</div>
                    </div>

                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="editUserIsAdmin">
                        <label class="form-check-label" for="editUserIsAdmin">
                            <i class="bi bi-shield-check me-1"></i>Admin privileges
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updateUser()">
                    <i class="bi bi-check-circle me-1"></i>Save Changes
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    let createUserModalInstance, editUserModalInstance;

    // Load users on page load
    document.addEventListener('DOMContentLoaded', () => {
        loadUsers();
        createUserModalInstance = new bootstrap.Modal(document.getElementById('createUserModal'));
        editUserModalInstance = new bootstrap.Modal(document.getElementById('editUserModal'));
    });

    async function loadUsers() {
        try {
            const response = await fetch('{{ applicationUrl }}/old/settings/users', {
                method: 'GET',
            });

            if (!response.ok) throw new Error('Failed to load users');

            const users = await response.json();
            renderUsersTable(users);
        } catch (error) {
            document.getElementById('usersTableBody').innerHTML = `
                <tr><td colspan="7" class="text-center text-danger">Error loading users: ${error.message}</td></tr>
            `;
        }
    }

    function renderUsersTable(users) {
        const tbody = document.getElementById('usersTableBody');

        if (users.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No users found</td></tr>';
            return;
        }

        tbody.innerHTML = users.map(user => `
            <tr>
                <td>${user.id}</td>
                <td>
                    <strong>${escapeHtml(user.name)}</strong>
                    ${user.id === {{ currentUser.id }} ? '<span class="badge bg-info ms-1">You</span>' : ''}
                </td>
                <td>${escapeHtml(user.email)}</td>
                <td>
                    ${user.isAdmin ? '<i class="bi bi-shield-check text-success"></i> Admin' : '<i class="bi bi-person text-muted"></i> User'}
                </td>
                <td><span class="badge bg-secondary">-</span></td>
                <td><small class="text-muted">-</small></td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary" onclick="showEditUserModal(${user.id}, '${escapeHtml(user.name)}', '${escapeHtml(user.email)}', ${user.isAdmin})" title="Edit">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-outline-danger" onclick="confirmDeleteUser(${user.id}, '${escapeHtml(user.name)}')" title="Delete">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');
    }

    function showCreateUserModal() {
        document.getElementById('createUserForm').reset();
        // Reset to initial state (welcome email checked, password fields hidden)
        document.getElementById('createUserSendWelcome').checked = true;
        togglePasswordFields();
        createUserModalInstance.show();
    }

    function togglePasswordFields() {
        const sendWelcome = document.getElementById('createUserSendWelcome').checked;
        const passwordContainer = document.getElementById('passwordFieldsContainer');
        const passwordInput = document.getElementById('createUserPassword');
        const passwordConfirmInput = document.getElementById('createUserPasswordConfirm');

        if (sendWelcome) {
            // Hide password fields when sending welcome email
            passwordContainer.style.display = 'none';
            passwordInput.required = false;
            passwordConfirmInput.required = false;
        } else {
            // Show password fields when not sending welcome email
            passwordContainer.style.display = 'block';
            passwordInput.required = true;
            passwordConfirmInput.required = true;
        }
    }

    async function createUser(button) {
        const name = document.getElementById('createUserName').value.trim();
        const email = document.getElementById('createUserEmail').value.trim();
        const password = document.getElementById('createUserPassword').value;
        const passwordConfirm = document.getElementById('createUserPasswordConfirm').value;
        const isAdmin = document.getElementById('createUserIsAdmin').checked;
        const sendWelcomeEmail = document.getElementById('createUserSendWelcome').checked;

        // Validate
        if (!name || !email) {
            showToast('Username and email are required', 'warning');
            return;
        }

        // Only validate password if not sending welcome email
        if (!sendWelcomeEmail) {
            if (!password) {
                showToast('Password is required', 'warning');
                return;
            }

            if (password !== passwordConfirm) {
                showToast('Passwords do not match', 'warning');
                return;
            }

            if (password.length < 10) {
                showToast('Password must be at least 10 characters', 'warning');
                return;
            }
        }

        // Disable button to prevent double-clicks
        const originalText = button.innerHTML;
        button.disabled = true;
        button.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Creating...';

        try {
            const response = await fetch('{{ applicationUrl }}/old/settings/users', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, email, password, isAdmin, sendWelcomeEmail }),
            });

            if (!response.ok) {
                const error = await response.text();
                throw new Error(error || 'Failed to create user');
            }

            showToast('User created successfully', 'success');
            createUserModalInstance.hide();
            loadUsers();
        } catch (error) {
            showToast('Error creating user: ' + error.message, 'danger');
        } finally {
            // Re-enable button
            button.disabled = false;
            button.innerHTML = originalText;
        }
    }

    function showEditUserModal(userId, name, email, isAdmin) {
        document.getElementById('editUserId').value = userId;
        document.getElementById('editUserName').value = name;
        document.getElementById('editUserEmail').value = email;
        document.getElementById('editUserPassword').value = '';
        document.getElementById('editUserIsAdmin').checked = isAdmin;
        editUserModalInstance.show();
    }

    async function updateUser() {
        const userId = document.getElementById('editUserId').value;
        const name = document.getElementById('editUserName').value.trim();
        const email = document.getElementById('editUserEmail').value.trim();
        const password = document.getElementById('editUserPassword').value;
        const isAdmin = document.getElementById('editUserIsAdmin').checked;

        const data = { name, email, isAdmin };
        if (password) {
            if (password.length < 10) {
                showToast('Password must be at least 10 characters', 'warning');
                return;
            }
            data.password = password;
        }

        try {
            const response = await fetch(`{{ applicationUrl }}/old/settings/users/${userId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data),
            });

            if (!response.ok) {
                const error = await response.text();
                throw new Error(error || 'Failed to update user');
            }

            showToast('User updated successfully', 'success');
            editUserModalInstance.hide();
            loadUsers();
        } catch (error) {
            showToast('Error updating user: ' + error.message, 'danger');
        }
    }

    async function confirmDeleteUser(userId, userName) {
        if (userId === {{ currentUser.id }}) {
            showToast('You cannot delete your own account from here', 'warning');
            return;
        }

        showConfirmModal(
            `Delete user "${userName}"? All their ratings and watch history will also be deleted. This action cannot be undone.`,
            async () => {
                try {
                    const response = await fetch(`{{ applicationUrl }}/old/settings/users/${userId}`, {
                        method: 'DELETE',
                    });

                    if (!response.ok) {
                        throw new Error('Failed to delete user');
                    }

                    showToast('User deleted successfully', 'success');
                    loadUsers();
                } catch (error) {
                    showToast('Error deleting user: ' + error.message, 'danger');
                }
            }
        );
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
</script>
