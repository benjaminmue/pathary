<div class="row">
    <!-- Settings Accordion (API, Application, Email) -->
    <div class="accordion" id="serverSettingsAccordion">
    <!-- API Settings Card -->
    <div class="col-md-12 mb-4">
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#apiSettings" aria-expanded="true">
                    <i class="bi bi-key me-2"></i>API Settings
                </button>
            </h2>
            <div id="apiSettings" class="accordion-collapse collapse show" data-bs-parent="#serverSettingsAccordion">
                <div class="accordion-body">
                <form id="apiSettingsForm">
                    <div class="mb-3">
                        <label for="tmdbApiKey" class="form-label">
                            TMDB API Key
                            <i class="bi bi-info-circle text-muted" title="Required for movie metadata" data-bs-toggle="tooltip"></i>
                        </label>
                        <div class="input-group">
                            <input type="password" class="form-control font-monospace" id="tmdbApiKey"
                                   placeholder="Enter TMDB API key (32 hexadecimal characters)">
                            <button class="btn btn-outline-secondary" type="button" onclick="toggleApiKeyVisibility('tmdbApiKey')">
                                <i class="bi bi-eye"></i>
                            </button>
                        </div>
                        <div class="form-text" id="tmdbKeyStatus">
                            <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                            Loading status...
                        </div>
                    </div>

                    <div class="mb-3">
                        <button type="button" class="btn btn-primary" id="saveApiSettingsBtn" onclick="saveApiSettings()">
                            <i class="bi bi-save me-1"></i>Save API Settings
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="testTmdbConnection()">
                            <i class="bi bi-lightning me-1"></i>Test TMDB Connection
                        </button>
                        <div id="saveHelperText" class="form-text mt-2" style="display: none;">
                            <i class="bi bi-info-circle"></i> <span id="saveHelperMessage"></span>
                        </div>
                    </div>
                </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Application Settings Card -->
    <div class="col-md-12 mb-4">
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#appSettings" aria-expanded="false">
                    <i class="bi bi-gear me-2"></i>Application Settings
                </button>
            </h2>
            <div id="appSettings" class="accordion-collapse collapse" data-bs-parent="#serverSettingsAccordion">
                <div class="accordion-body">
                <form id="appSettingsForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="appName" class="form-label">Application Name</label>
                            <input type="text" class="form-control" id="appName" value="Pathary">
                            <div class="form-text">Displayed in navbar and page titles</div>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="appUrl" class="form-label">Application URL</label>
                            <input type="url" class="form-control" id="appUrl" value="{{ applicationUrl }}" readonly>
                            <div class="form-text">Configure via APPLICATION_URL environment variable</div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="registrationEnabled">
                            <label class="form-check-label" for="registrationEnabled">
                                Enable user registration
                            </label>
                        </div>
                        <div class="form-text">Allow new users to create accounts without admin approval</div>
                    </div>

                    <button type="button" class="btn btn-primary" onclick="saveAppSettings()">
                        <i class="bi bi-save me-1"></i>Save App Settings
                    </button>
                </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Email Settings Card with Tabs -->
    <div class="col-md-12 mb-4">
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#emailSettings" aria-expanded="false">
                    <i class="bi bi-envelope me-2"></i>Email Settings
                </button>
            </h2>
            <div id="emailSettings" class="accordion-collapse collapse" data-bs-parent="#serverSettingsAccordion">
                <div class="accordion-body">
                <p class="text-muted small">
                    Configure email sending via SMTP password or OAuth 2.0 authentication
                </p>

                <!-- Authentication Mode Tabs -->
                <ul class="nav nav-tabs mb-4" id="emailAuthTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link {{ emailAuthMode == 'smtp_password' or emailAuthMode is not defined ? 'active' : '' }}"
                                id="smtp-password-tab" data-bs-toggle="tab" data-bs-target="#smtp-password-panel"
                                type="button" role="tab">
                            <i class="bi bi-key me-2"></i>SMTP Password
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link {{ emailAuthMode == 'smtp_oauth' ? 'active' : '' }}"
                                id="oauth-tab" data-bs-toggle="tab" data-bs-target="#oauth-panel"
                                type="button" role="tab">
                            <i class="bi bi-shield-lock me-2"></i>OAuth 2.0
                            {% if oauthConfig and oauthConfig.connected %}
                                <span class="badge bg-success ms-1">Connected</span>
                            {% endif %}
                        </button>
                    </li>
                </ul>

                <!-- Current Mode Indicator -->
                <div class="alert {{ emailAuthMode == 'smtp_oauth' ? 'alert-success' : 'alert-warning' }} mb-3" role="alert">
                    <div class="d-flex align-items-center">
                        <i class="bi {{ emailAuthMode == 'smtp_oauth' ? 'bi-shield-lock-fill' : 'bi-key-fill' }} fs-4 me-3"></i>
                        <div class="flex-grow-1">
                            <h6 class="mb-1">
                                <strong>Current Authentication Mode:</strong>
                                {{ emailAuthMode == 'smtp_oauth' ? 'OAuth 2.0 (Modern Auth)' : 'SMTP Password (Legacy)' }}
                            </h6>
                            <small>
                                {% if emailAuthMode == 'smtp_oauth' %}
                                    ✓ Using secure OAuth authentication with {{ oauthConfig ? oauthConfig.fromAddress : 'not configured' }}
                                {% else %}
                                    Using password-based authentication (less secure)
                                {% endif %}
                            </small>
                        </div>
                        {% if emailAuthMode == 'smtp_oauth' and not oauthConfig %}
                            <span class="badge bg-danger">Not Configured</span>
                        {% elseif emailAuthMode == 'smtp_oauth' and oauthConfig and not oauthConfig.connected %}
                            <span class="badge bg-warning">Not Connected</span>
                        {% elseif emailAuthMode == 'smtp_oauth' and oauthConfig and oauthConfig.connected %}
                            <span class="badge bg-success">Connected</span>
                        {% endif %}
                    </div>
                </div>

                <div class="tab-content" id="emailAuthTabContent">
                    <!-- SMTP Password Tab -->
                    <div class="tab-pane fade {{ emailAuthMode == 'smtp_password' or emailAuthMode is not defined ? 'show active' : '' }}"
                         id="smtp-password-panel" role="tabpanel">

                        <form id="emailSettingsForm">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="smtpHost" class="form-label">SMTP Host</label>
                                    <input type="text" class="form-control" id="smtpHost" placeholder="smtp.gmail.com"
                                           value="{{ smtpHost ?? '' }}">
                                </div>

                                <div class="col-md-3 mb-3">
                                    <label for="smtpPort" class="form-label">Port</label>
                                    <input type="number" class="form-control" id="smtpPort"
                                           value="{{ smtpPort ?? 587 }}" placeholder="587">
                                </div>

                                <div class="col-md-3 mb-3">
                                    <label for="smtpEncryption" class="form-label">Encryption</label>
                                    <select class="form-select" id="smtpEncryption">
                                        <option value="tls" {{ smtpEncryption == 'tls' ? 'selected' : '' }}>TLS (STARTTLS)</option>
                                        <option value="ssl" {{ smtpEncryption == 'ssl' ? 'selected' : '' }}>SSL</option>
                                        <option value="" {{ smtpEncryption == '' ? 'selected' : '' }}>None</option>
                                    </select>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="smtpUsername" class="form-label">Username / Email</label>
                                    <input type="text" class="form-control" id="smtpUsername" placeholder="your-email@gmail.com"
                                           value="{{ smtpUsername ?? '' }}">
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label for="smtpPassword" class="form-label">
                                        Password / App Password
                                        {% if smtpPasswordConfigured %}
                                            <span class="badge bg-success ms-2">
                                                <i class="bi bi-check-circle-fill"></i> Configured
                                            </span>
                                        {% endif %}
                                    </label>
                                    <div class="input-group">
                                        <input type="password" class="form-control" id="smtpPassword"
                                               placeholder="{% if smtpPasswordConfigured %}Saved (leave blank to keep current){% else %}Enter password{% endif %}">
                                        <button class="btn btn-outline-secondary" type="button" onclick="toggleApiKeyVisibility('smtpPassword')">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                    </div>
                                    <div class="form-text">
                                        {% if smtpPasswordConfigured %}
                                            Password is saved. Leave blank to keep current password.
                                        {% else %}
                                            Enter your SMTP password or app-specific password
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="smtpFromAddress" class="form-label">From Address</label>
                                <input type="email" class="form-control" id="smtpFromAddress" placeholder="noreply@pathary.local"
                                       value="{{ smtpFromAddress ?? '' }}">
                                <div class="form-text">Email address shown as sender</div>
                            </div>

                            <div class="mb-3">
                                <label for="smtpFromDisplayName" class="form-label">
                                    From Display Name <small class="text-muted">(optional)</small>
                                </label>
                                <input type="text" class="form-control" id="smtpFromDisplayName" placeholder="Email from Pathary"
                                       value="{{ smtpFromDisplayName ?? '' }}">
                                <div class="form-text">If set, recipients will see "Display Name &lt;email@address&gt;" instead of just the email address</div>
                            </div>

                            <div class="border-top pt-3 mt-3">
                                <button type="button" class="btn btn-primary" onclick="saveEmailSettings()">
                                    <i class="bi bi-save me-1"></i>Save SMTP Settings
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="sendTestEmail()">
                                    <i class="bi bi-send me-1"></i>Send Test Email
                                </button>
                                <button type="button" class="btn btn-outline-info" onclick="runSMTPDiagnostics()">
                                    <i class="bi bi-tools me-1"></i>Run Diagnostics
                                </button>
                                {% if emailAuthMode == 'smtp_oauth' %}
                                    <button type="button" class="btn btn-outline-warning" onclick="switchToPasswordMode()">
                                        <i class="bi bi-arrow-left-circle me-1"></i>Switch to Password Mode
                                    </button>
                                {% endif %}
                            </div>
                        </form>

                        <!-- SMTP Diagnostics Results -->
                        <div id="smtpDiagnosticsResults" class="mt-4" style="display: none;">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="bi bi-tools me-2"></i>SMTP Diagnostics</h5>
                                </div>
                                <div class="card-body" id="diagnosticsContent">
                                    <!-- Results will be populated here -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- OAuth 2.0 Tab -->
                    <div class="tab-pane fade {{ emailAuthMode == 'smtp_oauth' ? 'show active' : '' }}"
                         id="oauth-panel" role="tabpanel">

                        {% if not encryptionKeyConfigured %}
                            <div class="alert alert-warning" role="alert">
                                <h6 class="alert-heading"><i class="bi bi-exclamation-triangle me-2"></i>Encryption Key Required</h6>
                                <p class="mb-2">OAuth requires an encryption key to securely store credentials.</p>
                                <button type="button" class="btn btn-sm btn-warning" onclick="generateEncryptionKey()">
                                    <i class="bi bi-key me-1"></i>Generate Encryption Key
                                </button>
                                <p class="small text-muted mt-2 mb-0">
                                    For production, set <code>ENCRYPTION_KEY</code> environment variable instead.
                                </p>
                            </div>
                        {% endif %}

                        <!-- Gmail Setup Instructions Alert -->
                        <div class="alert alert-info mb-3" role="alert" id="gmailInstructions" style="display: none;">
                            <div class="d-flex">
                                <div class="flex-shrink-0">
                                    <i class="bi bi-info-circle-fill fs-4"></i>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <h6 class="alert-heading mb-2">Gmail OAuth Setup</h6>
                                    <p class="small mb-2">
                                        <strong>Quick setup guide:</strong> Follow the steps below or see the
                                        <a href="https://github.com/benjaminmue/pathary/wiki/OAuth-Email-Setup#gmail-oauth-setup" target="_blank" class="alert-link">
                                            <i class="bi bi-book me-1"></i>complete Gmail OAuth setup guide
                                        </a>
                                        for detailed instructions, troubleshooting, and API permission requirements.
                                    </p>
                                    <button class="btn btn-sm btn-outline-primary mb-2" type="button" data-bs-toggle="collapse" data-bs-target="#gmailInstructionsCollapse">
                                        <i class="bi bi-chevron-down me-1"></i>Show Quick Setup Steps
                                    </button>

                                    <div class="collapse" id="gmailInstructionsCollapse">
                                        <div class="mt-2">
                                            <h6 class="text-primary">1. Create Google Cloud Project</h6>
                                            <ol class="small mb-3">
                                                <li>Go to <a href="https://console.cloud.google.com/" target="_blank">Google Cloud Console</a></li>
                                                <li>Create a new project or select existing one</li>
                                                <li>Name: "Pathary Email OAuth"</li>
                                            </ol>

                                            <h6 class="text-primary">2. Enable Gmail API</h6>
                                            <ol class="small mb-3">
                                                <li>In your project, go to <strong>APIs & Services → Library</strong></li>
                                                <li>Search for "Gmail API"</li>
                                                <li>Click on it and click <strong>Enable</strong></li>
                                            </ol>

                                            <h6 class="text-primary">3. Configure OAuth Consent Screen</h6>
                                            <ol class="small mb-3">
                                                <li>Go to <strong>APIs & Services → OAuth consent screen</strong></li>
                                                <li>User Type: Select "Internal" (for Google Workspace) or "External"</li>
                                                <li>Fill in Application name: "Pathary"</li>
                                                <li>Add your email as support email</li>
                                                <li>Click <strong>Save and Continue</strong></li>
                                            </ol>

                                            <h6 class="text-primary">4. Create OAuth Client ID</h6>
                                            <ol class="small mb-3">
                                                <li>Go to <strong>APIs & Services → Credentials</strong></li>
                                                <li>Click <strong>Create Credentials → OAuth client ID</strong></li>
                                                <li>Application type: "Web application"</li>
                                                <li>Name: "Pathary Email OAuth"</li>
                                                <li>Authorized redirect URIs: Add the redirect URI shown below</li>
                                                <li>Click <strong>Create</strong></li>
                                                <li><strong>Copy the Client ID and Client Secret</strong></li>
                                            </ol>

                                            <h6 class="text-primary">5. Get Required Values</h6>
                                            <ul class="small mb-3">
                                                <li><strong>Client ID</strong>: From step 4</li>
                                                <li><strong>Client Secret</strong>: From step 4</li>
                                                <li><strong>Tenant ID</strong>: Not required for Gmail (leave empty)</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Azure Setup Instructions Alert -->
                        <div class="alert alert-info mb-3" role="alert" id="azureInstructions">
                            <div class="d-flex">
                                <div class="flex-shrink-0">
                                    <i class="bi bi-info-circle-fill fs-4"></i>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <h6 class="alert-heading mb-2">Azure App Registration Setup</h6>
                                    <p class="small mb-2">
                                        <strong>Quick setup guide:</strong> Follow the steps below or see the
                                        <a href="https://github.com/benjaminmue/pathary/wiki/OAuth-Email-Setup#microsoft-365-oauth-setup" target="_blank" class="alert-link">
                                            <i class="bi bi-book me-1"></i>complete Microsoft 365 OAuth setup guide
                                        </a>
                                        for detailed instructions, required API permissions, SMTP AUTH configuration, and troubleshooting.
                                    </p>
                                    <button class="btn btn-sm btn-outline-primary mb-2" type="button" data-bs-toggle="collapse" data-bs-target="#azureInstructionsCollapse">
                                        <i class="bi bi-chevron-down me-1"></i>Show Quick Setup Steps
                                    </button>

                                    <div class="collapse" id="azureInstructionsCollapse">
                                        <div class="mt-2">
                                            <h6 class="text-primary">1. Create App Registration</h6>
                                            <ol class="small mb-3">
                                                <li>Go to <a href="https://portal.azure.com/#view/Microsoft_AAD_RegisteredApps/ApplicationsListBlade" target="_blank">Azure Portal → App registrations</a></li>
                                                <li>Click <strong>New registration</strong></li>
                                                <li>Name: "Pathary Email OAuth"</li>
                                                <li>Supported account types: "Accounts in this organizational directory only"</li>
                                                <li>Redirect URI: Select "Web" and enter the URI shown below</li>
                                                <li>Click <strong>Register</strong></li>
                                            </ol>

                                            <h6 class="text-primary">2. Configure API Permissions</h6>
                                            <ol class="small mb-3">
                                                <li>In your app, go to <strong>API permissions</strong></li>
                                                <li>Click <strong>Add a permission</strong></li>
                                                <li>Select <strong>Microsoft Graph</strong></li>
                                                <li>Select <strong>Delegated permissions</strong></li>
                                                <li>Search for and check these permissions:
                                                    <ul>
                                                        <li><code>SMTP.Send</code> - Send emails from mailboxes using SMTP AUTH</li>
                                                        <li><code>User.Read</code> - Sign in and read user profile</li>
                                                        <li><code>offline_access</code> - Maintain access to data</li>
                                                    </ul>
                                                </li>
                                                <li>Click <strong>Add permissions</strong></li>
                                                <li>Click <strong>Grant admin consent for [Your Organization]</strong> (requires admin)</li>
                                                <li>Verify all three permissions show "✓ Granted" status</li>
                                            </ol>

                                            <h6 class="text-primary">3. Create Client Secret</h6>
                                            <ol class="small mb-3">
                                                <li>Go to <strong>Certificates & secrets</strong></li>
                                                <li>Click <strong>New client secret</strong></li>
                                                <li>Description: "Pathary OAuth Secret"</li>
                                                <li>Expires: Choose duration (3-24 months)</li>
                                                <li>Click <strong>Add</strong></li>
                                                <li><strong>Copy the secret value immediately</strong> (shown only once)</li>
                                            </ol>

                                            <h6 class="text-primary">4. Get Required Values</h6>
                                            <ul class="small mb-3">
                                                <li><strong>Client ID</strong>: App's Overview page → Application (client) ID</li>
                                                <li><strong>Tenant ID</strong>: App's Overview page → Directory (tenant) ID</li>
                                                <li><strong>Client Secret</strong>: Value you copied in step 3</li>
                                            </ul>

                                            <h6 class="text-primary">5. Enable SMTP AUTH (Important!)</h6>
                                            <p class="small mb-2">SMTP AUTH must be enabled for your mailbox:</p>
                                            <div class="bg-dark text-light p-2 rounded mb-2" style="font-family: monospace; font-size: 0.85em;">
                                                <div class="text-success"># Connect to Exchange Online PowerShell</div>
                                                <div>Install-Module ExchangeOnlineManagement</div>
                                                <div>Connect-ExchangeOnline</div>
                                                <div class="mt-2 text-success"># Enable SMTP AUTH for your mailbox</div>
                                                <div>Set-CASMailbox -Identity pathary@domain.local -SmtpClientAuthenticationDisabled $false</div>
                                            </div>

                                            <h6 class="text-primary">6. Send As Permission (Optional)</h6>
                                            <p class="small mb-2">If sending from a different address than the authenticated mailbox:</p>
                                            <div class="bg-dark text-light p-2 rounded" style="font-family: monospace; font-size: 0.85em;">
                                                <div class="text-success"># Create the "From" mailbox if it doesn't exist</div>
                                                <div>New-Mailbox -Shared -Name "No Reply" -PrimarySmtpAddress "noreply@domain.local"</div>
                                                <div class="mt-2 text-success"># Grant Send As permission</div>
                                                <div>Add-RecipientPermission -Identity "noreply@domain.local" -Trustee "pathary@domain.local" -AccessRights SendAs</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <form id="oauthSettingsForm">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="oauthProvider" class="form-label">
                                        Email Provider
                                        <i class="bi bi-info-circle text-muted" data-bs-toggle="tooltip"
                                           title="Select your email service provider. Click 'Show Setup Instructions' above for Azure configuration."></i>
                                    </label>
                                    <select class="form-select" id="oauthProvider" onchange="toggleTenantIdField(); toggleOAuthInstructions();">
                                        <option value="gmail" {{ oauthConfig and oauthConfig.provider == 'gmail' ? 'selected' : '' }}>
                                            Gmail
                                        </option>
                                        <option value="microsoft" {{ oauthConfig and oauthConfig.provider == 'microsoft' ? 'selected' : '' }}>
                                            Microsoft 365 / Outlook
                                        </option>
                                    </select>
                                    <div class="form-text">Select your email service provider</div>
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label for="oauthFromAddress" class="form-label">
                                        Authentication Mailbox
                                        <i class="bi bi-info-circle text-muted" data-bs-toggle="tooltip"
                                           title="The actual mailbox used for OAuth authentication (e.g., pathary@domain.local). Must be a real mailbox with SMTP AUTH enabled."></i>
                                    </label>
                                    <input type="email" class="form-control" id="oauthFromAddress"
                                           value="{{ oauthConfig ? oauthConfig.fromAddress : '' }}"
                                           placeholder="pathary@domain.local">
                                    <div class="form-text">Mailbox to authenticate with (must have SMTP AUTH enabled)</div>
                                </div>
                            </div>

                            <!-- SMTP Server Settings (Required for OAuth) -->
                            <div class="alert alert-info mb-4" role="alert">
                                <h6 class="alert-heading">
                                    <i class="bi bi-info-circle-fill me-2"></i>SMTP Server Settings Required
                                </h6>
                                <p class="mb-2 small">
                                    Even with OAuth authentication, SMTP server settings are required. OAuth replaces your <strong>password</strong> with a secure <strong>access token</strong>,
                                    but the application still needs to know <strong>which mail server to connect to</strong>.
                                </p>
                                <p class="mb-0 small">
                                    The server, port, and encryption below will be auto-filled based on your provider selection.
                                </p>
                            </div>

                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="oauthSmtpHost" class="form-label">
                                        SMTP Server <span class="text-danger">*</span>
                                        <i class="bi bi-info-circle text-muted" data-bs-toggle="tooltip"
                                           title="The SMTP server address for your email provider"></i>
                                    </label>
                                    <input type="text" class="form-control font-monospace" id="oauthSmtpHost"
                                           value="{{ smtpHost ?? (oauthConfig and oauthConfig.provider == 'gmail' ? 'smtp.gmail.com' : 'smtp.office365.com') }}"
                                           readonly>
                                    <div class="form-text">Auto-filled based on provider</div>
                                </div>

                                <div class="col-md-4 mb-3">
                                    <label for="oauthSmtpPort" class="form-label">
                                        Port <span class="text-danger">*</span>
                                    </label>
                                    <input type="number" class="form-control" id="oauthSmtpPort"
                                           value="{{ smtpPort ?? 587 }}"
                                           readonly>
                                    <div class="form-text">Default: 587 (TLS)</div>
                                </div>

                                <div class="col-md-4 mb-3">
                                    <label for="oauthSmtpEncryption" class="form-label">
                                        Encryption <span class="text-danger">*</span>
                                    </label>
                                    <select class="form-select" id="oauthSmtpEncryption" disabled>
                                        <option value="tls" {{ smtpEncryption == 'tls' or not smtpEncryption ? 'selected' : '' }}>TLS (STARTTLS)</option>
                                        <option value="ssl" {{ smtpEncryption == 'ssl' ? 'selected' : '' }}>SSL</option>
                                    </select>
                                    <div class="form-text">Default: TLS</div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label for="oauthEmailFromAddress" class="form-label">
                                        Email From Address (Optional)
                                        <i class="bi bi-info-circle text-muted" data-bs-toggle="tooltip"
                                           title="The 'From' address shown in emails (e.g., noreply@pathary.tv). Leave blank to use authentication mailbox. Requires 'Send As' permission if different."></i>
                                    </label>
                                    <div class="input-group">
                                        <input type="email" class="form-control" id="oauthEmailFromAddress"
                                               value="{{ serverSettings.fromAddress ?? '' }}"
                                               placeholder="noreply@pathary.tv (optional - leave blank to use authentication mailbox)">
                                        <button type="button" class="btn btn-outline-primary" onclick="saveOAuthFromAddress()">
                                            <i class="bi bi-save me-1"></i>Save
                                        </button>
                                    </div>
                                    <div class="form-text">
                                        Optional: Send emails from a different address.
                                        <span class="text-warning">Requires "Send As" permission in Exchange Online</span>
                                        (see setup instructions above).
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label for="oauthFromDisplayName" class="form-label">
                                        From Display Name <small class="text-muted">(optional)</small>
                                        <i class="bi bi-info-circle text-muted" data-bs-toggle="tooltip"
                                           title="Friendly name shown to recipients (e.g., 'Email from Pathary'). Works with both authentication mailbox and custom From addresses."></i>
                                    </label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="oauthFromDisplayName"
                                               value="{{ smtpFromDisplayName ?? '' }}"
                                               placeholder="Email from Pathary">
                                        <button type="button" class="btn btn-outline-primary" onclick="saveOAuthFromDisplayName()">
                                            <i class="bi bi-save me-1"></i>Save
                                        </button>
                                    </div>
                                    <div class="form-text">
                                        If set, recipients will see "Display Name &lt;email@address&gt;" instead of just the email address.
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="oauthClientId" class="form-label">Client ID</label>
                                    <input type="text" class="form-control font-monospace" id="oauthClientId"
                                           value="{{ oauthConfig ? oauthConfig.clientId : '' }}"
                                           placeholder="Enter client ID from provider">
                                    <div class="form-text">Public OAuth client identifier</div>
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label for="oauthClientSecret" class="form-label">
                                        Client Secret
                                        {% if oauthConfig %}
                                            <span class="badge bg-success ms-2">
                                                <i class="bi bi-check-circle-fill"></i> Configured
                                            </span>
                                        {% endif %}
                                    </label>
                                    <div class="input-group">
                                        <input type="password" class="form-control font-monospace" id="oauthClientSecret"
                                               placeholder="{% if oauthConfig %}Saved (leave blank to keep current){% else %}Enter client secret{% endif %}">
                                        <button class="btn btn-outline-secondary" type="button" onclick="toggleApiKeyVisibility('oauthClientSecret')">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                    </div>
                                    <div class="form-text">OAuth client secret (stored encrypted)</div>
                                </div>
                            </div>

                            <div class="row" id="tenantIdRow" style="display: {{ oauthConfig and oauthConfig.provider == 'microsoft' ? 'flex' : 'none' }};">
                                <div class="col-md-6 mb-3">
                                    <label for="oauthTenantId" class="form-label">Tenant ID (Microsoft Only)</label>
                                    <input type="text" class="form-control font-monospace" id="oauthTenantId"
                                           value="{{ oauthConfig ? oauthConfig.tenantId : '' }}"
                                           placeholder="common or your-tenant-guid">
                                    <div class="form-text">Azure AD tenant ID (use "common" for multi-tenant)</div>
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label for="oauthSecretExpiry" class="form-label">Client Secret Expires In</label>
                                    <select class="form-select" id="oauthSecretExpiry">
                                        {% set savedMonths = oauthConfig and oauthConfig.daysUntilSecretExpiry ? (oauthConfig.daysUntilSecretExpiry / 30)|round(0, 'floor') : 12 %}
                                        {% if savedMonths > 18 %}{% set savedMonths = 24 %}
                                        {% elseif savedMonths > 9 %}{% set savedMonths = 12 %}
                                        {% elseif savedMonths > 4 %}{% set savedMonths = 6 %}
                                        {% else %}{% set savedMonths = 3 %}{% endif %}
                                        <option value="3" {{ savedMonths == 3 ? 'selected' : '' }}>3 months</option>
                                        <option value="6" {{ savedMonths == 6 ? 'selected' : '' }}>6 months</option>
                                        <option value="12" {{ savedMonths == 12 ? 'selected' : '' }}>12 months</option>
                                        <option value="24" {{ savedMonths == 24 ? 'selected' : '' }}>24 months</option>
                                    </select>
                                    <div class="form-text">Track when secret needs renewal</div>
                                </div>
                            </div>

                            <!-- Connection Status -->
                            {% if oauthConfig %}
                                <div class="alert alert-{{ oauthConfig.tokenStatusVariant }} mb-3" role="alert">
                                    <div class="d-flex align-items-center">
                                        <div class="flex-grow-1">
                                            <strong>Status:</strong> {{ oauthConfig.tokenStatusLabel }}
                                            {% if oauthConfig.tokenStatusMessage %}
                                                <br><small>{{ oauthConfig.tokenStatusMessage }}</small>
                                            {% endif %}
                                            {% if oauthConfig.connectedAt %}
                                                <br><small class="text-muted">Connected: {{ oauthConfig.connectedAt }}</small>
                                            {% endif %}
                                            {% if oauthConfig.clientSecretExpiring %}
                                                <br><small class="text-warning">
                                                    <i class="bi bi-exclamation-triangle"></i> Client secret expires in {{ oauthConfig.daysUntilSecretExpiry }} days
                                                </small>
                                            {% endif %}
                                        </div>
                                        <div>
                                            <span class="badge bg-{{ oauthConfig.tokenStatusVariant }} fs-6">
                                                {{ oauthConfig.providerDisplayName }}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            {% endif %}

                            <!-- Redirect URI Display -->
                            <div class="mb-3">
                                <label class="form-label">OAuth Redirect URI</label>
                                <div class="input-group">
                                    <input type="text" class="form-control font-monospace" id="oauthRedirectUri"
                                           value="{{ applicationUrl }}/admin/server/email/oauth/callback" readonly>
                                    <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard('oauthRedirectUri')">
                                        <i class="bi bi-clipboard"></i>
                                    </button>
                                </div>
                                <div class="form-text">Configure this URL in your OAuth provider settings</div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="border-top pt-3 mt-3">
                                <button type="button" class="btn btn-primary" onclick="saveOAuthConfig()" {{ not encryptionKeyConfigured ? 'disabled' : '' }}>
                                    <i class="bi bi-save me-1"></i>Save OAuth Config
                                </button>

                                {% if oauthConfig %}
                                    {% if oauthConfig.connected %}
                                        <button type="button" class="btn btn-success" onclick="switchToOAuthMode()">
                                            <i class="bi bi-check-circle me-1"></i>Use OAuth Mode
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary" onclick="sendTestEmail()">
                                            <i class="bi bi-send me-1"></i>Send Test Email
                                        </button>
                                        <button type="button" class="btn btn-outline-warning" onclick="disconnectOAuth()">
                                            <i class="bi bi-x-circle me-1"></i>Disconnect
                                        </button>
                                    {% else %}
                                        <button type="button" class="btn btn-success" onclick="authorizeOAuth()">
                                            <i class="bi bi-box-arrow-up-right me-1"></i>Connect
                                        </button>
                                    {% endif %}

                                    <button type="button" class="btn btn-outline-danger" onclick="deleteOAuthConfig()">
                                        <i class="bi bi-trash me-1"></i>Delete Config
                                    </button>
                                {% else %}
                                    <button type="button" class="btn btn-success" onclick="authorizeOAuth()" disabled>
                                        <i class="bi bi-box-arrow-up-right me-1"></i>Connect (Save config first)
                                    </button>
                                {% endif %}
                            </div>

                            <!-- Helper Text -->
                            <div class="alert alert-info mt-3" role="alert">
                                <h6 class="alert-heading"><i class="bi bi-info-circle me-2"></i>Setup Instructions</h6>
                                <ol class="small mb-0">
                                    <li>Create OAuth app in <a href="https://console.cloud.google.com/" target="_blank">Google Cloud Console</a> or <a href="https://portal.azure.com/" target="_blank">Azure Portal</a></li>
                                    <li>Copy the redirect URI above and add it to your OAuth app settings</li>
                                    <li>Copy Client ID and Client Secret from your OAuth app</li>
                                    <li>Paste credentials here and click "Save OAuth Config"</li>
                                    <li>Click "Connect" to authorize Pathary to send emails</li>
                                    <li>After successful connection, click "Use OAuth Mode" to switch</li>
                                </ol>
                                <p class="small text-muted mb-0 mt-2">
                                    See <a href="https://github.com/benjaminmue/pathary/wiki" target="_blank">GitHub Wiki</a> for detailed setup guides.
                                </p>
                            </div>
                        </form>
                    </div>
                </div>
                </div>
            </div>
        </div>
    </div>
    </div><!-- End Settings Accordion -->

    <!-- Test Email Modal -->
    <div class="modal fade" id="testEmailModal" tabindex="-1" aria-labelledby="testEmailModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="testEmailModalLabel">
                        <i class="bi bi-send me-2"></i>Send Test Email
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="testEmailRecipient" class="form-label">Recipient Email Address</label>
                        <input type="email" class="form-control" id="testEmailRecipient"
                               placeholder="user@example.com" required>
                        <div class="form-text">Enter the address that should receive the test email.</div>
                        <div id="testEmailRecipientError" class="invalid-feedback" style="display: none;"></div>
                    </div>
                    <div id="testEmailError" class="alert alert-danger" style="display: none;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="sendTestEmailBtn" onclick="sendTestEmailSubmit()" disabled>
                        <i class="bi bi-send me-1"></i>Send Test Email
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- System Health Card -->
    <div class="col-md-12 mb-4">
        <div class="card admin-card">
            <div class="card-header health-card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-activity me-2"></i>System Health</span>
                <small class="text-muted" id="health-last-run">Last check: <span id="health-last-run-time">Never</span></small>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <!-- Database Box -->
                    <div class="col-md-6 col-lg-3">
                        <div class="card h-100 health-box" id="health-box-database">
                            <div class="card-body text-center d-flex flex-column">
                                <h6 class="card-title mb-3">Database</h6>
                                <div class="health-icon mb-3">
                                    <i class="bi bi-database text-secondary" style="font-size: 3rem;" id="health-icon-database"></i>
                                </div>
                                <span class="badge bg-secondary mb-2" id="health-badge-database">Unknown</span>
                                <p class="small text-muted mb-2" id="health-message-database">Not checked yet</p>
                                <p class="small text-muted mb-3" id="health-meta-database">
                                    <span id="health-latency-database">-</span> • <span id="health-checked-database">-</span>
                                </p>
                                <div class="mt-auto">
                                    <button class="btn btn-sm btn-outline-primary" id="health-retest-database" onclick="retestDatabase()">
                                        <i class="bi bi-arrow-clockwise"></i> Retest
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- TMDB Box -->
                    <div class="col-md-6 col-lg-3">
                        <div class="card h-100 health-box" id="health-box-tmdb">
                            <div class="card-body text-center d-flex flex-column">
                                <h6 class="card-title mb-3">TMDB API</h6>
                                <div class="health-icon mb-3">
                                    <i class="bi bi-cloud text-secondary" style="font-size: 3rem;" id="health-icon-tmdb"></i>
                                </div>
                                <span class="badge bg-secondary mb-2" id="health-badge-tmdb">Unknown</span>
                                <p class="small text-muted mb-2" id="health-message-tmdb">Not checked yet</p>
                                <p class="small text-muted mb-3" id="health-meta-tmdb">
                                    <span id="health-latency-tmdb">-</span> • <span id="health-checked-tmdb">-</span>
                                </p>
                                <div class="mt-auto">
                                    <button class="btn btn-sm btn-outline-primary me-1" id="health-retest-tmdb" onclick="retestTmdb()">
                                        <i class="bi bi-arrow-clockwise"></i> Retest
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="navigateToSettings('tmdb')">
                                        <i class="bi bi-gear"></i> Settings
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Email Box (OAuth or SMTP) -->
                    <div class="col-md-6 col-lg-3">
                        <div class="card h-100 health-box" id="health-box-oauth">
                            <div class="card-body text-center d-flex flex-column">
                                <h6 class="card-title mb-3" id="health-title-oauth">Email System</h6>
                                <div class="health-icon mb-3">
                                    <i class="bi bi-envelope text-secondary" style="font-size: 3rem;" id="health-icon-oauth"></i>
                                </div>
                                <span class="badge bg-secondary mb-2" id="health-badge-oauth">Unknown</span>
                                <p class="small text-muted mb-2" id="health-message-oauth">Not checked yet</p>
                                <p class="small text-muted mb-3" id="health-meta-oauth">
                                    <span id="health-latency-oauth">-</span> • <span id="health-checked-oauth">-</span>
                                </p>
                                <div class="mt-auto">
                                    <button class="btn btn-sm btn-outline-primary me-1" id="health-retest-oauth" onclick="retestOauth()">
                                        <i class="bi bi-arrow-clockwise"></i> Retest
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="navigateToSettings('email')">
                                        <i class="bi bi-gear"></i> Settings
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Integration 1 Box (Placeholder) -->
                    <div class="col-md-6 col-lg-3">
                        <div class="card h-100 health-box health-box-disabled" id="health-box-integration1">
                            <div class="card-body text-center d-flex flex-column">
                                <h6 class="card-title mb-3 text-muted">Integration 1</h6>
                                <div class="health-icon mb-3">
                                    <i class="bi bi-puzzle text-muted" style="font-size: 3rem;" id="health-icon-integration1"></i>
                                </div>
                                <span class="badge bg-secondary mb-2" id="health-badge-integration1">Disabled</span>
                                <p class="small text-muted mb-2" id="health-message-integration1">Not enabled</p>
                                <p class="small text-muted mb-3" id="health-meta-integration1">
                                    <span id="health-latency-integration1">-</span> • <span id="health-checked-integration1">-</span>
                                </p>
                                <div class="mt-auto">
                                    <button class="btn btn-sm btn-outline-secondary me-1" id="health-retest-integration1" disabled>
                                        <i class="bi bi-arrow-clockwise"></i> Retest
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="navigateToSettings('integration1')">
                                        <i class="bi bi-gear"></i> Settings
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Integration 2 Box (Placeholder) -->
                    <div class="col-md-6 col-lg-3">
                        <div class="card h-100 health-box health-box-disabled" id="health-box-integration2">
                            <div class="card-body text-center d-flex flex-column">
                                <h6 class="card-title mb-3 text-muted">Integration 2</h6>
                                <div class="health-icon mb-3">
                                    <i class="bi bi-puzzle text-muted" style="font-size: 3rem;" id="health-icon-integration2"></i>
                                </div>
                                <span class="badge bg-secondary mb-2" id="health-badge-integration2">Disabled</span>
                                <p class="small text-muted mb-2" id="health-message-integration2">Not enabled</p>
                                <p class="small text-muted mb-3" id="health-meta-integration2">
                                    <span id="health-latency-integration2">-</span> • <span id="health-checked-integration2">-</span>
                                </p>
                                <div class="mt-auto">
                                    <button class="btn btn-sm btn-outline-secondary me-1" id="health-retest-integration2" disabled>
                                        <i class="bi bi-arrow-clockwise"></i> Retest
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="navigateToSettings('integration2')">
                                        <i class="bi bi-gear"></i> Settings
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-3">
                    <button class="btn btn-primary btn-sm" id="runHealthCheckBtn" onclick="runHealthCheck()">
                        <i class="bi bi-arrow-clockwise me-1"></i>Check All Systems
                    </button>
                </div>

                <div id="health-check-error" class="alert alert-warning mt-3" style="display: none;"></div>
            </div>
        </div>
    </div>
</div>

<style>
    /* TMDB Status Badge Styling */
    #tmdbKeyStatus .badge {
        font-size: 0.875rem;
        padding: 0.35em 0.65em;
    }

    #tmdbKeyStatus .gap-2 > * {
        margin-right: 0.5rem;
    }

    #tmdbKeyStatus .gap-2 > *:last-child {
        margin-right: 0;
    }

    /* Accordion Styling - Match System Health Card */
    #serverSettingsAccordion .accordion-item {
        border: none;
        box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
        margin-bottom: 1.5rem;
        background-color: transparent;
    }

    #serverSettingsAccordion .accordion-header {
        margin-bottom: 0;
    }

    #serverSettingsAccordion .accordion-button {
        background-color: var(--bs-secondary-bg);
        color: var(--bs-body-color);
        border: none;
        border-bottom: 2px solid var(--bs-border-color);
        font-weight: 600;
        padding: 1rem 1.25rem;
    }

    #serverSettingsAccordion .accordion-button:not(.collapsed) {
        background-color: var(--bs-secondary-bg);
        color: var(--bs-body-color);
        box-shadow: none;
        border-bottom: 2px solid var(--bs-border-color);
    }

    #serverSettingsAccordion .accordion-button:focus {
        box-shadow: none;
        border-color: var(--bs-border-color);
    }

    #serverSettingsAccordion .accordion-button::after {
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%23adb5bd'%3e%3cpath fill-rule='evenodd' d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3e%3c/svg%3e");
    }

    #serverSettingsAccordion .accordion-button:not(.collapsed)::after {
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%23adb5bd'%3e%3cpath fill-rule='evenodd' d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3e%3c/svg%3e");
    }

    #serverSettingsAccordion .accordion-body {
        padding: 1.5rem 1.25rem;
        background-color: var(--bs-body-bg);
    }

    /* System Health Card - Match accordion header thickness */
    .health-card-header {
        padding: 1rem 1.25rem !important;
    }

    /* Health Box Styling */
    .health-box {
        transition: all 0.3s ease;
        border: 2px solid transparent;
    }

    .health-box:hover:not(.health-box-disabled) {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    .health-box-disabled {
        opacity: 0.6;
    }

    .health-box-disabled .card-body {
        background-color: var(--bs-secondary-bg);
    }

    .health-icon {
        line-height: 1;
    }

    .health-icon i {
        transition: color 0.3s ease;
    }

    /* Dark mode adjustments */
    [data-bs-theme="dark"] .health-box-disabled {
        opacity: 0.5;
    }

    [data-bs-theme="dark"] .health-box {
        border-color: var(--bs-border-color);
    }

    /* Responsive adjustments */
    @media (max-width: 991.98px) {
        .health-box .btn-sm {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }
    }
</style>

<script>
    // Load TMDB status on page load
    document.addEventListener('DOMContentLoaded', async () => {
        await loadTmdbStatus();

        // Track input changes for dirty state
        const tmdbInput = document.getElementById('tmdbApiKey');
        if (tmdbInput) {
            tmdbInput.addEventListener('input', () => {
                tmdbDirty = true;
                updateSaveButtonState();
            });
        }
    });

    async function loadTmdbStatus() {
        try {
            const response = await fetch('{{ applicationUrl }}/api/admin/settings/tmdb', {
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('authToken'),
                },
            });

            if (!response.ok) {
                throw new Error('Failed to load TMDB status');
            }

            const data = await response.json();
            updateTmdbStatus(data.configured, data.updated_at);
        } catch (error) {
            document.getElementById('tmdbKeyStatus').innerHTML =
                '<i class="bi bi-exclamation-circle text-warning"></i> Failed to load status';
        }
    }

    // Track TMDB configuration state
    let tmdbConfigured = false;
    let tmdbDirty = false;

    function updateTmdbStatus(configured, updatedAt) {
        const statusEl = document.getElementById('tmdbKeyStatus');
        tmdbConfigured = configured;
        tmdbDirty = false; // Reset dirty state when status is updated

        if (configured) {
            const timestamp = updatedAt ? new Date(updatedAt.replace(' ', 'T')).toLocaleString() : 'Unknown';
            statusEl.innerHTML = `
                <div class="d-flex align-items-center gap-2 flex-wrap">
                    <span class="badge bg-success">
                        <i class="bi bi-check-circle-fill me-1"></i>Key Configured
                    </span>
                    <span class="text-muted small">Last updated: ${timestamp}</span>
                    <a href="https://www.themoviedb.org/settings/api" target="_blank" rel="noopener" class="small">Get API key</a>
                </div>
            `;
        } else {
            statusEl.innerHTML = `
                <div class="d-flex align-items-center gap-2 flex-wrap">
                    <span class="badge bg-secondary">
                        <i class="bi bi-x-circle me-1"></i>Not Configured
                    </span>
                    <a href="https://www.themoviedb.org/settings/api" target="_blank" rel="noopener" class="small">Get API key</a>
                </div>
            `;
        }

        updateSaveButtonState();
    }

    function updateSaveButtonState() {
        const saveBtn = document.getElementById('saveApiSettingsBtn');
        const helperText = document.getElementById('saveHelperText');
        const helperMessage = document.getElementById('saveHelperMessage');

        if (!saveBtn) return;

        if (tmdbConfigured && !tmdbDirty) {
            // Configured and no changes
            saveBtn.className = 'btn btn-success';
            saveBtn.innerHTML = '<i class="bi bi-check-circle-fill me-1"></i>Saved';
            saveBtn.disabled = true;
            helperText.style.display = 'block';
            helperMessage.textContent = 'No changes to save. Enter a new API key to update.';
        } else if (tmdbDirty) {
            // User has made changes
            saveBtn.className = 'btn btn-primary';
            saveBtn.innerHTML = '<i class="bi bi-save me-1"></i>Save API Settings';
            saveBtn.disabled = false;
            helperText.style.display = 'none';
        } else {
            // Not configured
            saveBtn.className = 'btn btn-primary';
            saveBtn.innerHTML = '<i class="bi bi-save me-1"></i>Save API Settings';
            saveBtn.disabled = false;
            helperText.style.display = 'none';
        }
    }

    function toggleApiKeyVisibility(inputId) {
        const input = document.getElementById(inputId);
        const icon = event.target.closest('button').querySelector('i');

        if (input.type === 'password') {
            input.type = 'text';
            icon.classList.remove('bi-eye');
            icon.classList.add('bi-eye-slash');
        } else {
            input.type = 'password';
            icon.classList.remove('bi-eye-slash');
            icon.classList.add('bi-eye');
        }
    }

    async function saveApiSettings() {
        const tmdbApiKey = document.getElementById('tmdbApiKey').value.trim();

        if (tmdbApiKey === '') {
            showToast('Please enter a TMDB API key', 'warning');
            return;
        }

        // Validate format (32 hexadecimal characters)
        if (!/^[a-f0-9]{32}$/i.test(tmdbApiKey)) {
            showToast('Invalid API key format. Expected 32 hexadecimal characters.', 'danger');
            return;
        }

        try {
            const response = await fetch('{{ applicationUrl }}/api/admin/settings/tmdb', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + localStorage.getItem('authToken'),
                },
                body: JSON.stringify({
                    apiKey: tmdbApiKey,
                }),
            });

            const data = await response.json();

            if (!response.ok) {
                showToast(data.error || 'Failed to save API key', 'danger');
                return;
            }

            showToast(data.message || 'API key saved successfully', 'success');

            // Clear input and update status
            document.getElementById('tmdbApiKey').value = '';
            document.getElementById('tmdbApiKey').type = 'password';
            updateTmdbStatus(true, data.updated_at);

            // Reset dirty state and update button
            tmdbDirty = false;
            updateSaveButtonState();
        } catch (error) {
            showToast('Error saving API key: ' + error.message, 'danger');
        }
    }

    async function testTmdbConnection() {
        const button = event.target.closest('button');
        const originalHtml = button.innerHTML;
        button.disabled = true;
        button.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Testing...';

        try {
            const response = await fetch('{{ applicationUrl }}/api/admin/settings/tmdb/test', {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('authToken'),
                },
            });

            const data = await response.json();

            if (data.success) {
                showToast(`Connection successful! (${data.latency_ms}ms)`, 'success');
            } else {
                showToast(data.message || 'Connection test failed', 'danger');
            }
        } catch (error) {
            showToast('Error testing connection: ' + error.message, 'danger');
        } finally {
            button.disabled = false;
            button.innerHTML = originalHtml;
        }
    }

    async function saveAppSettings() {
        const appName = document.getElementById('appName').value;
        const registrationEnabled = document.getElementById('registrationEnabled').checked;

        try {
            // TODO: Implement app settings save endpoint
            showToast('App settings save feature coming soon', 'info');
        } catch (error) {
            showToast('Error saving app settings: ' + error.message, 'danger');
        }
    }

    async function saveEmailSettings() {
        const password = document.getElementById('smtpPassword').value.trim();

        const settings = {
            smtpHost: document.getElementById('smtpHost').value,
            smtpPort: parseInt(document.getElementById('smtpPort').value),
            smtpEncryption: document.getElementById('smtpEncryption').value,
            smtpUser: document.getElementById('smtpUsername').value,
            smtpFromAddress: document.getElementById('smtpFromAddress').value,
            smtpFromDisplayName: document.getElementById('smtpFromDisplayName').value,
            smtpWithAuthentication: true, // Enable auth when credentials provided
            _csrf_token: getCsrfToken(),
        };

        // Only include password if user entered a new one
        if (password !== '') {
            settings.smtpPassword = password;
        }

        try {
            const response = await fetch('{{ applicationUrl }}/api/admin/server/email', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(settings),
            });

            if (!response.ok) throw new Error('Failed to save email settings');

            showToast('Email settings saved successfully', 'success');

            // Clear password field after save and reload page to show updated status
            document.getElementById('smtpPassword').value = '';

            // Reload page after 1 second to show updated "Configured" status
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } catch (error) {
            showToast('Error saving email settings: ' + error.message, 'danger');
        }
    }

    // Track last used recipient (session only, not persisted)
    let lastTestEmailRecipient = '';

    function sendTestEmail() {
        const fromAddress = document.getElementById('smtpFromAddress').value;

        if (!fromAddress) {
            showToast('Please configure and save email settings first', 'warning');
            return;
        }

        // Reset modal state
        const recipientInput = document.getElementById('testEmailRecipient');
        const errorDiv = document.getElementById('testEmailError');
        const recipientError = document.getElementById('testEmailRecipientError');
        const sendBtn = document.getElementById('sendTestEmailBtn');

        // Clear previous values and errors
        recipientInput.value = '';
        recipientInput.classList.remove('is-invalid');
        errorDiv.style.display = 'none';
        recipientError.style.display = 'none';
        sendBtn.disabled = true;

        // Show the modal
        const modal = new bootstrap.Modal(document.getElementById('testEmailModal'));
        modal.show();
    }

    function validateTestEmailRecipient() {
        const recipientInput = document.getElementById('testEmailRecipient');
        const sendBtn = document.getElementById('sendTestEmailBtn');
        const recipientError = document.getElementById('testEmailRecipientError');
        const email = recipientInput.value.trim();

        // Basic email validation regex
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

        if (email === '') {
            sendBtn.disabled = true;
            recipientInput.classList.remove('is-invalid');
            recipientError.style.display = 'none';
            return false;
        }

        if (!emailRegex.test(email) || email.length > 255) {
            sendBtn.disabled = true;
            recipientInput.classList.add('is-invalid');
            recipientError.textContent = 'Please enter a valid email address';
            recipientError.style.display = 'block';
            return false;
        }

        sendBtn.disabled = false;
        recipientInput.classList.remove('is-invalid');
        recipientError.style.display = 'none';
        return true;
    }

    async function sendTestEmailSubmit() {
        const recipientInput = document.getElementById('testEmailRecipient');
        const errorDiv = document.getElementById('testEmailError');
        const sendBtn = document.getElementById('sendTestEmailBtn');
        const originalHtml = sendBtn.innerHTML;

        if (!validateTestEmailRecipient()) {
            return;
        }

        const recipient = recipientInput.value.trim();
        const settings = {
            smtpHost: document.getElementById('smtpHost').value,
            smtpPort: parseInt(document.getElementById('smtpPort').value),
            smtpFromAddress: document.getElementById('smtpFromAddress').value,
            smtpEncryption: document.getElementById('smtpEncryption').value,
            smtpWithAuthentication: true,
            smtpUser: document.getElementById('smtpUsername').value,
            smtpPassword: document.getElementById('smtpPassword').value,
            recipient: recipient,
            _csrf_token: getCsrfToken(),
        };

        // Show loading state
        sendBtn.disabled = true;
        sendBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Sending...';
        errorDiv.style.display = 'none';

        try {
            const response = await fetch('{{ applicationUrl }}/api/admin/server/email/test', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(settings),
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(errorText || 'Failed to send test email');
            }

            // Success - remember recipient for this session
            lastTestEmailRecipient = recipient;

            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('testEmailModal'));
            modal.hide();

            showToast(`Test email sent successfully to ${recipient}`, 'success');
        } catch (error) {
            // Show error in modal so user can correct recipient
            errorDiv.textContent = error.message;
            errorDiv.style.display = 'block';
        } finally {
            sendBtn.disabled = false;
            sendBtn.innerHTML = originalHtml;
        }
    }

    async function runSMTPDiagnostics() {
        const settings = {
            smtpHost: document.getElementById('smtpHost').value,
            smtpPort: parseInt(document.getElementById('smtpPort').value),
            smtpEncryption: document.getElementById('smtpEncryption').value,
            _csrf_token: getCsrfToken(),
        };

        const resultsDiv = document.getElementById('smtpDiagnosticsResults');
        const contentDiv = document.getElementById('diagnosticsContent');

        // Show loading state
        resultsDiv.style.display = 'block';
        contentDiv.innerHTML = `
            <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Running diagnostics...</span>
                </div>
                <p class="mt-2">Running SMTP diagnostics...</p>
            </div>
        `;

        try {
            const response = await fetch('{{ applicationUrl }}/api/admin/server/email/diagnose', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(settings),
            });

            if (!response.ok) {
                throw new Error('Failed to run diagnostics');
            }

            const results = await response.json();
            displayDiagnosticsResults(results);
        } catch (error) {
            contentDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    Error running diagnostics: ${error.message}
                </div>
            `;
        }
    }

    function displayDiagnosticsResults(results) {
        const contentDiv = document.getElementById('diagnosticsContent');
        const tests = results.tests || {};

        let html = `
            <div class="mb-3">
                <strong>Configuration:</strong>
                <span class="ms-2">Host: ${results.host}</span>
                <span class="ms-2">Port: ${results.port}</span>
                <span class="ms-2">Encryption: ${results.encryption || 'None'}</span>
            </div>
            <div class="mb-3">
                <strong>Overall Status:</strong>
                <span class="badge ${results.overall_status === 'passed' ? 'bg-success' : 'bg-danger'} ms-2">
                    ${results.overall_status === 'passed' ? 'PASSED' : 'FAILED'}
                </span>
            </div>
            <hr>
            <h6>Diagnostic Tests:</h6>
        `;

        const getStatusBadge = (status) => {
            if (status === 'success') return '<span class="badge bg-success">✓ PASS</span>';
            if (status === 'warning') return '<span class="badge bg-warning">⚠ WARNING</span>';
            return '<span class="badge bg-danger">✗ FAIL</span>';
        };

        for (const [testName, testResult] of Object.entries(tests)) {
            const testLabel = testName.replace(/_/g, ' ').toUpperCase();
            html += `
                <div class="card mb-2">
                    <div class="card-body py-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${testLabel}</strong>
                                <div class="small text-muted">${testResult.message}</div>
                                ${testResult.hint ? `<div class="small text-info mt-1"><i class="bi bi-lightbulb"></i> ${testResult.hint}</div>` : ''}
                            </div>
                            <div class="text-end">
                                ${getStatusBadge(testResult.status)}
                                ${testResult.latency_ms ? `<div class="small text-muted">${testResult.latency_ms}ms</div>` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        html += `
            <div class="mt-3">
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="document.getElementById('smtpDiagnosticsResults').style.display='none'">
                    <i class="bi bi-x-circle me-1"></i>Close
                </button>
            </div>
        `;

        contentDiv.innerHTML = html;
    }

    // Add event listener for recipient input validation
    document.addEventListener('DOMContentLoaded', () => {
        const recipientInput = document.getElementById('testEmailRecipient');
        if (recipientInput) {
            recipientInput.addEventListener('input', validateTestEmailRecipient);
            recipientInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !document.getElementById('sendTestEmailBtn').disabled) {
                    sendTestEmailSubmit();
                }
            });
        }
    });

    // Health Check Functions
    document.addEventListener('DOMContentLoaded', async () => {
        // Try to load cached status first
        const cachedData = await loadHealthStatus();

        // If no cached data or cache is old, run a fresh check
        if (!cachedData || cachedData.overall.status === 'unknown') {
            await runHealthCheck(true); // Silent mode - no toast
        }
    });

    async function loadHealthStatus() {
        try {
            const response = await fetch('{{ applicationUrl }}/admin/health');
            if (!response.ok) {
                throw new Error('Failed to load health status');
            }

            const data = await response.json();
            updateHealthDisplay(data);
            return data;
        } catch (error) {
            console.error('Error loading health status:', error);
            return null;
        }
    }

    async function runHealthCheck(silent = false) {
        const button = document.getElementById('runHealthCheckBtn');
        const originalHtml = button?.innerHTML;

        if (button) {
            button.disabled = true;
            button.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Checking...';
        }

        // Hide any previous error
        const errorDiv = document.getElementById('health-check-error');
        if (errorDiv) {
            errorDiv.style.display = 'none';
        }

        try {
            const response = await fetch('{{ applicationUrl }}/admin/health/run', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    _csrf_token: getCsrfToken(),
                }),
            });

            const data = await response.json();

            if (data.error) {
                // Rate limit or other error
                if (errorDiv) {
                    errorDiv.textContent = data.error;
                    errorDiv.style.display = 'block';
                }
            } else {
                updateHealthDisplay(data);
                updateLastRunTime();

                if (!silent) {
                    showToast('Health check completed', 'success');
                }

                // Store health status globally for notifications
                window.healthStatus = data;
            }
        } catch (error) {
            if (!silent) {
                showToast('Error running health check: ' + error.message, 'danger');
            }
        } finally {
            if (button) {
                button.disabled = false;
                button.innerHTML = originalHtml;
            }
        }
    }

    function updateLastRunTime() {
        const timeEl = document.getElementById('health-last-run-time');
        if (timeEl) {
            timeEl.textContent = new Date().toLocaleString();
        }
    }

    async function retestDatabase() {
        const button = document.getElementById('health-retest-database');
        const originalHtml = button?.innerHTML;

        if (button) {
            button.disabled = true;
            button.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
        }

        try {
            const response = await fetch('{{ applicationUrl }}/admin/health/db', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    _csrf_token: getCsrfToken(),
                }),
            });

            const data = await response.json();

            if (data.database) {
                updateServiceStatus('database', data.database);
                updateLastRunTime();
                showToast('Database check completed', 'success');
            }
        } catch (error) {
            showToast('Error checking database: ' + error.message, 'danger');
        } finally {
            if (button) {
                button.disabled = false;
                button.innerHTML = originalHtml;
            }
        }
    }

    async function retestTmdb() {
        const button = document.getElementById('health-retest-tmdb');
        const originalHtml = button?.innerHTML;

        if (button) {
            button.disabled = true;
            button.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
        }

        try {
            const response = await fetch('{{ applicationUrl }}/admin/health/tmdb', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    _csrf_token: getCsrfToken(),
                }),
            });

            const data = await response.json();

            if (data.tmdb) {
                updateServiceStatus('tmdb', data.tmdb);
                updateLastRunTime();
                showToast('TMDB check completed', 'success');
            }
        } catch (error) {
            showToast('Error checking TMDB: ' + error.message, 'danger');
        } finally {
            if (button) {
                button.disabled = false;
                button.innerHTML = originalHtml;
            }
        }
    }

    async function retestOauth() {
        const button = document.getElementById('health-retest-oauth');
        const originalHtml = button?.innerHTML;

        if (button) {
            button.disabled = true;
            button.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
        }

        try {
            const response = await fetch('{{ applicationUrl }}/admin/health/oauth', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    _csrf_token: getCsrfToken(),
                }),
            });

            const data = await response.json();

            if (data.oauth) {
                updateServiceStatus('oauth', data.oauth);
                updateLastRunTime();
                showToast('OAuth check completed', 'success');
            }
        } catch (error) {
            showToast('Error checking OAuth: ' + error.message, 'danger');
        } finally {
            if (button) {
                button.disabled = false;
                button.innerHTML = originalHtml;
            }
        }
    }

    function navigateToSettings(module) {
        switch (module) {
            case 'database':
                // Scroll to application settings (placeholder)
                showToast('Database settings section coming soon', 'info');
                break;
            case 'tmdb':
                // Scroll to TMDB API settings section
                const tmdbSection = document.querySelector('.card-header:has(.bi-key)');
                if (tmdbSection) {
                    tmdbSection.parentElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
                break;
            case 'email':
            case 'oauth':
                // Scroll to email settings section and expand accordion
                const emailCard = document.querySelector('.card-header:has(.bi-envelope)');
                if (emailCard) {
                    // Scroll to email settings card
                    emailCard.parentElement.scrollIntoView({ behavior: 'smooth', block: 'start' });

                    // Expand the accordion if collapsed
                    const collapseButton = emailCard.querySelector('[data-bs-toggle="collapse"]');
                    const targetCollapse = emailCard.nextElementSibling;

                    if (collapseButton && targetCollapse && !targetCollapse.classList.contains('show')) {
                        collapseButton.click();
                    }
                }
                break;
            case 'integration1':
            case 'integration2':
                showToast('Integration settings coming soon', 'info');
                break;
        }
    }

    function updateHealthDisplay(data) {
        // Update all modules
        if (data.database) {
            updateServiceStatus('database', data.database);
        }
        if (data.tmdb) {
            updateServiceStatus('tmdb', data.tmdb);
        }
        if (data.oauth) {
            updateServiceStatus('oauth', data.oauth);
        }
        if (data.integration1) {
            updateServiceStatus('integration1', data.integration1);
        }
        if (data.integration2) {
            updateServiceStatus('integration2', data.integration2);
        }
    }

    function updateServiceStatus(service, status) {
        const box = document.getElementById(`health-box-${service}`);
        const icon = document.getElementById(`health-icon-${service}`);
        const badge = document.getElementById(`health-badge-${service}`);
        const messageEl = document.getElementById(`health-message-${service}`);
        const latencyEl = document.getElementById(`health-latency-${service}`);
        const checkedEl = document.getElementById(`health-checked-${service}`);
        const retestBtn = document.getElementById(`health-retest-${service}`);
        const titleEl = document.getElementById(`health-title-${service}`);

        // Update box title if provider_name is available (for email box)
        if (titleEl && status.provider_name) {
            titleEl.textContent = status.provider_name;
            // Update title color based on enabled state
            if (status.enabled === false) {
                titleEl.classList.add('text-muted');
            } else {
                titleEl.classList.remove('text-muted');
            }
        }

        // Handle disabled state
        if (status.enabled === false) {
            box?.classList.add('health-box-disabled');
            icon?.classList.remove('text-success', 'text-warning', 'text-danger', 'text-secondary');
            icon?.classList.add('text-muted');
            badge.textContent = 'Disabled';
            badge.className = 'badge bg-secondary mb-2';
            messageEl.textContent = 'Not enabled';
            latencyEl.textContent = '-';
            checkedEl.textContent = '-';
            if (retestBtn) {
                retestBtn.disabled = true;
            }
            return;
        }

        // Remove disabled state if enabled
        box?.classList.remove('health-box-disabled');
        if (retestBtn) {
            retestBtn.disabled = false;
        }

        // Update icon color based on status
        icon?.classList.remove('text-success', 'text-warning', 'text-danger', 'text-secondary', 'text-muted');
        switch (status.status) {
            case 'healthy':
                icon?.classList.add('text-success');
                badge.className = 'badge bg-success mb-2';
                badge.textContent = 'Healthy';
                break;
            case 'degraded':
                icon?.classList.add('text-warning');
                badge.className = 'badge bg-warning mb-2';
                badge.textContent = 'Degraded';
                break;
            case 'down':
                icon?.classList.add('text-danger');
                badge.className = 'badge bg-danger mb-2';
                badge.textContent = 'Down';
                break;
            default:
                icon?.classList.add('text-secondary');
                badge.className = 'badge bg-secondary mb-2';
                badge.textContent = 'Unknown';
        }

        // Update message
        messageEl.textContent = status.message || 'No message';

        // Update latency
        if (status.latency_ms !== undefined && status.latency_ms > 0) {
            latencyEl.textContent = status.latency_ms + 'ms';
        } else {
            latencyEl.textContent = '-';
        }

        // Update checked timestamp
        if (status.checked_at) {
            const timestamp = new Date(status.checked_at.replace(' ', 'T')).toLocaleTimeString();
            checkedEl.textContent = timestamp;
        } else {
            checkedEl.textContent = '-';
        }
    }

    // ===========================
    // OAuth Email Functions
    // ===========================

    /**
     * Toggle visibility of Tenant ID field based on provider selection
     * Also auto-populate SMTP settings
     */
    function toggleTenantIdField() {
        const provider = document.getElementById('oauthProvider').value;
        const tenantIdRow = document.getElementById('tenantIdRow');
        const smtpHostInput = document.getElementById('oauthSmtpHost');

        if (provider === 'microsoft') {
            tenantIdRow.style.display = 'flex';
            if (smtpHostInput) {
                smtpHostInput.value = 'smtp.office365.com';
            }
        } else {
            tenantIdRow.style.display = 'none';
            if (smtpHostInput) {
                smtpHostInput.value = 'smtp.gmail.com';
            }
        }
    }

    /**
     * Copy redirect URI to clipboard
     */
    async function copyToClipboard(elementId) {
        const input = document.getElementById(elementId);
        const text = input.value;

        try {
            await navigator.clipboard.writeText(text);
            showToast('Redirect URI copied to clipboard', 'success');
        } catch (error) {
            // Fallback for older browsers
            input.select();
            document.execCommand('copy');
            showToast('Redirect URI copied to clipboard', 'success');
        }
    }

    /**
     * Save OAuth configuration (client ID, secret, etc.)
     */
    async function saveOAuthConfig() {
        const provider = document.getElementById('oauthProvider').value;
        const clientId = document.getElementById('oauthClientId').value.trim();
        const clientSecret = document.getElementById('oauthClientSecret').value.trim();
        const fromAddress = document.getElementById('oauthFromAddress').value.trim();
        const tenantId = document.getElementById('oauthTenantId').value.trim();
        const secretExpiresInMonths = parseInt(document.getElementById('oauthSecretExpiry').value);

        // Validation
        if (!clientId) {
            showToast('Client ID is required', 'warning');
            return;
        }

        if (!fromAddress) {
            showToast('From Address is required', 'warning');
            return;
        }

        // Email validation
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(fromAddress)) {
            showToast('Invalid email address format', 'danger');
            return;
        }

        // Client secret required only if not already configured
        const isUpdate = {{ oauthConfig ? 'true' : 'false' }};
        if (!isUpdate && !clientSecret) {
            showToast('Client Secret is required for initial configuration', 'warning');
            return;
        }

        // Microsoft requires tenant ID
        if (provider === 'microsoft' && !tenantId) {
            showToast('Tenant ID is required for Microsoft 365', 'warning');
            return;
        }

        const button = event.target;
        const originalHtml = button.innerHTML;
        button.disabled = true;
        button.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Saving...';

        try {
            // First, save OAuth configuration
            const payload = {
                _csrf_token: getCsrfToken(),
                provider: provider,
                clientId: clientId,
                fromAddress: fromAddress,
                tenantId: provider === 'microsoft' ? tenantId : null,
                secretExpiresInMonths: secretExpiresInMonths
            };

            // Only include secret if user entered one
            if (clientSecret) {
                payload.clientSecret = clientSecret;
            }

            const response = await fetch('{{ applicationUrl }}/admin/server/email/oauth/save', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload),
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || 'Failed to save OAuth configuration');
            }

            // Also save SMTP server settings (required for OAuth)
            const smtpHost = document.getElementById('oauthSmtpHost').value;
            const smtpPort = parseInt(document.getElementById('oauthSmtpPort').value);
            const smtpEncryption = document.getElementById('oauthSmtpEncryption').value;

            const smtpResponse = await fetch('{{ applicationUrl }}/api/admin/server/email', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    smtpHost: smtpHost,
                    smtpPort: smtpPort,
                    smtpEncryption: smtpEncryption,
                    smtpFromAddress: fromAddress,
                    smtpWithAuthentication: true,
                    _csrf_token: getCsrfToken(),
                }),
            });

            if (!smtpResponse.ok) {
                console.warn('Failed to save SMTP settings, but OAuth config was saved');
            }

            showToast('OAuth configuration and SMTP settings saved successfully', 'success');

            // Clear client secret field
            document.getElementById('oauthClientSecret').value = '';

            // Reload page to show updated status
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } catch (error) {
            showToast('Error saving OAuth configuration: ' + error.message, 'danger');
        } finally {
            button.disabled = false;
            button.innerHTML = originalHtml;
        }
    }

    /**
     * Save OAuth Email From Address (optional custom From address)
     */
    async function saveOAuthFromAddress() {
        const fromAddress = document.getElementById('oauthEmailFromAddress').value.trim();

        // Allow empty value (will use auth mailbox)
        if (fromAddress && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(fromAddress)) {
            showToast('Invalid email address format', 'danger');
            return;
        }

        const button = event.target;
        const originalHtml = button.innerHTML;
        button.disabled = true;
        button.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Saving...';

        try {
            // Use the existing email settings endpoint
            const response = await fetch('{{ applicationUrl }}/api/admin/server/email', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    smtpHost: '{{ serverSettings.smtpHost ?? "smtp.office365.com" }}',
                    smtpPort: {{ serverSettings.smtpPort ?? 587 }},
                    smtpEncryption: '{{ serverSettings.smtpEncryption ?? "tls" }}',
                    smtpUser: '',
                    smtpFromAddress: fromAddress,
                    smtpWithAuthentication: true,
                    _csrf_token: getCsrfToken(),
                }),
            });

            if (!response.ok) {
                throw new Error('Failed to save From address');
            }

            showToast(fromAddress
                ? `From address set to ${fromAddress}`
                : 'From address cleared (will use authentication mailbox)', 'success');

        } catch (error) {
            showToast('Error saving From address: ' + error.message, 'danger');
        } finally {
            button.disabled = false;
            button.innerHTML = originalHtml;
        }
    }

    /**
     * Save OAuth Email From Display Name
     */
    async function saveOAuthFromDisplayName() {
        const displayName = document.getElementById('oauthFromDisplayName').value.trim();

        const button = event.target;
        const originalHtml = button.innerHTML;
        button.disabled = true;
        button.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Saving...';

        try {
            // Use the existing email settings endpoint
            const response = await fetch('{{ applicationUrl }}/api/admin/server/email', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    smtpHost: '{{ serverSettings.smtpHost ?? "smtp.office365.com" }}',
                    smtpPort: {{ serverSettings.smtpPort ?? 587 }},
                    smtpEncryption: '{{ serverSettings.smtpEncryption ?? "tls" }}',
                    smtpUser: '',
                    smtpFromAddress: '{{ serverSettings.fromAddress ?? "" }}',
                    smtpFromDisplayName: displayName,
                    smtpWithAuthentication: true,
                    _csrf_token: getCsrfToken(),
                }),
            });

            if (!response.ok) {
                throw new Error('Failed to save From display name');
            }

            showToast(displayName
                ? `From display name set to "${displayName}"`
                : 'From display name cleared', 'success');

        } catch (error) {
            showToast('Error saving From display name: ' + error.message, 'danger');
        } finally {
            button.disabled = false;
            button.innerHTML = originalHtml;
        }
    }

    /**
     * Start OAuth authorization flow (redirect to provider)
     */
    function authorizeOAuth() {
        // Redirect to authorization endpoint
        // The backend will redirect to the OAuth provider's consent page
        window.location.href = '{{ applicationUrl }}/admin/server/email/oauth/authorize';
    }

    /**
     * Disconnect OAuth (clear tokens but keep configuration)
     */
    async function disconnectOAuth() {
        if (!confirm('Disconnect OAuth? This will remove the authorization but keep your configuration.')) {
            return;
        }

        const button = event.target;
        const originalHtml = button.innerHTML;
        button.disabled = true;
        button.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Disconnecting...';

        try {
            const response = await fetch('{{ applicationUrl }}/admin/server/email/oauth/disconnect', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    _csrf_token: getCsrfToken(),
                }),
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || 'Failed to disconnect OAuth');
            }

            showToast('OAuth disconnected successfully', 'success');

            // Reload page to show updated status
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } catch (error) {
            showToast('Error disconnecting OAuth: ' + error.message, 'danger');
        } finally {
            button.disabled = false;
            button.innerHTML = originalHtml;
        }
    }

    /**
     * Delete OAuth configuration completely
     */
    async function deleteOAuthConfig() {
        if (!confirm('Delete OAuth configuration? This will remove all settings and tokens. This action cannot be undone.')) {
            return;
        }

        const button = event.target;
        const originalHtml = button.innerHTML;
        button.disabled = true;
        button.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Deleting...';

        try {
            const response = await fetch('{{ applicationUrl }}/admin/server/email/oauth/delete', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    _csrf_token: getCsrfToken(),
                }),
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || 'Failed to delete OAuth configuration');
            }

            showToast('OAuth configuration deleted', 'success');

            // Reload page to show cleared form
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } catch (error) {
            showToast('Error deleting OAuth configuration: ' + error.message, 'danger');
        } finally {
            button.disabled = false;
            button.innerHTML = originalHtml;
        }
    }

    /**
     * Generate encryption key (for development)
     */
    async function generateEncryptionKey() {
        if (!confirm('Generate a new encryption key? This should only be used in development. In production, use the ENCRYPTION_KEY environment variable.')) {
            return;
        }

        const button = event.target;
        const originalHtml = button.innerHTML;
        button.disabled = true;
        button.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Generating...';

        try {
            const response = await fetch('{{ applicationUrl }}/admin/server/email/oauth/generate-key', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    _csrf_token: getCsrfToken(),
                }),
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || 'Failed to generate encryption key');
            }

            showToast('Encryption key generated and saved', 'success');

            // Reload page to hide warning and enable Save button
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } catch (error) {
            showToast('Error generating encryption key: ' + error.message, 'danger');
        } finally {
            button.disabled = false;
            button.innerHTML = originalHtml;
        }
    }

    /**
     * Switch email authentication mode to OAuth
     */
    async function switchToOAuthMode() {
        if (!confirm('Switch to OAuth email authentication? Emails will be sent using OAuth instead of password authentication.')) {
            return;
        }

        const button = event.target;
        const originalHtml = button.innerHTML;
        button.disabled = true;
        button.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Switching...';

        try {
            const response = await fetch('{{ applicationUrl }}/admin/server/email/auth-mode', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    _csrf_token: getCsrfToken(),
                    mode: 'smtp_oauth',
                }),
            });

            if (!response.ok) {
                throw new Error('Failed to switch to OAuth mode');
            }

            showToast('Switched to OAuth authentication mode', 'success');

            // Reload page to show active tab
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } catch (error) {
            showToast('Error switching to OAuth mode: ' + error.message, 'danger');
        } finally {
            button.disabled = false;
            button.innerHTML = originalHtml;
        }
    }

    /**
     * Switch email authentication mode to password
     */
    async function switchToPasswordMode() {
        if (!confirm('Switch to password-based email authentication? Emails will be sent using SMTP username/password instead of OAuth.')) {
            return;
        }

        const button = event.target;
        const originalHtml = button.innerHTML;
        button.disabled = true;
        button.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Switching...';

        try {
            const response = await fetch('{{ applicationUrl }}/admin/server/email/auth-mode', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    _csrf_token: getCsrfToken(),
                    mode: 'smtp_password',
                }),
            });

            if (!response.ok) {
                throw new Error('Failed to switch to password mode');
            }

            showToast('Switched to password authentication mode', 'success');

            // Reload page to show active tab
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } catch (error) {
            showToast('Error switching to password mode: ' + error.message, 'danger');
        } finally {
            button.disabled = false;
            button.innerHTML = originalHtml;
        }
    }

    /**
     * Toggle OAuth setup instructions based on selected provider
     */
    function toggleOAuthInstructions() {
        const provider = document.getElementById('oauthProvider').value;
        const gmailInstructions = document.getElementById('gmailInstructions');
        const azureInstructions = document.getElementById('azureInstructions');

        if (provider === 'gmail') {
            gmailInstructions.style.display = 'block';
            azureInstructions.style.display = 'none';
        } else {
            gmailInstructions.style.display = 'none';
            azureInstructions.style.display = 'block';
        }
    }

    // Handle OAuth callback success/error messages
    document.addEventListener('DOMContentLoaded', () => {
        const urlParams = new URLSearchParams(window.location.search);

        if (urlParams.has('oauth_success')) {
            showToast('OAuth authorization successful! You can now use OAuth mode.', 'success');
            // Clean up URL
            window.history.replaceState({}, document.title, window.location.pathname);
        }

        if (urlParams.has('oauth_error')) {
            const error = urlParams.get('oauth_error');
            showToast('OAuth authorization failed: ' + error, 'danger');
            // Clean up URL
            window.history.replaceState({}, document.title, window.location.pathname);
        }

        // Initialize OAuth instructions visibility based on current provider
        toggleOAuthInstructions();
    });
</script>
