<div class="row">
    <!-- API Settings Card -->
    <div class="col-md-12 mb-4">
        <div class="card admin-card">
            <div class="card-header">
                <i class="bi bi-key me-2"></i>API Settings
            </div>
            <div class="card-body">
                <form id="apiSettingsForm">
                    <div class="mb-3">
                        <label for="tmdbApiKey" class="form-label">
                            TMDB API Key
                            <i class="bi bi-info-circle text-muted" title="Required for movie metadata" data-bs-toggle="tooltip"></i>
                        </label>
                        <div class="input-group">
                            <input type="password" class="form-control font-monospace" id="tmdbApiKey"
                                   placeholder="Enter TMDB API key (32 hexadecimal characters)">
                            <button class="btn btn-outline-secondary" type="button" onclick="toggleApiKeyVisibility('tmdbApiKey')">
                                <i class="bi bi-eye"></i>
                            </button>
                        </div>
                        <div class="form-text" id="tmdbKeyStatus">
                            <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                            Loading status...
                        </div>
                    </div>

                    <div class="mb-3">
                        <button type="button" class="btn btn-primary" id="saveApiSettingsBtn" onclick="saveApiSettings()">
                            <i class="bi bi-save me-1"></i>Save API Settings
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="testTmdbConnection()">
                            <i class="bi bi-lightning me-1"></i>Test TMDB Connection
                        </button>
                        <div id="saveHelperText" class="form-text mt-2" style="display: none;">
                            <i class="bi bi-info-circle"></i> <span id="saveHelperMessage"></span>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Application Settings Card -->
    <div class="col-md-12 mb-4">
        <div class="card admin-card">
            <div class="card-header">
                <i class="bi bi-gear me-2"></i>Application Settings
            </div>
            <div class="card-body">
                <form id="appSettingsForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="appName" class="form-label">Application Name</label>
                            <input type="text" class="form-control" id="appName" value="Pathary">
                            <div class="form-text">Displayed in navbar and page titles</div>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="appUrl" class="form-label">Application URL</label>
                            <input type="url" class="form-control" id="appUrl" value="{{ applicationUrl }}" readonly>
                            <div class="form-text">Configure via APPLICATION_URL environment variable</div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="registrationEnabled">
                            <label class="form-check-label" for="registrationEnabled">
                                Enable user registration
                            </label>
                        </div>
                        <div class="form-text">Allow new users to create accounts without admin approval</div>
                    </div>

                    <button type="button" class="btn btn-primary" onclick="saveAppSettings()">
                        <i class="bi bi-save me-1"></i>Save App Settings
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Email Settings Card -->
    <div class="col-md-12 mb-4">
        <div class="card admin-card">
            <div class="card-header">
                <i class="bi bi-envelope me-2"></i>Email Settings (SMTP)
            </div>
            <div class="card-body">
                <p class="text-muted small">
                    Configure SMTP settings for sending emails (password resets, notifications, etc.)
                </p>

                <form id="emailSettingsForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="smtpHost" class="form-label">SMTP Host</label>
                            <input type="text" class="form-control" id="smtpHost" placeholder="smtp.gmail.com"
                                   value="{{ smtpHost ?? '' }}">
                        </div>

                        <div class="col-md-3 mb-3">
                            <label for="smtpPort" class="form-label">Port</label>
                            <input type="number" class="form-control" id="smtpPort"
                                   value="{{ smtpPort ?? 587 }}" placeholder="587">
                        </div>

                        <div class="col-md-3 mb-3">
                            <label for="smtpEncryption" class="form-label">Encryption</label>
                            <select class="form-select" id="smtpEncryption">
                                <option value="tls" {{ smtpEncryption == 'tls' ? 'selected' : '' }}>TLS (STARTTLS)</option>
                                <option value="ssl" {{ smtpEncryption == 'ssl' ? 'selected' : '' }}>SSL</option>
                                <option value="" {{ smtpEncryption == '' ? 'selected' : '' }}>None</option>
                            </select>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="smtpUsername" class="form-label">Username / Email</label>
                            <input type="text" class="form-control" id="smtpUsername" placeholder="your-email@gmail.com"
                                   value="{{ smtpUsername ?? '' }}">
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="smtpPassword" class="form-label">
                                Password / App Password
                                {% if smtpPasswordConfigured %}
                                    <span class="badge bg-success ms-2">
                                        <i class="bi bi-check-circle-fill"></i> Configured
                                    </span>
                                {% endif %}
                            </label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="smtpPassword"
                                       placeholder="{% if smtpPasswordConfigured %}Saved (leave blank to keep current){% else %}Enter password{% endif %}">
                                <button class="btn btn-outline-secondary" type="button" onclick="toggleApiKeyVisibility('smtpPassword')">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </div>
                            <div class="form-text">
                                {% if smtpPasswordConfigured %}
                                    Password is saved. Leave blank to keep current password.
                                {% else %}
                                    Enter your SMTP password or app-specific password
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="smtpFromAddress" class="form-label">From Address</label>
                        <input type="email" class="form-control" id="smtpFromAddress" placeholder="noreply@pathary.local"
                               value="{{ smtpFromAddress ?? '' }}">
                        <div class="form-text">Email address shown as sender</div>
                    </div>

                    <div class="border-top pt-3 mt-3">
                        <button type="button" class="btn btn-primary" onclick="saveEmailSettings()">
                            <i class="bi bi-save me-1"></i>Save Email Settings
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="sendTestEmail()">
                            <i class="bi bi-send me-1"></i>Send Test Email
                        </button>
                        <button type="button" class="btn btn-outline-info" onclick="runSMTPDiagnostics()">
                            <i class="bi bi-tools me-1"></i>Run Diagnostics
                        </button>
                    </div>
                </form>

                <!-- SMTP Diagnostics Results -->
                <div id="smtpDiagnosticsResults" class="mt-4" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="bi bi-tools me-2"></i>SMTP Diagnostics</h5>
                        </div>
                        <div class="card-body" id="diagnosticsContent">
                            <!-- Results will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- OAuth SMTP Placeholder -->
                <div class="alert alert-info mt-4" role="alert">
                    <h6 class="alert-heading"><i class="bi bi-lightbulb me-2"></i>OAuth SMTP Authentication</h6>
                    <p class="mb-0 small">
                        OAuth-based SMTP authentication (Gmail, Outlook) is planned for a future release.
                        For now, use app-specific passwords.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Test Email Modal -->
    <div class="modal fade" id="testEmailModal" tabindex="-1" aria-labelledby="testEmailModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="testEmailModalLabel">
                        <i class="bi bi-send me-2"></i>Send Test Email
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="testEmailRecipient" class="form-label">Recipient Email Address</label>
                        <input type="email" class="form-control" id="testEmailRecipient"
                               placeholder="user@example.com" required>
                        <div class="form-text">Enter the address that should receive the test email.</div>
                        <div id="testEmailRecipientError" class="invalid-feedback" style="display: none;"></div>
                    </div>
                    <div id="testEmailError" class="alert alert-danger" style="display: none;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="sendTestEmailBtn" onclick="sendTestEmailSubmit()" disabled>
                        <i class="bi bi-send me-1"></i>Send Test Email
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- System Health Card -->
    <div class="col-md-12 mb-4">
        <div class="card admin-card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-activity me-2"></i>System Health</span>
                <small class="text-muted" id="health-last-run">Last check: <span id="health-last-run-time">Never</span></small>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <!-- Database Box -->
                    <div class="col-md-6 col-lg-3">
                        <div class="card h-100 health-box" id="health-box-database">
                            <div class="card-body text-center d-flex flex-column">
                                <h6 class="card-title mb-3">Database</h6>
                                <div class="health-icon mb-3">
                                    <i class="bi bi-database text-secondary" style="font-size: 3rem;" id="health-icon-database"></i>
                                </div>
                                <span class="badge bg-secondary mb-2" id="health-badge-database">Unknown</span>
                                <p class="small text-muted mb-2" id="health-message-database">Not checked yet</p>
                                <p class="small text-muted mb-3" id="health-meta-database">
                                    <span id="health-latency-database">-</span> • <span id="health-checked-database">-</span>
                                </p>
                                <div class="mt-auto">
                                    <button class="btn btn-sm btn-outline-primary" id="health-retest-database" onclick="retestDatabase()">
                                        <i class="bi bi-arrow-clockwise"></i> Retest
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- TMDB Box -->
                    <div class="col-md-6 col-lg-3">
                        <div class="card h-100 health-box" id="health-box-tmdb">
                            <div class="card-body text-center d-flex flex-column">
                                <h6 class="card-title mb-3">TMDB API</h6>
                                <div class="health-icon mb-3">
                                    <i class="bi bi-cloud text-secondary" style="font-size: 3rem;" id="health-icon-tmdb"></i>
                                </div>
                                <span class="badge bg-secondary mb-2" id="health-badge-tmdb">Unknown</span>
                                <p class="small text-muted mb-2" id="health-message-tmdb">Not checked yet</p>
                                <p class="small text-muted mb-3" id="health-meta-tmdb">
                                    <span id="health-latency-tmdb">-</span> • <span id="health-checked-tmdb">-</span>
                                </p>
                                <div class="mt-auto">
                                    <button class="btn btn-sm btn-outline-primary me-1" id="health-retest-tmdb" onclick="retestTmdb()">
                                        <i class="bi bi-arrow-clockwise"></i> Retest
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="navigateToSettings('tmdb')">
                                        <i class="bi bi-gear"></i> Settings
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Integration 1 Box (Placeholder) -->
                    <div class="col-md-6 col-lg-3">
                        <div class="card h-100 health-box health-box-disabled" id="health-box-integration1">
                            <div class="card-body text-center d-flex flex-column">
                                <h6 class="card-title mb-3 text-muted">Integration 1</h6>
                                <div class="health-icon mb-3">
                                    <i class="bi bi-puzzle text-muted" style="font-size: 3rem;" id="health-icon-integration1"></i>
                                </div>
                                <span class="badge bg-secondary mb-2" id="health-badge-integration1">Disabled</span>
                                <p class="small text-muted mb-2" id="health-message-integration1">Not enabled</p>
                                <p class="small text-muted mb-3" id="health-meta-integration1">
                                    <span id="health-latency-integration1">-</span> • <span id="health-checked-integration1">-</span>
                                </p>
                                <div class="mt-auto">
                                    <button class="btn btn-sm btn-outline-secondary me-1" id="health-retest-integration1" disabled>
                                        <i class="bi bi-arrow-clockwise"></i> Retest
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="navigateToSettings('integration1')">
                                        <i class="bi bi-gear"></i> Settings
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Integration 2 Box (Placeholder) -->
                    <div class="col-md-6 col-lg-3">
                        <div class="card h-100 health-box health-box-disabled" id="health-box-integration2">
                            <div class="card-body text-center d-flex flex-column">
                                <h6 class="card-title mb-3 text-muted">Integration 2</h6>
                                <div class="health-icon mb-3">
                                    <i class="bi bi-puzzle text-muted" style="font-size: 3rem;" id="health-icon-integration2"></i>
                                </div>
                                <span class="badge bg-secondary mb-2" id="health-badge-integration2">Disabled</span>
                                <p class="small text-muted mb-2" id="health-message-integration2">Not enabled</p>
                                <p class="small text-muted mb-3" id="health-meta-integration2">
                                    <span id="health-latency-integration2">-</span> • <span id="health-checked-integration2">-</span>
                                </p>
                                <div class="mt-auto">
                                    <button class="btn btn-sm btn-outline-secondary me-1" id="health-retest-integration2" disabled>
                                        <i class="bi bi-arrow-clockwise"></i> Retest
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="navigateToSettings('integration2')">
                                        <i class="bi bi-gear"></i> Settings
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-3">
                    <button class="btn btn-primary btn-sm" id="runHealthCheckBtn" onclick="runHealthCheck()">
                        <i class="bi bi-arrow-clockwise me-1"></i>Check All Systems
                    </button>
                </div>

                <div id="health-check-error" class="alert alert-warning mt-3" style="display: none;"></div>
            </div>
        </div>
    </div>
</div>

<style>
    /* TMDB Status Badge Styling */
    #tmdbKeyStatus .badge {
        font-size: 0.875rem;
        padding: 0.35em 0.65em;
    }

    #tmdbKeyStatus .gap-2 > * {
        margin-right: 0.5rem;
    }

    #tmdbKeyStatus .gap-2 > *:last-child {
        margin-right: 0;
    }

    /* Health Box Styling */
    .health-box {
        transition: all 0.3s ease;
        border: 2px solid transparent;
    }

    .health-box:hover:not(.health-box-disabled) {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    .health-box-disabled {
        opacity: 0.6;
    }

    .health-box-disabled .card-body {
        background-color: var(--bs-secondary-bg);
    }

    .health-icon {
        line-height: 1;
    }

    .health-icon i {
        transition: color 0.3s ease;
    }

    /* Dark mode adjustments */
    [data-bs-theme="dark"] .health-box-disabled {
        opacity: 0.5;
    }

    [data-bs-theme="dark"] .health-box {
        border-color: var(--bs-border-color);
    }

    /* Responsive adjustments */
    @media (max-width: 991.98px) {
        .health-box .btn-sm {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }
    }
</style>

<script>
    // Load TMDB status on page load
    document.addEventListener('DOMContentLoaded', async () => {
        await loadTmdbStatus();

        // Track input changes for dirty state
        const tmdbInput = document.getElementById('tmdbApiKey');
        if (tmdbInput) {
            tmdbInput.addEventListener('input', () => {
                tmdbDirty = true;
                updateSaveButtonState();
            });
        }
    });

    async function loadTmdbStatus() {
        try {
            const response = await fetch('{{ applicationUrl }}/api/admin/settings/tmdb', {
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('authToken'),
                },
            });

            if (!response.ok) {
                throw new Error('Failed to load TMDB status');
            }

            const data = await response.json();
            updateTmdbStatus(data.configured, data.updated_at);
        } catch (error) {
            document.getElementById('tmdbKeyStatus').innerHTML =
                '<i class="bi bi-exclamation-circle text-warning"></i> Failed to load status';
        }
    }

    // Track TMDB configuration state
    let tmdbConfigured = false;
    let tmdbDirty = false;

    function updateTmdbStatus(configured, updatedAt) {
        const statusEl = document.getElementById('tmdbKeyStatus');
        tmdbConfigured = configured;
        tmdbDirty = false; // Reset dirty state when status is updated

        if (configured) {
            const timestamp = updatedAt ? new Date(updatedAt.replace(' ', 'T')).toLocaleString() : 'Unknown';
            statusEl.innerHTML = `
                <div class="d-flex align-items-center gap-2 flex-wrap">
                    <span class="badge bg-success">
                        <i class="bi bi-check-circle-fill me-1"></i>Key Configured
                    </span>
                    <span class="text-muted small">Last updated: ${timestamp}</span>
                    <a href="https://www.themoviedb.org/settings/api" target="_blank" rel="noopener" class="small">Get API key</a>
                </div>
            `;
        } else {
            statusEl.innerHTML = `
                <div class="d-flex align-items-center gap-2 flex-wrap">
                    <span class="badge bg-secondary">
                        <i class="bi bi-x-circle me-1"></i>Not Configured
                    </span>
                    <a href="https://www.themoviedb.org/settings/api" target="_blank" rel="noopener" class="small">Get API key</a>
                </div>
            `;
        }

        updateSaveButtonState();
    }

    function updateSaveButtonState() {
        const saveBtn = document.getElementById('saveApiSettingsBtn');
        const helperText = document.getElementById('saveHelperText');
        const helperMessage = document.getElementById('saveHelperMessage');

        if (!saveBtn) return;

        if (tmdbConfigured && !tmdbDirty) {
            // Configured and no changes
            saveBtn.className = 'btn btn-success';
            saveBtn.innerHTML = '<i class="bi bi-check-circle-fill me-1"></i>Saved';
            saveBtn.disabled = true;
            helperText.style.display = 'block';
            helperMessage.textContent = 'No changes to save. Enter a new API key to update.';
        } else if (tmdbDirty) {
            // User has made changes
            saveBtn.className = 'btn btn-primary';
            saveBtn.innerHTML = '<i class="bi bi-save me-1"></i>Save API Settings';
            saveBtn.disabled = false;
            helperText.style.display = 'none';
        } else {
            // Not configured
            saveBtn.className = 'btn btn-primary';
            saveBtn.innerHTML = '<i class="bi bi-save me-1"></i>Save API Settings';
            saveBtn.disabled = false;
            helperText.style.display = 'none';
        }
    }

    function toggleApiKeyVisibility(inputId) {
        const input = document.getElementById(inputId);
        const icon = event.target.closest('button').querySelector('i');

        if (input.type === 'password') {
            input.type = 'text';
            icon.classList.remove('bi-eye');
            icon.classList.add('bi-eye-slash');
        } else {
            input.type = 'password';
            icon.classList.remove('bi-eye-slash');
            icon.classList.add('bi-eye');
        }
    }

    async function saveApiSettings() {
        const tmdbApiKey = document.getElementById('tmdbApiKey').value.trim();

        if (tmdbApiKey === '') {
            showToast('Please enter a TMDB API key', 'warning');
            return;
        }

        // Validate format (32 hexadecimal characters)
        if (!/^[a-f0-9]{32}$/i.test(tmdbApiKey)) {
            showToast('Invalid API key format. Expected 32 hexadecimal characters.', 'danger');
            return;
        }

        try {
            const response = await fetch('{{ applicationUrl }}/api/admin/settings/tmdb', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + localStorage.getItem('authToken'),
                },
                body: JSON.stringify({
                    apiKey: tmdbApiKey,
                }),
            });

            const data = await response.json();

            if (!response.ok) {
                showToast(data.error || 'Failed to save API key', 'danger');
                return;
            }

            showToast(data.message || 'API key saved successfully', 'success');

            // Clear input and update status
            document.getElementById('tmdbApiKey').value = '';
            document.getElementById('tmdbApiKey').type = 'password';
            updateTmdbStatus(true, data.updated_at);

            // Reset dirty state and update button
            tmdbDirty = false;
            updateSaveButtonState();
        } catch (error) {
            showToast('Error saving API key: ' + error.message, 'danger');
        }
    }

    async function testTmdbConnection() {
        const button = event.target.closest('button');
        const originalHtml = button.innerHTML;
        button.disabled = true;
        button.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Testing...';

        try {
            const response = await fetch('{{ applicationUrl }}/api/admin/settings/tmdb/test', {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('authToken'),
                },
            });

            const data = await response.json();

            if (data.success) {
                showToast(`Connection successful! (${data.latency_ms}ms)`, 'success');
            } else {
                showToast(data.message || 'Connection test failed', 'danger');
            }
        } catch (error) {
            showToast('Error testing connection: ' + error.message, 'danger');
        } finally {
            button.disabled = false;
            button.innerHTML = originalHtml;
        }
    }

    async function saveAppSettings() {
        const appName = document.getElementById('appName').value;
        const registrationEnabled = document.getElementById('registrationEnabled').checked;

        try {
            // TODO: Implement app settings save endpoint
            showToast('App settings save feature coming soon', 'info');
        } catch (error) {
            showToast('Error saving app settings: ' + error.message, 'danger');
        }
    }

    async function saveEmailSettings() {
        const password = document.getElementById('smtpPassword').value.trim();

        const settings = {
            smtpHost: document.getElementById('smtpHost').value,
            smtpPort: parseInt(document.getElementById('smtpPort').value),
            smtpEncryption: document.getElementById('smtpEncryption').value,
            smtpUser: document.getElementById('smtpUsername').value,
            smtpFromAddress: document.getElementById('smtpFromAddress').value,
            smtpWithAuthentication: true, // Enable auth when credentials provided
        };

        // Only include password if user entered a new one
        if (password !== '') {
            settings.smtpPassword = password;
        }

        try {
            const response = await fetch('{{ applicationUrl }}/old/settings/server/email', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(settings),
            });

            if (!response.ok) throw new Error('Failed to save email settings');

            showToast('Email settings saved successfully', 'success');

            // Clear password field after save and reload page to show updated status
            document.getElementById('smtpPassword').value = '';

            // Reload page after 1 second to show updated "Configured" status
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } catch (error) {
            showToast('Error saving email settings: ' + error.message, 'danger');
        }
    }

    // Track last used recipient (session only, not persisted)
    let lastTestEmailRecipient = '';

    function sendTestEmail() {
        const fromAddress = document.getElementById('smtpFromAddress').value;

        if (!fromAddress) {
            showToast('Please configure and save email settings first', 'warning');
            return;
        }

        // Reset modal state
        const recipientInput = document.getElementById('testEmailRecipient');
        const errorDiv = document.getElementById('testEmailError');
        const recipientError = document.getElementById('testEmailRecipientError');
        const sendBtn = document.getElementById('sendTestEmailBtn');

        // Clear previous values and errors
        recipientInput.value = '';
        recipientInput.classList.remove('is-invalid');
        errorDiv.style.display = 'none';
        recipientError.style.display = 'none';
        sendBtn.disabled = true;

        // Show the modal
        const modal = new bootstrap.Modal(document.getElementById('testEmailModal'));
        modal.show();
    }

    function validateTestEmailRecipient() {
        const recipientInput = document.getElementById('testEmailRecipient');
        const sendBtn = document.getElementById('sendTestEmailBtn');
        const recipientError = document.getElementById('testEmailRecipientError');
        const email = recipientInput.value.trim();

        // Basic email validation regex
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

        if (email === '') {
            sendBtn.disabled = true;
            recipientInput.classList.remove('is-invalid');
            recipientError.style.display = 'none';
            return false;
        }

        if (!emailRegex.test(email) || email.length > 255) {
            sendBtn.disabled = true;
            recipientInput.classList.add('is-invalid');
            recipientError.textContent = 'Please enter a valid email address';
            recipientError.style.display = 'block';
            return false;
        }

        sendBtn.disabled = false;
        recipientInput.classList.remove('is-invalid');
        recipientError.style.display = 'none';
        return true;
    }

    async function sendTestEmailSubmit() {
        const recipientInput = document.getElementById('testEmailRecipient');
        const errorDiv = document.getElementById('testEmailError');
        const sendBtn = document.getElementById('sendTestEmailBtn');
        const originalHtml = sendBtn.innerHTML;

        if (!validateTestEmailRecipient()) {
            return;
        }

        const recipient = recipientInput.value.trim();
        const settings = {
            smtpHost: document.getElementById('smtpHost').value,
            smtpPort: parseInt(document.getElementById('smtpPort').value),
            smtpFromAddress: document.getElementById('smtpFromAddress').value,
            smtpEncryption: document.getElementById('smtpEncryption').value,
            smtpWithAuthentication: true,
            smtpUser: document.getElementById('smtpUsername').value,
            smtpPassword: document.getElementById('smtpPassword').value,
            recipient: recipient,
        };

        // Show loading state
        sendBtn.disabled = true;
        sendBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Sending...';
        errorDiv.style.display = 'none';

        try {
            const response = await fetch('{{ applicationUrl }}/old/settings/server/email-test', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(settings),
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(errorText || 'Failed to send test email');
            }

            // Success - remember recipient for this session
            lastTestEmailRecipient = recipient;

            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('testEmailModal'));
            modal.hide();

            showToast(`Test email sent successfully to ${recipient}`, 'success');
        } catch (error) {
            // Show error in modal so user can correct recipient
            errorDiv.textContent = error.message;
            errorDiv.style.display = 'block';
        } finally {
            sendBtn.disabled = false;
            sendBtn.innerHTML = originalHtml;
        }
    }

    async function runSMTPDiagnostics() {
        const settings = {
            smtpHost: document.getElementById('smtpHost').value,
            smtpPort: parseInt(document.getElementById('smtpPort').value),
            smtpEncryption: document.getElementById('smtpEncryption').value,
        };

        const resultsDiv = document.getElementById('smtpDiagnosticsResults');
        const contentDiv = document.getElementById('diagnosticsContent');

        // Show loading state
        resultsDiv.style.display = 'block';
        contentDiv.innerHTML = `
            <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Running diagnostics...</span>
                </div>
                <p class="mt-2">Running SMTP diagnostics...</p>
            </div>
        `;

        try {
            const response = await fetch('{{ applicationUrl }}/old/settings/server/email-diagnose', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(settings),
            });

            if (!response.ok) {
                throw new Error('Failed to run diagnostics');
            }

            const results = await response.json();
            displayDiagnosticsResults(results);
        } catch (error) {
            contentDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    Error running diagnostics: ${error.message}
                </div>
            `;
        }
    }

    function displayDiagnosticsResults(results) {
        const contentDiv = document.getElementById('diagnosticsContent');
        const tests = results.tests || {};

        let html = `
            <div class="mb-3">
                <strong>Configuration:</strong>
                <span class="ms-2">Host: ${results.host}</span>
                <span class="ms-2">Port: ${results.port}</span>
                <span class="ms-2">Encryption: ${results.encryption || 'None'}</span>
            </div>
            <div class="mb-3">
                <strong>Overall Status:</strong>
                <span class="badge ${results.overall_status === 'passed' ? 'bg-success' : 'bg-danger'} ms-2">
                    ${results.overall_status === 'passed' ? 'PASSED' : 'FAILED'}
                </span>
            </div>
            <hr>
            <h6>Diagnostic Tests:</h6>
        `;

        const getStatusBadge = (status) => {
            if (status === 'success') return '<span class="badge bg-success">✓ PASS</span>';
            if (status === 'warning') return '<span class="badge bg-warning">⚠ WARNING</span>';
            return '<span class="badge bg-danger">✗ FAIL</span>';
        };

        for (const [testName, testResult] of Object.entries(tests)) {
            const testLabel = testName.replace(/_/g, ' ').toUpperCase();
            html += `
                <div class="card mb-2">
                    <div class="card-body py-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${testLabel}</strong>
                                <div class="small text-muted">${testResult.message}</div>
                                ${testResult.hint ? `<div class="small text-info mt-1"><i class="bi bi-lightbulb"></i> ${testResult.hint}</div>` : ''}
                            </div>
                            <div class="text-end">
                                ${getStatusBadge(testResult.status)}
                                ${testResult.latency_ms ? `<div class="small text-muted">${testResult.latency_ms}ms</div>` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        html += `
            <div class="mt-3">
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="document.getElementById('smtpDiagnosticsResults').style.display='none'">
                    <i class="bi bi-x-circle me-1"></i>Close
                </button>
            </div>
        `;

        contentDiv.innerHTML = html;
    }

    // Add event listener for recipient input validation
    document.addEventListener('DOMContentLoaded', () => {
        const recipientInput = document.getElementById('testEmailRecipient');
        if (recipientInput) {
            recipientInput.addEventListener('input', validateTestEmailRecipient);
            recipientInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !document.getElementById('sendTestEmailBtn').disabled) {
                    sendTestEmailSubmit();
                }
            });
        }
    });

    // Health Check Functions
    document.addEventListener('DOMContentLoaded', async () => {
        // Try to load cached status first
        const cachedData = await loadHealthStatus();

        // If no cached data or cache is old, run a fresh check
        if (!cachedData || cachedData.overall.status === 'unknown') {
            await runHealthCheck(true); // Silent mode - no toast
        }
    });

    async function loadHealthStatus() {
        try {
            const response = await fetch('{{ applicationUrl }}/admin/health');
            if (!response.ok) {
                throw new Error('Failed to load health status');
            }

            const data = await response.json();
            updateHealthDisplay(data);
            return data;
        } catch (error) {
            console.error('Error loading health status:', error);
            return null;
        }
    }

    async function runHealthCheck(silent = false) {
        const button = document.getElementById('runHealthCheckBtn');
        const originalHtml = button?.innerHTML;

        if (button) {
            button.disabled = true;
            button.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Checking...';
        }

        // Hide any previous error
        const errorDiv = document.getElementById('health-check-error');
        if (errorDiv) {
            errorDiv.style.display = 'none';
        }

        try {
            const response = await fetch('{{ applicationUrl }}/admin/health/run', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    csrf: getCsrfToken(),
                }),
            });

            const data = await response.json();

            if (data.error) {
                // Rate limit or other error
                if (errorDiv) {
                    errorDiv.textContent = data.error;
                    errorDiv.style.display = 'block';
                }
            } else {
                updateHealthDisplay(data);
                updateLastRunTime();

                if (!silent) {
                    showToast('Health check completed', 'success');
                }

                // Store health status globally for notifications
                window.healthStatus = data;
            }
        } catch (error) {
            if (!silent) {
                showToast('Error running health check: ' + error.message, 'danger');
            }
        } finally {
            if (button) {
                button.disabled = false;
                button.innerHTML = originalHtml;
            }
        }
    }

    function updateLastRunTime() {
        const timeEl = document.getElementById('health-last-run-time');
        if (timeEl) {
            timeEl.textContent = new Date().toLocaleString();
        }
    }

    async function retestDatabase() {
        const button = document.getElementById('health-retest-database');
        const originalHtml = button?.innerHTML;

        if (button) {
            button.disabled = true;
            button.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
        }

        try {
            const response = await fetch('{{ applicationUrl }}/admin/health/db', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    csrf: getCsrfToken(),
                }),
            });

            const data = await response.json();

            if (data.database) {
                updateServiceStatus('database', data.database);
                updateLastRunTime();
                showToast('Database check completed', 'success');
            }
        } catch (error) {
            showToast('Error checking database: ' + error.message, 'danger');
        } finally {
            if (button) {
                button.disabled = false;
                button.innerHTML = originalHtml;
            }
        }
    }

    async function retestTmdb() {
        const button = document.getElementById('health-retest-tmdb');
        const originalHtml = button?.innerHTML;

        if (button) {
            button.disabled = true;
            button.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
        }

        try {
            const response = await fetch('{{ applicationUrl }}/admin/health/tmdb', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    csrf: getCsrfToken(),
                }),
            });

            const data = await response.json();

            if (data.tmdb) {
                updateServiceStatus('tmdb', data.tmdb);
                updateLastRunTime();
                showToast('TMDB check completed', 'success');
            }
        } catch (error) {
            showToast('Error checking TMDB: ' + error.message, 'danger');
        } finally {
            if (button) {
                button.disabled = false;
                button.innerHTML = originalHtml;
            }
        }
    }

    function navigateToSettings(module) {
        switch (module) {
            case 'database':
                // Scroll to application settings (placeholder)
                showToast('Database settings section coming soon', 'info');
                break;
            case 'tmdb':
                // Scroll to TMDB API settings section
                const tmdbSection = document.querySelector('.card-header:has(.bi-key)');
                if (tmdbSection) {
                    tmdbSection.parentElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
                break;
            case 'integration1':
            case 'integration2':
                showToast('Integration settings coming soon', 'info');
                break;
        }
    }

    function updateHealthDisplay(data) {
        // Update all modules
        if (data.database) {
            updateServiceStatus('database', data.database);
        }
        if (data.tmdb) {
            updateServiceStatus('tmdb', data.tmdb);
        }
        if (data.integration1) {
            updateServiceStatus('integration1', data.integration1);
        }
        if (data.integration2) {
            updateServiceStatus('integration2', data.integration2);
        }
    }

    function updateServiceStatus(service, status) {
        const box = document.getElementById(`health-box-${service}`);
        const icon = document.getElementById(`health-icon-${service}`);
        const badge = document.getElementById(`health-badge-${service}`);
        const messageEl = document.getElementById(`health-message-${service}`);
        const latencyEl = document.getElementById(`health-latency-${service}`);
        const checkedEl = document.getElementById(`health-checked-${service}`);
        const retestBtn = document.getElementById(`health-retest-${service}`);

        // Handle disabled state
        if (status.enabled === false) {
            box?.classList.add('health-box-disabled');
            icon?.classList.remove('text-success', 'text-warning', 'text-danger', 'text-secondary');
            icon?.classList.add('text-muted');
            badge.textContent = 'Disabled';
            badge.className = 'badge bg-secondary mb-2';
            messageEl.textContent = 'Not enabled';
            latencyEl.textContent = '-';
            checkedEl.textContent = '-';
            if (retestBtn) {
                retestBtn.disabled = true;
            }
            return;
        }

        // Remove disabled state if enabled
        box?.classList.remove('health-box-disabled');
        if (retestBtn) {
            retestBtn.disabled = false;
        }

        // Update icon color based on status
        icon?.classList.remove('text-success', 'text-warning', 'text-danger', 'text-secondary', 'text-muted');
        switch (status.status) {
            case 'healthy':
                icon?.classList.add('text-success');
                badge.className = 'badge bg-success mb-2';
                badge.textContent = 'Healthy';
                break;
            case 'degraded':
                icon?.classList.add('text-warning');
                badge.className = 'badge bg-warning mb-2';
                badge.textContent = 'Degraded';
                break;
            case 'down':
                icon?.classList.add('text-danger');
                badge.className = 'badge bg-danger mb-2';
                badge.textContent = 'Down';
                break;
            default:
                icon?.classList.add('text-secondary');
                badge.className = 'badge bg-secondary mb-2';
                badge.textContent = 'Unknown';
        }

        // Update message
        messageEl.textContent = status.message || 'No message';

        // Update latency
        if (status.latency_ms !== undefined && status.latency_ms > 0) {
            latencyEl.textContent = status.latency_ms + 'ms';
        } else {
            latencyEl.textContent = '-';
        }

        // Update checked timestamp
        if (status.checked_at) {
            const timestamp = new Date(status.checked_at.replace(' ', 'T')).toLocaleTimeString();
            checkedEl.textContent = timestamp;
        } else {
            checkedEl.textContent = '-';
        }
    }
</script>
