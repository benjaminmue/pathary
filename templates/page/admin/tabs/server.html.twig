<div class="row">
    <!-- API Settings Card -->
    <div class="col-md-12 mb-4">
        <div class="card admin-card">
            <div class="card-header">
                <i class="bi bi-key me-2"></i>API Settings
            </div>
            <div class="card-body">
                <form id="apiSettingsForm">
                    <div class="mb-3">
                        <label for="tmdbApiKey" class="form-label">
                            TMDB API Key
                            <i class="bi bi-info-circle text-muted" title="Required for movie metadata" data-bs-toggle="tooltip"></i>
                        </label>
                        <div class="input-group">
                            <input type="password" class="form-control font-monospace" id="tmdbApiKey"
                                   placeholder="Enter TMDB API key (32 hexadecimal characters)">
                            <button class="btn btn-outline-secondary" type="button" onclick="toggleApiKeyVisibility('tmdbApiKey')">
                                <i class="bi bi-eye"></i>
                            </button>
                        </div>
                        <div class="form-text" id="tmdbKeyStatus">
                            <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                            Loading status...
                        </div>
                    </div>

                    <div class="mb-3">
                        <button type="button" class="btn btn-primary" onclick="saveApiSettings()">
                            <i class="bi bi-save me-1"></i>Save API Settings
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="testTmdbConnection()">
                            <i class="bi bi-lightning me-1"></i>Test TMDB Connection
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Application Settings Card -->
    <div class="col-md-12 mb-4">
        <div class="card admin-card">
            <div class="card-header">
                <i class="bi bi-gear me-2"></i>Application Settings
            </div>
            <div class="card-body">
                <form id="appSettingsForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="appName" class="form-label">Application Name</label>
                            <input type="text" class="form-control" id="appName" value="Pathary">
                            <div class="form-text">Displayed in navbar and page titles</div>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="appUrl" class="form-label">Application URL</label>
                            <input type="url" class="form-control" id="appUrl" value="{{ applicationUrl }}" readonly>
                            <div class="form-text">Configure via APPLICATION_URL environment variable</div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="registrationEnabled">
                            <label class="form-check-label" for="registrationEnabled">
                                Enable user registration
                            </label>
                        </div>
                        <div class="form-text">Allow new users to create accounts without admin approval</div>
                    </div>

                    <button type="button" class="btn btn-primary" onclick="saveAppSettings()">
                        <i class="bi bi-save me-1"></i>Save App Settings
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Email Settings Card -->
    <div class="col-md-12 mb-4">
        <div class="card admin-card">
            <div class="card-header">
                <i class="bi bi-envelope me-2"></i>Email Settings (SMTP)
            </div>
            <div class="card-body">
                <p class="text-muted small">
                    Configure SMTP settings for sending emails (password resets, notifications, etc.)
                </p>

                <form id="emailSettingsForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="smtpHost" class="form-label">SMTP Host</label>
                            <input type="text" class="form-control" id="smtpHost" placeholder="smtp.gmail.com">
                        </div>

                        <div class="col-md-3 mb-3">
                            <label for="smtpPort" class="form-label">Port</label>
                            <input type="number" class="form-control" id="smtpPort" value="587">
                        </div>

                        <div class="col-md-3 mb-3">
                            <label for="smtpEncryption" class="form-label">Encryption</label>
                            <select class="form-select" id="smtpEncryption">
                                <option value="tls">TLS</option>
                                <option value="ssl">SSL</option>
                                <option value="none">None</option>
                            </select>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="smtpUsername" class="form-label">Username / Email</label>
                            <input type="text" class="form-control" id="smtpUsername" placeholder="your-email@gmail.com">
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="smtpPassword" class="form-label">Password / App Password</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="smtpPassword" placeholder="•••••••••••">
                                <button class="btn btn-outline-secondary" type="button" onclick="toggleApiKeyVisibility('smtpPassword')">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="smtpFromAddress" class="form-label">From Address</label>
                        <input type="email" class="form-control" id="smtpFromAddress" placeholder="noreply@pathary.local">
                        <div class="form-text">Email address shown as sender</div>
                    </div>

                    <div class="border-top pt-3 mt-3">
                        <button type="button" class="btn btn-primary" onclick="saveEmailSettings()">
                            <i class="bi bi-save me-1"></i>Save Email Settings
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="sendTestEmail()">
                            <i class="bi bi-send me-1"></i>Send Test Email
                        </button>
                    </div>
                </form>

                <!-- OAuth SMTP Placeholder -->
                <div class="alert alert-info mt-4" role="alert">
                    <h6 class="alert-heading"><i class="bi bi-lightbulb me-2"></i>OAuth SMTP Authentication</h6>
                    <p class="mb-0 small">
                        OAuth-based SMTP authentication (Gmail, Outlook) is planned for a future release.
                        For now, use app-specific passwords.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- System Health Card -->
    <div class="col-md-12 mb-4">
        <div class="card admin-card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-activity me-2"></i>System Health</span>
                <small class="text-muted" id="health-last-run">Last check: <span id="health-last-run-time">Never</span></small>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th style="width: 200px;">Service</th>
                                <th style="width: 120px;">Status</th>
                                <th>Message</th>
                                <th style="width: 100px;">Latency</th>
                                <th style="width: 180px;">Last Checked</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr id="health-db-row">
                                <td><i class="bi bi-database me-2"></i>Database</td>
                                <td><span id="health-db-status" class="badge bg-secondary">Unknown</span></td>
                                <td id="health-db-message">Not checked yet</td>
                                <td id="health-db-latency">-</td>
                                <td id="health-db-checked">-</td>
                            </tr>
                            <tr id="health-tmdb-row">
                                <td><i class="bi bi-cloud me-2"></i>TMDB API</td>
                                <td><span id="health-tmdb-status" class="badge bg-secondary">Unknown</span></td>
                                <td id="health-tmdb-message">Not checked yet</td>
                                <td id="health-tmdb-latency">-</td>
                                <td id="health-tmdb-checked">-</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="mt-3">
                    <button class="btn btn-primary btn-sm" id="runHealthCheckBtn" onclick="runHealthCheck()">
                        <i class="bi bi-arrow-clockwise me-1"></i>Run Health Check
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="runDatabaseCheck()">
                        <i class="bi bi-database me-1"></i>Check Database
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="runTmdbCheck()">
                        <i class="bi bi-cloud me-1"></i>Check TMDB API
                    </button>
                </div>

                <div id="health-check-error" class="alert alert-warning mt-3" style="display: none;"></div>
            </div>
        </div>
    </div>
</div>

<script>
    // Load TMDB status on page load
    document.addEventListener('DOMContentLoaded', async () => {
        await loadTmdbStatus();
    });

    async function loadTmdbStatus() {
        try {
            const response = await fetch('{{ applicationUrl }}/api/admin/settings/tmdb', {
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('authToken'),
                },
            });

            if (!response.ok) {
                throw new Error('Failed to load TMDB status');
            }

            const data = await response.json();
            updateTmdbStatus(data.configured, data.updated_at);
        } catch (error) {
            document.getElementById('tmdbKeyStatus').innerHTML =
                '<i class="bi bi-exclamation-circle text-warning"></i> Failed to load status';
        }
    }

    function updateTmdbStatus(configured, updatedAt) {
        const statusEl = document.getElementById('tmdbKeyStatus');

        if (configured) {
            const timestamp = updatedAt ? new Date(updatedAt.replace(' ', 'T')).toLocaleString() : 'Unknown';
            statusEl.innerHTML = `
                <i class="bi bi-check-circle text-success"></i> Key is configured
                • Last updated: ${timestamp}
                • <a href="https://www.themoviedb.org/settings/api" target="_blank" rel="noopener">Get API key</a>
            `;
        } else {
            statusEl.innerHTML = `
                <i class="bi bi-x-circle text-muted"></i> Key not configured
                • <a href="https://www.themoviedb.org/settings/api" target="_blank" rel="noopener">Get API key</a>
            `;
        }
    }

    function toggleApiKeyVisibility(inputId) {
        const input = document.getElementById(inputId);
        const icon = event.target.closest('button').querySelector('i');

        if (input.type === 'password') {
            input.type = 'text';
            icon.classList.remove('bi-eye');
            icon.classList.add('bi-eye-slash');
        } else {
            input.type = 'password';
            icon.classList.remove('bi-eye-slash');
            icon.classList.add('bi-eye');
        }
    }

    async function saveApiSettings() {
        const tmdbApiKey = document.getElementById('tmdbApiKey').value.trim();

        if (tmdbApiKey === '') {
            showToast('Please enter a TMDB API key', 'warning');
            return;
        }

        // Validate format (32 hexadecimal characters)
        if (!/^[a-f0-9]{32}$/i.test(tmdbApiKey)) {
            showToast('Invalid API key format. Expected 32 hexadecimal characters.', 'danger');
            return;
        }

        try {
            const response = await fetch('{{ applicationUrl }}/api/admin/settings/tmdb', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + localStorage.getItem('authToken'),
                },
                body: JSON.stringify({
                    apiKey: tmdbApiKey,
                }),
            });

            const data = await response.json();

            if (!response.ok) {
                showToast(data.error || 'Failed to save API key', 'danger');
                return;
            }

            showToast(data.message || 'API key saved successfully', 'success');

            // Clear input and update status
            document.getElementById('tmdbApiKey').value = '';
            document.getElementById('tmdbApiKey').type = 'password';
            updateTmdbStatus(true, data.updated_at);
        } catch (error) {
            showToast('Error saving API key: ' + error.message, 'danger');
        }
    }

    async function testTmdbConnection() {
        const button = event.target.closest('button');
        const originalHtml = button.innerHTML;
        button.disabled = true;
        button.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Testing...';

        try {
            const response = await fetch('{{ applicationUrl }}/api/admin/settings/tmdb/test', {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('authToken'),
                },
            });

            const data = await response.json();

            if (data.success) {
                showToast(`Connection successful! (${data.latency_ms}ms)`, 'success');
            } else {
                showToast(data.message || 'Connection test failed', 'danger');
            }
        } catch (error) {
            showToast('Error testing connection: ' + error.message, 'danger');
        } finally {
            button.disabled = false;
            button.innerHTML = originalHtml;
        }
    }

    async function saveAppSettings() {
        const appName = document.getElementById('appName').value;
        const registrationEnabled = document.getElementById('registrationEnabled').checked;

        try {
            // TODO: Implement app settings save endpoint
            showToast('App settings save feature coming soon', 'info');
        } catch (error) {
            showToast('Error saving app settings: ' + error.message, 'danger');
        }
    }

    async function saveEmailSettings() {
        const settings = {
            host: document.getElementById('smtpHost').value,
            port: document.getElementById('smtpPort').value,
            encryption: document.getElementById('smtpEncryption').value,
            username: document.getElementById('smtpUsername').value,
            password: document.getElementById('smtpPassword').value,
            fromAddress: document.getElementById('smtpFromAddress').value,
        };

        try {
            const response = await fetch('{{ applicationUrl }}/old/settings/server/email', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(settings),
            });

            if (!response.ok) throw new Error('Failed to save email settings');

            showToast('Email settings saved successfully', 'success');
        } catch (error) {
            showToast('Error saving email settings: ' + error.message, 'danger');
        }
    }

    async function sendTestEmail() {
        const fromAddress = document.getElementById('smtpFromAddress').value;

        if (!fromAddress) {
            showToast('Please configure and save email settings first', 'warning');
            return;
        }

        showConfirmModal(
            `Send a test email to ${fromAddress}?`,
            async () => {
                try {
                    const response = await fetch('{{ applicationUrl }}/old/settings/server/email-test', {
                        method: 'POST',
                    });

                    if (!response.ok) throw new Error('Failed to send test email');

                    showToast('Test email sent successfully', 'success');
                } catch (error) {
                    showToast('Error sending test email: ' + error.message, 'danger');
                }
            }
        );
    }

    // Health Check Functions
    document.addEventListener('DOMContentLoaded', async () => {
        // Try to load cached status first
        const cachedData = await loadHealthStatus();

        // If no cached data or cache is old, run a fresh check
        if (!cachedData || cachedData.overall.status === 'unknown') {
            await runHealthCheck(true); // Silent mode - no toast
        }
    });

    async function loadHealthStatus() {
        try {
            const response = await fetch('{{ applicationUrl }}/admin/health');
            if (!response.ok) {
                throw new Error('Failed to load health status');
            }

            const data = await response.json();
            updateHealthDisplay(data);
            return data;
        } catch (error) {
            console.error('Error loading health status:', error);
            return null;
        }
    }

    async function runHealthCheck(silent = false) {
        const button = document.getElementById('runHealthCheckBtn');
        const originalHtml = button?.innerHTML;

        if (button) {
            button.disabled = true;
            button.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Checking...';
        }

        // Hide any previous error
        const errorDiv = document.getElementById('health-check-error');
        if (errorDiv) {
            errorDiv.style.display = 'none';
        }

        try {
            const response = await fetch('{{ applicationUrl }}/admin/health/run', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    csrf: getCsrfToken(),
                }),
            });

            const data = await response.json();

            if (data.error) {
                // Rate limit or other error
                if (errorDiv) {
                    errorDiv.textContent = data.error;
                    errorDiv.style.display = 'block';
                }
            } else {
                updateHealthDisplay(data);
                updateLastRunTime();

                if (!silent) {
                    showToast('Health check completed', 'success');
                }

                // Store health status globally for notifications
                window.healthStatus = data;
            }
        } catch (error) {
            if (!silent) {
                showToast('Error running health check: ' + error.message, 'danger');
            }
        } finally {
            if (button) {
                button.disabled = false;
                button.innerHTML = originalHtml;
            }
        }
    }

    function updateLastRunTime() {
        const timeEl = document.getElementById('health-last-run-time');
        if (timeEl) {
            timeEl.textContent = new Date().toLocaleString();
        }
    }

    async function runDatabaseCheck() {
        // For now, just run the full health check
        // Can be extended to run individual checks if endpoints are added
        await runHealthCheck();
    }

    async function runTmdbCheck() {
        // For now, just run the full health check
        // Can be extended to run individual checks if endpoints are added
        await runHealthCheck();
    }

    function updateHealthDisplay(data) {
        // Update Database status
        if (data.database) {
            updateServiceStatus('db', data.database);
        }

        // Update TMDB status
        if (data.tmdb) {
            updateServiceStatus('tmdb', data.tmdb);
        }
    }

    function updateServiceStatus(service, status) {
        const statusBadge = document.getElementById(`health-${service}-status`);
        const messageEl = document.getElementById(`health-${service}-message`);
        const latencyEl = document.getElementById(`health-${service}-latency`);
        const checkedEl = document.getElementById(`health-${service}-checked`);

        // Update status badge with color
        statusBadge.textContent = status.status.charAt(0).toUpperCase() + status.status.slice(1);
        statusBadge.className = 'badge';

        switch (status.status) {
            case 'healthy':
                statusBadge.classList.add('bg-success');
                break;
            case 'degraded':
                statusBadge.classList.add('bg-warning');
                break;
            case 'down':
                statusBadge.classList.add('bg-danger');
                break;
            default:
                statusBadge.classList.add('bg-secondary');
        }

        // Update message
        messageEl.textContent = status.message || 'No message';

        // Update latency
        if (status.latency_ms !== undefined && status.latency_ms > 0) {
            latencyEl.textContent = status.latency_ms + 'ms';
        } else {
            latencyEl.textContent = '-';
        }

        // Update checked timestamp
        if (status.checked_at) {
            const timestamp = new Date(status.checked_at.replace(' ', 'T')).toLocaleString();
            checkedEl.textContent = timestamp;
        } else {
            checkedEl.textContent = '-';
        }
    }
</script>
