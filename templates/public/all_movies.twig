{% extends 'layouts/app_base.twig' %}

{% block title %}All Movies{% endblock %}

{% block stylesheets %}
<style>
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
        padding: 1.5rem 0;
        border-bottom: 1px solid var(--bs-border-color);
        margin-bottom: 1.5rem;
    }

    .page-title {
        font-size: 1.75rem;
        font-weight: 700;
        margin: 0;
    }

    .page-subtitle {
        color: var(--bs-secondary-color);
        font-size: 0.9rem;
        margin-top: 0.25rem;
    }

    .controls {
        display: flex;
        gap: 0.75rem;
        align-items: center;
    }

    .sort-select {
        min-width: 160px;
    }

    .btn-filter-toggle {
        display: none;
    }

    /* Desktop filters sidebar */
    .content-wrapper {
        display: grid;
        grid-template-columns: 260px 1fr;
        gap: 2rem;
    }

    .filters-sidebar {
        position: sticky;
        top: 1rem;
        height: fit-content;
    }

    .filters-card {
        background: var(--bs-tertiary-bg);
        border-radius: 12px;
        padding: 1.25rem;
    }

    .filters-title {
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .filter-group {
        margin-bottom: 1.25rem;
    }

    .filter-group:last-child {
        margin-bottom: 0;
    }

    .filter-label {
        font-size: 0.85rem;
        font-weight: 500;
        margin-bottom: 0.5rem;
        color: var(--bs-body-color);
    }

    .filter-select,
    .filter-input {
        width: 100%;
        padding: 0.5rem 0.75rem;
        border: 1px solid var(--bs-border-color);
        border-radius: 6px;
        background: var(--bs-body-bg);
        color: var(--bs-body-color);
        font-size: 0.9rem;
    }

    .filter-select:focus,
    .filter-input:focus {
        outline: none;
        border-color: var(--accent-purple);
        box-shadow: 0 0 0 3px rgba(111, 45, 189, 0.1);
    }

    .filter-range {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }

    .filter-range input {
        flex: 1;
        min-width: 0;
    }

    .filter-range-separator {
        color: var(--bs-secondary-color);
    }

    .filter-actions {
        display: flex;
        gap: 0.5rem;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid var(--bs-border-color);
    }

    .btn-apply-filters {
        flex: 1;
        background: var(--pathe-yellow);
        border-color: var(--pathe-yellow);
        color: var(--pathe-dark);
        font-weight: 600;
    }

    .btn-apply-filters:hover {
        background: #e0a808;
        border-color: #e0a808;
        color: var(--pathe-dark);
    }

    .btn-clear-filters {
        background: transparent;
        border: 1px solid var(--bs-border-color);
        color: var(--bs-secondary-color);
    }

    .btn-clear-filters:hover {
        background: var(--bs-tertiary-bg);
        color: var(--bs-body-color);
    }

    /* Rating filter info text */
    .filter-info {
        font-size: 0.75rem;
        color: var(--bs-secondary-color);
        margin-top: 0.25rem;
    }

    /* Movie grid */
    .movie-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
        gap: 1.5rem;
    }

    .movie-card {
        background: var(--bs-body-bg);
        border: 1px solid var(--bs-border-color);
        border-radius: 8px;
        overflow: hidden;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        text-decoration: none;
        color: inherit;
        display: block;
    }

    .movie-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    }

    .movie-poster {
        width: 100%;
        aspect-ratio: 2/3;
        object-fit: cover;
    }

    .movie-poster-placeholder {
        width: 100%;
        aspect-ratio: 2/3;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, var(--pathe-dark) 0%, #3a3a3a 100%);
        color: #888;
        font-size: 0.75rem;
        text-align: center;
        padding: 1rem;
    }

    .movie-info {
        padding: 0.75rem;
    }

    .movie-title {
        font-size: 0.9rem;
        font-weight: 500;
        margin-bottom: 0.25rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .movie-meta-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 0.5rem;
    }

    .movie-year {
        font-size: 0.8rem;
        color: var(--bs-secondary-color);
    }

    .movie-rating {
        display: flex;
        align-items: center;
        gap: 0.25rem;
        font-size: 0.8rem;
        color: var(--pathe-yellow);
    }

    .movie-rating .popcorn-mini {
        width: 14px;
        height: 14px;
        fill: var(--pathe-yellow);
    }

    .no-movies {
        text-align: center;
        padding: 3rem 2rem;
        color: var(--bs-secondary-color);
        grid-column: 1 / -1;
    }

    .active-filters {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }

    .active-filter-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
        background: rgba(111, 45, 189, 0.1);
        border: 1px solid rgba(111, 45, 189, 0.3);
        color: var(--accent-purple);
        padding: 0.25rem 0.75rem;
        border-radius: 1rem;
        font-size: 0.8rem;
    }

    /* Mobile responsive */
    @media (max-width: 991px) {
        .btn-filter-toggle {
            display: inline-flex;
        }

        .content-wrapper {
            grid-template-columns: 1fr;
        }

        .filters-sidebar {
            display: none;
        }

        .movie-grid {
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 1rem;
        }
    }

    @media (max-width: 576px) {
        .page-header {
            flex-direction: column;
            align-items: flex-start;
        }

        .controls {
            width: 100%;
            flex-wrap: wrap;
        }

        .sort-select {
            flex: 1;
            min-width: 120px;
        }

        .movie-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
        }
    }

    /* Offcanvas filters styling */
    .offcanvas-filters .offcanvas-header {
        border-bottom: 1px solid var(--bs-border-color);
    }

    .offcanvas-filters .offcanvas-body {
        padding: 1.25rem;
    }
</style>
{% endblock %}

{% block body %}
<div class="container">
    <header class="page-header">
        <div>
            <h1 class="page-title">All Movies</h1>
            <p class="page-subtitle">{{ totalMovies }} movie{{ totalMovies != 1 ? 's' : '' }} in library</p>
        </div>

        <div class="controls">
            <button class="btn btn-outline-secondary btn-filter-toggle" type="button" data-bs-toggle="offcanvas" data-bs-target="#filtersOffcanvas">
                <i class="bi bi-funnel"></i> Filters
            </button>

            <select class="form-select sort-select" id="sortSelect" onchange="updateSort(this.value)">
                <option value="added-desc" {{ currentSort == 'added' and currentOrder == 'desc' ? 'selected' : '' }}>Recently Added</option>
                <option value="added-asc" {{ currentSort == 'added' and currentOrder == 'asc' ? 'selected' : '' }}>Oldest Added</option>
                <option value="title-asc" {{ currentSort == 'title' and currentOrder == 'asc' ? 'selected' : '' }}>Title A-Z</option>
                <option value="title-desc" {{ currentSort == 'title' and currentOrder == 'desc' ? 'selected' : '' }}>Title Z-A</option>
                <option value="release_date-desc" {{ currentSort == 'release_date' and currentOrder == 'desc' ? 'selected' : '' }}>Newest Release</option>
                <option value="release_date-asc" {{ currentSort == 'release_date' and currentOrder == 'asc' ? 'selected' : '' }}>Oldest Release</option>
                <option value="global_rating-desc" {{ currentSort == 'global_rating' and currentOrder == 'desc' ? 'selected' : '' }}>Highest Rated</option>
                <option value="global_rating-asc" {{ currentSort == 'global_rating' and currentOrder == 'asc' ? 'selected' : '' }}>Lowest Rated</option>
                <option value="own_rating-desc" {{ currentSort == 'own_rating' and currentOrder == 'desc' ? 'selected' : '' }}>My Rating (High)</option>
                <option value="own_rating-asc" {{ currentSort == 'own_rating' and currentOrder == 'asc' ? 'selected' : '' }}>My Rating (Low)</option>
            </select>
        </div>
    </header>

    {% if currentGenre or currentRatingMin or currentRatingMax or currentYearMin or currentYearMax %}
        <div class="active-filters">
            {% if currentGenre %}
                <span class="active-filter-badge">
                    <i class="bi bi-tag"></i> {{ currentGenre }}
                </span>
            {% endif %}
            {% if currentRatingMin or currentRatingMax %}
                <span class="active-filter-badge">
                    <i class="bi bi-star"></i> Rating: {{ currentRatingMin ?? 1 }} - {{ currentRatingMax ?? 7 }}
                </span>
            {% endif %}
            {% if currentYearMin or currentYearMax %}
                <span class="active-filter-badge">
                    <i class="bi bi-calendar"></i> Year: {{ currentYearMin ?? yearRange.min }} - {{ currentYearMax ?? yearRange.max }}
                </span>
            {% endif %}
        </div>
    {% endif %}

    <div class="content-wrapper">
        <!-- Desktop Filters Sidebar -->
        <aside class="filters-sidebar">
            <div class="filters-card">
                <h2 class="filters-title">
                    Filters
                    {% if currentGenre or currentRatingMin or currentRatingMax or currentYearMin or currentYearMax %}
                        <a href="{{ applicationUrl }}/movies?sort={{ currentSort }}&order={{ currentOrder }}" class="btn btn-sm btn-clear-filters">Clear</a>
                    {% endif %}
                </h2>

                <form id="filtersForm" action="{{ applicationUrl }}/movies" method="get">
                    <input type="hidden" name="sort" value="{{ currentSort }}">
                    <input type="hidden" name="order" value="{{ currentOrder }}">

                    <div class="filter-group">
                        <label class="filter-label">Genre</label>
                        <select name="genre" class="filter-select">
                            <option value="">All Genres</option>
                            {% for g in genres %}
                                <option value="{{ g }}" {{ currentGenre == g ? 'selected' : '' }}>{{ g }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Global Rating (avg)</label>
                        <div class="filter-range">
                            <input type="number" name="rating_min" class="filter-input" placeholder="Min" min="1" max="7" value="{{ currentRatingMin }}">
                            <span class="filter-range-separator">-</span>
                            <input type="number" name="rating_max" class="filter-input" placeholder="Max" min="1" max="7" value="{{ currentRatingMax }}">
                        </div>
                        <p class="filter-info">Filters by rounded average (1-7 popcorn scale)</p>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Release Year</label>
                        <div class="filter-range">
                            <input type="number" name="year_min" class="filter-input" placeholder="{{ yearRange.min ?? 'Min' }}" min="{{ yearRange.min }}" max="{{ yearRange.max }}" value="{{ currentYearMin }}">
                            <span class="filter-range-separator">-</span>
                            <input type="number" name="year_max" class="filter-input" placeholder="{{ yearRange.max ?? 'Max' }}" min="{{ yearRange.min }}" max="{{ yearRange.max }}" value="{{ currentYearMax }}">
                        </div>
                    </div>

                    <div class="filter-actions">
                        <button type="submit" class="btn btn-apply-filters">Apply Filters</button>
                    </div>
                </form>
            </div>
        </aside>

        <!-- Movie Grid -->
        <main>
            <div class="movie-grid">
                {% if movies|length > 0 %}
                    {% for movie in movies %}
                        <a href="{{ applicationUrl }}/movie/{{ movie.movie_id }}" class="movie-card">
                            {% if movie.posterPath %}
                                <img src="{{ movie.posterPath }}" alt="{{ movie.title }}" class="movie-poster" loading="lazy">
                            {% else %}
                                <div class="movie-poster-placeholder">{{ movie.title }}</div>
                            {% endif %}
                            <div class="movie-info">
                                <div class="movie-title" title="{{ movie.title }}">{{ movie.title }}</div>
                                <div class="movie-meta-row">
                                    {% if movie.release_date %}
                                        <span class="movie-year">{{ movie.release_date|date('Y') }}</span>
                                    {% else %}
                                        <span class="movie-year">-</span>
                                    {% endif %}
                                    {% if movie.avg_popcorn %}
                                        <span class="movie-rating">
                                            <svg viewBox="0 0 24 24" class="popcorn-mini" aria-hidden="true">
                                                <path d="M7 22l1-9H4c-.8 0-1.3-.9-.8-1.5l3-4C5.5 5.5 5 4.3 5 3c0-1.7 1.3-3 3-3 .8 0 1.5.3 2 .8C10.5.3 11.2 0 12 0s1.5.3 2 .8c.5-.5 1.2-.8 2-.8 1.7 0 3 1.3 3 3 0 1.3-.5 2.5-1.2 3.5l3 4c.5.6 0 1.5-.8 1.5h-4l1 9H7z"/>
                                            </svg>
                                            {{ movie.avg_popcorn|number_format(1) }}
                                        </span>
                                    {% endif %}
                                </div>
                            </div>
                        </a>
                    {% endfor %}
                {% else %}
                    <div class="no-movies">
                        <h3>No movies found</h3>
                        <p>Try adjusting your filters or add some movies to the library.</p>
                    </div>
                {% endif %}
            </div>
        </main>
    </div>
</div>

<!-- Mobile Filters Offcanvas -->
<div class="offcanvas offcanvas-end offcanvas-filters" tabindex="-1" id="filtersOffcanvas" aria-labelledby="filtersOffcanvasLabel">
    <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="filtersOffcanvasLabel">Filters</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
        <form id="filtersFormMobile" action="{{ applicationUrl }}/movies" method="get">
            <input type="hidden" name="sort" value="{{ currentSort }}">
            <input type="hidden" name="order" value="{{ currentOrder }}">

            <div class="filter-group">
                <label class="filter-label">Genre</label>
                <select name="genre" class="filter-select">
                    <option value="">All Genres</option>
                    {% for g in genres %}
                        <option value="{{ g }}" {{ currentGenre == g ? 'selected' : '' }}>{{ g }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="filter-group">
                <label class="filter-label">Global Rating (avg)</label>
                <div class="filter-range">
                    <input type="number" name="rating_min" class="filter-input" placeholder="Min" min="1" max="7" value="{{ currentRatingMin }}">
                    <span class="filter-range-separator">-</span>
                    <input type="number" name="rating_max" class="filter-input" placeholder="Max" min="1" max="7" value="{{ currentRatingMax }}">
                </div>
                <p class="filter-info">Filters by rounded average (1-7 popcorn scale)</p>
            </div>

            <div class="filter-group">
                <label class="filter-label">Release Year</label>
                <div class="filter-range">
                    <input type="number" name="year_min" class="filter-input" placeholder="{{ yearRange.min ?? 'Min' }}" min="{{ yearRange.min }}" max="{{ yearRange.max }}" value="{{ currentYearMin }}">
                    <span class="filter-range-separator">-</span>
                    <input type="number" name="year_max" class="filter-input" placeholder="{{ yearRange.max ?? 'Max' }}" min="{{ yearRange.min }}" max="{{ yearRange.max }}" value="{{ currentYearMax }}">
                </div>
            </div>

            <div class="filter-actions">
                <button type="submit" class="btn btn-apply-filters">Apply Filters</button>
                <a href="{{ applicationUrl }}/movies?sort={{ currentSort }}&order={{ currentOrder }}" class="btn btn-clear-filters">Clear</a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function updateSort(value) {
    const [sort, order] = value.split('-');
    const url = new URL(window.location.href);
    url.searchParams.set('sort', sort);
    url.searchParams.set('order', order);
    window.location.href = url.toString();
}
</script>
{% endblock %}
