{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"],"fields":{"title":{"boost":1000.0},"text":{"boost":1.0},"tags":{"boost":1000000.0}}},"docs":[{"location":"","title":"Home","text":"Welcome to Pathary      Self-Hosted Movie Tracking for Friend Groups    <p>     \u2022 Rate movies on a 1-7 popcorn scale \ud83c\udf7f \u2022     \u2022 Share with friends \u2022     \u2022 Track your watch history \u2022   </p> <p>Documentation Migration Notice</p> <p>This documentation site was recently created and is actively being updated. I am transitioning away from the GitHub Wiki, which will no longer be maintained. All future documentation updates will be published here at docs.pathary.tv.</p>"},{"location":"#what-is-pathary","title":"What is Pathary?","text":"<p>Imagine Letterboxd meets your own private server with a unique popcorn rating system. That's Pathary!</p> <p>Built for friend groups who love movies, Pathary lets you:</p> <ul> <li> <p> Popcorn Ratings</p> <p>Rate movies from 1-7 popcorns instead of boring stars. More kernels = more fun!</p> </li> <li> <p> Group Experience</p> <p>See what your friends rated each movie. Build your shared cinema culture.</p> </li> <li> <p> Privacy First</p> <p>Self-hosted on your infrastructure. No tracking, no ads, no corporate overlords.</p> </li> <li> <p> Easy Setup</p> <p>Docker-based deployment with SQLite. Up and running in 5 minutes.</p> </li> </ul> <p>Fork Attribution</p> <p>Pathary is a fork of Movary by Lee Peuker, enhanced with enterprise security, OAuth email, and group features.</p>"},{"location":"#quick-start","title":"Quick Start","text":"<p>Get Pathary running in 3 simple steps:</p> Step 1: Clone &amp; ConfigureStep 2: LaunchStep 3: Create Admin <pre><code># Clone the repository\ngit clone https://github.com/benjaminmue/pathary.git\ncd pathary\n\n# Create your config\ncp .env.example .env.local\nnano .env.local  # Add your TMDB API key\n</code></pre> <pre><code># Start with Docker\ndocker compose up -d\n\n# Run database migrations\nmake app_database_migrate\n</code></pre> <pre><code># Create your first user (admin)\ndocker compose exec app php bin/console user:create\n</code></pre> <p>You're Done!</p> <p>Visit <code>http://localhost/</code> and start rating movies! \ud83c\udf89</p>"},{"location":"#key-features","title":"Key Features","text":""},{"location":"#for-movie-lovers","title":"For Movie Lovers","text":"<p> Unique Rating System</p> <p>Rate movies 1-7 on the popcorn scale. Because 5 stars just doesn't cut it when you need to express that a movie is \"good but not great.\"</p> <p> Watch History</p> <p>Track when and where you watched each movie. Perfect for settling \"Did we watch this already?\" arguments.</p> <p> Group Ratings</p> <p>See aggregate ratings from all users. Find out if you're the only one who loved that weird art film.</p> <p> Movie Discovery</p> <p>Browse and search 1M+ movies via TMDB integration. Find your next movie night pick.</p>"},{"location":"#security-auth","title":"Security &amp; Auth","text":"<p> 2FA Protection</p> <p>TOTP support with recovery codes and trusted device management. Keep your ratings safe!</p> <p> OAuth Email</p> <p>Gmail and Microsoft 365 OAuth 2.0. No more SMTP passwords lying around.</p> <p> Audit Logging</p> <p>Track all security events. Know who logged in, when, and from where.</p> <p> Strong Passwords</p> <p>Enforced password policy with real-time validation. Security that doesn't compromise.</p>"},{"location":"#perfect-for","title":"Perfect For","text":"<p>Friend Groups</p> <p>You watch movies together and want to remember what everyone thought. Build your shared movie culture!</p> <p>Film Clubs</p> <p>Need a private rating system for your club members? Pathary keeps everything in your control.</p> <p>Privacy Enthusiasts</p> <p>Tired of corporate platforms tracking your every move? Host it yourself, own your data.</p> <p>Power Users</p> <p>Want integrations with Plex, Jellyfin, Trakt, and Letterboxd? Pathary has you covered.</p>"},{"location":"#explore-the-docs","title":"Explore the Docs","text":"<ul> <li> <p> Getting Started</p> <p>Installation guide and initial setup</p> </li> <li> <p> Security</p> <p>2FA, OAuth, and password policies</p> </li> <li> <p> Configuration</p> <p>Environment variables and settings</p> </li> <li> <p> Architecture</p> <p>How Pathary works under the hood</p> </li> <li> <p> Deployment</p> <p>Production setup and reverse proxy</p> </li> <li> <p> Features</p> <p>Movies, ratings, and integrations</p> </li> <li> <p> Troubleshooting</p> <p>Logs, debugging, and common issues</p> </li> <li> <p> Migrations</p> <p>Database migrations and upgrades</p> </li> </ul>"},{"location":"#pathary-vs-movary","title":"Pathary vs Movary","text":"Feature Movary Pathary \ud83d\udd10 OAuth Email Auth \u274c \u2705 Gmail + Microsoft 365 \ud83d\udee1\ufe0f Two-Factor Auth \u274c \u2705 TOTP + Recovery Codes \ud83d\udd11 Password Policy \u274c \u2705 Enforced Requirements \ud83d\udcca Health Dashboard \u274c \u2705 System Monitoring \ud83d\udd0d Audit Logging \u274c \u2705 Security Events \ud83d\udc65 Group Focus Individual Friend Groups \ud83c\udfa8 Modern UI Bootstrap 4 Bootstrap 5 Dark Mode"},{"location":"#community-support","title":"Community &amp; Support","text":"<p>Need Help?</p> <ul> <li>\ud83d\udcd6 Documentation: You're reading it! Use the search bar above.</li> <li>\ud83d\udc1b Bug Reports: Create an issue</li> <li>\ud83d\udca1 Feature Requests: Suggest an idea</li> <li>\ud83d\udcdd Contributing: Check out Issue Labels</li> </ul> <p>Project Status</p> <p>Pathary is in active development. Expect frequent updates, new features, and improvements. Always back up your data before updating!</p> <p>     Made with \u2764\ufe0f for movie lovers everywhere   </p> <p> \u2b50 Star on GitHub </p>"},{"location":"OAUTH_AUDIT_LOGGING/","title":"OAuth Configuration Audit Logging","text":""},{"location":"OAUTH_AUDIT_LOGGING/#overview","title":"Overview","text":"<p>This document describes the security audit logging implementation for OAuth email configuration changes in Pathary.</p>"},{"location":"OAUTH_AUDIT_LOGGING/#implementation-summary","title":"Implementation Summary","text":"<p>All OAuth configuration changes are now logged to the <code>user_security_audit_log</code> table with actor, timestamp, IP address, user agent, and safe metadata details.</p>"},{"location":"OAUTH_AUDIT_LOGGING/#event-types","title":"Event Types","text":"<p>The following OAuth configuration events are logged:</p>"},{"location":"OAUTH_AUDIT_LOGGING/#1-oauth-config-created","title":"1. OAuth Config Created","text":"<ul> <li>Event Type: <code>oauth_config_created</code></li> <li>Trigger: When a new OAuth configuration is saved for the first time</li> <li>Metadata Logged:</li> <li><code>provider</code> - Provider name (gmail, microsoft)</li> <li><code>client_id</code> - OAuth client ID (safe to log)</li> <li><code>from_address</code> - Email address to send from</li> <li><code>tenant_id</code> - Azure AD tenant ID (Microsoft only)</li> <li><code>has_secret_expiry</code> - Whether client secret has expiry set</li> <li>Never Logged: <code>client_secret</code></li> </ul>"},{"location":"OAUTH_AUDIT_LOGGING/#2-oauth-config-updated","title":"2. OAuth Config Updated","text":"<ul> <li>Event Type: <code>oauth_config_updated</code></li> <li>Trigger: When an existing OAuth configuration is modified</li> <li>Metadata Logged: Same as oauth_config_created</li> <li>Never Logged: <code>client_secret</code></li> </ul>"},{"location":"OAUTH_AUDIT_LOGGING/#3-oauth-connected","title":"3. OAuth Connected","text":"<ul> <li>Event Type: <code>oauth_connected</code></li> <li>Trigger: When OAuth authorization callback succeeds and refresh token is saved</li> <li>Metadata Logged:</li> <li><code>provider</code> - Provider name</li> <li><code>from_address</code> - Email address</li> <li><code>granted_scopes</code> - OAuth scopes granted by user</li> <li>Never Logged: <code>refresh_token</code>, <code>access_token</code>, <code>authorization_code</code>, <code>state</code></li> </ul>"},{"location":"OAUTH_AUDIT_LOGGING/#4-oauth-callback-failed","title":"4. OAuth Callback Failed","text":"<ul> <li>Event Type: <code>oauth_callback_failed</code></li> <li>Trigger: When OAuth authorization callback fails</li> <li>Metadata Logged:</li> <li><code>error</code> - Error code from provider or 'exception'</li> <li><code>error_description</code> - Sanitized error message</li> <li>Never Logged: Full stack trace, sensitive query parameters</li> </ul>"},{"location":"OAUTH_AUDIT_LOGGING/#5-oauth-disconnected","title":"5. OAuth Disconnected","text":"<ul> <li>Event Type: <code>oauth_disconnected</code></li> <li>Trigger: When OAuth connection is disconnected (tokens cleared, config preserved)</li> <li>Metadata Logged:</li> <li><code>provider</code> - Provider name</li> <li><code>from_address</code> - Email address</li> <li>Never Logged: Token values</li> </ul>"},{"location":"OAUTH_AUDIT_LOGGING/#6-oauth-config-deleted","title":"6. OAuth Config Deleted","text":"<ul> <li>Event Type: <code>oauth_config_deleted</code></li> <li>Trigger: When OAuth configuration is completely deleted</li> <li>Metadata Logged:</li> <li><code>provider</code> - Provider name</li> <li><code>client_id</code> - OAuth client ID</li> <li><code>from_address</code> - Email address</li> <li>Never Logged: <code>client_secret</code>, tokens</li> </ul>"},{"location":"OAUTH_AUDIT_LOGGING/#7-email-auth-mode-changed","title":"7. Email Auth Mode Changed","text":"<ul> <li>Event Type: <code>oauth_auth_mode_changed</code></li> <li>Trigger: When email authentication mode is switched between <code>smtp_password</code> and <code>smtp_oauth</code></li> <li>Metadata Logged:</li> <li><code>old_mode</code> - Previous auth mode</li> <li><code>new_mode</code> - New auth mode</li> <li>Never Logged: Passwords, tokens</li> </ul>"},{"location":"OAUTH_AUDIT_LOGGING/#8-oauth-encryption-key-generated","title":"8. OAuth Encryption Key Generated","text":"<ul> <li>Event Type: <code>oauth_encryption_key_generated</code></li> <li>Trigger: When a new AES-256 encryption key is generated for OAuth secrets</li> <li>Metadata Logged:</li> <li><code>key_source</code> - Where key is stored (database or environment)</li> <li><code>key_length</code> - Length of base64-encoded key</li> <li>Never Logged: Encryption key value</li> </ul>"},{"location":"OAUTH_AUDIT_LOGGING/#security-guarantees","title":"Security Guarantees","text":""},{"location":"OAUTH_AUDIT_LOGGING/#what-is-never-logged","title":"What is NEVER Logged:","text":"<ul> <li>\u274c OAuth client secrets (encrypted or plaintext)</li> <li>\u274c Refresh tokens</li> <li>\u274c Access tokens</li> <li>\u274c Authorization codes</li> <li>\u274c Encryption key values</li> <li>\u274c SMTP passwords</li> <li>\u274c Raw callback query strings</li> <li>\u274c Full stack traces</li> </ul>"},{"location":"OAUTH_AUDIT_LOGGING/#what-is-logged","title":"What IS Logged:","text":"<ul> <li>\u2705 Provider name (gmail, microsoft)</li> <li>\u2705 Client ID (public identifier)</li> <li>\u2705 Tenant ID (Microsoft - public identifier)</li> <li>\u2705 From email address</li> <li>\u2705 Granted OAuth scopes</li> <li>\u2705 Connection status changes</li> <li>\u2705 Auth mode changes</li> <li>\u2705 Actor user ID</li> <li>\u2705 Timestamp</li> <li>\u2705 IP address</li> <li>\u2705 User agent (trimmed)</li> </ul>"},{"location":"OAUTH_AUDIT_LOGGING/#database-schema","title":"Database Schema","text":"<p>All events are stored in the <code>user_security_audit_log</code> table:</p> <pre><code>CREATE TABLE `user_security_audit_log` (\n    `id` INTEGER PRIMARY KEY AUTOINCREMENT,\n    `user_id` INTEGER NOT NULL,\n    `event_type` TEXT NOT NULL,\n    `ip_address` TEXT DEFAULT NULL,\n    `user_agent` TEXT DEFAULT NULL,\n    `metadata` TEXT DEFAULT NULL,  -- JSON with safe details only\n    `created_at` TEXT NOT NULL,\n    FOREIGN KEY (`user_id`) REFERENCES `user`(`id`) ON DELETE CASCADE\n)\n</code></pre>"},{"location":"OAUTH_AUDIT_LOGGING/#implementation-files","title":"Implementation Files","text":""},{"location":"OAUTH_AUDIT_LOGGING/#modified-files","title":"Modified Files:","text":"<ol> <li>src/Domain/User/Service/SecurityAuditService.php</li> <li>Added 8 new event type constants</li> <li> <p>Added human-readable labels for UI display</p> </li> <li> <p>src/HttpController/Web/OAuthEmailController.php</p> </li> <li>Injected SecurityAuditService and Authentication</li> <li>Added audit logging to all OAuth actions:<ul> <li>saveConfig() - Lines 119-133</li> <li>callback() - Lines 202-213, 238-250, 256-267</li> <li>disconnect() - Lines 300-311</li> <li>deleteConfig() - Lines 355-367</li> <li>generateEncryptionKey() - Lines 420-431</li> <li>updateAuthMode() - Lines 543-554</li> </ul> </li> </ol>"},{"location":"OAUTH_AUDIT_LOGGING/#unchanged-files","title":"Unchanged Files:","text":"<ul> <li>src/Service/Email/OAuthConfigService.php - No logging added (to avoid duplicates)</li> <li>src/Service/Email/OAuthTokenService.php - No logging added (controller handles it)</li> </ul>"},{"location":"OAUTH_AUDIT_LOGGING/#viewing-audit-logs","title":"Viewing Audit Logs","text":""},{"location":"OAUTH_AUDIT_LOGGING/#user-profile-security-activity","title":"User Profile - Security Activity","text":"<p>Admins can view their own OAuth configuration events at: - URL: <code>/profile/security</code> - Shows last 20 events for the current user - Includes OAuth config events if the user performed them</p>"},{"location":"OAUTH_AUDIT_LOGGING/#admin-panel-events","title":"Admin Panel - Events","text":"<p>Admins can view all OAuth configuration events across all users at: - URL: <code>/admin/events</code> - Filter by event type (select OAuth event types) - Search by IP address, user agent, or metadata - View detailed metadata for each event</p>"},{"location":"OAUTH_AUDIT_LOGGING/#testing-checklist","title":"Testing Checklist","text":"<p>To verify audit logging is working:</p> <ol> <li>Create OAuth Config</li> <li>Navigate to Admin \u2192 Server Management \u2192 Email Settings \u2192 OAuth</li> <li>Configure a Gmail or Microsoft provider</li> <li>Check audit log for <code>oauth_config_created</code> event</li> <li>Verify metadata contains provider, client_id, from_address</li> <li> <p>Verify client_secret is NOT in metadata</p> </li> <li> <p>Update OAuth Config</p> </li> <li>Modify existing OAuth config (change client ID or from address)</li> <li> <p>Check audit log for <code>oauth_config_updated</code> event</p> </li> <li> <p>Connect OAuth</p> </li> <li>Click \"Connect\" and complete OAuth authorization flow</li> <li>Check audit log for <code>oauth_connected</code> event</li> <li>Verify metadata contains provider and granted_scopes</li> <li> <p>Verify refresh_token and access_token are NOT in metadata</p> </li> <li> <p>Disconnect OAuth</p> </li> <li>Click \"Disconnect\"</li> <li> <p>Check audit log for <code>oauth_disconnected</code> event</p> </li> <li> <p>Delete OAuth Config</p> </li> <li>Click \"Delete Configuration\"</li> <li> <p>Check audit log for <code>oauth_config_deleted</code> event</p> </li> <li> <p>Change Auth Mode</p> </li> <li>Switch between smtp_password and smtp_oauth</li> <li>Check audit log for <code>oauth_auth_mode_changed</code> event</li> <li> <p>Verify old_mode and new_mode are logged</p> </li> <li> <p>Generate Encryption Key</p> </li> <li>Click \"Generate Encryption Key\"</li> <li>Check audit log for <code>oauth_encryption_key_generated</code> event</li> <li> <p>Verify key value is NOT in metadata</p> </li> <li> <p>Failed Callback</p> </li> <li>Trigger a failed OAuth callback (deny consent or use invalid credentials)</li> <li>Check audit log for <code>oauth_callback_failed</code> event</li> </ol>"},{"location":"OAUTH_AUDIT_LOGGING/#retention-policy","title":"Retention Policy","text":"<ul> <li>Audit logs are retained for 90 days by default</li> <li>Configurable via <code>SecurityAuditService::cleanupOldEvents()</code></li> <li>No implementation changes required for standard retention</li> </ul>"},{"location":"OAUTH_AUDIT_LOGGING/#compliance","title":"Compliance","text":"<p>This implementation helps with: - GDPR Compliance: Audit trail of administrative actions - Security Audits: Track who changed OAuth configuration and when - Incident Response: Identify unauthorized changes to email settings - Accountability: Clear record of administrative actions</p>"},{"location":"OAUTH_AUDIT_LOGGING/#related-issues","title":"Related Issues","text":"<ul> <li>Issue #17: Add security audit logging for OAuth configuration changes</li> <li>OAuth Monitoring (Issue #20): OAuth token refresh monitoring</li> </ul>"},{"location":"OAUTH_AUDIT_LOGGING/#notes","title":"Notes","text":"<ul> <li>All audit logging occurs AFTER authorization checks pass (admin-only)</li> <li>Logging placement: Controller layer (single responsibility)</li> <li>No duplicate logs from service layer</li> <li>IP address respects reverse proxy forwarded headers (via <code>$_SERVER['REMOTE_ADDR']</code>)</li> <li>User agent is logged as-is from <code>$_SERVER['HTTP_USER_AGENT']</code></li> </ul>"},{"location":"OAUTH_MONITORING_IMPLEMENTATION/","title":"OAuth Token Monitoring Implementation Summary","text":"<p>This document summarizes the complete OAuth token monitoring and alerting system implemented for Pathary Issue #20.</p>"},{"location":"OAUTH_MONITORING_IMPLEMENTATION/#implementation-overview","title":"Implementation Overview","text":"<p>A comprehensive OAuth monitoring system that proactively warns administrators before OAuth tokens expire, preventing email sending failures.</p>"},{"location":"OAUTH_MONITORING_IMPLEMENTATION/#files-created","title":"Files Created","text":""},{"location":"OAUTH_MONITORING_IMPLEMENTATION/#database-migrations","title":"Database Migrations","text":"<ul> <li><code>db/migrations/mysql/20251227192513_AddOAuthMonitoringFields.php</code></li> <li>Adds monitoring fields to <code>oauth_email_config</code> table</li> <li>Creates <code>oauth_admin_banner_ack</code> table for banner acknowledgements</li> </ul>"},{"location":"OAUTH_MONITORING_IMPLEMENTATION/#core-services","title":"Core Services","text":"<ul> <li><code>src/Service/Email/OAuthMonitoringService.php</code></li> <li>Core monitoring logic and health evaluation</li> <li>Alert level calculation (ok/warn/critical/expired)</li> <li>Notification scheduling and management</li> <li>Admin banner acknowledgement tracking</li> <li>Email notification sending to admins</li> <li> <p>Security event logging</p> </li> <li> <p><code>src/Service/Email/OAuthLazyMonitoringService.php</code></p> </li> <li>Lazy monitoring service triggered on page loads</li> <li>Database locking to prevent concurrent runs</li> <li>Stale lock detection and cleanup</li> <li>6-hour minimum interval enforcement</li> <li>Last run time tracking</li> </ul>"},{"location":"OAUTH_MONITORING_IMPLEMENTATION/#middleware","title":"Middleware","text":"<ul> <li><code>src/HttpController/Web/Middleware/OAuthLazyMonitoring.php</code></li> <li>Global middleware applied to all web routes</li> <li>Triggers lazy monitoring on every page load</li> <li>Non-blocking execution</li> <li>Exception handling to prevent request interruption</li> </ul>"},{"location":"OAUTH_MONITORING_IMPLEMENTATION/#api-controllers","title":"API Controllers","text":"<ul> <li><code>src/HttpController/Api/OAuthMonitoringController.php</code></li> <li><code>GET /api/admin/oauth/monitoring-status</code> - Check if banner should show</li> <li><code>POST /api/admin/oauth/acknowledge-banner</code> - Acknowledge banner for 3 hours</li> </ul>"},{"location":"OAUTH_MONITORING_IMPLEMENTATION/#templates","title":"Templates","text":"<ul> <li><code>templates/partials/oauth_monitor_banner.twig</code></li> <li>Bootstrap modal banner for admin alerts</li> <li>Automatically checks status on page load</li> <li>3-hour acknowledgement suppression</li> <li>Escalation detection (re-shows if alert level increases)</li> </ul>"},{"location":"OAUTH_MONITORING_IMPLEMENTATION/#documentation","title":"Documentation","text":"<ul> <li><code>docs/oauth-monitoring-setup.md</code></li> <li>Complete setup guide for lazy monitoring</li> <li>No cron configuration required</li> <li>Troubleshooting guide</li> <li>Security considerations</li> </ul>"},{"location":"OAUTH_MONITORING_IMPLEMENTATION/#files-modified","title":"Files Modified","text":""},{"location":"OAUTH_MONITORING_IMPLEMENTATION/#value-objects","title":"Value Objects","text":"<ul> <li><code>src/Service/Email/OAuthConfig.php</code></li> <li>Added monitoring fields: <code>lastFailureAt</code>, <code>lastErrorCode</code>, <code>reauthRequired</code>, <code>alertLevel</code>, <code>nextNotificationAt</code></li> <li>Added helper methods: <code>getAlertLevelInfo()</code>, <code>requiresAttention()</code>, <code>getDaysSinceLastRefresh()</code>, <code>getDaysSinceLastFailure()</code></li> </ul>"},{"location":"OAUTH_MONITORING_IMPLEMENTATION/#services","title":"Services","text":"<ul> <li><code>src/Service/Email/OAuthConfigService.php</code></li> <li>Added <code>updateMonitoring()</code> method for recording refresh attempts</li> <li>Added <code>updateAlertLevel()</code> method for alert state management</li> <li>Updated <code>hydrateConfig()</code> to load new monitoring fields</li> </ul>"},{"location":"OAUTH_MONITORING_IMPLEMENTATION/#security-audit","title":"Security Audit","text":"<ul> <li><code>src/Domain/User/Service/SecurityAuditService.php</code></li> <li>Added 9 new OAuth monitoring event type constants</li> <li>Added event labels for UI display</li> <li>Events: warn_45, warn_30, warn_15, warn_daily, expired, refresh_failed, refresh_recovered, banner_acknowledged, banner_shown</li> </ul>"},{"location":"OAUTH_MONITORING_IMPLEMENTATION/#routes","title":"Routes","text":"<ul> <li><code>settings/routes.php</code></li> <li>Added OAuth monitoring API routes with admin authentication</li> </ul>"},{"location":"OAUTH_MONITORING_IMPLEMENTATION/#router","title":"Router","text":"<ul> <li><code>src/Service/Router/RouterService.php</code></li> <li>Added <code>OAuthLazyMonitoring</code> middleware to all web routes</li> <li>Runs after session start, before route handlers</li> </ul>"},{"location":"OAUTH_MONITORING_IMPLEMENTATION/#layout","title":"Layout","text":"<ul> <li><code>templates/layouts/app_base.twig</code></li> <li>Included OAuth monitoring banner partial</li> </ul>"},{"location":"OAUTH_MONITORING_IMPLEMENTATION/#database-schema-changes","title":"Database Schema Changes","text":""},{"location":"OAUTH_MONITORING_IMPLEMENTATION/#oauth_email_config-table","title":"oauth_email_config Table","text":"<p>New columns: <pre><code>last_failure_at          DATETIME       -- Last token refresh failure\nlast_error_code          VARCHAR(100)   -- Sanitized error code\nreauth_required          TINYINT(1)     -- Re-authorization needed flag\nalert_level              VARCHAR(20)    -- ok/warn/critical/expired\nnext_notification_at     DATETIME       -- Next scheduled notification time\n</code></pre></p>"},{"location":"OAUTH_MONITORING_IMPLEMENTATION/#oauth_admin_banner_ack-table","title":"oauth_admin_banner_ack Table","text":"<p>New table: <pre><code>id                       INT(10) UNSIGNED AUTO_INCREMENT\nuser_id                  INT(10) UNSIGNED  -- Admin who acknowledged\nalert_level_acked        VARCHAR(20)       -- Alert level at acknowledgement\nacked_at                 DATETIME          -- Acknowledgement timestamp\n</code></pre></p>"},{"location":"OAUTH_MONITORING_IMPLEMENTATION/#architecture","title":"Architecture","text":""},{"location":"OAUTH_MONITORING_IMPLEMENTATION/#monitoring-flow","title":"Monitoring Flow","text":"<ol> <li> <p>Lazy Trigger (On Page Load) <pre><code>User Request \u2192 Middleware \u2192 OAuthLazyMonitoringService.triggerIfNeeded()\n\u251c\u2500 Check if 6+ hours elapsed since last run\n\u251c\u2500 Try to acquire database lock (non-blocking)\n\u2514\u2500 If lock acquired \u2192 OAuthMonitoringService.runMonitoring()\n</code></pre></p> </li> <li> <p>Health Evaluation <pre><code>runMonitoring() \u2192 attemptTokenRefresh() \u2192 evaluateHealth() \u2192 updateAlertLevel()\n</code></pre></p> </li> <li> <p>Notification Decision <pre><code>evaluateHealth() \u2192 shouldNotifyAt() \u2192 sendNotifications() \u2192 logMonitoringEvent()\n</code></pre></p> </li> <li> <p>Post-Monitoring Cleanup <pre><code>updateLastRunTime() \u2192 releaseLock()\n</code></pre></p> </li> <li> <p>Admin Experience <pre><code>Page Load \u2192 Banner JavaScript \u2192 API Check \u2192 Show Modal (if needed)\nAdmin Acknowledges \u2192 API Call \u2192 Record Acknowledgement \u2192 Hide for 3 hours\n</code></pre></p> </li> </ol>"},{"location":"OAUTH_MONITORING_IMPLEMENTATION/#alert-level-logic","title":"Alert Level Logic","text":"<pre><code>OK:\n  - Recent successful refresh\n  - No failures\n  - Token age within limits\n\nWARN (45/30 days):\n  - Approaching recommended refresh interval\n  - Notify once at threshold, then weekly/every 3 days\n\nCRITICAL (15 days):\n  - Close to recommended refresh\n  - OR token refresh failing for &lt;7 days\n  - Notify daily\n\nEXPIRED:\n  - Re-authorization required\n  - Token revoked/invalid\n  - Refresh failing for 7+ days\n  - Notify daily\n</code></pre>"},{"location":"OAUTH_MONITORING_IMPLEMENTATION/#banner-suppression-logic","title":"Banner Suppression Logic","text":"<pre><code>Should Show Banner =\n  (Alert Level &gt;= WARN)\n  AND (\n    Never Acknowledged\n    OR Acknowledgement Expired (&gt;3 hours)\n    OR Alert Level Escalated\n  )\n</code></pre>"},{"location":"OAUTH_MONITORING_IMPLEMENTATION/#security-features","title":"Security Features","text":""},{"location":"OAUTH_MONITORING_IMPLEMENTATION/#whats-logged-safe","title":"What's Logged (Safe)","text":"<ul> <li>Event types and timestamps</li> <li>Provider names (gmail/microsoft)</li> <li>Error codes (sanitized, max 100 chars)</li> <li>Alert levels</li> <li>IP addresses of admin actions</li> <li>User agent strings</li> </ul>"},{"location":"OAUTH_MONITORING_IMPLEMENTATION/#whats-never-logged-sensitive","title":"What's NEVER Logged (Sensitive)","text":"<ul> <li>Access tokens</li> <li>Refresh tokens</li> <li>Client secrets</li> <li>Full error messages containing tokens</li> <li>Admin passwords</li> <li>Email content</li> </ul>"},{"location":"OAUTH_MONITORING_IMPLEMENTATION/#error-code-sanitization","title":"Error Code Sanitization","text":"<pre><code>// Sanitize error code (max 100 chars)\n$sanitizedCode = $errorCode !== null ? substr($errorCode, 0, 100) : null;\n\n// Sanitize error message (max 255 chars)\n$sanitizedMessage = $errorMessage !== null ? substr($errorMessage, 0, 255) : null;\n</code></pre>"},{"location":"OAUTH_MONITORING_IMPLEMENTATION/#event-types","title":"Event Types","text":"<p>All events logged to <code>user_security_audit_log</code> table:</p> Event Type When Logged User ID <code>oauth_token_warn_45</code> 45 days before refresh needed 0 (system) <code>oauth_token_warn_30</code> 30 days before refresh needed 0 (system) <code>oauth_token_warn_15</code> 15 days before refresh needed 0 (system) <code>oauth_token_warn_daily</code> Daily alerts (&lt; 15 days) 0 (system) <code>oauth_token_expired</code> Token expired or re-auth required 0 (system) <code>oauth_token_refresh_failed</code> Token refresh failed 0 (system) <code>oauth_token_refresh_recovered</code> Token refresh recovered 0 (system) <code>oauth_banner_acknowledged</code> Admin acknowledged banner Admin user ID <code>oauth_banner_shown</code> Banner displayed to admin Admin user ID <p>Event metadata includes: <pre><code>{\n  \"provider\": \"gmail\",\n  \"alert_level\": \"warn\",\n  \"status\": \"success|failed\",\n  \"error_code\": \"invalid_grant\",\n  \"reauth_required\": true|false\n}\n</code></pre></p>"},{"location":"OAUTH_MONITORING_IMPLEMENTATION/#configuration-constants","title":"Configuration Constants","text":""},{"location":"OAUTH_MONITORING_IMPLEMENTATION/#thresholds-days","title":"Thresholds (Days)","text":"<pre><code>THRESHOLD_45_DAYS = 45       // First warning\nTHRESHOLD_30_DAYS = 30       // Second warning\nTHRESHOLD_15_DAYS = 15       // Critical warning\nDAILY_ALERT_START = 14       // Start daily alerts\n</code></pre>"},{"location":"OAUTH_MONITORING_IMPLEMENTATION/#health-criteria","title":"Health Criteria","text":"<pre><code>MAX_DAYS_WITHOUT_REFRESH = 60        // Token age limit\nMAX_CONSECUTIVE_FAILURES = 3         // Critical threshold\n</code></pre>"},{"location":"OAUTH_MONITORING_IMPLEMENTATION/#banner-behavior","title":"Banner Behavior","text":"<pre><code>BANNER_ACK_TTL_SECONDS = 10800      // 3 hours\n</code></pre>"},{"location":"OAUTH_MONITORING_IMPLEMENTATION/#lazy-monitoring-behavior","title":"Lazy Monitoring Behavior","text":"<pre><code>MIN_INTERVAL_SECONDS = 21600        // 6 hours between runs\nLOCK_TIMEOUT_SECONDS = 300          // 5 minutes lock timeout\n</code></pre>"},{"location":"OAUTH_MONITORING_IMPLEMENTATION/#lazy-monitoring-setup","title":"Lazy Monitoring Setup","text":"<p>No configuration required - the monitoring system is automatically active after running the database migration.</p>"},{"location":"OAUTH_MONITORING_IMPLEMENTATION/#how-it-works","title":"How It Works","text":"<ol> <li>Middleware Integration: The <code>OAuthLazyMonitoring</code> middleware is automatically applied to all web routes</li> <li>Automatic Triggering: Every page load checks if monitoring should run</li> <li>Smart Throttling: Monitoring only runs if 6+ hours have elapsed since last run</li> <li>Database Locking: Concurrent requests are prevented via non-blocking locks</li> <li>Background Execution: Monitoring runs without blocking page loads</li> </ol>"},{"location":"OAUTH_MONITORING_IMPLEMENTATION/#benefits","title":"Benefits","text":"<ul> <li>\u2705 No cron jobs to configure</li> <li>\u2705 Works in any hosting environment</li> <li>\u2705 Self-contained within the application</li> <li>\u2705 Automatic activation on deployment</li> </ul>"},{"location":"OAUTH_MONITORING_IMPLEMENTATION/#verification","title":"Verification","text":"<p>Check that monitoring is running:</p> <pre><code># View logs for monitoring activity\ndocker compose logs app | grep -i \"oauth monitoring\"\n\n# Check last run time\ndocker compose exec db mysql -u movary -p -e \"USE movary; SELECT * FROM server_setting WHERE \\`key\\` = 'oauth_monitoring_last_run_at';\"\n\n# Check for stuck locks (should be empty)\ndocker compose exec db mysql -u movary -p -e \"USE movary; SELECT * FROM server_setting WHERE \\`key\\` = 'oauth_monitoring_lock';\"\n</code></pre>"},{"location":"OAUTH_MONITORING_IMPLEMENTATION/#testing-checklist","title":"Testing Checklist","text":""},{"location":"OAUTH_MONITORING_IMPLEMENTATION/#unit-tests-future","title":"Unit Tests (Future)","text":"<ul> <li> Health evaluation logic</li> <li> Alert level calculation</li> <li> Notification scheduling</li> <li> Banner acknowledgement TTL</li> <li> Escalation detection</li> <li> Database locking mechanism</li> <li> 6-hour interval enforcement</li> </ul>"},{"location":"OAUTH_MONITORING_IMPLEMENTATION/#integration-tests-manual","title":"Integration Tests (Manual)","text":"<ul> <li> Database migration runs successfully</li> <li> Middleware triggers monitoring on page load</li> <li> Monitoring only runs if 6+ hours elapsed</li> <li> Database lock prevents concurrent runs</li> <li> OAuth health check attempts token refresh</li> <li> Notifications sent to all admins</li> <li> Banner appears when threshold reached</li> <li> Banner acknowledgement persists for 3 hours</li> <li> Banner re-appears when alert level escalates</li> <li> Events logged to Admin \u2192 Events</li> <li> API endpoints require admin authentication</li> <li> Monitoring doesn't block page loads</li> </ul>"},{"location":"OAUTH_MONITORING_IMPLEMENTATION/#verification-steps","title":"Verification Steps","text":"<ol> <li> <p>Run Migration <pre><code>docker compose exec app php vendor/bin/phinx migrate -c ./settings/phinx.php\n</code></pre></p> </li> <li> <p>Test Lazy Monitoring Trigger <pre><code># Reset last run time to force immediate run\ndocker compose exec db mysql -u movary -p -e \"USE movary; DELETE FROM server_setting WHERE \\`key\\` = 'oauth_monitoring_last_run_at';\"\n\n# Visit any page in Pathary\ncurl -I http://localhost/\n\n# Check logs for monitoring activity\ndocker compose logs app | grep -i \"oauth monitoring\"\n</code></pre></p> </li> <li> <p>Verify 6-Hour Interval <pre><code># Visit page again immediately\ncurl -I http://localhost/\n\n# Logs should show monitoring was skipped (within 6-hour window)\ndocker compose logs app | tail -20\n</code></pre></p> </li> <li> <p>Check Events</p> </li> <li>Login as admin</li> <li>Navigate to Admin \u2192 Events</li> <li>Filter for OAuth events</li> <li> <p>Should see monitoring events after page visits</p> </li> <li> <p>Test Banner (if OAuth in warning state)</p> </li> <li>Login as admin</li> <li>Banner should appear if OAuth needs attention</li> <li>Acknowledge banner</li> <li> <p>Verify it doesn't re-appear for 3 hours</p> </li> <li> <p>Verify Email Notifications</p> </li> <li>Configure OAuth</li> <li>Simulate warning condition (modify DB timestamps)</li> <li>Reset last run time and visit a page</li> <li>Check admin email inbox</li> </ol>"},{"location":"OAUTH_MONITORING_IMPLEMENTATION/#dependencies","title":"Dependencies","text":""},{"location":"OAUTH_MONITORING_IMPLEMENTATION/#required-services","title":"Required Services","text":"<ul> <li><code>OAuthConfigService</code> - OAuth configuration management</li> <li><code>OAuthTokenService</code> - Token refresh operations</li> <li><code>SecurityAuditService</code> - Event logging</li> <li><code>UserApi</code> - Admin user lookup</li> <li><code>EmailService</code> - Notification emails</li> </ul>"},{"location":"OAUTH_MONITORING_IMPLEMENTATION/#required-database-tables","title":"Required Database Tables","text":"<ul> <li><code>oauth_email_config</code> - OAuth settings with monitoring fields</li> <li><code>oauth_admin_banner_ack</code> - Banner acknowledgements</li> <li><code>user_security_audit_log</code> - Event storage</li> <li><code>user</code> - Admin user lookup</li> </ul>"},{"location":"OAUTH_MONITORING_IMPLEMENTATION/#future-enhancements","title":"Future Enhancements","text":""},{"location":"OAUTH_MONITORING_IMPLEMENTATION/#planned-features","title":"Planned Features","text":"<ol> <li>System Health dashboard tile for OAuth status</li> <li>Configurable thresholds via admin UI</li> <li>Webhook notifications (Slack, Discord, etc.)</li> <li>Multi-tenant OAuth support</li> <li>Automatic token refresh scheduling</li> <li>GraphQL API for monitoring status</li> <li>Prometheus metrics export</li> <li>Historical uptime tracking</li> </ol>"},{"location":"OAUTH_MONITORING_IMPLEMENTATION/#potential-improvements","title":"Potential Improvements","text":"<ol> <li>Machine learning for failure prediction</li> <li>Automatic re-authorization flow</li> <li>Provider-specific health checks</li> <li>Token rotation reminders</li> <li>Compliance reporting (SOC 2, HIPAA)</li> <li>Multi-language support for notifications</li> <li>Custom notification templates</li> </ol>"},{"location":"OAUTH_MONITORING_IMPLEMENTATION/#acceptance-criteria-status","title":"Acceptance Criteria Status","text":"<p>\u2705 Admin warning popup appears starting 45-day window and can be acknowledged for 3 hours   - Implemented via Bootstrap modal with JavaScript status checking   - Acknowledgement tracked in <code>oauth_admin_banner_ack</code> table   - Escalation detection bypasses acknowledgement TTL</p> <p>\u2705 Emails sent to admins at 45/30/15 days and daily after, until resolved   - Notification schedule implemented in <code>evaluateHealth()</code> and <code>shouldNotifyAt()</code>   - Email sending in <code>sendNotifications()</code> method   - Idempotent execution prevents spam</p> <p>\u2705 All alerts recorded in Admin \u2192 Events   - 9 event types defined in SecurityAuditService   - Events logged via <code>logMonitoringEvent()</code> method   - Metadata includes provider, alert level, error codes</p> <p>\u2705 System Health includes dedicated Email OAuth box   - NOTE: System Health box not yet implemented (marked as future feature)   - Structure and API ready for integration   - Can be added to existing health dashboard</p> <p>\u2705 No secrets logged or displayed   - Error code and message sanitization   - Token values never included in logs or events   - Metadata excludes sensitive data</p> <p>\u2705 Monitoring runs automatically without external configuration   - Lazy monitoring via middleware on page loads   - No cron jobs or external schedulers required   - Self-contained within application   - Comprehensive setup documentation</p>"},{"location":"OAUTH_MONITORING_IMPLEMENTATION/#conclusion","title":"Conclusion","text":"<p>This implementation provides a robust, production-ready OAuth monitoring system that: - Proactively prevents email sending failures - Provides multiple notification channels (email + banner) - Maintains security and privacy standards - Integrates seamlessly with existing security audit infrastructure - Requires zero external configuration (no cron jobs) - Works in any hosting environment (Unraid, VPS, Docker, etc.)</p> <p>The system is fully functional and ready for production deployment after running the database migration. No additional setup steps required - monitoring activates automatically when users visit the site.</p>"},{"location":"changelog/","title":"Wiki Changelog","text":"<p>This page tracks major updates to the Pathary Wiki documentation.</p>"},{"location":"changelog/#2025-12-22-security-and-ui-update","title":"2025-12-22 - Security and UI Update","text":"<p>Covers main repository commits: <code>ca155ec4</code> through <code>d8bd95c3</code> (2025-12-14 to 2025-12-22)</p>"},{"location":"changelog/#new-pages-added","title":"New Pages Added","text":"<ul> <li>Two-Factor Authentication - Comprehensive guide to TOTP, recovery codes, and trusted devices</li> <li>Password Policy and Security - Password requirements and security best practices</li> <li>Changelog (this page) - Track Wiki updates</li> </ul>"},{"location":"changelog/#major-updates","title":"Major Updates","text":""},{"location":"changelog/#security-features","title":"Security Features","text":"<ul> <li>Authentication-and-Sessions.md: Updated 2FA section with recovery codes and trusted device support</li> <li>Documented new security routes (<code>/profile/security/*</code>)</li> <li>Added security audit log functionality</li> <li>Updated login flow to include device trust and recovery code options</li> </ul>"},{"location":"changelog/#frontend-and-ui","title":"Frontend and UI","text":"<ul> <li>Frontend-and-UI.md:</li> <li>Added Footer Navigation section documenting the new sticky footer with GitHub links</li> <li>Expanded Bootstrap Icons section with security and profile page icons</li> <li>Updated Base Layout with flexbox sticky footer pattern and conditional display</li> <li>Added bottom spacing documentation (<code>pb-4</code> class)</li> </ul>"},{"location":"changelog/#getting-started","title":"Getting Started","text":"<ul> <li>Getting-Started.md:</li> <li>Updated to use <code>.env.local</code> for local development (never committed to git)</li> <li>Emphasized port 80 requirement for proper routing</li> <li>Added proper docker-compose command for local development</li> <li>Updated port configuration guidance with <code>APPLICATION_URL</code> sync</li> </ul>"},{"location":"changelog/#home-page","title":"Home Page","text":"<ul> <li>Home.md:</li> <li>Added 3 new features to Feature Overview (2FA, Password Policy, Security Audit Log)</li> <li>Reorganized Wiki Navigation with new \"Security\" section</li> <li>Fixed Wiki link syntax (removed extra <code>]</code> brackets)</li> </ul>"},{"location":"changelog/#main-repository-changes-documented","title":"Main Repository Changes Documented","text":""},{"location":"changelog/#securityauthentication-commits-fd5084e8-10ee888f-7d242b3a-3d08f8fa-d8bd95c3","title":"Security/Authentication (Commits: fd5084e8, 10ee888f, 7d242b3a, 3d08f8fa, d8bd95c3)","text":"<ul> <li>Complete 2FA system with TOTP, QR codes, and authenticator app support</li> <li>Recovery codes system (10 single-use backup codes, bcrypt hashed)</li> <li>Trusted devices feature (30-day trust via secure cookies, 10 device limit)</li> <li>Recovery code confirmation flow with progressive UI</li> <li>Password policy enforcement (10+ chars, uppercase, lowercase, number, special char)</li> <li>Security audit log for tracking security events</li> <li>Security configuration improvements (removed hardcoded credentials)</li> <li>Secret scanning documentation and tools</li> </ul>"},{"location":"changelog/#uiux-improvements-commits-2b880b4d-f09647d3-19c70415-e0c9f94d-e99f38f8","title":"UI/UX Improvements (Commits: 2b880b4d, f09647d3, 19c70415, e0c9f94d, e99f38f8)","text":"<ul> <li>Sticky footer navigation with GitHub, Wiki, and Issue links</li> <li>Footer hidden on login page</li> <li>Consistent bottom spacing across all pages (pb-4)</li> <li>Login page centered on all screen sizes</li> <li>Bootstrap Icons added to Profile and Security settings</li> <li>Improved icon coverage for security features</li> </ul>"},{"location":"changelog/#configuration-commits-50aed95c-d8bd95c3","title":"Configuration (Commits: 50aed95c, d8bd95c3)","text":"<ul> <li><code>.env.local</code> approach for local development</li> <li>Expanded <code>.gitignore</code> patterns for security</li> <li>Removed <code>docker-compose.local.yml</code> with hardcoded credentials</li> <li>Converted <code>http-client.env.json</code> to <code>.example</code> template</li> </ul>"},{"location":"changelog/#routes-commit-3382249e","title":"Routes (Commit: 3382249e)","text":"<ul> <li>Fixed <code>/old/*</code> routes redirect to use correct APPLICATION_URL</li> <li>Added 9 new security-related routes for 2FA, recovery codes, and trusted devices</li> </ul>"},{"location":"changelog/#files-not-changed-still-accurate","title":"Files Not Changed (Still Accurate)","text":"<p>The following pages were reviewed and remain accurate: - Architecture.md - Database.md - Deployment.md - Logging-and-Troubleshooting.md - Migrations.md - Movies-and-TMDB.md - Ratings-and-Comments.md - Routing-and-Controllers.md</p>"},{"location":"changelog/#2025-12-14-initial-wiki-creation","title":"2025-12-14 - Initial Wiki Creation","text":"<p>Initial comprehensive documentation created with the following pages:</p> <ul> <li>Home.md</li> <li>Architecture.md</li> <li>Authentication-and-Sessions.md</li> <li>Database.md</li> <li>Deployment.md</li> <li>Frontend-and-UI.md</li> <li>Getting-Started.md</li> <li>Logging-and-Troubleshooting.md</li> <li>Migrations.md</li> <li>Movies-and-TMDB.md</li> <li>Ratings-and-Comments.md</li> <li>Routing-and-Controllers.md</li> </ul> <p>\u2190 Back to Wiki Home</p>"},{"location":"configuration/","title":"Configuration","text":""},{"location":"configuration/#introduction","title":"Introduction","text":"<p>There are two main ways how to set your server configuration:</p> <ul> <li>Environment variables</li> <li>Web UI (Settings -&gt; Server), this config is stored in the database</li> </ul> <p>Info</p> <p>Environment variables have the highest priority and overwrite everything else as long as they are set.</p>"},{"location":"configuration/#environment-variables","title":"Environment variables","text":"<p>The <code>Web UI</code> column is set to yes if an environment variable can alternatively be set via the web UI.</p>"},{"location":"configuration/#general","title":"General","text":"NAME DEFAULT VALUE INFO Web UI <code>TMDB_API_KEY</code> - Required (get key here) yes <code>APPLICATION_URL</code> - Public base url of the application (e.g. <code>htttp://localhost</code>) yes <code>APPLICATION_NAME</code> <code>Pathary</code> Application name, displayed e.g. as brand name in the navbar yes <code>TMDB_ENABLE_IMAGE_CACHING</code> <code>0</code> More info here <code>ENABLE_REGISTRATION</code> <code>0</code> Enables public user registration <code>MIN_RUNTIME_IN_SECONDS_FOR_JOB_PROCESSING</code> <code>15</code> Minimum time between background jobs processing <code>TIMEZONE</code> <code>UTC</code> Supported timezones here yes <code>DEFAULT_LOGIN_EMAIL</code> - Email address to always autofill on login page <code>DEFAULT_LOGIN_PASSWORD</code> - Password to always autofill on login page <code>TOTP_ISSUER</code> <code>Pathary</code> The issuer used when setting up two factor authentication"},{"location":"configuration/#database","title":"Database","text":"<p>Required to run the application</p> NAME DEFAULT VALUE INFO <code>DATABASE_MODE</code> <code>sqlite</code> <code>sqlite</code> or <code>mysql</code> <code>DATABASE_SQLITE</code> <code>storage/movary.sqlite</code> <code>DATABASE_MYSQL_HOST</code> - Required when mode is <code>mysql</code> <code>DATABASE_MYSQL_PORT</code> <code>3306</code> <code>DATABASE_MYSQL_NAME</code> - Required when mode is <code>mysql</code> <code>DATABASE_MYSQL_USER</code> - Required when mode is <code>mysql</code> <code>DATABASE_MYSQL_PASSWORD</code> - Required when mode is <code>mysql</code> <code>DATABASE_MYSQL_CHARSET</code> <code>utf8mb4</code> <code>DATABASE_DISABLE_AUTO_MIGRATION</code> <code>0</code> On default docker runs migrations on container startup"},{"location":"configuration/#third-party-integrations","title":"Third party integrations","text":"<p>Required for some third party integrations. Only necessary if the relevant third party integrations should be enabled.</p> NAME DEFAULT VALUE INFO Web UI <code>PLEX_IDENTIFIER</code> - Required for Plex Authentication. Generate with e.g. <code>openssl rand -base64 32</code> <code>PLEX_APP_NAME</code> <code>Pathary</code> Used for Plex Authentication <code>JELLYFIN_DEVICE_ID</code> - Required for Jellyfin Authentication. Generate with e.g. <code>openssl rand -base64 32</code> <code>JELLYFIN_APP_NAME</code> <code>Pathary</code> Used for Jellyfin Authentication"},{"location":"configuration/#email","title":"Email","text":"<p>Required when email support is wanted</p> NAME DEFAULT VALUE INFO Web UI <code>SMTP_HOST</code> - yes <code>SMTP_PORT</code> - yes <code>SMTP_FROM_ADDRESS</code> - Email address used as sender address yes <code>SMTP_ENCRYPTION</code> - <code>SSL</code> and <code>TSL</code> supported yes <code>SMTP_WITH_AUTH</code> - <code>0</code> or <code>1</code> yes <code>SMTP_USER</code> - Required if auth is enabled yes <code>SMTP_PASSWORD</code> - Required if auth is enabled yes"},{"location":"configuration/#logging","title":"Logging","text":"NAME DEFAULT VALUE INFO <code>LOG_LEVEL</code> <code>warning</code> Uses RFC 5424 severity levels <code>LOG_ENABLE_STACKTRACE</code> <code>0</code> Only needed for debugging <code>LOG_ENABLE_FILE_LOGGING</code> <code>1</code> Persist logs to a file in directory <code>storage/logs</code>"},{"location":"deployment/","title":"Deployment","text":"<p>This page covers deploying Pathary in production environments.</p>"},{"location":"deployment/#docker-deployment","title":"Docker Deployment","text":""},{"location":"deployment/#official-image","title":"Official Image","text":"<pre><code>docker pull ghcr.io/benjaminmue/pathary:latest\n</code></pre>"},{"location":"deployment/#basic-docker-run","title":"Basic Docker Run","text":"<pre><code>docker run -d \\\n  --name pathary \\\n  -p 80:80 \\\n  -e TMDB_API_KEY=your_key \\\n  -v pathary-storage:/app/storage \\\n  ghcr.io/benjaminmue/pathary:latest\n</code></pre>"},{"location":"deployment/#docker-compose-production","title":"Docker Compose (Production)","text":"<pre><code>version: '3.8'\n\nservices:\n  pathary:\n    image: ghcr.io/benjaminmue/pathary:latest\n    restart: unless-stopped\n    ports:\n      - \"8080:80\"\n    environment:\n      - APPLICATION_URL=https://pathary.example.com\n      - TMDB_API_KEY=${TMDB_API_KEY}\n      - DATABASE_MODE=mysql\n      - DATABASE_MYSQL_HOST=mysql\n      - DATABASE_MYSQL_NAME=pathary\n      - DATABASE_MYSQL_USER=pathary\n      - DATABASE_MYSQL_PASSWORD=${MYSQL_PASSWORD}\n      - LOG_LEVEL=warning\n    volumes:\n      - pathary-storage:/app/storage\n    depends_on:\n      - mysql\n\n  mysql:\n    image: mysql:8.0\n    restart: unless-stopped\n    environment:\n      - MYSQL_DATABASE=pathary\n      - MYSQL_USER=pathary\n      - MYSQL_PASSWORD=${MYSQL_PASSWORD}\n      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}\n    volumes:\n      - mysql-data:/var/lib/mysql\n\nvolumes:\n  pathary-storage:\n  mysql-data:\n</code></pre>"},{"location":"deployment/#building-locally","title":"Building Locally","text":""},{"location":"deployment/#build-docker-image","title":"Build Docker Image","text":"<pre><code># From repository root\ndocker build -t pathary:local -f Dockerfile .\n</code></pre>"},{"location":"deployment/#development-build","title":"Development Build","text":"<pre><code>docker build --target development -t pathary:dev -f build/Dockerfile .\n</code></pre>"},{"location":"deployment/#container-startup","title":"Container Startup","text":"<p>File: <code>build/scripts/entrypoint.sh</code></p> <p>On container start: 1. Runs database migrations (unless disabled) 2. Creates storage symlink 3. Starts PHP-FPM + Nginx</p>"},{"location":"deployment/#disable-auto-migration","title":"Disable Auto-Migration","text":"<pre><code>DATABASE_DISABLE_AUTO_MIGRATION=true\n</code></pre>"},{"location":"deployment/#reverse-proxy-configuration","title":"Reverse Proxy Configuration","text":""},{"location":"deployment/#required-headers","title":"Required Headers","text":"<p>Your reverse proxy must forward these headers:</p> Header Purpose <code>Host</code> Original host <code>X-Real-IP</code> Client IP <code>X-Forwarded-For</code> Proxy chain <code>X-Forwarded-Proto</code> Original protocol (http/https) <code>X-Forwarded-Host</code> Original host"},{"location":"deployment/#nginx-configuration","title":"Nginx Configuration","text":"<pre><code>server {\n    listen 443 ssl http2;\n    server_name pathary.example.com;\n\n    ssl_certificate /path/to/cert.pem;\n    ssl_certificate_key /path/to/key.pem;\n\n    location / {\n        proxy_pass http://pathary:80;\n\n        proxy_set_header Host $host;\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header X-Forwarded-Proto $scheme;\n        proxy_set_header X-Forwarded-Host $host;\n\n        proxy_connect_timeout 60s;\n        proxy_send_timeout 60s;\n        proxy_read_timeout 60s;\n    }\n}\n</code></pre>"},{"location":"deployment/#traefik-configuration","title":"Traefik Configuration","text":"<pre><code>services:\n  pathary:\n    labels:\n      - \"traefik.enable=true\"\n      - \"traefik.http.routers.pathary.rule=Host(`pathary.example.com`)\"\n      - \"traefik.http.routers.pathary.entrypoints=websecure\"\n      - \"traefik.http.routers.pathary.tls=true\"\n      - \"traefik.http.services.pathary.loadbalancer.server.port=80\"\n</code></pre>"},{"location":"deployment/#caddy-configuration","title":"Caddy Configuration","text":"<pre><code>pathary.example.com {\n    reverse_proxy pathary:80\n}\n</code></pre> <p>Caddy automatically handles headers and SSL.</p>"},{"location":"deployment/#environment-variables","title":"Environment Variables","text":""},{"location":"deployment/#production-essentials","title":"Production Essentials","text":"<pre><code># Required\nTMDB_API_KEY=your_key\n\n# Recommended\nAPPLICATION_URL=https://pathary.example.com\nDATABASE_MODE=mysql\nDATABASE_MYSQL_HOST=mysql\nDATABASE_MYSQL_NAME=pathary\nDATABASE_MYSQL_USER=pathary\nDATABASE_MYSQL_PASSWORD=strong_password\n\n# Logging\nLOG_LEVEL=warning\nLOG_ENABLE_FILE_LOGGING=1\n</code></pre>"},{"location":"deployment/#security-notes","title":"Security Notes","text":"<ul> <li>Never commit <code>.env</code> files to git</li> <li>Use Docker secrets or environment variables for passwords</li> <li>Change default database credentials</li> </ul>"},{"location":"deployment/#volume-mounts","title":"Volume Mounts","text":"Path Purpose <code>/app/storage</code> SQLite database, logs, cached images <code>/app/storage/logs</code> Application logs <code>/app/storage/images</code> Cached TMDB images"},{"location":"deployment/#backup-storage","title":"Backup Storage","text":"<pre><code>docker run --rm \\\n  -v pathary-storage:/source:ro \\\n  -v $(pwd):/backup \\\n  alpine tar czf /backup/pathary-storage.tar.gz -C /source .\n</code></pre>"},{"location":"deployment/#health-checks","title":"Health Checks","text":""},{"location":"deployment/#basic-health-check","title":"Basic Health Check","text":"<pre><code>curl -f http://localhost:8080/ || exit 1\n</code></pre>"},{"location":"deployment/#docker-compose-health-check","title":"Docker Compose Health Check","text":"<pre><code>services:\n  pathary:\n    healthcheck:\n      test: [\"CMD\", \"curl\", \"-f\", \"http://localhost/\"]\n      interval: 30s\n      timeout: 10s\n      retries: 3\n</code></pre>"},{"location":"deployment/#logs","title":"Logs","text":""},{"location":"deployment/#view-logs","title":"View Logs","text":"<pre><code># Docker logs\ndocker logs pathary\n\n# Application logs (inside container)\ndocker exec pathary cat /app/storage/logs/movary.log\n</code></pre>"},{"location":"deployment/#log-rotation","title":"Log Rotation","text":"<p>Application logs are written to <code>/app/storage/logs/</code>. Implement log rotation:</p> <pre><code># Logrotate config\n/app/storage/logs/*.log {\n    daily\n    rotate 7\n    compress\n    missingok\n    notifempty\n}\n</code></pre>"},{"location":"deployment/#unraid-deployment","title":"Unraid Deployment","text":""},{"location":"deployment/#community-applications","title":"Community Applications","text":"<p>Search for \"Pathary\" in Unraid Community Applications (if available).</p>"},{"location":"deployment/#manual-template","title":"Manual Template","text":"<pre><code>&lt;?xml version=\"1.0\"?&gt;\n&lt;Container version=\"2\"&gt;\n  &lt;Name&gt;pathary&lt;/Name&gt;\n  &lt;Repository&gt;ghcr.io/benjaminmue/pathary:latest&lt;/Repository&gt;\n  &lt;Network&gt;bridge&lt;/Network&gt;\n  &lt;Privileged&gt;false&lt;/Privileged&gt;\n  &lt;Config Name=\"Web UI\" Target=\"80\" Default=\"8080\" Mode=\"tcp\" Description=\"Web interface\" Type=\"Port\" Display=\"always\" Required=\"true\" Mask=\"false\"&gt;8080&lt;/Config&gt;\n  &lt;Config Name=\"TMDB API Key\" Target=\"TMDB_API_KEY\" Default=\"\" Mode=\"\" Description=\"TMDB API key\" Type=\"Variable\" Display=\"always\" Required=\"true\" Mask=\"true\"/&gt;\n  &lt;Config Name=\"Storage\" Target=\"/app/storage\" Default=\"/mnt/user/appdata/pathary\" Mode=\"rw\" Description=\"Application data\" Type=\"Path\" Display=\"always\" Required=\"true\" Mask=\"false\"/&gt;\n&lt;/Container&gt;\n</code></pre>"},{"location":"deployment/#updates","title":"Updates","text":""},{"location":"deployment/#update-docker-image","title":"Update Docker Image","text":"<pre><code>docker compose pull\ndocker compose up -d\n</code></pre>"},{"location":"deployment/#check-version","title":"Check Version","text":"<p>The application version is displayed in Settings \u2192 App.</p>"},{"location":"deployment/#troubleshooting-deployment","title":"Troubleshooting Deployment","text":""},{"location":"deployment/#container-wont-start","title":"Container Won't Start","text":"<pre><code># Check logs\ndocker logs pathary\n\n# Common issues:\n# - Missing TMDB_API_KEY\n# - Database connection failed\n# - Migration error\n</code></pre>"},{"location":"deployment/#502-bad-gateway","title":"502 Bad Gateway","text":"<ul> <li>Check if container is running: <code>docker ps</code></li> <li>Check proxy headers are correct</li> <li>Verify network connectivity between proxy and container</li> </ul>"},{"location":"deployment/#https-issues","title":"HTTPS Issues","text":"<p>Ensure <code>APPLICATION_URL</code> includes <code>https://</code> and your proxy forwards <code>X-Forwarded-Proto: https</code>.</p>"},{"location":"deployment/#permission-errors","title":"Permission Errors","text":"<pre><code># Fix storage permissions\ndocker exec pathary chown -R www-data:www-data /app/storage\ndocker exec pathary chmod -R 755 /app/storage\n</code></pre>"},{"location":"deployment/#related-pages","title":"Related Pages","text":"<ul> <li>Getting Started] - Initial setup</li> <li>Logging and Troubleshooting] - Debugging</li> <li>Migrations] - Database updates</li> </ul> <p>\u2190 Back to Wiki Home</p>"},{"location":"faq/","title":"FAQ","text":"<p>Q: Will Pathary support tv shows or other media types?</p> <p>A: Currently there is no active development for supporting more media types. Contributions in that directions are welcome!</p> <p>Q: Can I share my history and ratings publicly?</p> <p>A: Yes, you can set (e.g. via <code>/settings</code> page) your <code>Privacy</code> levels and decide who is allowed to view your data. All page urls starting with <code>/users/&lt;username&gt;/...</code> (= pages with a user selector at the top) can be set to be publicly visible.</p>"},{"location":"getting-started/","title":"Getting Started","text":"<p>This guide covers how to set up and run Pathary locally.</p>"},{"location":"getting-started/#requirements","title":"Requirements","text":"<ul> <li>Docker and Docker Compose (recommended)</li> <li>TMDB API Key - Required for movie search (Get one here)</li> </ul> <p>For manual installation: - PHP 8.2+ - MySQL 8.0+ or SQLite 3 - Composer</p>"},{"location":"getting-started/#quick-start-with-docker","title":"Quick Start with Docker","text":""},{"location":"getting-started/#1-clone-the-repository","title":"1. Clone the Repository","text":"<pre><code>git clone https://github.com/benjaminmue/pathary.git\ncd pathary\n</code></pre>"},{"location":"getting-started/#2-create-local-environment-file","title":"2. Create Local Environment File","text":"<p>IMPORTANT: For local development, use <code>.env.local</code> instead of modifying <code>.env</code>:</p> <pre><code>cat &gt; .env.local &lt;&lt; 'EOF'\nTMDB_API_KEY=your_actual_key_here\nHTTP_PORT=80\nAPPLICATION_URL=http://localhost\nEOF\n</code></pre> <p>Why <code>.env.local</code>? - <code>.env.local</code> is in <code>.gitignore</code> and will never be committed - Keeps your API keys and local config safe from accidental commits - <code>.env</code> remains as the example/template file</p>"},{"location":"getting-started/#3-start-the-application","title":"3. Start the Application","text":"<p>For local development with MySQL:</p> <pre><code>docker compose --env-file .env.local \\\n  -f docker-compose.yml \\\n  -f docker-compose.development.yml \\\n  -f docker-compose.mysql.yml \\\n  up -d\n</code></pre> <p>For production deployment, use your deployment-specific env file or environment variables.</p> <p>The application will be available at <code>http://localhost/</code> (port 80).</p> <p>Port Note: The app must be reachable on port 80 for proper routing. The docker-compose configuration maps host port 80 to container port 8080.</p>"},{"location":"getting-started/#4-first-user-creation","title":"4. First User Creation","text":"<p>On first launch with no users in the database: 1. Navigate to <code>http://localhost</code> 2. You'll be redirected to <code>/landing</code> (first-run page) 3. Click to create your first admin user 4. Fill in username, email, and password</p> <p>Code path: <code>src/HttpController/Web/LandingPageController.php</code></p>"},{"location":"getting-started/#environment-variables","title":"Environment Variables","text":""},{"location":"getting-started/#required","title":"Required","text":"Variable Description <code>TMDB_API_KEY</code> Your TMDB API key for movie data"},{"location":"getting-started/#optional-general","title":"Optional - General","text":"Variable Default Description <code>APPLICATION_URL</code> - Public URL (e.g., <code>https://pathary.example.com</code>) <code>APPLICATION_NAME</code> <code>Pathary</code> Displayed in navbar and emails <code>TIMEZONE</code> <code>UTC</code> PHP timezone (list)"},{"location":"getting-started/#optional-database","title":"Optional - Database","text":"Variable Default Description <code>DATABASE_MODE</code> <code>sqlite</code> <code>sqlite</code> or <code>mysql</code> <code>DATABASE_SQLITE</code> <code>storage/movary.sqlite</code> SQLite file path <code>DATABASE_MYSQL_HOST</code> - MySQL host <code>DATABASE_MYSQL_PORT</code> <code>3306</code> MySQL port <code>DATABASE_MYSQL_NAME</code> - Database name <code>DATABASE_MYSQL_USER</code> - Database user <code>DATABASE_MYSQL_PASSWORD</code> - Database password <code>DATABASE_MYSQL_CHARSET</code> <code>utf8mb4</code> Character set"},{"location":"getting-started/#optional-logging","title":"Optional - Logging","text":"Variable Default Description <code>LOG_LEVEL</code> <code>warning</code> RFC 5424 level (debug, info, warning, error) <code>LOG_ENABLE_STACKTRACE</code> <code>0</code> Include stack traces in logs <code>LOG_ENABLE_FILE_LOGGING</code> <code>1</code> Write logs to <code>storage/logs/</code>"},{"location":"getting-started/#optional-docker","title":"Optional - Docker","text":"Variable Default Description <code>HTTP_PORT</code> <code>80</code> Web server port <code>USER_ID</code> <code>3000</code> Container user ID <code>GROUP_ID</code> <code>3000</code> Container group ID"},{"location":"getting-started/#docker-compose-examples","title":"Docker Compose Examples","text":""},{"location":"getting-started/#sqlite-simple-setup","title":"SQLite (Simple Setup)","text":"<pre><code>services:\n  pathary:\n    image: ghcr.io/benjaminmue/pathary:latest\n    ports:\n      - \"80:80\"\n    environment:\n      - TMDB_API_KEY=your_key_here\n    volumes:\n      - pathary-storage:/app/storage\n\nvolumes:\n  pathary-storage:\n</code></pre>"},{"location":"getting-started/#mysql-production-setup","title":"MySQL (Production Setup)","text":"<pre><code>services:\n  pathary:\n    image: ghcr.io/benjaminmue/pathary:latest\n    ports:\n      - \"80:80\"\n    environment:\n      - TMDB_API_KEY=your_key_here\n      - DATABASE_MODE=mysql\n      - DATABASE_MYSQL_HOST=mysql\n      - DATABASE_MYSQL_NAME=pathary\n      - DATABASE_MYSQL_USER=pathary\n      - DATABASE_MYSQL_PASSWORD=secret\n    volumes:\n      - pathary-storage:/app/storage\n    depends_on:\n      - mysql\n\n  mysql:\n    image: mysql:8.0\n    environment:\n      - MYSQL_DATABASE=pathary\n      - MYSQL_USER=pathary\n      - MYSQL_PASSWORD=secret\n      - MYSQL_ROOT_PASSWORD=rootsecret\n    volumes:\n      - mysql-data:/var/lib/mysql\n\nvolumes:\n  pathary-storage:\n  mysql-data:\n</code></pre>"},{"location":"getting-started/#common-startup-issues","title":"Common Startup Issues","text":""},{"location":"getting-started/#tmdb_api_key-not-set","title":"\"TMDB_API_KEY not set\"","text":"<p>Set the <code>TMDB_API_KEY</code> environment variable: <pre><code>export TMDB_API_KEY=your_key\ndocker compose up -d\n</code></pre></p>"},{"location":"getting-started/#database-migration-fails","title":"Database Migration Fails","text":"<p>Check database connectivity. For MySQL, ensure the database server is ready: <pre><code>docker compose logs pathary\n</code></pre></p> <p>Migrations retry 5 times with 5-second delays (see <code>build/scripts/entrypoint.sh</code>).</p>"},{"location":"getting-started/#permission-denied-on-storage","title":"Permission Denied on Storage","text":"<p>Ensure the storage volume is writable: <pre><code>docker exec pathary-app chmod -R 777 /app/storage\n</code></pre></p> <p>Or set matching <code>USER_ID</code>/<code>GROUP_ID</code> in your compose file.</p>"},{"location":"getting-started/#port-already-in-use","title":"Port Already in Use","text":"<p>If port 80 is already in use on your host, you can map to a different host port:</p> <pre><code>ports:\n  - \"8080:8080\"  # Use port 8080 on host\nenvironment:\n  - HTTP_PORT=8080\n  - APPLICATION_URL=http://localhost:8080\n</code></pre> <p>Important: Update <code>APPLICATION_URL</code> to match your chosen port to ensure internal redirects work correctly.</p>"},{"location":"getting-started/#next-steps","title":"Next Steps","text":"<ul> <li>Architecture] - Understand the codebase structure</li> <li>Authentication] - Learn about login and sessions</li> <li>Deployment] - Production deployment guide</li> </ul> <p>\u2190 Back to Wiki Home</p>"},{"location":"initial-user-setup/","title":"Initial User Setup","text":"<p>How to create the first user account for a fresh Pathary installation.</p>"},{"location":"initial-user-setup/#prerequisites","title":"Prerequisites","text":"<ul> <li>Pathary is running (Docker or local)</li> <li>Database migrations have been executed</li> <li>You have access to either the web interface or CLI</li> </ul>"},{"location":"initial-user-setup/#method-1-web-ui-recommended","title":"Method 1: Web UI (Recommended)","text":"<p>On a fresh install with no users, Pathary automatically redirects to the registration page.</p>"},{"location":"initial-user-setup/#steps","title":"Steps","text":"<ol> <li>Open <code>http://localhost:8080/</code> in your browser</li> <li>You'll be redirected to <code>/create-user</code></li> <li>Fill in the form:</li> <li>Email: <code>admin@example.com</code></li> <li>Username: <code>admin</code> (letters and numbers only)</li> <li>Password: minimum 8 characters</li> <li>Repeat Password: same as above</li> <li>Click Create</li> </ol> <p>The first user is automatically granted admin privileges.</p>"},{"location":"initial-user-setup/#why-this-works","title":"Why this works","text":"<p>When no users exist: - The <code>ServerHasNoUsers</code> middleware redirects all visitors to <code>/create-user</code> - The <code>ServerHasUsers</code> middleware allows access to the registration form - <code>CreateUserController</code> sets <code>isAdmin = true</code> for the first user</p>"},{"location":"initial-user-setup/#method-2-cli-command","title":"Method 2: CLI Command","text":"<p>Use the <code>user:create</code> command for headless or scripted setups.</p>"},{"location":"initial-user-setup/#docker","title":"Docker","text":"<pre><code>docker exec -it pathary php bin/console.php user:create \\\n  \"admin@example.com\" \\\n  \"YourSecurePassword123\" \\\n  \"admin\" \\\n  true\n</code></pre>"},{"location":"initial-user-setup/#local-docker-compose","title":"Local / Docker Compose","text":"<pre><code># If using docker-compose\ndocker compose exec app php bin/console.php user:create \\\n  \"admin@example.com\" \\\n  \"YourSecurePassword123\" \\\n  \"admin\" \\\n  true\n\n# If running locally\nphp bin/console.php user:create \\\n  \"admin@example.com\" \\\n  \"YourSecurePassword123\" \\\n  \"admin\" \\\n  true\n</code></pre>"},{"location":"initial-user-setup/#command-arguments","title":"Command Arguments","text":"Argument Required Description <code>email</code> Yes Valid email address <code>password</code> Yes Minimum 8 characters <code>name</code> Yes Username (letters and numbers only, e.g. <code>admin123</code>) <code>isAdmin</code> No <code>true</code> or <code>false</code> (default: <code>false</code>)"},{"location":"initial-user-setup/#example-output","title":"Example Output","text":"<pre><code>User created.\n</code></pre>"},{"location":"initial-user-setup/#error-messages","title":"Error Messages","text":"Error Cause <code>Email already in use</code> Email exists in database <code>Password must contain at least 8 characters</code> Password too short <code>Name must only consist of numbers and letters</code> Invalid characters in username <code>Name already in use</code> Username already taken"},{"location":"initial-user-setup/#method-3-direct-database-insert-last-resort","title":"Method 3: Direct Database Insert (Last Resort)","text":"<p>Only use this if Methods 1 and 2 fail.</p>"},{"location":"initial-user-setup/#generate-password-hash","title":"Generate Password Hash","text":"<pre><code>php -r \"echo password_hash('YourSecurePassword123', PASSWORD_DEFAULT) . PHP_EOL;\"\n</code></pre> <p>Output example: <pre><code>$2y$10$abcdefghijklmnopqrstuv.wxyzABCDEFGHIJKLMNOPQRS\n</code></pre></p>"},{"location":"initial-user-setup/#insert-user","title":"Insert User","text":"<pre><code>INSERT INTO user (email, password, name, is_admin, created_at)\nVALUES (\n  'admin@example.com',\n  '$2y$10$YOUR_GENERATED_HASH_HERE',\n  'admin',\n  1,\n  datetime('now')\n);\n</code></pre> <p>For MySQL, use <code>NOW()</code> instead of <code>datetime('now')</code>.</p>"},{"location":"initial-user-setup/#required-columns","title":"Required Columns","text":"Column Type Description <code>email</code> string Unique email address <code>password</code> string bcrypt hash from <code>password_hash()</code> <code>name</code> string Unique username (alphanumeric) <code>is_admin</code> int <code>1</code> for admin, <code>0</code> for regular user <code>created_at</code> datetime Account creation timestamp"},{"location":"initial-user-setup/#troubleshooting","title":"Troubleshooting","text":""},{"location":"initial-user-setup/#403-forbidden-on-create-user","title":"\"403 Forbidden\" on /create-user","text":"<p>Cause: Users already exist in database, and <code>ENABLE_REGISTRATION=0</code> (default).</p> <p>Solutions: - Use CLI method instead - Set <code>ENABLE_REGISTRATION=1</code> environment variable (then disable after) - Use admin panel at <code>/settings/users</code> if you have an admin account</p>"},{"location":"initial-user-setup/#404-not-found-on-create-user","title":"\"404 Not Found\" on /create-user","text":"<p>Cause: URL rewriting not configured.</p> <p>Solution: Ensure Apache <code>.htaccess</code> is present in <code>public/</code> directory and <code>mod_rewrite</code> is enabled.</p>"},{"location":"initial-user-setup/#database-connection-errors","title":"Database connection errors","text":"<p>Cause: Database not configured or migrations not run.</p> <p>Solutions: <pre><code># Check database mode\necho $DATABASE_MODE\n\n# Run migrations (Docker)\ndocker exec -it pathary php bin/console.php database:migration:migrate\n\n# Run migrations (local)\nphp bin/console.php database:migration:migrate\n</code></pre></p>"},{"location":"initial-user-setup/#could-not-create-user-with-no-details","title":"\"Could not create user\" with no details","text":"<p>Cause: Generic error, check logs.</p> <p>Solution: <pre><code># View logs (Docker)\ndocker logs pathary\n\n# View logs (local)\ncat storage/logs/*.log\n</code></pre></p>"},{"location":"initial-user-setup/#cookiesession-issues-after-login","title":"Cookie/session issues after login","text":"<p>Cause: Browser blocking cookies or <code>APPLICATION_URL</code> mismatch.</p> <p>Solutions: - Ensure <code>APPLICATION_URL</code> matches how you access the app - Clear browser cookies for the domain - Check browser console for cookie warnings</p>"},{"location":"initial-user-setup/#verification-checklist","title":"Verification Checklist","text":"<p>After creating your first user:</p> <ul> <li> Login works at <code>/login</code></li> <li> Dashboard loads after login</li> <li> Can search for movies</li> <li> Can add a movie to library</li> <li> Can rate a movie (1-7 popcorns)</li> <li> Admin settings accessible at <code>/settings/users</code> (if admin)</li> </ul>"},{"location":"initial-user-setup/#user-management-commands","title":"User Management Commands","text":"<pre><code># List all users\nphp bin/console.php user:list\n\n# Update user\nphp bin/console.php user:update &lt;userId&gt; --email=\"new@email.com\"\n\n# Delete user\nphp bin/console.php user:delete &lt;userId&gt;\n</code></pre>"},{"location":"issue-labels/","title":"Issue Labels","text":"<p>This page documents the GitHub Issue label taxonomy for Pathary.</p> <p>\ud83d\udccc View actual labels with colors \u2192</p>"},{"location":"issue-labels/#label-requirements","title":"Label Requirements","text":"<p>Every issue MUST have: - Exactly one Type label - Exactly one Priority label - At least one Area label</p> <p>Optional labels: - Status labels for workflow tracking</p>"},{"location":"issue-labels/#label-groups","title":"Label Groups","text":""},{"location":"issue-labels/#type-labels","title":"Type Labels","text":"<p>Choose exactly one:</p> Label Description Something isn't working correctly New feature or request Improvements or additions to documentation Security issues or implementations Performance optimization issues Code quality improvements without new features Maintenance tasks (dependencies, tooling, CI)"},{"location":"issue-labels/#priority-labels","title":"Priority Labels","text":"<p>Choose exactly one:</p> Label Description Critical/Blocker - Must be fixed immediately High priority - Should be addressed soon Medium priority - Normal timeline Low priority - Nice to have"},{"location":"issue-labels/#area-labels","title":"Area Labels","text":"<p>Choose one or more:</p> Label Description Authentication &amp; user management Two-factor authentication Email functionality (SMTP, OAuth, notifications) Admin panel &amp; server management User interface &amp; frontend Movie tracking &amp; ratings TMDB API integration Database schema &amp; migrations Docker &amp; containerization API endpoints &amp; integrations"},{"location":"issue-labels/#status-labels-optional","title":"Status Labels (Optional)","text":"Label Description Needs initial review and categorization Ready for development Currently being worked on Blocked by dependencies or external factors Waiting for more information from reporter"},{"location":"issue-labels/#community-generic-labels","title":"Community &amp; Generic Labels","text":"Label Description Good for newcomers Extra attention is needed This issue or pull request already exists This doesn't seem right Further information is requested This will not be worked on"},{"location":"issue-labels/#triage-checklist","title":"Triage Checklist","text":"<p>When creating or triaging an issue:</p> <ol> <li>Pick Type - What kind of issue? (bug, enhancement, security, etc.)</li> <li>Pick Priority - How urgent? (p0, p1, p2, p3)</li> <li>Pick Area(s) - Which part of codebase? (auth, ui, database, etc.)</li> <li>Add Status (optional) - Where in workflow? (triage, ready, in-progress, blocked)</li> </ol>"},{"location":"issue-labels/#examples","title":"Examples","text":""},{"location":"issue-labels/#security-vulnerability","title":"Security Vulnerability","text":"<p>Issue: \"XSS vulnerability in user profile form\"</p> <p>Labels:  </p>"},{"location":"issue-labels/#feature-request","title":"Feature Request","text":"<p>Issue: \"Add email notifications for new ratings\"</p> <p>Labels:  </p>"},{"location":"issue-labels/#performance-issue","title":"Performance Issue","text":"<p>Issue: \"Movie list page loads slowly with 1000+ movies\"</p> <p>Labels:  </p>"},{"location":"issue-labels/#documentation-update","title":"Documentation Update","text":"<p>Issue: \"Add OAuth setup instructions to wiki\"</p> <p>Labels:  </p>"},{"location":"issue-labels/#questions","title":"Questions?","text":"<p>If unsure which labels to apply, add  and a maintainer will review during triage.</p>"},{"location":"migrations/","title":"Migrations","text":"<p>This page covers database schema management using Phinx migrations.</p>"},{"location":"migrations/#overview","title":"Overview","text":"<p>Pathary uses Phinx for database migrations. Migrations are PHP classes that define schema changes.</p>"},{"location":"migrations/#migration-locations","title":"Migration Locations","text":"<pre><code>db/migrations/\n\u251c\u2500\u2500 mysql/      # MySQL-specific migrations\n\u2514\u2500\u2500 sqlite/     # SQLite-specific migrations\n</code></pre> <p>Each database type has its own migration set due to syntax differences.</p>"},{"location":"migrations/#configuration","title":"Configuration","text":"<p>File: <code>settings/phinx.php</code></p> <pre><code>return [\n    'paths' =&gt; [\n        'migrations' =&gt; '%%PHINX_CONFIG_DIR%%/../db/migrations/' . $databaseMode,\n    ],\n    'environments' =&gt; [\n        'default_environment' =&gt; $databaseMode,\n        'mysql' =&gt; [\n            'adapter' =&gt; 'mysql',\n            'host' =&gt; $config-&gt;getAsString('DATABASE_MYSQL_HOST'),\n            'name' =&gt; $config-&gt;getAsString('DATABASE_MYSQL_NAME'),\n            'user' =&gt; $config-&gt;getAsString('DATABASE_MYSQL_USER'),\n            'pass' =&gt; $config-&gt;getAsString('DATABASE_MYSQL_PASSWORD'),\n            // ...\n        ],\n        'sqlite' =&gt; [\n            'adapter' =&gt; 'sqlite',\n            'name' =&gt; $config-&gt;getAsString('DATABASE_SQLITE'),\n        ],\n    ],\n];\n</code></pre>"},{"location":"migrations/#when-migrations-run","title":"When Migrations Run","text":""},{"location":"migrations/#automatic-container-startup","title":"Automatic (Container Startup)","text":"<p>File: <code>build/scripts/entrypoint.sh</code></p> <pre><code>if [ \"$DATABASE_DISABLE_AUTO_MIGRATION\" != \"true\" ]; then\n  RETRY_COUNT=0\n  MAX_RETRIES=5\n\n  while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do\n    /usr/bin/php /app/bin/console.php database:migration:migrate\n\n    if [ $? -eq 0 ]; then\n      echo \"SUCCESS: Automatic database migration succeeded\"\n      break\n    else\n      RETRY_COUNT=$((RETRY_COUNT + 1))\n      echo \"ERROR: Automatic database migration failed, attempt $RETRY_COUNT\"\n      sleep 5\n    fi\n  done\nfi\n</code></pre> <p>Key behaviors: - Runs on every container start (unless disabled) - Retries up to 5 times with 5-second delays - Useful for waiting on database availability</p>"},{"location":"migrations/#disable-auto-migration","title":"Disable Auto-Migration","text":"<pre><code>DATABASE_DISABLE_AUTO_MIGRATION=true\n</code></pre>"},{"location":"migrations/#manual-execution","title":"Manual Execution","text":"<pre><code># Inside container\nphp bin/console.php database:migration:migrate\n\n# From host via Docker\ndocker exec pathary-app php bin/console.php database:migration:migrate\n</code></pre>"},{"location":"migrations/#cli-commands","title":"CLI Commands","text":""},{"location":"migrations/#check-status","title":"Check Status","text":"<pre><code>docker exec pathary-app php bin/console.php database:migration:status\n</code></pre> <p>Output: <pre><code> Status  [Migration ID]   Migration Name\n-----------------------------------------\n     up  20210124104021   SetupBaseTables\n     up  20220510185016   AddUser\n     up  20251214000000   AddWatchedDateAndLocationToMovieUserRating\n</code></pre></p>"},{"location":"migrations/#run-migrations","title":"Run Migrations","text":"<pre><code># Run all pending\ndocker exec pathary-app php bin/console.php database:migration:migrate\n\n# Dry run (show what would run)\ndocker exec pathary-app php bin/console.php database:migration:migrate --dry-run\n</code></pre>"},{"location":"migrations/#rollback","title":"Rollback","text":"<pre><code># Rollback last migration\ndocker exec pathary-app php bin/console.php database:migration:rollback\n\n# Rollback to specific version\ndocker exec pathary-app php bin/console.php database:migration:rollback -t 20220510185016\n</code></pre>"},{"location":"migrations/#migration-structure","title":"Migration Structure","text":""},{"location":"migrations/#file-naming","title":"File Naming","text":"<pre><code>{timestamp}_{MigrationName}.php\n\nExample:\n20251214000000_AddWatchedDateAndLocationToMovieUserRating.php\n</code></pre> <p>The timestamp format is <code>YYYYMMDDHHmmss</code>.</p>"},{"location":"migrations/#migration-class","title":"Migration Class","text":"<pre><code>&lt;?php declare(strict_types=1);\n\nuse Phinx\\Migration\\AbstractMigration;\n\nfinal class AddWatchedDateAndLocationToMovieUserRating extends AbstractMigration\n{\n    public function up() : void\n    {\n        $this-&gt;execute(\n            &lt;&lt;&lt;SQL\n            ALTER TABLE movie_user_rating\n                ADD COLUMN watched_year SMALLINT UNSIGNED DEFAULT NULL,\n                ADD COLUMN watched_month TINYINT UNSIGNED DEFAULT NULL,\n                ADD COLUMN watched_day TINYINT UNSIGNED DEFAULT NULL,\n                ADD COLUMN location_id TINYINT UNSIGNED DEFAULT NULL;\n            SQL,\n        );\n    }\n\n    public function down() : void\n    {\n        $this-&gt;execute(\n            &lt;&lt;&lt;SQL\n            ALTER TABLE movie_user_rating\n                DROP COLUMN watched_year,\n                DROP COLUMN watched_month,\n                DROP COLUMN watched_day,\n                DROP COLUMN location_id;\n            SQL,\n        );\n    }\n}\n</code></pre>"},{"location":"migrations/#creating-a-new-migration","title":"Creating a New Migration","text":""},{"location":"migrations/#1-create-migration-file","title":"1. Create Migration File","text":"<p>Create matching files for both MySQL and SQLite:</p> <pre><code># MySQL\ntouch db/migrations/mysql/20251215120000_AddNewFeature.php\n\n# SQLite\ntouch db/migrations/sqlite/20251215120000_AddNewFeature.php\n</code></pre>"},{"location":"migrations/#2-write-migration-logic","title":"2. Write Migration Logic","text":"<p>MySQL version (<code>db/migrations/mysql/20251215120000_AddNewFeature.php</code>):</p> <pre><code>&lt;?php declare(strict_types=1);\n\nuse Phinx\\Migration\\AbstractMigration;\n\nfinal class AddNewFeature extends AbstractMigration\n{\n    public function up() : void\n    {\n        $this-&gt;execute(\n            &lt;&lt;&lt;SQL\n            ALTER TABLE movie ADD COLUMN new_field VARCHAR(256) DEFAULT NULL;\n            SQL,\n        );\n    }\n\n    public function down() : void\n    {\n        $this-&gt;execute(\n            &lt;&lt;&lt;SQL\n            ALTER TABLE movie DROP COLUMN new_field;\n            SQL,\n        );\n    }\n}\n</code></pre> <p>SQLite version (<code>db/migrations/sqlite/20251215120000_AddNewFeature.php</code>):</p> <pre><code>&lt;?php declare(strict_types=1);\n\nuse Phinx\\Migration\\AbstractMigration;\n\nfinal class AddNewFeature extends AbstractMigration\n{\n    public function up() : void\n    {\n        // SQLite requires separate ALTER statements\n        $this-&gt;execute('ALTER TABLE movie ADD COLUMN new_field TEXT DEFAULT NULL;');\n    }\n\n    public function down() : void\n    {\n        // SQLite &lt;3.35 doesn't support DROP COLUMN\n        // Use table recreation for older versions\n        $this-&gt;execute(\n            &lt;&lt;&lt;SQL\n            CREATE TABLE movie_backup AS SELECT ... FROM movie;\n            DROP TABLE movie;\n            CREATE TABLE movie (...);\n            INSERT INTO movie SELECT ... FROM movie_backup;\n            DROP TABLE movie_backup;\n            SQL,\n        );\n    }\n}\n</code></pre>"},{"location":"migrations/#3-test-migration","title":"3. Test Migration","text":"<pre><code># Run migration\ndocker exec pathary-app php bin/console.php database:migration:migrate\n\n# Check status\ndocker exec pathary-app php bin/console.php database:migration:status\n\n# Test rollback\ndocker exec pathary-app php bin/console.php database:migration:rollback\n</code></pre>"},{"location":"migrations/#conventions","title":"Conventions","text":""},{"location":"migrations/#naming","title":"Naming","text":"<ul> <li>Use descriptive names: <code>AddCommentToMovieUserRating</code>, <code>RemoveDeprecatedColumn</code></li> <li>Match class name to filename</li> </ul>"},{"location":"migrations/#sql-syntax","title":"SQL Syntax","text":"<ul> <li>MySQL and SQLite have different syntax for some operations</li> <li>Always create both versions</li> <li>Test both database modes</li> </ul>"},{"location":"migrations/#down-methods","title":"Down Methods","text":"<ul> <li>Always implement <code>down()</code> for rollback capability</li> <li>Be careful with data loss (DROP COLUMN deletes data)</li> </ul>"},{"location":"migrations/#indexes","title":"Indexes","text":"<pre><code>// MySQL\n$this-&gt;execute('CREATE INDEX idx_name ON table(column);');\n\n// SQLite\n$this-&gt;execute('CREATE INDEX IF NOT EXISTS idx_name ON table(column);');\n</code></pre>"},{"location":"migrations/#troubleshooting","title":"Troubleshooting","text":""},{"location":"migrations/#migration-fails-on-startup","title":"Migration Fails on Startup","text":"<p>Check logs: <pre><code>docker compose logs pathary\n</code></pre></p> <p>Common causes: - Database not ready (retries should help) - Syntax error in migration - Missing database permissions</p>"},{"location":"migrations/#table-already-exists","title":"\"Table already exists\"","text":"<p>If a migration partially ran: <pre><code># Check migration status\ndocker exec pathary-app php bin/console.php database:migration:status\n\n# Manually mark as run (if table exists)\n# Edit phinxlog table directly\n</code></pre></p>"},{"location":"migrations/#rollback-fails","title":"Rollback Fails","text":"<ul> <li>Check that <code>down()</code> is implemented</li> <li>Verify rollback SQL is valid</li> <li>Some operations (data deletion) cannot be undone</li> </ul>"},{"location":"migrations/#sqlite-drop-column-issues","title":"SQLite DROP COLUMN Issues","text":"<p>SQLite versions before 3.35.0 don't support <code>DROP COLUMN</code>. Use table recreation:</p> <pre><code>public function down() : void\n{\n    // Create backup without the column\n    $this-&gt;execute('CREATE TABLE tmp AS SELECT col1, col2 FROM original;');\n    $this-&gt;execute('DROP TABLE original;');\n    $this-&gt;execute('ALTER TABLE tmp RENAME TO original;');\n}\n</code></pre>"},{"location":"migrations/#migration-history","title":"Migration History","text":"<p>The <code>phinxlog</code> table tracks which migrations have run:</p> <pre><code>SELECT * FROM phinxlog ORDER BY version DESC LIMIT 5;\n</code></pre> version migration_name start_time end_time breakpoint 20251214000000 AddWatchedDateAndLocation 2025-12-14 15:30:00 2025-12-14 15:30:01 0"},{"location":"migrations/#related-pages","title":"Related Pages","text":"<ul> <li>Database] - Schema overview</li> <li>Getting Started] - Initial setup</li> <li>Deployment] - Production considerations</li> </ul> <p>\u2190 Back to Wiki Home</p>"},{"location":"oauth-email-setup/","title":"OAuth Email Setup Guide","text":"<p>This guide explains how to configure OAuth 2.0 authentication for sending emails from Pathary using Gmail or Microsoft 365.</p>"},{"location":"oauth-email-setup/#table-of-contents","title":"Table of Contents","text":"<ul> <li>Overview</li> <li>Prerequisites</li> <li>Gmail OAuth Setup</li> <li>Microsoft 365 OAuth Setup</li> <li>Pathary Configuration</li> <li>Testing</li> <li>Troubleshooting</li> </ul>"},{"location":"oauth-email-setup/#overview","title":"Overview","text":"<p>OAuth 2.0 email authentication provides enhanced security over traditional SMTP password authentication:</p> <ul> <li>No passwords stored - Uses OAuth access tokens instead of passwords</li> <li>Granular permissions - Only grants email sending permissions</li> <li>Automatic token refresh - Tokens refresh automatically without re-authorization</li> <li>Revocable access - Can revoke access from provider without changing password</li> </ul> <p>Supported Providers: - Gmail - Personal Gmail or Google Workspace accounts - Microsoft 365 - Microsoft 365 / Outlook.com accounts</p>"},{"location":"oauth-email-setup/#prerequisites","title":"Prerequisites","text":""},{"location":"oauth-email-setup/#1-enable-https-production","title":"1. Enable HTTPS (Production)","text":"<p>OAuth providers require HTTPS for redirect URIs (except localhost). Configure your reverse proxy (Nginx, Caddy, Traefik) with SSL/TLS certificates.</p> <p>Example Nginx configuration: <pre><code>server {\n    listen 443 ssl http2;\n    server_name pathary.example.com;\n\n    ssl_certificate /path/to/cert.pem;\n    ssl_certificate_key /path/to/key.pem;\n\n    location / {\n        proxy_pass http://localhost:80;\n        proxy_set_header Host $host;\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header X-Forwarded-Proto $scheme;\n    }\n}\n</code></pre></p>"},{"location":"oauth-email-setup/#2-set-application_url","title":"2. Set APPLICATION_URL","text":"<p>Set the <code>APPLICATION_URL</code> environment variable to match your public URL:</p> <pre><code># .env or .env.local\nAPPLICATION_URL=https://pathary.example.com\n</code></pre> <p>For local development: <pre><code>APPLICATION_URL=http://localhost\n</code></pre></p>"},{"location":"oauth-email-setup/#3-generate-encryption-key","title":"3. Generate Encryption Key","text":"<p>Generate a strong encryption key for storing OAuth secrets:</p> <pre><code>openssl rand -hex 32\n</code></pre> <p>Set as environment variable: <pre><code>ENCRYPTION_KEY=your_generated_64_character_hex_string\n</code></pre></p> <p>Or generate via Pathary UI: Admin \u2192 Server Management \u2192 Email Settings \u2192 OAuth tab \u2192 \"Generate Encryption Key\"</p>"},{"location":"oauth-email-setup/#gmail-oauth-setup","title":"Gmail OAuth Setup","text":""},{"location":"oauth-email-setup/#step-1-create-google-cloud-project","title":"Step 1: Create Google Cloud Project","text":"<ol> <li>Go to Google Cloud Console</li> <li>Click Select a project \u2192 New Project</li> <li>Project name: <code>Pathary Email OAuth</code> (or any name you prefer)</li> <li>Organization: Select your organization (if applicable)</li> <li>Click Create</li> </ol>"},{"location":"oauth-email-setup/#step-2-enable-gmail-api","title":"Step 2: Enable Gmail API","text":"<ol> <li>In your project, go to APIs &amp; Services \u2192 Library</li> <li>Search for Gmail API</li> <li>Click on it and click Enable</li> <li>Wait for activation to complete</li> </ol>"},{"location":"oauth-email-setup/#step-3-configure-oauth-consent-screen","title":"Step 3: Configure OAuth Consent Screen","text":"<ol> <li>Go to APIs &amp; Services \u2192 OAuth consent screen</li> <li>User Type:</li> <li>Internal (for Google Workspace - only users in your organization)</li> <li>External (for personal Gmail - available to any Google account)</li> <li>Click Create</li> </ol> <p>Fill in the form: - App name: <code>Pathary</code> - User support email: Your email address - App logo: (Optional) Upload Pathary logo - Application home page: Your Pathary URL (e.g., <code>https://pathary.example.com</code>) - Authorized domains: Your domain (e.g., <code>example.com</code>) - Developer contact information: Your email address</p> <ol> <li>Click Save and Continue</li> <li>Scopes: Skip this step (Pathary uses Gmail API scope, not Graph scopes)</li> <li>Click Save and Continue</li> <li>Test users (if External): Add email addresses that can use OAuth during testing</li> <li>Click Save and Continue</li> <li>Review summary and click Back to Dashboard</li> </ol>"},{"location":"oauth-email-setup/#step-4-create-oauth-20-client-id","title":"Step 4: Create OAuth 2.0 Client ID","text":"<ol> <li>Go to APIs &amp; Services \u2192 Credentials</li> <li>Click Create Credentials \u2192 OAuth client ID</li> <li>Application type: Select Web application</li> <li>Name: <code>Pathary Email Client</code> (or any name you prefer)</li> </ol> <p>Configure Authorized Redirect URIs: 5. Under Authorized redirect URIs, click Add URI 6. Enter your OAuth callback URL:    - Format: <code>{APPLICATION_URL}/admin/server/email/oauth/callback</code>    - Example production: <code>https://pathary.example.com/admin/server/email/oauth/callback</code>    - Example local: <code>http://localhost/admin/server/email/oauth/callback</code></p> <ol> <li>Click Create</li> </ol> <p>Save Credentials: 8. A popup shows your Client ID and Client Secret 9. Copy both values - you'll need them for Pathary configuration 10. Click OK</p>"},{"location":"oauth-email-setup/#step-5-configure-in-pathary","title":"Step 5: Configure in Pathary","text":"<ol> <li>Go to Admin \u2192 Server Management \u2192 Email Settings \u2192 OAuth tab</li> <li>Email Provider: Select Gmail</li> <li>Client ID: Paste the Client ID from step 8</li> <li>Client Secret: Paste the Client Secret from step 8</li> <li>From Address: Enter your Gmail address (e.g., <code>noreply@example.com</code>)</li> <li>Click Save OAuth Settings</li> </ol>"},{"location":"oauth-email-setup/#step-6-authorize-gmail-account","title":"Step 6: Authorize Gmail Account","text":"<ol> <li>Click Connect button</li> <li>You'll be redirected to Google sign-in</li> <li>Sign in with your Gmail account</li> <li>Grant permissions: Review and click Allow</li> <li>You should see: \"Pathary wants to access your Google Account\"</li> <li>Permission: \"Read, compose, send, and permanently delete all your email from Gmail\"</li> <li>You'll be redirected back to Pathary</li> <li>You should see \"OAuth authorization successful!\"</li> </ol>"},{"location":"oauth-email-setup/#step-7-verify-connection","title":"Step 7: Verify Connection","text":"<ol> <li>Check Connection Status shows \"Connected\" with green checkmark</li> <li>Token Status should show \"Active\"</li> <li>Click Send Test Email to verify</li> </ol>"},{"location":"oauth-email-setup/#microsoft-365-oauth-setup","title":"Microsoft 365 OAuth Setup","text":""},{"location":"oauth-email-setup/#step-1-register-app-in-azure-portal","title":"Step 1: Register App in Azure Portal","text":"<ol> <li>Go to Azure Portal</li> <li>Navigate to Azure Active Directory (or Microsoft Entra ID)</li> <li>Click App registrations in left sidebar</li> <li>Click New registration</li> </ol> <p>Fill in the form: - Name: <code>Pathary Email OAuth</code> (or any name you prefer) - Supported account types:   - Single tenant (only your organization) - Recommended   - Multitenant (any Azure AD directory) - If you have multiple tenants   - Personal accounts - Include personal Microsoft accounts - Redirect URI:   - Platform: Web   - URI: Your OAuth callback URL (e.g., <code>https://pathary.example.com/admin/server/email/oauth/callback</code>)</p> <ol> <li>Click Register</li> </ol> <p>Save Application Details: 6. On the Overview page, note down:    - Application (client) ID - You'll need this for Pathary    - Directory (tenant) ID - You'll need this for Pathary</p>"},{"location":"oauth-email-setup/#step-2-create-client-secret","title":"Step 2: Create Client Secret","text":"<ol> <li>In your app, go to Certificates &amp; secrets in left sidebar</li> <li>Click Client secrets tab</li> <li>Click New client secret</li> <li>Description: <code>Pathary Email OAuth Secret</code></li> <li>Expires: Select expiration period</li> <li>Recommended: 24 months (maximum)</li> <li>Important: You must renew before expiration</li> <li>Click Add</li> <li>Copy the secret Value immediately - it will only be shown once!</li> </ol>"},{"location":"oauth-email-setup/#step-3-add-api-permissions","title":"Step 3: Add API Permissions","text":"<p>This is the most critical step for Microsoft 365 OAuth to work correctly.</p>"},{"location":"oauth-email-setup/#add-office-365-exchange-online-permissions","title":"Add Office 365 Exchange Online Permissions","text":"<ol> <li>Go to API permissions in left sidebar</li> <li>Click Add a permission</li> <li>Click APIs my organization uses tab</li> <li>Search for Office 365 Exchange Online</li> <li>Click on it</li> <li>Click Delegated permissions</li> <li>Check SMTP.Send</li> <li>Click Add permissions</li> </ol>"},{"location":"oauth-email-setup/#add-microsoft-graph-permissions","title":"Add Microsoft Graph Permissions","text":"<ol> <li>Click Add a permission again</li> <li>Click Microsoft Graph</li> <li>Click Delegated permissions</li> <li>Search and check:<ul> <li>User.Read</li> <li>offline_access</li> </ul> </li> <li>Click Add permissions</li> </ol>"},{"location":"oauth-email-setup/#grant-admin-consent","title":"Grant Admin Consent","text":"<ol> <li>Click Grant admin consent for [Your Organization] button</li> <li>Click Yes to confirm</li> <li>Wait for status to update - all permissions should show green checkmarks under \"Status\"</li> </ol> <p>Expected permissions list: <pre><code>API / Permissions name          Type           Status\n\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\nMicrosoft Graph\n  offline_access                Delegated      \u2713 Granted\n  User.Read                     Delegated      \u2713 Granted\n\nOffice 365 Exchange Online\n  SMTP.Send                     Delegated      \u2713 Granted\n</code></pre></p>"},{"location":"oauth-email-setup/#step-4-enable-smtp-auth-critical","title":"Step 4: Enable SMTP AUTH (Critical!)","text":"<p>Microsoft 365 requires SMTP AUTH to be enabled at both tenant and mailbox levels.</p>"},{"location":"oauth-email-setup/#check-tenant-level-smtp-auth","title":"Check Tenant-Level SMTP AUTH","text":"<p>Connect to Exchange Online PowerShell: <pre><code>Install-Module -Name ExchangeOnlineManagement\nConnect-ExchangeOnline -UserPrincipalName admin@yourdomain.com\n</code></pre></p> <p>Check if SMTP AUTH is enabled: <pre><code>Get-OrganizationConfig | Select-Object SmtpClientAuthenticationDisabled\n</code></pre></p> <p>If <code>SmtpClientAuthenticationDisabled</code> is <code>True</code>, enable it: <pre><code>Set-OrganizationConfig -SmtpClientAuthenticationDisabled $false\n</code></pre></p>"},{"location":"oauth-email-setup/#check-mailbox-level-smtp-auth","title":"Check Mailbox-Level SMTP AUTH","text":"<p>Check specific mailbox: <pre><code>Get-CASMailbox -Identity mail@yourdomain.com | Select-Object SmtpClientAuthenticationDisabled\n</code></pre></p> <p>If disabled, enable it: <pre><code>Set-CASMailbox -Identity mail@yourdomain.com -SmtpClientAuthenticationDisabled $false\n</code></pre></p>"},{"location":"oauth-email-setup/#create-authentication-policy-alternative","title":"Create Authentication Policy (Alternative)","text":"<p>If you want to enable SMTP AUTH only for specific mailboxes:</p> <pre><code># Create policy\nNew-AuthenticationPolicy -Name \"Allow SMTP AUTH\" -AllowBasicAuthSmtp\n\n# Assign to mailbox\nSet-User -Identity mail@yourdomain.com -AuthenticationPolicy \"Allow SMTP AUTH\"\n</code></pre>"},{"location":"oauth-email-setup/#step-5-optional-register-service-principal","title":"Step 5: (Optional) Register Service Principal","text":"<p>For enhanced permissions (SendAs), register the app as a service principal:</p> <pre><code># Get app details from Azure Portal Overview page\n$appId = \"f2da336d-56cd-4e18-b426-b4567b0ca98c\"  # Application (client) ID\n$objectId = \"bdb51601-5178-4fb3-b4ad-f1e79fef5016\"  # Object ID\n\n# Register service principal\nNew-ServicePrincipal -AppId $appId -ServiceId $objectId\n\n# Grant SendAs permission\nAdd-RecipientPermission -Identity 'mail@yourdomain.com' -Trustee $objectId -AccessRights SendAs\n</code></pre>"},{"location":"oauth-email-setup/#step-6-configure-in-pathary","title":"Step 6: Configure in Pathary","text":"<ol> <li>Go to Admin \u2192 Server Management \u2192 Email Settings \u2192 OAuth tab</li> <li>Email Provider: Select Microsoft 365 / Outlook</li> <li>Client ID: Paste the Application (client) ID from Azure</li> <li>Client Secret: Paste the secret Value from step 2</li> <li>Tenant ID: Paste the Directory (tenant) ID from Azure</li> <li>Authentication Mailbox: Enter your Microsoft 365 email (e.g., <code>mail@yourdomain.com</code>)</li> <li>Email From Address: (Optional) Different from address (e.g., <code>noreply@yourdomain.com</code>)</li> <li>Click Save OAuth Settings</li> </ol>"},{"location":"oauth-email-setup/#step-7-authorize-microsoft-account","title":"Step 7: Authorize Microsoft Account","text":"<ol> <li>Click Connect button</li> <li>You'll be redirected to Microsoft sign-in</li> <li>Sign in with your Microsoft 365 account</li> <li>Grant permissions: Review and click Accept</li> <li>You should see: \"Pathary wants to access your account\"</li> <li>Permissions requested:<ul> <li>Send mail as you</li> <li>Maintain access to data you have given it access to</li> <li>Sign you in and read your profile</li> </ul> </li> <li>You'll be redirected back to Pathary</li> <li>You should see \"OAuth authorization successful!\"</li> </ol>"},{"location":"oauth-email-setup/#step-8-verify-connection","title":"Step 8: Verify Connection","text":"<ol> <li>Check Connection Status shows \"Connected\" with green checkmark</li> <li>Token Status should show \"Active\"</li> <li>Granted Scopes should include:</li> <li><code>SMTP.Send</code></li> <li><code>User.Read</code></li> <li><code>offline_access</code></li> <li>Click Send Test Email to verify</li> </ol>"},{"location":"oauth-email-setup/#pathary-configuration","title":"Pathary Configuration","text":""},{"location":"oauth-email-setup/#access-oauth-settings","title":"Access OAuth Settings","text":"<ol> <li>Log in to Pathary as admin</li> <li>Go to Admin \u2192 Server Management</li> <li>Click Email Settings section</li> <li>Click OAuth tab</li> </ol>"},{"location":"oauth-email-setup/#configuration-fields","title":"Configuration Fields","text":"<p>Email Provider: - Select <code>Gmail</code> or <code>Microsoft 365 / Outlook</code> - Shows provider-specific setup instructions when selected</p> <p>Client ID: - Gmail: From Google Cloud Console \u2192 Credentials - Microsoft: Application (client) ID from Azure Portal</p> <p>Client Secret: - Gmail: From Google Cloud Console \u2192 Credentials - Microsoft: Secret Value from Azure Portal (Certificates &amp; secrets)</p> <p>Tenant ID (Microsoft 365 only): - Directory (tenant) ID from Azure Portal - Leave blank for multi-tenant apps (uses <code>common</code>)</p> <p>Authentication Mailbox: - The email account used for OAuth authorization - Gmail: Your Gmail address (e.g., <code>you@gmail.com</code>) - Microsoft: Your Microsoft 365 address (e.g., <code>mail@yourdomain.com</code>)</p> <p>Email From Address (Optional): - Different email shown as sender - Must be an alias or have SendAs permissions - Leave blank to use Authentication Mailbox as From address</p> <p>Secret Expiry Reminder (Optional): - Set reminder for client secret expiration (Microsoft 365) - Recommended: Set to 23 months if secret expires in 24 months - Pathary will show warning when expiry approaches</p>"},{"location":"oauth-email-setup/#switch-between-password-and-oauth","title":"Switch Between Password and OAuth","text":"<p>Switch to OAuth: 1. Configure OAuth settings in OAuth tab 2. Click Connect to authorize 3. Click Switch to OAuth Mode button 4. All emails will now use OAuth authentication</p> <p>Switch to Password: 1. Go to Password tab 2. Configure SMTP settings (host, port, username, password) 3. Click Save SMTP Settings 4. Click Switch to Password Mode button 5. All emails will now use password authentication</p> <p>Note: OAuth configuration is preserved when switching modes.</p>"},{"location":"oauth-email-setup/#testing","title":"Testing","text":""},{"location":"oauth-email-setup/#send-test-email","title":"Send Test Email","text":"<ol> <li>Go to Admin \u2192 Server Management \u2192 Email Settings</li> <li>Click Send Test Email button</li> <li>Check your inbox for test email</li> <li>Email subject: \"Test Email from Pathary\"</li> <li>Email body: \"This is a test email sent to check the currently set email settings.\"</li> </ol>"},{"location":"oauth-email-setup/#verify-token-refresh","title":"Verify Token Refresh","text":"<p>OAuth tokens expire after 1 hour. Pathary automatically refreshes them using the refresh token.</p> <p>Monitor token refresh: 1. Check Last Token Refresh timestamp in OAuth tab 2. Send test email after 1 hour 3. Token should refresh automatically 4. Token Status should remain \"Active\"</p>"},{"location":"oauth-email-setup/#check-logs","title":"Check Logs","text":"<p>If email sending fails, check logs:</p> <pre><code># Docker logs\ndocker compose logs app\n\n# Look for errors containing:\n# - \"OAuth\"\n# - \"SMTP\"\n# - \"Failed to refresh\"\n# - \"Authentication unsuccessful\"\n</code></pre>"},{"location":"oauth-email-setup/#troubleshooting","title":"Troubleshooting","text":""},{"location":"oauth-email-setup/#gmail-issues","title":"Gmail Issues","text":""},{"location":"oauth-email-setup/#error-redirect_uri_mismatch","title":"Error: \"redirect_uri_mismatch\"","text":"<p>Cause: Redirect URI in Pathary doesn't match Google Cloud Console configuration.</p> <p>Fix: 1. Check <code>APPLICATION_URL</code> environment variable matches your domain 2. Go to Google Cloud Console \u2192 Credentials \u2192 Your OAuth Client 3. Verify Authorized redirect URIs contains exact URL:    - <code>{APPLICATION_URL}/admin/server/email/oauth/callback</code> 4. Update if needed and try again</p>"},{"location":"oauth-email-setup/#error-invalid_scope","title":"Error: \"invalid_scope\"","text":"<p>Cause: Gmail API not enabled in Google Cloud project.</p> <p>Fix: 1. Go to Google Cloud Console \u2192 APIs &amp; Services \u2192 Library 2. Search for \"Gmail API\" 3. Click Enable 4. Wait a few minutes and try again</p>"},{"location":"oauth-email-setup/#error-access-blocked-this-apps-request-is-invalid","title":"Error: \"Access blocked: This app's request is invalid\"","text":"<p>Cause: OAuth consent screen not configured or missing required fields.</p> <p>Fix: 1. Go to Google Cloud Console \u2192 APIs &amp; Services \u2192 OAuth consent screen 2. Ensure all required fields are filled:    - App name    - User support email    - Developer contact information 3. Click Save and Continue</p>"},{"location":"oauth-email-setup/#no-refresh-token-received","title":"No refresh token received","text":"<p>Cause: OAuth consent screen not showing or user previously authorized.</p> <p>Fix: 1. Revoke access: https://myaccount.google.com/permissions 2. Find \"Pathary\" and click Remove access 3. Reconnect OAuth in Pathary 4. You should see consent screen asking for permissions</p>"},{"location":"oauth-email-setup/#microsoft-365-issues","title":"Microsoft 365 Issues","text":""},{"location":"oauth-email-setup/#error-535-573-authentication-unsuccessful","title":"Error: \"535 5.7.3 Authentication unsuccessful\"","text":"<p>This is the most common Microsoft 365 OAuth error. Several possible causes:</p> <p>Cause 1: Wrong token audience</p> <p>The token is requested for Azure AD Graph instead of Exchange Online.</p> <p>Fix: Verify code uses correct configuration (already fixed in Pathary): <pre><code>// OAuthTokenService.php and EmailService.php\n'defaultEndPointVersion' =&gt; Azure::ENDPOINT_VERSION_2_0,\n'urlAPI' =&gt; 'https://outlook.office365.com/',\n'resource' =&gt; 'https://outlook.office365.com/',\n</code></pre></p> <p>Cause 2: Missing SMTP.Send scope</p> <p>The app doesn't have Exchange Online SMTP.Send permission.</p> <p>Fix: 1. Go to Azure Portal \u2192 App registrations \u2192 Your app \u2192 API permissions 2. Verify Office 365 Exchange Online \u2192 SMTP.Send exists and is granted 3. If missing, add it:    - Click Add a permission    - Click APIs my organization uses tab    - Search for Office 365 Exchange Online    - Select Delegated permissions \u2192 Check SMTP.Send    - Click Add permissions 4. Click Grant admin consent for [Organization] 5. Disconnect and reconnect OAuth in Pathary</p> <p>Verify granted scopes in database: <pre><code>SELECT granted_scopes FROM oauth_email_config;\n</code></pre> Should include: <code>SMTP.Send User.Read offline_access</code></p> <p>Cause 3: SMTP AUTH disabled</p> <p>SMTP protocol is disabled at tenant or mailbox level.</p> <p>Fix: <pre><code># Connect to Exchange Online\nConnect-ExchangeOnline\n\n# Check tenant level\nGet-OrganizationConfig | Select-Object SmtpClientAuthenticationDisabled\n\n# Enable if needed\nSet-OrganizationConfig -SmtpClientAuthenticationDisabled $false\n\n# Check mailbox level\nGet-CASMailbox -Identity mail@yourdomain.com | Select-Object SmtpClientAuthenticationDisabled\n\n# Enable if needed\nSet-CASMailbox -Identity mail@yourdomain.com -SmtpClientAuthenticationDisabled $false\n</code></pre></p> <p>Cause 4: Service principal not registered</p> <p>App not registered as service principal in Exchange Online.</p> <p>Fix: <pre><code># Get app details from Azure Portal\n$appId = \"YOUR-APPLICATION-CLIENT-ID\"\n$objectId = \"YOUR-APPLICATION-OBJECT-ID\"\n\n# Register service principal\nNew-ServicePrincipal -AppId $appId -ServiceId $objectId\n\n# Grant SendAs permission\nAdd-RecipientPermission -Identity 'mail@yourdomain.com' -Trustee $objectId -AccessRights SendAs\n</code></pre></p>"},{"location":"oauth-email-setup/#error-aadsts50011-redirect-uri-mismatch","title":"Error: \"AADSTS50011: redirect uri mismatch\"","text":"<p>Cause: Redirect URI in Pathary doesn't match Azure app registration.</p> <p>Fix: 1. Check <code>APPLICATION_URL</code> environment variable 2. Go to Azure Portal \u2192 App registrations \u2192 Your app \u2192 Authentication 3. Under Redirect URIs, verify exact URL exists:    - <code>{APPLICATION_URL}/admin/server/email/oauth/callback</code> 4. Add if missing and click Save</p>"},{"location":"oauth-email-setup/#error-aadsts65001-the-user-or-administrator-has-not-consented","title":"Error: \"AADSTS65001: The user or administrator has not consented\"","text":"<p>Cause: Admin consent not granted for API permissions.</p> <p>Fix: 1. Go to Azure Portal \u2192 App registrations \u2192 Your app \u2192 API permissions 2. Click Grant admin consent for [Your Organization] 3. Click Yes to confirm 4. Verify all permissions show green checkmarks under \"Status\"</p>"},{"location":"oauth-email-setup/#error-aadsts7000218-the-request-body-must-contain-the-following-parameter-client_assertion-or-client_secret","title":"Error: \"AADSTS7000218: The request body must contain the following parameter: 'client_assertion' or 'client_secret'\"","text":"<p>Cause: Client secret expired or invalid.</p> <p>Fix: 1. Go to Azure Portal \u2192 App registrations \u2192 Your app \u2192 Certificates &amp; secrets 2. Check if secret is expired under Client secrets 3. If expired, create new secret:    - Click New client secret    - Set expiration period    - Click Add    - Copy the Value immediately 4. Update client secret in Pathary OAuth settings 5. Click Save OAuth Settings 6. Disconnect and reconnect OAuth</p>"},{"location":"oauth-email-setup/#error-invalid_grant-or-token-has-been-revoked","title":"Error: \"invalid_grant\" or \"Token has been revoked\"","text":"<p>Cause: Refresh token expired or user revoked access.</p> <p>Fix: 1. Go to Pathary \u2192 Admin \u2192 Email Settings \u2192 OAuth tab 2. Click Disconnect 3. Click Connect to re-authorize 4. Sign in and grant permissions again</p>"},{"location":"oauth-email-setup/#cant-find-office-365-exchange-online-in-api-permissions","title":"Can't find \"Office 365 Exchange Online\" in API permissions","text":"<p>Cause: You're looking in the wrong tab.</p> <p>Fix: 1. Click Add a permission 2. Important: Click APIs my organization uses tab (NOT \"Microsoft APIs\") 3. Search for Office 365 Exchange Online 4. Select it 5. Choose Delegated permissions 6. Check SMTP.Send</p>"},{"location":"oauth-email-setup/#general-issues","title":"General Issues","text":""},{"location":"oauth-email-setup/#error-oauth-configuration-not-found","title":"Error: \"OAuth configuration not found\"","text":"<p>Cause: OAuth settings not saved.</p> <p>Fix: 1. Go to Admin \u2192 Email Settings \u2192 OAuth tab 2. Fill in all required fields 3. Click Save OAuth Settings 4. Verify \"Settings saved successfully\" message</p>"},{"location":"oauth-email-setup/#error-encryption_key-not-configured","title":"Error: \"ENCRYPTION_KEY not configured\"","text":"<p>Cause: Encryption key not set.</p> <p>Fix: Option 1 - Generate via UI: 1. Go to Admin \u2192 Email Settings \u2192 OAuth tab 2. Click Generate Encryption Key 3. Key is automatically saved</p> <p>Option 2 - Set environment variable: <pre><code># Generate key\nopenssl rand -hex 32\n\n# Add to .env or .env.local\nENCRYPTION_KEY=your_generated_64_character_hex_string\n\n# Restart container\ndocker compose restart app\n</code></pre></p>"},{"location":"oauth-email-setup/#connection-shows-connected-but-emails-fail","title":"Connection shows \"Connected\" but emails fail","text":"<p>Cause: Email auth mode not set to OAuth.</p> <p>Fix: 1. Check database:    <pre><code>SELECT value FROM server_setting WHERE key = 'email_auth_mode';\n</code></pre> 2. If not <code>smtp_oauth</code>, set it:    <pre><code>INSERT INTO server_setting (key, value)\nVALUES ('email_auth_mode', 'smtp_oauth')\nON DUPLICATE KEY UPDATE value = 'smtp_oauth';\n</code></pre> 3. Or use UI: Click Switch to OAuth Mode button</p>"},{"location":"oauth-email-setup/#token-status-shows-error","title":"Token Status shows \"Error\"","text":"<p>Cause: Token refresh failed.</p> <p>Fix: 1. Check error message in Token Status field 2. Common errors:    - \"invalid_client\": Client ID or secret incorrect \u2192 Update credentials    - \"invalid_grant\": Refresh token expired \u2192 Disconnect and reconnect    - \"unauthorized_client\": Missing API permissions \u2192 Add required permissions 3. Click Disconnect and Connect again to re-authorize</p>"},{"location":"oauth-email-setup/#smtp-connect-failed","title":"SMTP connect() failed","text":"<p>Cause: Wrong SMTP host or port for OAuth provider.</p> <p>Fix: OAuth mode uses provider defaults (cannot be changed): - Gmail: <code>smtp.gmail.com:587</code> (TLS) - Microsoft 365: <code>smtp.office365.com:587</code> (TLS)</p> <p>Verify <code>email_auth_mode</code> is set to <code>smtp_oauth</code> (not <code>smtp_password</code>).</p>"},{"location":"oauth-email-setup/#security-considerations","title":"Security Considerations","text":""},{"location":"oauth-email-setup/#client-secret-rotation","title":"Client Secret Rotation","text":"<p>Microsoft 365 client secrets expire (max 24 months). Plan ahead:</p> <ol> <li>Set Secret Expiry Reminder in Pathary to 23 months</li> <li>Before expiry, create new secret in Azure Portal</li> <li>Update client secret in Pathary</li> <li>Click Disconnect and Connect to get new token</li> <li>Delete old secret in Azure Portal</li> </ol> <p>Gmail client secrets don't expire unless you regenerate them.</p>"},{"location":"oauth-email-setup/#revoking-access","title":"Revoking Access","text":"<p>Gmail: 1. Go to https://myaccount.google.com/permissions 2. Find \"Pathary\" 3. Click Remove access</p> <p>Microsoft 365: 1. Go to https://myaccount.microsoft.com/privacy/app-permissions 2. Find \"Pathary Email OAuth\" 3. Click Remove</p> <p>Or via Azure Portal: 1. Azure Portal \u2192 Enterprise applications 2. Find your app 3. Click Delete or revoke user consent</p>"},{"location":"oauth-email-setup/#encryption-key-rotation","title":"Encryption Key Rotation","text":"<p>If you rotate <code>ENCRYPTION_KEY</code>:</p> <ol> <li>All stored secrets become inaccessible</li> <li>You must reconnect OAuth for all providers</li> <li>Plan rotation during maintenance window</li> </ol>"},{"location":"oauth-email-setup/#audit-logging","title":"Audit Logging","text":"<p>Monitor OAuth authorization attempts:</p> <pre><code>SELECT * FROM security_audit_log\nWHERE event_type = 'oauth_authorization'\nORDER BY created_at DESC\nLIMIT 20;\n</code></pre>"},{"location":"oauth-email-setup/#additional-resources","title":"Additional Resources","text":"<ul> <li>Google OAuth 2.0 Documentation</li> <li>Microsoft Identity Platform OAuth 2.0</li> <li>Office 365 Exchange Online SMTP AUTH</li> <li>Pathary GitHub Repository</li> <li>Pathary Issues</li> </ul>"},{"location":"oauth-email-setup/#getting-help","title":"Getting Help","text":"<p>If you encounter issues not covered in this guide:</p> <ol> <li>Check Pathary logs: <code>docker compose logs app</code></li> <li>Verify all prerequisites are met</li> <li>Search existing issues</li> <li>Create a new issue with:</li> <li>Provider (Gmail or Microsoft 365)</li> <li>Error message</li> <li>Steps to reproduce</li> <li>Log output (redact secrets!)</li> </ol>"},{"location":"oauth-monitoring-setup/","title":"OAuth Token Monitoring Setup Guide","text":"<p>This guide explains the automated OAuth token monitoring system for Email OAuth connections in Pathary.</p>"},{"location":"oauth-monitoring-setup/#overview","title":"Overview","text":"<p>The OAuth monitoring system automatically checks the health of your Email OAuth connection (Gmail or Microsoft 365) and alerts administrators when action is needed. This prevents email sending failures due to expired or revoked OAuth tokens.</p> <p>No configuration required - monitoring runs automatically when users visit the site.</p>"},{"location":"oauth-monitoring-setup/#features","title":"Features","text":"<ul> <li>Automatic Health Checks: Runs on page loads without requiring cron jobs or scheduled tasks</li> <li>Smart Throttling: Checks run at most every 6 hours to avoid overhead</li> <li>Multi-Tier Alerts: Warnings at 45, 30, and 15 days before recommended refresh</li> <li>Admin Notifications: Email alerts to all administrators</li> <li>Admin Popup Banner: Visual alerts when admins login (dismissible for 3 hours)</li> <li>Event Logging: All monitoring events logged to Admin \u2192 Events</li> <li>System Health Dashboard: OAuth status visible in System Health (future feature)</li> </ul>"},{"location":"oauth-monitoring-setup/#how-it-works","title":"How It Works","text":""},{"location":"oauth-monitoring-setup/#lazy-monitoring","title":"Lazy Monitoring","text":"<p>Pathary uses a \"lazy monitoring\" approach where OAuth health checks are triggered automatically when any user visits the site:</p> <ol> <li>On Page Load: Every web request checks if monitoring should run</li> <li>Time-Based Throttling: Monitoring only runs if at least 6 hours have passed since the last check</li> <li>Database Locking: Concurrent requests are prevented via database locks</li> <li>Non-Blocking: Monitoring runs in the background and doesn't slow down page loads</li> </ol> <p>This approach means: - \u2705 No cron jobs to configure - \u2705 No external schedulers needed - \u2705 Works in any hosting environment (Unraid, VPS, Docker, etc.) - \u2705 Monitoring happens automatically as long as someone uses the site - \u26a0\ufe0f Requires occasional site visits (at least once every 6 hours for timely alerts)</p>"},{"location":"oauth-monitoring-setup/#monitoring-interval","title":"Monitoring Interval","text":"<p>The system runs health checks at most every 6 hours. This interval balances: - Timely detection of OAuth issues - Minimal overhead on page loads - Reduced API calls to OAuth providers</p> <p>If you need more frequent checks, you can visit any page in Pathary to trigger a check (if 6+ hours have elapsed).</p>"},{"location":"oauth-monitoring-setup/#alert-schedule","title":"Alert Schedule","text":"Threshold Alert Level Notification Frequency 45 days before refresh needed Warning Once, then weekly 30 days before refresh needed Warning Once, then every 3 days 15 days before refresh needed Critical Once, then daily Token refresh failing Critical Daily until resolved Re-authorization required Expired Immediate, then daily"},{"location":"oauth-monitoring-setup/#installation","title":"Installation","text":""},{"location":"oauth-monitoring-setup/#1-run-database-migration","title":"1. Run Database Migration","text":"<p>The OAuth monitoring system requires database schema changes. Run the migration:</p> <pre><code># In Docker (recommended)\ndocker compose exec app php vendor/bin/phinx migrate -c ./settings/phinx.php\n\n# Locally (if running without Docker)\nphp vendor/bin/phinx migrate -c ./settings/phinx.php\n</code></pre> <p>This adds: - Monitoring fields to <code>oauth_email_config</code> table - <code>oauth_admin_banner_ack</code> table for tracking banner acknowledgements</p>"},{"location":"oauth-monitoring-setup/#2-verify-installation","title":"2. Verify Installation","text":"<p>That's it! No additional configuration needed. The monitoring system is now active.</p> <p>To verify it's working:</p> <ol> <li> <p>Check the logs after visiting a page:    <pre><code>docker compose logs app | grep -i \"oauth monitoring\"\n\n# You should see entries like:\n# [INFO] Triggering lazy OAuth monitoring\n# [INFO] Lazy OAuth monitoring completed\n</code></pre></p> </li> <li> <p>Visit Admin \u2192 Events:</p> </li> <li>Login as admin</li> <li>Go to Admin \u2192 Events</li> <li>Filter by event type containing \"oauth\"</li> <li> <p>You should see monitoring events logged after 6+ hours of site activity</p> </li> <li> <p>Check last run time in the database (optional):    <pre><code>docker compose exec db mysql -u movary -p -e \"USE movary; SELECT * FROM server_setting WHERE \\`key\\` = 'oauth_monitoring_last_run_at';\"\n</code></pre></p> </li> </ol>"},{"location":"oauth-monitoring-setup/#monitoring-behavior","title":"Monitoring Behavior","text":""},{"location":"oauth-monitoring-setup/#health-evaluation-logic","title":"Health Evaluation Logic","text":"<p>The system evaluates OAuth health based on:</p> <ol> <li>Token Refresh Success: Can the system successfully refresh the access token?</li> <li>Days Since Last Refresh: How long since the last successful refresh?</li> <li>Error Patterns: What errors are occurring (if any)?</li> <li>Re-auth Required: Does the error indicate re-authorization is needed?</li> </ol>"},{"location":"oauth-monitoring-setup/#alert-level-determination","title":"Alert Level Determination","text":"<ul> <li>OK: Recent successful refresh, no failures</li> <li>Warning: Approaching recommended refresh interval (45/30/15 days)</li> <li>Critical: Token refresh failing or very close to recommended refresh</li> <li>Expired: Re-authorization required, token revoked, or refresh failing for 7+ days</li> </ul>"},{"location":"oauth-monitoring-setup/#notification-suppression","title":"Notification Suppression","text":"<p>Notifications are sent according to the schedule above and are suppressed if: - Already notified within the scheduled interval - Alert level has not escalated - Admin has acknowledged the banner within the last 3 hours (banner only)</p>"},{"location":"oauth-monitoring-setup/#admin-experience","title":"Admin Experience","text":""},{"location":"oauth-monitoring-setup/#email-notifications","title":"Email Notifications","text":"<p>Admins receive email alerts when thresholds are crossed. Emails include:</p> <ul> <li>Alert level (WARNING/CRITICAL/URGENT)</li> <li>Provider name (Gmail/Microsoft 365)</li> <li>Status message with details</li> <li>Days to action (if applicable)</li> <li>Last error details (if any)</li> <li>Direct link to Email Settings page</li> </ul> <p>Important: Emails are sent using fallback SMTP password authentication if OAuth is failing, ensuring you always receive alerts.</p>"},{"location":"oauth-monitoring-setup/#admin-banner","title":"Admin Banner","text":"<p>When admins visit any page in Pathary, they may see a modal banner if:</p> <ul> <li>OAuth connection requires attention (warn/critical/expired)</li> <li>Banner was not acknowledged in the last 3 hours</li> <li>Alert level has not been resolved</li> </ul> <p>The banner can be: - Acknowledged: Dismissed for 3 hours - Bypassed: Click \"Open Email Settings\" to address immediately</p> <p>If alert level escalates (e.g., warn \u2192 critical), banner shows immediately even if recently acknowledged.</p>"},{"location":"oauth-monitoring-setup/#admin-events-log","title":"Admin Events Log","text":"<p>All monitoring activities are logged to Admin \u2192 Events:</p> <ul> <li><code>oauth_token_warn_45/30/15</code> - Warning notifications sent</li> <li><code>oauth_token_warn_daily</code> - Daily critical alert sent</li> <li><code>oauth_token_expired</code> - Token expiry detected</li> <li><code>oauth_token_refresh_failed</code> - Token refresh failed</li> <li><code>oauth_token_refresh_recovered</code> - Token refresh recovered after failure</li> <li><code>oauth_banner_acknowledged</code> - Admin acknowledged banner</li> </ul> <p>Events include metadata: - Provider (gmail/microsoft) - Alert level - Error code (if applicable) - Re-auth required status</p>"},{"location":"oauth-monitoring-setup/#troubleshooting","title":"Troubleshooting","text":""},{"location":"oauth-monitoring-setup/#no-monitoring-events","title":"No Monitoring Events","text":"<p>Problem: No OAuth monitoring events appearing in Admin \u2192 Events</p> <p>Solutions: 1. Ensure database migration was run: <code>docker compose exec app php vendor/bin/phinx migrate -c ./settings/phinx.php</code> 2. Verify OAuth is configured: Admin \u2192 Email Settings \u2192 OAuth tab 3. Check if anyone has visited the site in the last 6 hours (monitoring needs page loads) 4. Check application logs: <code>docker compose logs app | grep -i oauth</code> 5. Visit a page and wait a moment, then check logs again</p>"},{"location":"oauth-monitoring-setup/#no-alerts-received","title":"No Alerts Received","text":"<p>Problem: OAuth may be failing but no alerts sent</p> <p>Solutions: 1. Verify monitoring is running: Check Admin \u2192 Events for recent <code>oauth_token_</code> events 2. Check if OAuth is actually configured: Admin \u2192 Email Settings \u2192 OAuth tab 3. Verify admin users have valid email addresses 4. Check application logs: <code>docker compose logs app | grep -i oauth</code> 5. Verify email sending works: Admin \u2192 Email Settings \u2192 Test Email</p>"},{"location":"oauth-monitoring-setup/#banner-not-showing","title":"Banner Not Showing","text":"<p>Problem: Admin banner not appearing</p> <p>Solutions: 1. Verify you're logged in as admin 2. Check OAuth alert level by visiting Admin \u2192 Email Settings \u2192 OAuth tab 3. Check browser console for JavaScript errors (F12 \u2192 Console) 4. Clear browser cache and reload page 5. Verify banner was not recently acknowledged: Check <code>oauth_admin_banner_ack</code> table</p>"},{"location":"oauth-monitoring-setup/#monitoring-running-too-frequently","title":"Monitoring Running Too Frequently","text":"<p>Problem: Monitoring appears to run on every page load</p> <p>Solutions: 1. Check database for last run time:    <pre><code>docker compose exec db mysql -u movary -p -e \"USE movary; SELECT * FROM server_setting WHERE \\`key\\` = 'oauth_monitoring_last_run_at';\"\n</code></pre> 2. Verify 6-hour interval is being enforced in logs 3. Check for database lock issues:    <pre><code>docker compose exec db mysql -u movary -p -e \"USE movary; SELECT * FROM server_setting WHERE \\`key\\` = 'oauth_monitoring_lock';\"\n</code></pre>    - If a lock is stuck, delete it: <code>DELETE FROM server_setting WHERE \\</code>key` = 'oauth_monitoring_lock';`</p>"},{"location":"oauth-monitoring-setup/#false-alerts","title":"False Alerts","text":"<p>Problem: Receiving alerts but OAuth is working fine</p> <p>Solutions: 1. Check if your OAuth provider has temporary issues 2. Review error codes in Admin \u2192 Events to identify pattern 3. If using Microsoft 365, verify SMTP AUTH is enabled at tenant level 4. Try reconnecting OAuth: Admin \u2192 Email Settings \u2192 OAuth \u2192 Disconnect \u2192 Connect</p>"},{"location":"oauth-monitoring-setup/#security-considerations","title":"Security Considerations","text":""},{"location":"oauth-monitoring-setup/#whats-logged","title":"What's Logged","text":"<p>The monitoring system logs: - Event types and timestamps - Provider names (gmail/microsoft) - Error codes (sanitized) - Alert levels - IP addresses of admin actions</p>"},{"location":"oauth-monitoring-setup/#whats-never-logged","title":"What's NEVER Logged","text":"<ul> <li>Access tokens</li> <li>Refresh tokens</li> <li>Client secrets</li> <li>Full error messages containing tokens</li> <li>Admin passwords</li> <li>Email content</li> </ul>"},{"location":"oauth-monitoring-setup/#data-retention","title":"Data Retention","text":"<ul> <li>Monitoring events follow the same retention as other security audit logs</li> <li>Banner acknowledgements are kept until replaced (one per admin user)</li> <li>Recommendation: Implement periodic cleanup of old audit logs (90 days)</li> </ul>"},{"location":"oauth-monitoring-setup/#advanced-configuration","title":"Advanced Configuration","text":""},{"location":"oauth-monitoring-setup/#adjusting-monitoring-interval","title":"Adjusting Monitoring Interval","text":"<p>Edit <code>src/Service/Email/OAuthLazyMonitoringService.php</code>:</p> <pre><code>// Run monitoring at most every X hours\nprivate const MIN_INTERVAL_SECONDS = 21600; // 6 hours (default)\n\n// Change to 3 hours:\nprivate const MIN_INTERVAL_SECONDS = 10800;\n\n// Change to 12 hours:\nprivate const MIN_INTERVAL_SECONDS = 43200;\n</code></pre> <p>Warning: More frequent checks increase database queries and OAuth provider API calls.</p>"},{"location":"oauth-monitoring-setup/#adjusting-alert-thresholds","title":"Adjusting Alert Thresholds","text":"<p>Edit <code>src/Service/Email/OAuthMonitoringService.php</code>:</p> <pre><code>// Health thresholds (days)\nprivate const THRESHOLD_45_DAYS = 45;  // First warning\nprivate const THRESHOLD_30_DAYS = 30;  // Second warning\nprivate const THRESHOLD_15_DAYS = 15;  // Critical warning\nprivate const DAILY_ALERT_START = 14;  // Start daily alerts\nprivate const MAX_DAYS_WITHOUT_REFRESH = 60; // Token age limit\n</code></pre> <p>Warning: Changing these values requires understanding OAuth refresh token lifecycle for your provider.</p>"},{"location":"oauth-monitoring-setup/#manual-health-check-for-testing","title":"Manual Health Check (For Testing)","text":"<p>You can force an immediate monitoring run by resetting the last run time:</p> <pre><code>docker compose exec db mysql -u movary -p -e \"USE movary; DELETE FROM server_setting WHERE \\`key\\` = 'oauth_monitoring_last_run_at';\"\n</code></pre> <p>Then visit any page in Pathary to trigger monitoring immediately.</p>"},{"location":"oauth-monitoring-setup/#disabling-features","title":"Disabling Features","text":"<p>Disable email notifications: Remove admin email addresses (banner will still work)</p> <p>Disable banner: Remove the banner include from <code>templates/layouts/app_base.twig</code></p> <p>Disable monitoring completely: Don't run the database migration</p>"},{"location":"oauth-monitoring-setup/#best-practices","title":"Best Practices","text":"<ol> <li>Visit the site regularly: Monitoring requires page loads, so ensure at least one admin checks the site daily</li> <li>Test email delivery: Before relying on email alerts, send a test email from Admin \u2192 Email Settings</li> <li>Document your OAuth setup: Keep records of client ID, tenant ID, and expiry dates</li> <li>Monitor the monitoring: Check Admin \u2192 Events periodically to ensure monitoring runs</li> <li>Act promptly on alerts: Don't wait until expiry to reconnect</li> <li>Keep refresh tokens fresh: Reconnect OAuth yearly even if not prompted</li> </ol>"},{"location":"oauth-monitoring-setup/#maintenance","title":"Maintenance","text":""},{"location":"oauth-monitoring-setup/#check-monitoring-status","title":"Check Monitoring Status","text":"<p>View recent monitoring activity:</p> <pre><code># Check logs\ndocker compose logs app | grep -i \"oauth monitoring\"\n\n# Check last run time\ndocker compose exec db mysql -u movary -p -e \"USE movary; SELECT * FROM server_setting WHERE \\`key\\` = 'oauth_monitoring_last_run_at';\"\n\n# Check for stuck locks\ndocker compose exec db mysql -u movary -p -e \"USE movary; SELECT * FROM server_setting WHERE \\`key\\` = 'oauth_monitoring_lock';\"\n</code></pre>"},{"location":"oauth-monitoring-setup/#force-immediate-check","title":"Force Immediate Check","text":"<p>Reset last run time and visit any page:</p> <pre><code>docker compose exec db mysql -u movary -p -e \"USE movary; DELETE FROM server_setting WHERE \\`key\\` = 'oauth_monitoring_last_run_at';\"\n</code></pre>"},{"location":"oauth-monitoring-setup/#cleanup-old-events","title":"Cleanup Old Events","text":"<p>Manually clean up old OAuth monitoring events:</p> <pre><code>DELETE FROM user_security_audit_log\nWHERE event_type LIKE 'oauth_%'\nAND created_at &lt; DATE_SUB(NOW(), INTERVAL 90 DAY);\n</code></pre> <p>Or programmatically (future feature): <pre><code>docker compose exec app php /app/bin/console.php audit:cleanup --days=90\n</code></pre></p>"},{"location":"oauth-monitoring-setup/#support","title":"Support","text":"<p>For issues or questions:</p> <ol> <li>Check application logs: <code>docker compose logs app</code></li> <li>Review Admin \u2192 Events for error patterns</li> <li>Test OAuth connection manually: Admin \u2192 Email Settings \u2192 OAuth \u2192 Test Connection</li> <li>Create an issue: https://github.com/benjaminmue/pathary/issues</li> </ol>"},{"location":"oauth-monitoring-setup/#future-enhancements","title":"Future Enhancements","text":"<p>Planned features: - System Health dashboard tile for OAuth status - Configurable thresholds via admin UI - Webhook notifications - Slack/Discord integration - Multi-tenant OAuth support - Manual \"Check Now\" button in admin UI</p>"},{"location":"oauth_database_schema/","title":"OAuth Email Configuration Database Schema","text":""},{"location":"oauth_database_schema/#design-decision","title":"Design Decision","text":"<p>Create a dedicated <code>oauth_email_config</code> table instead of using <code>server_setting</code> because: 1. MySQL Limitation: <code>server_setting.value</code> is VARCHAR(255), insufficient for encrypted tokens (typically 500+ chars) 2. Clear Security Boundary: Separate table makes encrypted data handling explicit 3. Better Type Safety: Can use appropriate column types for each field 4. Audit Trail: Can track OAuth-specific metadata separately</p>"},{"location":"oauth_database_schema/#table-schema","title":"Table Schema","text":""},{"location":"oauth_database_schema/#oauth_email_config","title":"oauth_email_config","text":"<p>Purpose: Store OAuth 2.0 configuration and tokens for email sending</p>"},{"location":"oauth_database_schema/#columns","title":"Columns","text":"Column Type (SQLite) Type (MySQL) Nullable Description <code>id</code> INTEGER INT(10) UNSIGNED NO Primary key, auto-increment <code>provider</code> TEXT VARCHAR(50) NO OAuth provider: 'gmail' or 'microsoft' <code>client_id</code> TEXT VARCHAR(255) NO Public OAuth client identifier <code>client_secret_encrypted</code> TEXT TEXT NO Encrypted client secret (AES-256-CBC + base64) <code>client_secret_iv</code> TEXT VARCHAR(255) NO Initialization vector for client_secret decryption <code>tenant_id</code> TEXT VARCHAR(255) YES Microsoft only: Azure AD tenant ID <code>refresh_token_encrypted</code> TEXT TEXT YES Encrypted refresh token (AES-256-CBC + base64) <code>refresh_token_iv</code> TEXT VARCHAR(255) YES Initialization vector for refresh_token decryption <code>from_address</code> TEXT VARCHAR(255) NO Email address to send from (must match OAuth account) <code>scopes</code> TEXT VARCHAR(500) YES OAuth scopes granted (space-separated) <code>token_status</code> TEXT VARCHAR(50) NO Status: 'not_connected', 'active', 'expired', 'error' <code>token_error</code> TEXT TEXT YES Last error message from OAuth provider <code>client_secret_expires_at</code> TEXT DATETIME YES When client secret expires (Microsoft only) <code>connected_at</code> TEXT DATETIME YES When OAuth connection was established <code>last_token_refresh_at</code> TEXT DATETIME YES Last time access token was refreshed <code>created_at</code> TEXT DATETIME NO Record creation timestamp <code>updated_at</code> TEXT DATETIME NO Record last update timestamp"},{"location":"oauth_database_schema/#constraints","title":"Constraints","text":"<ul> <li>PRIMARY KEY: <code>id</code></li> <li>UNIQUE: Only one OAuth configuration allowed (enforce at application layer)</li> <li>CHECK (SQLite 3.37+): <code>provider IN ('gmail', 'microsoft')</code></li> <li>CHECK (SQLite 3.37+): <code>token_status IN ('not_connected', 'active', 'expired', 'error')</code></li> </ul>"},{"location":"oauth_database_schema/#indexes","title":"Indexes","text":"<ul> <li>INDEX on <code>provider</code> (for future multi-config support)</li> <li>INDEX on <code>token_status</code> (for monitoring)</li> </ul>"},{"location":"oauth_database_schema/#email-authentication-mode","title":"Email Authentication Mode","text":"<p>Add to <code>server_setting</code> table: - Key: <code>emailAuthMode</code> - Values: 'smtp_password' (default) | 'smtp_oauth' - Purpose: Switch between password-based SMTP and OAuth-based SMTP</p>"},{"location":"oauth_database_schema/#encryption-strategy","title":"Encryption Strategy","text":""},{"location":"oauth_database_schema/#encryption-algorithm","title":"Encryption Algorithm","text":"<ul> <li>Algorithm: AES-256-CBC</li> <li>Key Source: <code>ENCRYPTION_KEY</code> environment variable (32 bytes)</li> <li>IV Storage: Separate column for each encrypted field</li> <li>Format: <code>base64_encode(openssl_encrypt($plaintext, 'AES-256-CBC', $key, 0, $iv))</code></li> </ul>"},{"location":"oauth_database_schema/#key-management","title":"Key Management","text":"<ol> <li>Production: Admin must set <code>ENCRYPTION_KEY</code> in <code>.env</code> or environment</li> <li>Development: Generate random key on first use, store in database</li> <li>Migration: Warn if key not set, prevent OAuth configuration until set</li> </ol>"},{"location":"oauth_database_schema/#encrypted-fields","title":"Encrypted Fields","text":"<ul> <li><code>client_secret_encrypted</code> + <code>client_secret_iv</code></li> <li><code>refresh_token_encrypted</code> + <code>refresh_token_iv</code></li> </ul>"},{"location":"oauth_database_schema/#non-encrypted-fields-why","title":"Non-Encrypted Fields (why)","text":"<ul> <li><code>client_id</code> - Public identifier, safe to store plain</li> <li><code>tenant_id</code> - Public Azure AD tenant GUID</li> <li><code>from_address</code> - Email address, needed for queries</li> <li><code>provider</code> - Metadata, not sensitive</li> </ul>"},{"location":"oauth_database_schema/#migration-strategy","title":"Migration Strategy","text":""},{"location":"oauth_database_schema/#step-1-create-table","title":"Step 1: Create Table","text":"<ul> <li>Migration: <code>CreateOAuthEmailConfigTable</code></li> <li>SQLite and MySQL versions</li> <li>No data migration needed (new feature)</li> </ul>"},{"location":"oauth_database_schema/#step-2-add-emailauthmode-setting","title":"Step 2: Add emailAuthMode Setting","text":"<ul> <li>Use existing <code>ServerSettings::updateValue()</code> method</li> <li>Default to 'smtp_password' (preserve existing behavior)</li> <li>No migration needed (key-value table)</li> </ul>"},{"location":"oauth_database_schema/#sample-data","title":"Sample Data","text":""},{"location":"oauth_database_schema/#gmail-configuration","title":"Gmail Configuration","text":"<pre><code>id: 1\nprovider: 'gmail'\nclient_id: '12345-abcdef.apps.googleusercontent.com'\nclient_secret_encrypted: 'base64encodedencryptedvalue'\nclient_secret_iv: 'randomiv123456'\ntenant_id: NULL\nrefresh_token_encrypted: 'base64encodedrefreshtoken'\nrefresh_token_iv: 'randomiv789012'\nfrom_address: 'noreply@example.com'\nscopes: 'https://mail.google.com/'\ntoken_status: 'active'\ntoken_error: NULL\nclient_secret_expires_at: NULL\nconnected_at: '2025-12-23 10:30:00'\nlast_token_refresh_at: '2025-12-23 14:15:00'\ncreated_at: '2025-12-23 10:25:00'\nupdated_at: '2025-12-23 14:15:00'\n</code></pre>"},{"location":"oauth_database_schema/#microsoft-365-configuration","title":"Microsoft 365 Configuration","text":"<pre><code>id: 1\nprovider: 'microsoft'\nclient_id: 'abc123-def456-ghi789'\nclient_secret_encrypted: 'base64encodedencryptedvalue'\nclient_secret_iv: 'randomiv123456'\ntenant_id: 'common' or 'tenant-guid-here'\nrefresh_token_encrypted: 'base64encodedrefreshtoken'\nrefresh_token_iv: 'randomiv789012'\nfrom_address: 'smtp@pathary.tv'\nscopes: 'offline_access https://outlook.office.com/SMTP.Send'\ntoken_status: 'active'\ntoken_error: NULL\nclient_secret_expires_at: '2027-12-23 00:00:00'\nconnected_at: '2025-12-23 10:30:00'\nlast_token_refresh_at: '2025-12-23 14:15:00'\ncreated_at: '2025-12-23 10:25:00'\nupdated_at: '2025-12-23 14:15:00'\n</code></pre>"},{"location":"oauth_database_schema/#security-considerations","title":"Security Considerations","text":""},{"location":"oauth_database_schema/#what-gets-encrypted","title":"What Gets Encrypted","text":"<ul> <li>\u2705 <code>client_secret</code> - OAuth client secret (sensitive credential)</li> <li>\u2705 <code>refresh_token</code> - Long-lived token (grants email access)</li> </ul>"},{"location":"oauth_database_schema/#what-doesnt-get-encrypted","title":"What Doesn't Get Encrypted","text":"<ul> <li>\u274c <code>client_id</code> - Public identifier, not sensitive</li> <li>\u274c <code>tenant_id</code> - Public directory identifier</li> <li>\u274c <code>from_address</code> - Email address, needed for queries/display</li> <li>\u274c <code>scopes</code> - OAuth scope strings, not sensitive</li> <li>\u274c <code>provider</code> - Provider name, metadata</li> <li>\u274c <code>token_status</code> - Status enum, metadata</li> <li>\u274c <code>token_error</code> - Error messages (may contain hints, but generally safe)</li> </ul>"},{"location":"oauth_database_schema/#access-tokens","title":"Access Tokens","text":"<ul> <li>NOT stored in database - too short-lived (1 hour)</li> <li>Generated on-demand from refresh_token when sending email</li> <li>Kept in memory only during email send operation</li> </ul>"},{"location":"oauth_database_schema/#backwards-compatibility","title":"Backwards Compatibility","text":""},{"location":"oauth_database_schema/#existing-smtp-password-users","title":"Existing SMTP Password Users","text":"<ul> <li>No impact - <code>server_setting</code> still has all SMTP fields</li> <li><code>emailAuthMode</code> defaults to 'smtp_password'</li> <li>Existing functionality preserved completely</li> </ul>"},{"location":"oauth_database_schema/#migration-path","title":"Migration Path","text":"<ol> <li>Existing users continue using password-based SMTP</li> <li>Admin can configure OAuth in new UI tab</li> <li>Admin switches <code>emailAuthMode</code> to 'smtp_oauth' when ready</li> <li>Can switch back to password at any time</li> </ol>"},{"location":"oauth_database_schema/#rollback-strategy","title":"Rollback Strategy","text":"<p>If OAuth fails or needs to be disabled: 1. Switch <code>emailAuthMode</code> back to 'smtp_password' 2. SMTP password fields still present and working 3. OAuth config remains in database (can reconnect later)</p>"},{"location":"oauth_database_schema/#future-enhancements","title":"Future Enhancements","text":""},{"location":"oauth_database_schema/#multi-account-support","title":"Multi-Account Support","text":"<p>Current design allows one OAuth config. Future enhancement: - Add <code>is_active</code> boolean to <code>oauth_email_config</code> - Remove uniqueness constraint - Allow multiple providers (select at send time)</p>"},{"location":"oauth_database_schema/#token-expiry-monitoring","title":"Token Expiry Monitoring","text":"<ul> <li>Cron job to check <code>client_secret_expires_at</code> (Microsoft)</li> <li>Email admin 30/7 days before expiry</li> <li>Dashboard warning when approaching expiry</li> </ul>"},{"location":"oauth_database_schema/#audit-logging","title":"Audit Logging","text":"<ul> <li>Log OAuth connection/disconnection events</li> <li>Track failed token refreshes</li> <li>Monitor unusual access patterns</li> </ul>"},{"location":"oauth_database_schema/#scope-expansion","title":"Scope Expansion","text":"<ul> <li>Add <code>requested_scopes</code> vs <code>granted_scopes</code> columns</li> <li>Support scope incremental authorization</li> <li>Detect missing scopes and prompt for re-auth</li> </ul> <p>Schema Version: 1.0 Last Updated: 2025-12-23 Author: Claude Code (Pathary OAuth Implementation)</p>"},{"location":"proxy/","title":"Reverse Proxy Configuration","text":"<p>Pathary works behind reverse proxies like Nginx, Traefik, Caddy, or HAProxy. This document covers the required configuration.</p>"},{"location":"proxy/#quick-setup","title":"Quick Setup","text":"<ol> <li>Set <code>APPLICATION_URL</code> to your public URL (e.g., <code>https://pathary.tv</code>)</li> <li>Configure your reverse proxy to forward required headers</li> <li>Ensure WebSocket/long-polling is not blocked (if using real-time features)</li> </ol>"},{"location":"proxy/#environment-variables","title":"Environment Variables","text":"Variable Required Description <code>APPLICATION_URL</code> Yes Your public-facing URL (e.g., <code>https://pathary.tv</code>). Must match the URL users access in their browser."},{"location":"proxy/#nginx-configuration","title":"Nginx Configuration","text":"<pre><code>server {\n    listen 443 ssl http2;\n    server_name pathary.tv;\n\n    # SSL configuration\n    ssl_certificate /path/to/cert.pem;\n    ssl_certificate_key /path/to/key.pem;\n\n    location / {\n        proxy_pass http://pathary-app:80;\n\n        # Required headers\n        proxy_set_header Host $host;\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header X-Forwarded-Proto $scheme;\n        proxy_set_header X-Forwarded-Host $host;\n\n        # WebSocket support (if needed)\n        proxy_http_version 1.1;\n        proxy_set_header Upgrade $http_upgrade;\n        proxy_set_header Connection \"upgrade\";\n\n        # Timeouts\n        proxy_connect_timeout 60s;\n        proxy_send_timeout 60s;\n        proxy_read_timeout 60s;\n    }\n}\n</code></pre>"},{"location":"proxy/#traefik-configuration","title":"Traefik Configuration","text":"<pre><code># docker-compose.yml with Traefik labels\nservices:\n  pathary:\n    labels:\n      - \"traefik.enable=true\"\n      - \"traefik.http.routers.pathary.rule=Host(`pathary.tv`)\"\n      - \"traefik.http.routers.pathary.entrypoints=websecure\"\n      - \"traefik.http.routers.pathary.tls=true\"\n      - \"traefik.http.services.pathary.loadbalancer.server.port=80\"\n</code></pre>"},{"location":"proxy/#caddy-configuration","title":"Caddy Configuration","text":"<pre><code>pathary.tv {\n    reverse_proxy pathary-app:80\n}\n</code></pre> <p>Caddy automatically handles forwarded headers and SSL.</p>"},{"location":"proxy/#required-proxy-headers","title":"Required Proxy Headers","text":"<p>These headers should be forwarded by your reverse proxy:</p> Header Purpose <code>Host</code> Original host header <code>X-Real-IP</code> Client's real IP address <code>X-Forwarded-For</code> Chain of proxy IPs <code>X-Forwarded-Proto</code> Original protocol (http/https) <code>X-Forwarded-Host</code> Original host requested by client"},{"location":"proxy/#x-movary-client-header","title":"X-Movary-Client Header","text":"<p>The <code>X-Movary-Client</code> header is used internally for API authentication to identify the client type. You do not need to configure this in your proxy - the web UI sends it automatically via JavaScript.</p> <p>If you see \"Missing request header X-Movary-Client\" errors: 1. This is handled automatically by the web interface 2. The application normalizes header casing to work with proxies that alter header case 3. No proxy configuration is needed for this header</p>"},{"location":"proxy/#cookie-settings","title":"Cookie Settings","text":"<p>When running behind HTTPS, cookies are automatically set with: - <code>Secure</code> flag (for HTTPS) - <code>SameSite=Lax</code> (CSRF protection)</p> <p>Ensure your proxy correctly forwards the <code>X-Forwarded-Proto: https</code> header so the application knows it's behind SSL.</p>"},{"location":"proxy/#troubleshooting","title":"Troubleshooting","text":""},{"location":"proxy/#login-fails-with-missing-request-header-x-movary-client","title":"Login fails with \"Missing request header X-Movary-Client\"","text":"<p>This error should not occur with recent versions. The application normalizes HTTP header casing to handle proxies that alter header case (e.g., converting <code>X-Movary-Client</code> to <code>x-movary-client</code>).</p> <p>If you still see this error: 1. Check browser developer tools \u2192 Network tab \u2192 look at the login request 2. Verify the <code>X-Movary-Client</code> header is present in the request 3. Check if your proxy is stripping custom headers (some WAFs do this)</p>"},{"location":"proxy/#redirect-loops-or-wrong-urls","title":"Redirect loops or wrong URLs","text":"<ol> <li>Verify <code>APPLICATION_URL</code> matches your public URL exactly</li> <li>Include the protocol: <code>https://pathary.tv</code> not just <code>pathary.tv</code></li> <li>Do not include a trailing slash</li> </ol>"},{"location":"proxy/#mixed-content-warnings","title":"Mixed content warnings","text":"<p>Ensure <code>X-Forwarded-Proto: https</code> is being forwarded so the app generates HTTPS URLs.</p>"},{"location":"proxy/#docker-compose-example-with-nginx-proxy","title":"Docker Compose Example with Nginx Proxy","text":"<pre><code>version: '3.8'\n\nservices:\n  pathary:\n    image: ghcr.io/leepeuker/pathary:latest\n    environment:\n      - APPLICATION_URL=https://pathary.tv\n      - DATABASE_MODE=mysql\n      - DATABASE_MYSQL_HOST=mysql\n      - DATABASE_MYSQL_NAME=pathary\n      - DATABASE_MYSQL_USER=pathary\n      - DATABASE_MYSQL_PASSWORD=secret\n    networks:\n      - proxy\n      - internal\n\n  mysql:\n    image: mysql:8.0\n    environment:\n      - MYSQL_DATABASE=pathary\n      - MYSQL_USER=pathary\n      - MYSQL_PASSWORD=secret\n      - MYSQL_ROOT_PASSWORD=rootsecret\n    volumes:\n      - mysql_data:/var/lib/mysql\n    networks:\n      - internal\n\nnetworks:\n  proxy:\n    external: true\n  internal:\n\nvolumes:\n  mysql_data:\n</code></pre>"},{"location":"rating-test/","title":"Rating Feature Test Checklist","text":"<p>Manual test checklist for the movie rating functionality.</p>"},{"location":"rating-test/#prerequisites","title":"Prerequisites","text":"<ul> <li>App running at http://localhost:8080</li> <li>User logged in</li> <li>At least one movie in the library (add via search if needed)</li> </ul>"},{"location":"rating-test/#test-steps","title":"Test Steps","text":""},{"location":"rating-test/#1-navigate-to-movie-detail","title":"1. Navigate to Movie Detail","text":"<pre><code>GET http://localhost:8080/movie/1\n</code></pre> <p>Expected: Page loads with 200, shows movie details and rating form.</p>"},{"location":"rating-test/#2-hover-preview-desktop","title":"2. Hover Preview (Desktop)","text":"<ul> <li> Hover over popcorn icons</li> <li> Icons fill up to hovered position (yellow)</li> <li> Moving mouse away restores previous selection (or empty if none)</li> </ul>"},{"location":"rating-test/#3-click-selection","title":"3. Click Selection","text":"<ul> <li> Click on 5<sup>th</sup> popcorn</li> <li> Icons 1-5 turn yellow, 6-7 stay gray</li> <li> Hidden input value is \"5\"</li> <li> Click same popcorn again to toggle off (all gray, value \"0\")</li> </ul>"},{"location":"rating-test/#4-submit-rating","title":"4. Submit Rating","text":"<ul> <li> Select rating (e.g., 5 popcorns)</li> <li> Optionally add comment</li> <li> Click \"Submit Rating\"</li> <li> Expected: 302 redirect to <code>/movie/1#ratings</code></li> <li> Page reloads showing your rating</li> </ul>"},{"location":"rating-test/#5-update-rating","title":"5. Update Rating","text":"<ul> <li> Change rating to different value</li> <li> Update comment</li> <li> Submit</li> <li> Expected: Rating updates, <code>updated_at</code> changes</li> </ul>"},{"location":"rating-test/#6-verify-database","title":"6. Verify Database","text":"<pre><code>docker exec -it pathary-mysql mysql -upathary_user -ppathary_pass_123! pathary \\\n  -e \"SELECT * FROM movie_user_rating WHERE movie_id = 1;\"\n</code></pre> <p>Expected columns: - <code>movie_id</code>: 1 - <code>user_id</code>: your user ID - <code>rating_popcorn</code>: 1-7 or NULL - <code>comment</code>: your comment or NULL - <code>updated_at</code>: recent timestamp</p>"},{"location":"rating-test/#curl-test-no-csrf-required","title":"Curl Test (No CSRF Required)","text":"<pre><code># Get a session cookie first by logging in via browser, then:\ncurl -i -X POST http://localhost:8080/movie/1/rate \\\n  -b \"id=YOUR_AUTH_COOKIE\" \\\n  -d \"rating_popcorn=5\" \\\n  -d \"comment=Great movie!\"\n</code></pre> <p>Expected response: <pre><code>HTTP/1.1 303 See Other\nLocation: /movie/1#ratings\n</code></pre></p>"},{"location":"rating-test/#keyboard-navigation","title":"Keyboard Navigation","text":"<ul> <li> Tab to first popcorn button</li> <li> Press Arrow Right/Up to increase rating</li> <li> Press Arrow Left/Down to decrease rating</li> <li> Press Enter/Space on focused button to select</li> </ul>"},{"location":"rating-test/#mobile-touch","title":"Mobile (Touch)","text":"<ul> <li> Tap popcorn icons to select</li> <li> No hover state needed</li> <li> Submit works normally</li> </ul>"},{"location":"rating-test/#edge-cases","title":"Edge Cases","text":"<ul> <li> Submit with rating 0 (unrated): Should save NULL for rating_popcorn</li> <li> Submit with only comment (no rating): Should save NULL for rating_popcorn</li> <li> Very long comment: Should truncate or handle gracefully</li> <li> Special characters in comment: Should be escaped properly</li> </ul>"},{"location":"architecture/architecture/","title":"Architecture","text":"<p>This page describes Pathary's system design, request flow, and codebase organization.</p>"},{"location":"architecture/architecture/#request-flow","title":"Request Flow","text":"<pre><code>HTTP Request\n     \u2502\n     \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502     public/index.php               \u2502  Entry point\n\u2502     (Loads bootstrap.php)          \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                 \u2502\n                 \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502     DI Container (PHP-DI)          \u2502  Dependency injection\n\u2502     (bootstrap.php)                \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                 \u2502\n                 \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502     FastRoute Dispatcher           \u2502  URL routing\n\u2502     (settings/routes.php)          \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                 \u2502\n                 \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502     Middleware Chain               \u2502  Auth checks, session start\n\u2502     (src/HttpController/*/         \u2502\n\u2502      Middleware/*.php)             \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                 \u2502\n                 \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502     Controller                     \u2502  Business logic\n\u2502     (src/HttpController/{Web,Api}) \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                 \u2502\n                 \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502     Services &amp; Repositories        \u2502  Data access, external APIs\n\u2502     (src/Service, src/Domain)      \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                 \u2502\n                 \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502     Twig Template Rendering        \u2502  HTML generation\n\u2502     (templates/*.twig)             \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                 \u2502\n                 \u25bc\n     HTTP Response\n</code></pre>"},{"location":"architecture/architecture/#folder-structure","title":"Folder Structure","text":"<pre><code>pathary/\n\u251c\u2500\u2500 bin/                        # CLI entry points\n\u2502   \u2514\u2500\u2500 console.php             # Command-line application\n\u251c\u2500\u2500 bootstrap.php               # DI container setup\n\u251c\u2500\u2500 build/                      # Docker build files\n\u2502   \u2514\u2500\u2500 scripts/\n\u2502       \u2514\u2500\u2500 entrypoint.sh       # Container startup script\n\u251c\u2500\u2500 db/\n\u2502   \u2514\u2500\u2500 migrations/\n\u2502       \u251c\u2500\u2500 mysql/              # MySQL migrations\n\u2502       \u2514\u2500\u2500 sqlite/             # SQLite migrations\n\u251c\u2500\u2500 docs/                       # Documentation\n\u251c\u2500\u2500 public/                     # Web root\n\u2502   \u251c\u2500\u2500 index.php               # HTTP entry point\n\u2502   \u251c\u2500\u2500 css/                    # Stylesheets\n\u2502   \u251c\u2500\u2500 js/                     # JavaScript\n\u2502   \u2514\u2500\u2500 images/                 # Static images\n\u251c\u2500\u2500 settings/\n\u2502   \u251c\u2500\u2500 routes.php              # Route definitions\n\u2502   \u2514\u2500\u2500 phinx.php               # Migration config\n\u251c\u2500\u2500 src/\n\u2502   \u251c\u2500\u2500 Api/                    # External API clients\n\u2502   \u2502   \u251c\u2500\u2500 Tmdb/               # TMDB API\n\u2502   \u2502   \u251c\u2500\u2500 Trakt/              # Trakt API\n\u2502   \u2502   \u251c\u2500\u2500 Plex/               # Plex API\n\u2502   \u2502   \u2514\u2500\u2500 Jellyfin/           # Jellyfin API\n\u2502   \u251c\u2500\u2500 Command/                # CLI commands\n\u2502   \u251c\u2500\u2500 Domain/                 # Business entities\n\u2502   \u2502   \u251c\u2500\u2500 Movie/              # Movie, ratings, history\n\u2502   \u2502   \u251c\u2500\u2500 User/               # User accounts\n\u2502   \u2502   \u251c\u2500\u2500 Person/             # Actors, directors\n\u2502   \u2502   \u2514\u2500\u2500 Genre/              # Movie genres\n\u2502   \u251c\u2500\u2500 Factory.php             # DI factory methods\n\u2502   \u251c\u2500\u2500 HttpController/\n\u2502   \u2502   \u251c\u2500\u2500 Api/                # REST API controllers\n\u2502   \u2502   \u2514\u2500\u2500 Web/                # Web page controllers\n\u2502   \u2502       \u2514\u2500\u2500 Middleware/     # Request middleware\n\u2502   \u251c\u2500\u2500 JobQueue/               # Background job system\n\u2502   \u251c\u2500\u2500 Service/                # Application services\n\u2502   \u2502   \u251c\u2500\u2500 GroupMovieService   # Group ratings logic\n\u2502   \u2502   \u2514\u2500\u2500 ...                 # Integration services\n\u2502   \u251c\u2500\u2500 Util/                   # Utilities\n\u2502   \u2514\u2500\u2500 ValueObject/            # Immutable value objects\n\u251c\u2500\u2500 storage/                    # Runtime data\n\u2502   \u251c\u2500\u2500 logs/                   # Application logs\n\u2502   \u2514\u2500\u2500 images/                 # Cached images\n\u2514\u2500\u2500 templates/                  # Twig templates\n    \u251c\u2500\u2500 base.html.twig          # Base layout\n    \u251c\u2500\u2500 component/              # Reusable components\n    \u251c\u2500\u2500 layouts/                # Page layouts\n    \u251c\u2500\u2500 page/                   # Full pages\n    \u2514\u2500\u2500 public/                 # Public-facing pages\n</code></pre>"},{"location":"architecture/architecture/#key-design-decisions","title":"Key Design Decisions","text":""},{"location":"architecture/architecture/#1-php-di-for-dependency-injection","title":"1. PHP-DI for Dependency Injection","text":"<p>The application uses PHP-DI with factory methods defined in <code>src/Factory.php</code>. Services are created lazily and injected automatically.</p> <p>Key file: <code>bootstrap.php</code> <pre><code>$builder = new DI\\ContainerBuilder();\n$builder-&gt;addDefinitions([\n    Config::class =&gt; DI\\factory([Factory::class, 'createConfig']),\n    Connection::class =&gt; DI\\factory([Factory::class, 'createDbConnection']),\n    // ...\n]);\n</code></pre></p>"},{"location":"architecture/architecture/#2-fastroute-for-routing","title":"2. FastRoute for Routing","text":"<p>Routes are defined in <code>settings/routes.php</code> with support for: - Route groups (web vs API) - Middleware chains - Route parameters with regex validation</p>"},{"location":"architecture/architecture/#3-twig-for-templating","title":"3. Twig for Templating","text":"<p>HTML rendering uses Twig with: - Template inheritance (<code>base.html.twig</code>) - Component partials (<code>templates/component/</code>) - Custom filters and functions</p>"},{"location":"architecture/architecture/#4-doctrine-dbal-for-database","title":"4. Doctrine DBAL for Database","text":"<p>Database access uses Doctrine DBAL (not ORM): - Direct SQL queries with parameter binding - Supports MySQL and SQLite - Migrations via Phinx</p>"},{"location":"architecture/architecture/#5-repository-pattern","title":"5. Repository Pattern","text":"<p>Data access is organized by domain: <pre><code>src/Domain/Movie/\n\u251c\u2500\u2500 MovieApi.php           # High-level API\n\u251c\u2500\u2500 MovieRepository.php    # Database queries\n\u251c\u2500\u2500 MovieEntity.php        # Data structure\n\u2514\u2500\u2500 MovieEntityList.php    # Collection\n</code></pre></p>"},{"location":"architecture/architecture/#6-group-focused-design","title":"6. Group-Focused Design","text":"<p>Unlike single-user movie trackers, Pathary is designed for groups: - <code>GroupMovieService</code> calculates aggregate ratings - Home page shows movies watched by any user - Individual ratings display all users' opinions</p>"},{"location":"architecture/architecture/#key-classes","title":"Key Classes","text":"Class Location Purpose <code>Factory</code> <code>src/Factory.php</code> DI factory methods <code>Authentication</code> <code>src/Domain/User/Service/Authentication.php</code> Login/session handling <code>GroupMovieService</code> <code>src/Service/GroupMovieService.php</code> Group rating aggregation <code>MovieRepository</code> <code>src/Domain/Movie/MovieRepository.php</code> Movie database queries <code>TmdbApi</code> <code>src/Api/Tmdb/TmdbApi.php</code> TMDB data fetching"},{"location":"architecture/architecture/#related-pages","title":"Related Pages","text":"<ul> <li>Routing and Controllers] - Detailed route documentation</li> <li>Database] - Schema and queries</li> <li>Authentication] - Security implementation</li> </ul> <p>\u2190 Back to Wiki Home</p>"},{"location":"architecture/database/","title":"Database","text":"<p>This page documents Pathary's database schema, connection modes, and data access patterns.</p>"},{"location":"architecture/database/#database-modes","title":"Database Modes","text":"<p>Pathary supports two database backends:</p> Mode Use Case Configuration SQLite Development, single-user <code>DATABASE_MODE=sqlite</code> MySQL Production, multi-user <code>DATABASE_MODE=mysql</code>"},{"location":"architecture/database/#sqlite-configuration","title":"SQLite Configuration","text":"<pre><code>DATABASE_MODE=sqlite\nDATABASE_SQLITE=storage/movary.sqlite\n</code></pre>"},{"location":"architecture/database/#mysql-configuration","title":"MySQL Configuration","text":"<pre><code>DATABASE_MODE=mysql\nDATABASE_MYSQL_HOST=localhost\nDATABASE_MYSQL_PORT=3306\nDATABASE_MYSQL_NAME=pathary\nDATABASE_MYSQL_USER=pathary\nDATABASE_MYSQL_PASSWORD=secret\nDATABASE_MYSQL_CHARSET=utf8mb4\n</code></pre>"},{"location":"architecture/database/#connection-setup","title":"Connection Setup","text":"<p>File: <code>src/Factory.php</code></p> <pre><code>public static function createDbConnection(ContainerInterface $container) : Connection\n{\n    $config = $container-&gt;get(Config::class);\n    $databaseMode = $config-&gt;getAsString('DATABASE_MODE', 'sqlite');\n\n    if ($databaseMode === 'mysql') {\n        return DBAL\\DriverManager::getConnection([\n            'dbname' =&gt; $config-&gt;getAsString('DATABASE_MYSQL_NAME'),\n            'user' =&gt; $config-&gt;getAsString('DATABASE_MYSQL_USER'),\n            'password' =&gt; $config-&gt;getAsString('DATABASE_MYSQL_PASSWORD'),\n            'host' =&gt; $config-&gt;getAsString('DATABASE_MYSQL_HOST'),\n            'port' =&gt; $config-&gt;getAsInt('DATABASE_MYSQL_PORT', 3306),\n            'driver' =&gt; 'pdo_mysql',\n            'charset' =&gt; $config-&gt;getAsString('DATABASE_MYSQL_CHARSET', 'utf8mb4'),\n        ]);\n    }\n\n    // SQLite\n    return DBAL\\DriverManager::getConnection([\n        'path' =&gt; $config-&gt;getAsString('DATABASE_SQLITE', 'storage/movary.sqlite'),\n        'driver' =&gt; 'pdo_sqlite',\n    ]);\n}\n</code></pre>"},{"location":"architecture/database/#table-overview","title":"Table Overview","text":""},{"location":"architecture/database/#core-tables","title":"Core Tables","text":"Table Description <code>movie</code> Movie metadata from TMDB <code>user</code> User accounts <code>movie_user_rating</code> Per-user movie ratings <code>movie_user_watch_dates</code> Watch history entries <code>movie_history</code> Legacy history (deprecated)"},{"location":"architecture/database/#reference-tables","title":"Reference Tables","text":"Table Description <code>genre</code> Movie genres <code>movie_genre</code> Movie-genre associations <code>person</code> Actors, directors <code>movie_cast</code> Movie-actor associations <code>movie_crew</code> Movie-crew associations <code>company</code> Production companies <code>movie_production_company</code> Movie-company associations"},{"location":"architecture/database/#user-tables","title":"User Tables","text":"Table Description <code>user_auth_token</code> Authentication tokens <code>user_api_token</code> API access tokens <code>user_person_settings</code> Hidden actors/directors"},{"location":"architecture/database/#cache-tables","title":"Cache Tables","text":"Table Description <code>cache_tmdb_languages</code> TMDB language cache <code>cache_trakt_user_movie_watched</code> Trakt sync cache <code>cache_trakt_user_movie_rating</code> Trakt rating cache <code>cache_jellyfin</code> Jellyfin sync cache"},{"location":"architecture/database/#system-tables","title":"System Tables","text":"Table Description <code>job_queue</code> Background job queue <code>phinxlog</code> Migration history"},{"location":"architecture/database/#key-table-schemas","title":"Key Table Schemas","text":""},{"location":"architecture/database/#movie","title":"movie","text":"<pre><code>CREATE TABLE movie (\n    id INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,\n    title VARCHAR(256) NOT NULL,\n    original_title VARCHAR(256),\n    tagline VARCHAR(512),\n    overview TEXT,\n    original_language VARCHAR(10),\n    release_date DATE,\n    runtime INT UNSIGNED,\n    tmdb_id INT UNSIGNED UNIQUE,\n    imdb_id VARCHAR(20),\n    trakt_id INT UNSIGNED,\n    tmdb_poster_path VARCHAR(256),\n    poster_path VARCHAR(256),\n    tmdb_vote_average DECIMAL(3,1),\n    tmdb_vote_count INT UNSIGNED,\n    imdb_rating DECIMAL(2,1),\n    imdb_rating_vote_count INT UNSIGNED,\n    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n    updated_at TIMESTAMP ON UPDATE CURRENT_TIMESTAMP\n);\n</code></pre>"},{"location":"architecture/database/#user","title":"user","text":"<pre><code>CREATE TABLE user (\n    id INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,\n    name VARCHAR(256) NOT NULL UNIQUE,\n    email VARCHAR(256) NOT NULL UNIQUE,\n    password_hash VARCHAR(256) NOT NULL,\n    is_admin TINYINT(1) DEFAULT 0,\n    privacy_level TINYINT DEFAULT 1,\n    date_format_id TINYINT DEFAULT 0,\n    totp_uri VARCHAR(256),\n    profile_image VARCHAR(256),\n    -- Integration tokens\n    plex_access_token CHAR(128),\n    jellyfin_access_token CHAR(128),\n    jellyfin_user_id CHAR(128),\n    jellyfin_server_url VARCHAR(256),\n    -- Feature flags\n    core_account_changes_disabled TINYINT(1) DEFAULT 0,\n    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n);\n</code></pre>"},{"location":"architecture/database/#movie_user_rating","title":"movie_user_rating","text":"<pre><code>CREATE TABLE movie_user_rating (\n    movie_id INT UNSIGNED NOT NULL,\n    user_id INT UNSIGNED NOT NULL,\n    rating TINYINT,                    -- Legacy 1-10 rating\n    rating_popcorn TINYINT UNSIGNED,   -- Popcorn 1-7 rating\n    comment TEXT,\n    watched_year SMALLINT UNSIGNED,    -- Partial date: year\n    watched_month TINYINT UNSIGNED,    -- Partial date: month\n    watched_day TINYINT UNSIGNED,      -- Partial date: day\n    location_id TINYINT UNSIGNED,      -- Where watched (1=Cinema, 2=Home, 3=Other)\n    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n    updated_at TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n    PRIMARY KEY (movie_id, user_id),\n    FOREIGN KEY (movie_id) REFERENCES movie(id) ON DELETE CASCADE,\n    FOREIGN KEY (user_id) REFERENCES user(id) ON DELETE CASCADE\n);\n</code></pre>"},{"location":"architecture/database/#movie_user_watch_dates","title":"movie_user_watch_dates","text":"<pre><code>CREATE TABLE movie_user_watch_dates (\n    movie_id INT UNSIGNED NOT NULL,\n    user_id INT UNSIGNED NOT NULL,\n    watched_at DATETIME,\n    plays INT DEFAULT 1,\n    comment TEXT,\n    position INT,\n    location_id INT UNSIGNED,\n    PRIMARY KEY (movie_id, user_id, watched_at),\n    FOREIGN KEY (movie_id) REFERENCES movie(id) ON DELETE CASCADE,\n    FOREIGN KEY (user_id) REFERENCES user(id) ON DELETE CASCADE\n);\n</code></pre>"},{"location":"architecture/database/#user_auth_token","title":"user_auth_token","text":"<pre><code>CREATE TABLE user_auth_token (\n    id INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,\n    user_id INT UNSIGNED NOT NULL,\n    token VARCHAR(64) NOT NULL,\n    token_hash VARCHAR(64),\n    expiration_date DATETIME NOT NULL,\n    device_name VARCHAR(256) NOT NULL,\n    user_agent TEXT NOT NULL,\n    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n    last_used_at DATETIME,\n    INDEX idx_token_hash (token_hash),\n    FOREIGN KEY (user_id) REFERENCES user(id) ON DELETE CASCADE\n);\n</code></pre>"},{"location":"architecture/database/#table-relationships","title":"Table Relationships","text":"<pre><code>                    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n                    \u2502    user      \u2502\n                    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                           \u2502\n        \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n        \u2502                  \u2502                  \u2502\n        \u25bc                  \u25bc                  \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 user_auth_    \u2502  \u2502 movie_user_   \u2502  \u2502 movie_user_   \u2502\n\u2502 token         \u2502  \u2502 rating        \u2502  \u2502 watch_dates   \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                           \u2502                  \u2502\n                           \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                                    \u25bc\n                           \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n                           \u2502    movie      \u2502\n                           \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                                   \u2502\n        \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n        \u2502                          \u2502                          \u2502\n        \u25bc                          \u25bc                          \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510          \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510          \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  movie_genre  \u2502          \u2502  movie_cast   \u2502          \u2502  movie_crew   \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518          \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518          \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n        \u2502                          \u2502                          \u2502\n        \u25bc                          \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                               \u25bc\n\u2502    genre      \u2502                       \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                       \u2502    person     \u2502\n                                        \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"architecture/database/#query-patterns","title":"Query Patterns","text":""},{"location":"architecture/database/#repository-pattern","title":"Repository Pattern","text":"<p>File: <code>src/Domain/Movie/MovieRepository.php</code></p> <pre><code>public function findById(int $id) : ?array\n{\n    return $this-&gt;dbConnection-&gt;fetchAssociative(\n        'SELECT * FROM movie WHERE id = ?',\n        [$id],\n    ) ?: null;\n}\n</code></pre>"},{"location":"architecture/database/#group-statistics","title":"Group Statistics","text":"<p>File: <code>src/Service/GroupMovieService.php</code></p> <pre><code>public function getMovieGroupStats(int $movieId) : array\n{\n    return $this-&gt;dbConnection-&gt;fetchAssociative(\n        &lt;&lt;&lt;SQL\n        SELECT\n            AVG(rating_popcorn) AS avg_popcorn,\n            COUNT(rating_popcorn) AS rating_count,\n            MAX(updated_at) AS last_rating_activity\n        FROM movie_user_rating\n        WHERE movie_id = ? AND rating_popcorn IS NOT NULL\n        SQL,\n        [$movieId],\n    );\n}\n</code></pre>"},{"location":"architecture/database/#inspecting-data-locally","title":"Inspecting Data Locally","text":""},{"location":"architecture/database/#docker-mysql","title":"Docker MySQL","text":"<pre><code># Connect to MySQL\ndocker exec -it pathary-mysql mysql -u pathary -pmovary pathary\n\n# Run query\nSELECT * FROM movie LIMIT 5;\n</code></pre>"},{"location":"architecture/database/#docker-sqlite","title":"Docker SQLite","text":"<pre><code># Connect to SQLite\ndocker exec -it pathary-app sqlite3 /app/storage/movary.sqlite\n\n# Run query\n.tables\nSELECT * FROM movie LIMIT 5;\n</code></pre>"},{"location":"architecture/database/#show-table-structure","title":"Show Table Structure","text":"<pre><code>-- MySQL\nDESCRIBE movie_user_rating;\n\n-- SQLite\n.schema movie_user_rating\n</code></pre>"},{"location":"architecture/database/#backup-and-restore","title":"Backup and Restore","text":""},{"location":"architecture/database/#mysql-backup","title":"MySQL Backup","text":"<pre><code>docker exec pathary-mysql mysqldump -u pathary -pmovary pathary &gt; backup.sql\n</code></pre>"},{"location":"architecture/database/#mysql-restore","title":"MySQL Restore","text":"<pre><code>cat backup.sql | docker exec -i pathary-mysql mysql -u pathary -pmovary pathary\n</code></pre>"},{"location":"architecture/database/#sqlite-backup","title":"SQLite Backup","text":"<pre><code>docker cp pathary-app:/app/storage/movary.sqlite ./backup.sqlite\n</code></pre>"},{"location":"architecture/database/#sqlite-restore","title":"SQLite Restore","text":"<pre><code>docker cp ./backup.sqlite pathary-app:/app/storage/movary.sqlite\n</code></pre>"},{"location":"architecture/database/#related-pages","title":"Related Pages","text":"<ul> <li>Migrations] - Schema changes</li> <li>Ratings and Comments] - Rating data model</li> <li>Architecture] - Data access layer</li> </ul> <p>\u2190 Back to Wiki Home</p>"},{"location":"architecture/frontend-and-ui/","title":"Frontend and UI","text":"<p>This page covers Pathary's frontend architecture, templates, and styling.</p>"},{"location":"architecture/frontend-and-ui/#technology-stack","title":"Technology Stack","text":"Component Technology Templating Twig CSS Framework Bootstrap 5 Icons Bootstrap Icons JavaScript Vanilla JS Date Picker Datepicker.js"},{"location":"architecture/frontend-and-ui/#template-structure","title":"Template Structure","text":"<pre><code>templates/\n\u251c\u2500\u2500 base.html.twig              # Root layout\n\u251c\u2500\u2500 component/                  # Reusable components\n\u2502   \u251c\u2500\u2500 navbar_app.twig         # Authenticated navbar\n\u2502   \u251c\u2500\u2500 navbar_public.twig      # Public navbar\n\u2502   \u251c\u2500\u2500 modal_log_play.twig     # Log play modal\n\u2502   \u2514\u2500\u2500 ...\n\u251c\u2500\u2500 components/\n\u2502   \u2514\u2500\u2500 popcorn_rating.twig     # Rating widget\n\u251c\u2500\u2500 layouts/\n\u2502   \u251c\u2500\u2500 layout_public.twig      # Public page layout\n\u2502   \u2514\u2500\u2500 layout_app.twig         # App page layout\n\u251c\u2500\u2500 page/                       # Full pages\n\u2502   \u251c\u2500\u2500 login.html.twig\n\u2502   \u251c\u2500\u2500 settings-*.html.twig\n\u2502   \u2514\u2500\u2500 ...\n\u251c\u2500\u2500 partials/                   # Page sections\n\u2502   \u2514\u2500\u2500 movie_grid.twig         # Movie poster grid\n\u2514\u2500\u2500 public/                     # Public-facing pages\n    \u251c\u2500\u2500 home.twig               # Home page\n    \u2514\u2500\u2500 movie_detail.twig       # Movie detail page\n</code></pre>"},{"location":"architecture/frontend-and-ui/#base-layout","title":"Base Layout","text":"<p>File: <code>templates/base.html.twig</code></p> <p>All pages use a flexbox sticky footer pattern with consistent bottom spacing:</p> <pre><code>&lt;!DOCTYPE html&gt;\n&lt;html data-bs-theme=\"{{ theme }}\"&gt;\n&lt;head&gt;\n    &lt;meta charset=\"UTF-8\"&gt;\n    &lt;meta name=\"viewport\" content=\"width=device-width, initial-scale=1\"&gt;\n    &lt;title&gt;{% block title %}Pathary{% endblock %} | {{ applicationName }}&lt;/title&gt;\n\n    &lt;!-- Bootstrap CSS --&gt;\n    &lt;link href=\"/css/bootstrap.min.css\" rel=\"stylesheet\"&gt;\n    &lt;link href=\"/css/bootstrap-icons-1.10.2.css\" rel=\"stylesheet\"&gt;\n\n    {% block styles %}{% endblock %}\n&lt;/head&gt;\n&lt;body class=\"d-flex flex-column min-vh-100\"&gt;\n    {% block navbar %}{% endblock %}\n\n    &lt;div class=\"flex-grow-1 pb-4\"&gt;\n        {% block body %}{% endblock %}\n    &lt;/div&gt;\n\n    {% if showFooter is not defined or showFooter %}\n        {% include 'partials/footer.twig' %}\n    {% endif %}\n\n    &lt;!-- Bootstrap JS --&gt;\n    &lt;script src=\"/js/bootstrap.bundle.min.js\"&gt;&lt;/script&gt;\n    {% block scripts %}{% endblock %}\n&lt;/body&gt;\n&lt;/html&gt;\n</code></pre>"},{"location":"architecture/frontend-and-ui/#layout-features","title":"Layout Features","text":"<ul> <li>Sticky Footer: Uses <code>min-vh-100</code> + <code>flex-column</code> + <code>flex-grow-1</code> pattern</li> <li>Bottom Spacing: <code>pb-4</code> class on main content wrapper (24px padding)</li> <li>Conditional Footer: Footer can be hidden via <code>showFooter</code> variable (e.g., on login page)</li> <li>Dynamic Theme: Theme is controlled via <code>{{ theme }}</code> variable</li> </ul>"},{"location":"architecture/frontend-and-ui/#footer-navigation","title":"Footer Navigation","text":"<p>File: <code>templates/partials/footer.twig</code></p> <p>A sticky footer is included on all pages (except login) with links to project resources:</p> <pre><code>&lt;footer class=\"footer mt-auto py-3 bg-body-tertiary border-top\"&gt;\n    &lt;div class=\"container\"&gt;\n        &lt;div class=\"d-flex flex-wrap justify-content-center gap-3 small\"&gt;\n            &lt;a href=\"https://github.com/benjaminmue/pathary\" target=\"_blank\" rel=\"noopener noreferrer\"\n               class=\"text-body-secondary text-decoration-none\"&gt;\n                &lt;i class=\"bi bi-github me-1\"&gt;&lt;/i&gt;GitHub\n            &lt;/a&gt;\n            &lt;a href=\"https://github.com/benjaminmue/pathary/wiki\" target=\"_blank\" rel=\"noopener noreferrer\"\n               class=\"text-body-secondary text-decoration-none\"&gt;\n                &lt;i class=\"bi bi-book me-1\"&gt;&lt;/i&gt;Wiki\n            &lt;/a&gt;\n            &lt;a href=\"https://github.com/benjaminmue/pathary/issues/new\" target=\"_blank\" rel=\"noopener noreferrer\"\n               class=\"text-body-secondary text-decoration-none\"&gt;\n                &lt;i class=\"bi bi-bug me-1\"&gt;&lt;/i&gt;Report Issue\n            &lt;/a&gt;\n        &lt;/div&gt;\n    &lt;/div&gt;\n&lt;/footer&gt;\n</code></pre>"},{"location":"architecture/frontend-and-ui/#footer-features","title":"Footer Features","text":"<ul> <li>Sticky Positioning: Uses <code>mt-auto</code> with flexbox container</li> <li>Responsive Design: <code>flex-wrap</code> ensures links stack on mobile</li> <li>External Link Safety: <code>rel=\"noopener noreferrer\"</code> for security</li> <li>Bootstrap Icons: Prefixes each link with an icon</li> <li>Conditional Display: Hidden on login page via <code>showFooter</code> variable</li> </ul>"},{"location":"architecture/frontend-and-ui/#dark-mode","title":"Dark Mode","text":"<p>Pathary uses Bootstrap 5's built-in dark mode with <code>data-bs-theme</code> attribute:</p> <pre><code>&lt;html data-bs-theme=\"dark\"&gt;\n</code></pre> <p>The theme can be dynamically set per-user or globally.</p>"},{"location":"architecture/frontend-and-ui/#custom-colors","title":"Custom Colors","text":"<p>File: <code>templates/public/movie_detail.twig</code> (and other pages)</p> <pre><code>:root {\n    --pathe-yellow: #f5c518;\n    --pathe-dark: #1a1a1a;\n    --accent-purple: #6f2dbd;\n}\n</code></pre>"},{"location":"architecture/frontend-and-ui/#navbar","title":"Navbar","text":""},{"location":"architecture/frontend-and-ui/#authenticated-navbar","title":"Authenticated Navbar","text":"<p>File: <code>templates/component/navbar_app.twig</code></p> <p>Features: - Logo with SVG image - Search button - User dropdown - Dark theme styling</p> <pre><code>&lt;nav class=\"navbar navbar-expand-lg navbar-dark bg-dark\"&gt;\n    &lt;div class=\"container\"&gt;\n        &lt;a class=\"navbar-brand d-flex align-items-center\" href=\"/\"&gt;\n            &lt;img src=\"/images/logo.svg\" alt=\"Pathary\" class=\"navbar-logo me-2\"&gt;\n            {{ applicationName }}\n        &lt;/a&gt;\n\n        &lt;button class=\"navbar-toggler\" data-bs-toggle=\"collapse\" data-bs-target=\"#navbarNav\"&gt;\n            &lt;span class=\"navbar-toggler-icon\"&gt;&lt;/span&gt;\n        &lt;/button&gt;\n\n        &lt;div class=\"collapse navbar-collapse\" id=\"navbarNav\"&gt;\n            &lt;ul class=\"navbar-nav me-auto\"&gt;\n                &lt;li class=\"nav-item\"&gt;\n                    &lt;a class=\"nav-link\" href=\"/movies\"&gt;All Movies&lt;/a&gt;\n                &lt;/li&gt;\n            &lt;/ul&gt;\n            &lt;ul class=\"navbar-nav\"&gt;\n                &lt;li class=\"nav-item dropdown\"&gt;\n                    &lt;a class=\"nav-link dropdown-toggle\" href=\"#\" data-bs-toggle=\"dropdown\"&gt;\n                        {{ currentUser.name }}\n                    &lt;/a&gt;\n                    &lt;ul class=\"dropdown-menu dropdown-menu-end\"&gt;\n                        &lt;li&gt;&lt;a class=\"dropdown-item\" href=\"/profile\"&gt;Profile&lt;/a&gt;&lt;/li&gt;\n                        &lt;li&gt;&lt;a class=\"dropdown-item\" href=\"/settings/account/general\"&gt;Settings&lt;/a&gt;&lt;/li&gt;\n                        &lt;li&gt;&lt;hr class=\"dropdown-divider\"&gt;&lt;/li&gt;\n                        &lt;li&gt;&lt;a class=\"dropdown-item\" href=\"#\" onclick=\"logout()\"&gt;Logout&lt;/a&gt;&lt;/li&gt;\n                    &lt;/ul&gt;\n                &lt;/li&gt;\n            &lt;/ul&gt;\n        &lt;/div&gt;\n    &lt;/div&gt;\n&lt;/nav&gt;\n</code></pre>"},{"location":"architecture/frontend-and-ui/#logo-styling","title":"Logo Styling","text":"<p>File: <code>public/css/global.css</code></p> <pre><code>.navbar-logo {\n    width: auto;\n    height: 32px;\n    object-fit: contain;\n}\n</code></pre>"},{"location":"architecture/frontend-and-ui/#login-page","title":"Login Page","text":"<p>File: <code>templates/page/login.html.twig</code></p> <p>Features: - Centered logo with shadow border - Animated falling popcorn background - Dark theme</p>"},{"location":"architecture/frontend-and-ui/#logo-container","title":"Logo Container","text":"<pre><code>.login-logo-container {\n    position: relative;\n    width: 150px;\n    height: 150px;\n    border-radius: 50%;\n    overflow: hidden;\n}\n\n.login-logo-container::before {\n    content: '';\n    position: absolute;\n    inset: 0;\n    border-radius: 50%;\n    padding: 4px;\n    background: linear-gradient(135deg, var(--pathe-yellow), var(--accent-purple));\n    -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);\n    -webkit-mask-composite: xor;\n    mask-composite: exclude;\n    box-shadow: 0 0 20px rgba(245, 197, 24, 0.3);\n}\n</code></pre>"},{"location":"architecture/frontend-and-ui/#popcorn-animation","title":"Popcorn Animation","text":"<p>File: <code>public/js/login-bg.js</code></p> <p>Creates falling popcorn emoji animation on the login page.</p>"},{"location":"architecture/frontend-and-ui/#movie-grid","title":"Movie Grid","text":"<p>File: <code>templates/partials/movie_grid.twig</code></p> <p>Displays movies in a responsive grid:</p> <pre><code>&lt;div class=\"movie-grid\"&gt;\n    {% for movie in movies %}\n        &lt;a href=\"/movie/{{ movie.movie_id }}\" class=\"movie-card\"&gt;\n            &lt;div class=\"movie-poster\"&gt;\n                {% if movie.poster_src %}\n                    &lt;img src=\"{{ movie.poster_src }}\" alt=\"{{ movie.title }}\"&gt;\n                {% else %}\n                    &lt;div class=\"poster-placeholder\"&gt;{{ movie.title }}&lt;/div&gt;\n                {% endif %}\n            &lt;/div&gt;\n            &lt;div class=\"movie-title\"&gt;{{ movie.title }}&lt;/div&gt;\n            {% if movie.avg_popcorn %}\n                &lt;div class=\"movie-rating\"&gt;\n                    {{ movie.avg_popcorn|number_format(1) }} \ud83c\udf7f\n                &lt;/div&gt;\n            {% endif %}\n        &lt;/a&gt;\n    {% endfor %}\n&lt;/div&gt;\n</code></pre>"},{"location":"architecture/frontend-and-ui/#movie-detail-page","title":"Movie Detail Page","text":"<p>File: <code>templates/public/movie_detail.twig</code></p> <p>Sections: 1. Hero: Poster + basic info 2. Group Rating: Average popcorn rating 3. Your Rating: Rating form (authenticated users) 4. Individual Ratings: All user ratings 5. Cast &amp; Crew: Actor/director list</p>"},{"location":"architecture/frontend-and-ui/#inline-styles","title":"Inline Styles","text":"<p>The movie detail page includes extensive inline CSS for: - Hero layout - Rating cards - Form styling - Responsive design</p>"},{"location":"architecture/frontend-and-ui/#rating-widget","title":"Rating Widget","text":"<p>File: <code>templates/components/popcorn_rating.twig</code></p> <p>Modes: - <code>display</code>: Read-only popcorn display - <code>input</code>: Interactive rating selector</p> <pre><code>{% if mode == 'input' %}\n    &lt;div class=\"popcorn-rating popcorn-rating--input\"&gt;\n        &lt;input type=\"hidden\" name=\"{{ name }}\" value=\"{{ valueInt }}\"&gt;\n        {% for i in 1..7 %}\n            &lt;button type=\"button\"\n                    class=\"popcorn-rating__item {{ i &lt;= valueInt ? 'popcorn-on' : 'popcorn-off' }}\"\n                    data-value=\"{{ i }}\"&gt;\n                \ud83c\udf7f\n            &lt;/button&gt;\n        {% endfor %}\n    &lt;/div&gt;\n{% else %}\n    &lt;div class=\"popcorn-rating\" aria-label=\"Rating: {{ valueInt }} out of 7\"&gt;\n        {% for i in 1..7 %}\n            &lt;span class=\"popcorn-rating__item {{ i &lt;= valueInt ? 'popcorn-on' : 'popcorn-off' }}\"&gt;\ud83c\udf7f&lt;/span&gt;\n        {% endfor %}\n    &lt;/div&gt;\n{% endif %}\n</code></pre>"},{"location":"architecture/frontend-and-ui/#javascript-files","title":"JavaScript Files","text":"File Purpose <code>public/js/app.js</code> Main application JS <code>public/js/login.js</code> Login form handling <code>public/js/login-bg.js</code> Popcorn animation <code>public/js/movie.js</code> Movie page interactions <code>public/js/settings-*.js</code> Settings page logic"},{"location":"architecture/frontend-and-ui/#login-form","title":"Login Form","text":"<p>File: <code>public/js/login.js</code></p> <pre><code>document.getElementById('loginForm').addEventListener('submit', async (e) =&gt; {\n    e.preventDefault();\n\n    const response = await fetch('/api/authentication/token', {\n        method: 'POST',\n        headers: {\n            'Content-Type': 'application/json',\n            'X-Movary-Client': 'pathary-web',\n        },\n        body: JSON.stringify({\n            email: document.getElementById('email').value,\n            password: document.getElementById('password').value,\n            rememberMe: document.getElementById('rememberMe').checked,\n        }),\n    });\n\n    if (response.ok) {\n        window.location.href = '/';\n    } else {\n        showError('Invalid credentials');\n    }\n});\n</code></pre>"},{"location":"architecture/frontend-and-ui/#css-files","title":"CSS Files","text":"File Purpose <code>public/css/bootstrap.min.css</code> Bootstrap framework <code>public/css/bootstrap-icons-1.10.2.css</code> Icon font <code>public/css/global.css</code> Global custom styles <code>public/css/login.css</code> Login page styles <code>public/css/movie.css</code> Movie page styles <code>public/css/settings.css</code> Settings page styles"},{"location":"architecture/frontend-and-ui/#responsive-design","title":"Responsive Design","text":"<p>Bootstrap breakpoints are used throughout:</p> <pre><code>@media (max-width: 768px) {\n    .rating-form-row {\n        flex-direction: column;\n        gap: 1rem;\n    }\n\n    .rating-form-divider {\n        display: none;\n    }\n}\n</code></pre>"},{"location":"architecture/frontend-and-ui/#icons","title":"Icons","text":"<p>Bootstrap Icons (version 1.10.2) are used throughout the application via CSS classes.</p> <p>File: <code>public/css/bootstrap-icons-1.10.2.css</code></p>"},{"location":"architecture/frontend-and-ui/#common-icons","title":"Common Icons","text":"Icon Class Unicode Usage <code>bi-calendar-event</code> \\f1d5 Date picker, watch dates <code>bi-geo-alt</code> \\f3f2 Location picker <code>bi-trash</code> \\f5de Delete actions <code>bi-search</code> \\f52a Search functionality <code>bi-github</code> \\f3ed GitHub links in footer <code>bi-book</code> \\f2ff Wiki documentation links <code>bi-bug</code> \\f337 Issue reporting"},{"location":"architecture/frontend-and-ui/#security-page-icons","title":"Security Page Icons","text":"Icon Class Unicode Usage <code>bi-key</code> \\f474 Password management <code>bi-lock-fill</code> \\f4aa 2FA enabled <code>bi-unlock-fill</code> \\f686 2FA disabled <code>bi-life-preserver</code> \\f49b Recovery codes <code>bi-laptop</code> \\f484 Trusted devices <code>bi-activity</code> \\f200 Security audit log"},{"location":"architecture/frontend-and-ui/#profile-page-icons","title":"Profile Page Icons","text":"Icon Class Unicode Usage <code>bi-person-circle</code> \\f4da Profile photo <code>bi-person-badge</code> \\f4cc Display name <code>bi-envelope</code> \\f32f Email address <code>bi-shield-lock</code> \\f52f Security settings tab <code>bi-box-arrow-right</code> \\f2e5 Sign out"},{"location":"architecture/frontend-and-ui/#usage-example","title":"Usage Example","text":"<pre><code>&lt;!-- Basic icon --&gt;\n&lt;i class=\"bi bi-calendar-event\"&gt;&lt;/i&gt;\n\n&lt;!-- Icon with margin --&gt;\n&lt;i class=\"bi bi-github me-1\"&gt;&lt;/i&gt;GitHub\n\n&lt;!-- Icon in button --&gt;\n&lt;button class=\"btn btn-primary\"&gt;\n    &lt;i class=\"bi bi-search me-2\"&gt;&lt;/i&gt;Search Movies\n&lt;/button&gt;\n\n&lt;!-- Icon with color --&gt;\n&lt;i class=\"bi bi-lock-fill text-success\"&gt;&lt;/i&gt; 2FA Enabled\n</code></pre>"},{"location":"architecture/frontend-and-ui/#related-pages","title":"Related Pages","text":"<ul> <li>Ratings and Comments] - Rating UI components</li> <li>Routing and Controllers] - Template rendering</li> <li>Architecture] - Twig integration</li> </ul> <p>\u2190 Back to Wiki Home</p>"},{"location":"architecture/routing-and-controllers/","title":"Routing and Controllers","text":"<p>This page documents how HTTP requests are routed to controllers in Pathary.</p>"},{"location":"architecture/routing-and-controllers/#route-configuration","title":"Route Configuration","text":"<p>Routes are defined in <code>settings/routes.php</code> using FastRoute.</p> <pre><code>return function (FastRoute\\RouteCollector $routeCollector) {\n    $routerService = new RouterService();\n\n    // Web routes (HTML pages)\n    $routeCollector-&gt;addGroup('', fn($r) =&gt; addWebRoutes($routerService, $r));\n\n    // API routes (JSON)\n    $routeCollector-&gt;addGroup('/api', fn($r) =&gt; addApiRoutes($routerService, $r));\n};\n</code></pre>"},{"location":"architecture/routing-and-controllers/#route-table","title":"Route Table","text":""},{"location":"architecture/routing-and-controllers/#public-routes-no-authentication","title":"Public Routes (No Authentication)","text":"Method Path Controller Description GET <code>/</code> <code>PublicHomeController::index</code> Home page with movie grid GET <code>/movie/{id}</code> <code>PublicMovieController::detail</code> Movie detail page GET <code>/login</code> <code>AuthenticationController::renderLoginPage</code> Login form GET <code>/landing</code> <code>LandingPageController::render</code> First-run setup GET <code>/create-user</code> <code>CreateUserController::renderPage</code> Registration form GET <code>/docs/api</code> <code>OpenApiController::renderPage</code> API documentation GET <code>/profile-images/{filename}</code> <code>ProfileController::serveImage</code> Serve profile images"},{"location":"architecture/routing-and-controllers/#authenticated-routes-login-required","title":"Authenticated Routes (Login Required)","text":"Method Path Controller Description POST <code>/movie/{id}/rate</code> <code>RateMovieController::rate</code> Submit rating POST <code>/movie/{id}/rate/delete</code> <code>RateMovieController::deleteRating</code> Delete rating GET <code>/search</code> <code>SearchController::search</code> Search movies GET <code>/movies</code> <code>AllMoviesController::index</code> All movies page GET <code>/profile</code> <code>ProfileController::show</code> User profile POST <code>/profile</code> <code>ProfileController::update</code> Update profile GET <code>/tmdb/movie/{tmdbId}</code> <code>TmdbMovieController::detail</code> TMDB movie preview POST <code>/tmdb/movie/{tmdbId}/add</code> <code>TmdbMovieController::add</code> Add movie from TMDB GET <code>/jobs</code> <code>JobController::getJobs</code> Job queue status POST <code>/log-movie</code> <code>HistoryController::logMovie</code> Log a movie watch"},{"location":"architecture/routing-and-controllers/#settings-routes","title":"Settings Routes","text":"Method Path Controller Description GET <code>/settings/account/general</code> <code>SettingsController::renderGeneralAccountPage</code> Account settings GET <code>/settings/account/security</code> <code>SettingsController::renderSecurityAccountPage</code> Security settings GET <code>/settings/integrations/trakt</code> <code>SettingsController::renderTraktPage</code> Trakt integration GET <code>/settings/integrations/plex</code> <code>SettingsController::renderPlexPage</code> Plex integration GET <code>/settings/integrations/jellyfin</code> <code>SettingsController::renderJellyfinPage</code> Jellyfin integration GET <code>/settings/server/general</code> <code>SettingsController::renderServerGeneralPage</code> Server settings"},{"location":"architecture/routing-and-controllers/#user-media-routes","title":"User Media Routes","text":"Method Path Controller Description GET <code>/users/{username}</code> <code>DashboardController::render</code> User dashboard GET <code>/users/{username}/history</code> <code>HistoryController::renderHistory</code> Watch history GET <code>/users/{username}/watchlist</code> <code>WatchlistController::renderWatchlist</code> User watchlist GET <code>/users/{username}/movies</code> <code>MoviesController::renderPage</code> User's movies GET <code>/users/{username}/movies/{id}</code> <code>MovieController::renderPage</code> Movie detail (user view)"},{"location":"architecture/routing-and-controllers/#api-routes","title":"API Routes","text":"Method Path Controller Description POST <code>/api/authentication/token</code> <code>AuthenticationController::createToken</code> Login (get token) DELETE <code>/api/authentication/token</code> <code>AuthenticationController::destroyToken</code> Logout GET <code>/api/users/{username}/history/movies</code> <code>HistoryController::getHistory</code> Get watch history POST <code>/api/users/{username}/history/movies</code> <code>HistoryController::addToHistory</code> Add to history GET <code>/api/movies/search</code> <code>MovieSearchController::search</code> Search TMDB POST <code>/api/movies/add</code> <code>MovieAddController::addMovie</code> Add movie"},{"location":"architecture/routing-and-controllers/#webhook-routes","title":"Webhook Routes","text":"Method Path Controller Description POST <code>/api/webhook/plex/{id}</code> <code>PlexController::handlePlexWebhook</code> Plex scrobble POST <code>/api/webhook/jellyfin/{id}</code> <code>JellyfinController::handleJellyfinWebhook</code> Jellyfin scrobble POST <code>/api/webhook/emby/{id}</code> <code>EmbyController::handleEmbyWebhook</code> Emby scrobble POST <code>/api/webhook/kodi/{id}</code> <code>KodiController::handleKodiWebhook</code> Kodi scrobble"},{"location":"architecture/routing-and-controllers/#middleware","title":"Middleware","text":"<p>Middleware runs before controllers to perform checks.</p>"},{"location":"architecture/routing-and-controllers/#available-middleware","title":"Available Middleware","text":"Middleware Location Purpose <code>UserIsAuthenticated</code> <code>Web/Middleware/</code> Requires login <code>UserIsUnauthenticated</code> <code>Web/Middleware/</code> Must NOT be logged in <code>UserIsAdmin</code> <code>Web/Middleware/</code> Requires admin role <code>ServerHasNoUsers</code> <code>Web/Middleware/</code> First-run check <code>ServerHasUsers</code> <code>Web/Middleware/</code> Has existing users <code>ServerHasRegistrationEnabled</code> <code>Web/Middleware/</code> Registration allowed <code>IsAuthorizedToReadUserData</code> <code>Web/Middleware/</code> Can view user profile <code>UserHasJellyfinToken</code> <code>Web/Middleware/</code> Has Jellyfin configured <code>StartSession</code> <code>Web/Middleware/</code> Initialize PHP session"},{"location":"architecture/routing-and-controllers/#middleware-chain-example","title":"Middleware Chain Example","text":"<pre><code>$routes-&gt;add('POST', '/settings/server/general',\n    [SettingsController::class, 'updateServerGeneral'],\n    [\n        Web\\Middleware\\UserIsAuthenticated::class,\n        Web\\Middleware\\UserIsAdmin::class\n    ]\n);\n</code></pre>"},{"location":"architecture/routing-and-controllers/#controller-locations","title":"Controller Locations","text":""},{"location":"architecture/routing-and-controllers/#web-controllers-srchttpcontrollerweb","title":"Web Controllers (<code>src/HttpController/Web/</code>)","text":"Controller Purpose <code>PublicHomeController</code> Home page <code>PublicMovieController</code> Public movie detail <code>RateMovieController</code> Rating submission <code>AuthenticationController</code> Login/logout pages <code>SettingsController</code> All settings pages <code>ProfileController</code> User profile management <code>DashboardController</code> User dashboard <code>HistoryController</code> Watch history <code>SearchController</code> Movie search <code>TmdbMovieController</code> TMDB movie preview/add"},{"location":"architecture/routing-and-controllers/#api-controllers-srchttpcontrollerapi","title":"API Controllers (<code>src/HttpController/Api/</code>)","text":"Controller Purpose <code>AuthenticationController</code> Token management <code>HistoryController</code> History API <code>WatchlistController</code> Watchlist API <code>MovieSearchController</code> Search API <code>PlexController</code> Plex webhooks <code>JellyfinController</code> Jellyfin webhooks"},{"location":"architecture/routing-and-controllers/#requestresponse-flow","title":"Request/Response Flow","text":"<pre><code>// public/index.php\n$routeInfo = $dispatcher-&gt;dispatch($_SERVER['REQUEST_METHOD'], $uri);\n\nswitch ($routeInfo[0]) {\n    case FastRoute\\Dispatcher::FOUND:\n        $handler = $routeInfo[1]['handler'];\n\n        // Run middleware chain\n        foreach ($routeInfo[1]['middleware'] as $middleware) {\n            $middlewareResponse = $container-&gt;call($middleware, [$httpRequest]);\n            if ($middlewareResponse instanceof Response) {\n                return $middlewareResponse; // Short-circuit\n            }\n        }\n\n        // Call controller\n        $response = $container-&gt;call($handler, [$httpRequest]);\n        break;\n}\n</code></pre>"},{"location":"architecture/routing-and-controllers/#route-parameters","title":"Route Parameters","text":"<p>Routes support regex-validated parameters:</p> <pre><code>// Numeric ID only\n'/movie/{id:[0-9]+}'\n\n// Alphanumeric username\n'/users/{username:[a-zA-Z0-9]+}'\n\n// Any characters\n'/profile-images/{filename:.+}'\n\n// Optional slug suffix\n'/users/{username}/movies/{id:\\d+}[-{nameSlugSuffix:[^/]*}]'\n</code></pre>"},{"location":"architecture/routing-and-controllers/#related-pages","title":"Related Pages","text":"<ul> <li>Architecture] - System overview</li> <li>Authentication and Sessions] - Login flow</li> <li>Frontend and UI] - Template rendering</li> </ul> <p>\u2190 Back to Wiki Home</p>"},{"location":"development/database-migrations/","title":"Database Migrations","text":"<p>Movary uses phinx to manage database migrations</p> <p>In order to create a new migration, run the following command:</p> <pre><code>php vendor/bin/phinx create MyNewMigration -c ./settings/phinx.php\n</code></pre> <p>Make sure to use CamelCase, so the first character of your migration name has to be capitalized and preferably any words are capitalized as well. So in the name <code>my new migration</code>, the words begin with a capital letter and the spaces are removed.</p> <p>The <code>-c</code> parameter tells Phinx to use the configurations that are in <code>phinx.php</code>. To create a migration for MySQL, you'll have to update your <code>.env</code> file to <code>DATABASE_MODE=mysql</code> and set up the appropriate configuration (such as password, host, etc.) to connect to your MySQL database.</p> <p>To make a migration for SQlite3, you can update your <code>.env</code> file to <code>DATABASE_MODE=sqlite</code>.</p>"},{"location":"development/file-structure/","title":"Directory Structure","text":""},{"location":"development/file-structure/#backend","title":"Backend","text":"<p>Most of the backend files are in the <code>/src</code> directory. The main <code>index.php</code> is in <code>/public</code>.</p> <p>Within the <code>/src</code> directory, various other directories are located.</p> <ul> <li><code>/src/Api</code> - Contains usage of external APIs (such as Trakt, Plex, Jellyfin, etc.)</li> <li><code>/src/Command</code> - Contains Movary CLI commands  (which can be executed via <code>php /bin/console.php</code>)</li> <li><code>/src/HttpController</code> - Contains files processing HTTP requests. Controllers and middleware are located here, for both the HTTP requests directed at the API and just the usual   web interface.</li> <li><code>/src/Service</code> - Contains core Movary components, such as the routing system, the processing of external API data and some other stuff. Note: The <code>/src/api</code> directory is mainly   meant for connecting with the external APIs and sending HTTP requests, whereas the external API stuff in <code>/src/Service</code> mainly handles how to process the data from those   external APIs.</li> <li><code>/src/Util</code> - Contains basic utility files to keep consistency throughout the project</li> <li><code>/src/Domain</code> - Contains the core Movary domain implementation, e.g. what is a movie in Movary (required movary and tmdb ids) or a watch date (required user and movary ids) and   how to create or delete those</li> </ul>"},{"location":"development/file-structure/#templates","title":"Templates","text":"<p>The frontend of Movary is mainly regular HTML5, but it also uses the twig framework from Symfony, to use dynamic templates. This allows for cleaner code when injecting PHP code in HTML. So instead of using <code>&lt;?php echo $variable ?&gt;</code>, you can use <code>{{ $variable }}</code> and the twig engine will automatically translate the clean code into the PHP code. See their documentation for more information.</p>"},{"location":"development/file-structure/#frontend-assets","title":"Frontend assets","text":"<p>The CSS, Javascript and the images are located in <code>/public</code>.</p>"},{"location":"development/setup/","title":"Setup","text":""},{"location":"development/setup/#local-development-setup","title":"Local development setup","text":"<p>First steps for local development setup:</p> <ul> <li>Clone the repository</li> <li>Copy the file <code>.env.example</code> to <code>.env</code> and customize it for your local environment<ul> <li>Set <code>USER_ID</code> to the UID owning the local files (<code>echo $UID</code>)</li> <li>Add your <code>TMDB_API_KEY</code></li> </ul> </li> <li>Run <code>make build_development</code> to create your local development environment <ul> <li>Build and start the development stage of the docker image from scratch</li> <li>Mount project files in to the docker container (changes to files affect application in realtime)</li> <li>Install composer dependencies</li> <li>Create the database (sqlite on default)</li> <li>Run database migrations</li> <li>Create the storage symlink</li> </ul> </li> </ul> <p>The application should be up-to-date and running locally now.</p> <p>Use the following cli commands to manage your local environment:</p> <ul> <li><code>make up</code> to start the application in production stage using SQLite (using docker volumes)</li> <li><code>make up_mysql</code> to start the application in production stage using MySQL (using docker volumes)</li> <li><code>make up_development</code> to start the application in development stage using SQLite (mounting local files)</li> <li><code>make up_development_myqsl</code> to start the application in development stage using MySQL (mounting local files)</li> <li><code>make down</code> to stop all containers</li> <li><code>make app_database_migrate</code> execute the database migrations</li> <li><code>make app_jobs_process</code> process the next job from the queue (see database table <code>job_queue</code>)</li> </ul>"},{"location":"development/setup/#xdebug","title":"Xdebug","text":"<p>You can change <code>XDEBUG_MODE</code> to <code>debug</code> in the <code>.env</code> file to enable debugging using Xdebug in the development docker container.</p> <p>For example, in VSCode or VSCodium, the following debug configuration would allow you to set breakpoints and debug the PHP code:</p> <pre><code>{\n  \"version\": \"0.2.0\",\n  \"configurations\": [\n    {\n      \"name\": \"Listen for Xdebug\",\n      \"type\": \"php\",\n      \"request\": \"launch\",\n      \"port\": 9003,\n      \"pathMappings\": {\n        \"/app\": \"${workspaceRoot}\"\n      }\n    }\n  ]\n}\n</code></pre>"},{"location":"development/setup/#ide-recommendation-phpstorm","title":"IDE recommendation: PhpStorm","text":"<p>PhpStorm is recommended for development. Import the Pathary code style scheme (found at <code>settings/phpstorm.xml</code>). For import instructions see the official docs.</p> <p>To apply the code style rules use at least the following features:</p> <ul> <li><code>Reformat code</code> (more info here)</li> <li><code>Rearrange code</code> (more info here)</li> <li><code>Optimize imports</code></li> </ul> <p>Notes:</p> <ul> <li>Please apply the code style rules for every file you changed</li> <li>To find the default shortcuts for the features and/or customize search for them in Settings -&gt; Keymap</li> <li>If you use the PhpStorm UI for git you can execute the features automatically before every commit (Settings -&gt; Version Control -&gt; Commit -&gt; Commit Checks)</li> </ul>"},{"location":"development/setup/#documentation","title":"Documentation","text":""},{"location":"development/setup/#general","title":"General","text":""},{"location":"development/setup/#description","title":"Description","text":"<p>This project uses Material for MkDocs for the documentation.</p> <p>This is part of the default development docker compose setup and can be reached via <code>http://127.0.0.1:8000</code>.</p> <p>To adjust the documentation files look into the <code>docs</code> directory and the configuration of MkDocs is in <code>mkdocs.yml</code>. </p>"},{"location":"development/setup/#setup","title":"Setup","text":"<p>Run <code>make up_docs</code> to start MkDocs. Set environment variable <code>HTTP_PORT_DOCS</code> to adjust host port. </p>"},{"location":"development/setup/#rest-api","title":"REST-Api","text":"<p>Checkout the API docs via the url <code>http://127.0.0.1/docs/api</code>.</p> <p>This uses the schema defined in the file <code>/docs/openapi.json</code>. Please adjust openapi schema if you change the API.</p>"},{"location":"development/setup/#useful-links","title":"Useful links","text":"<ul> <li>Trakt API docs</li> <li>TMDB API docs</li> <li>OpenAPI API docs</li> </ul>"},{"location":"development/structure/","title":"Backend Structure","text":""},{"location":"development/structure/#routing","title":"Routing","text":"<p>When someone visits Movary, a request wil be sent to the Router, which is configured via <code>/settings/routes.php</code>.</p> <p>To add a new route, go to the file <code>settings/routes.php</code> and add this new line:</p> <pre><code>$routes-&gt;add('&lt;HTTP_METHOD&gt;', '/your/url/path', [Web\\Some\\Controller::class, 'Method']);\n</code></pre> <p>Replace  with either <code>GET</code>, <code>POST</code>, <code>PUT</code> or <code>DELETE</code> and put this line of code in either the <code>addWebRoutes</code> function or the <code>addApiRoutes</code> function. It should be in <code>addWebRoutes</code> if it's a route that the user will be visiting on the website and in the <code>addApiRoutes</code> if it's not. <p>Movary uses FastRoute to manage most of the routing stuff (only the middleware is added by us) and for more info, visit their git repo.</p>"},{"location":"development/structure/#middleware","title":"Middleware","text":"<p>Middlewares are methods that check if the user is allowed to do this. For example, to check if someone is allowed to access the settings page, the middleware <code>UserIsAuthenticated</code> will be used and to check if the user is an admin, the middleware <code>UserIsAdmin</code> is used.</p> <p>All the middleware are in the namespace <code>Movary\\HttpController\\Web\\Middleware</code> and use the interface <code>MiddlewareInterface</code>.</p>"},{"location":"development/structure/#writing-new-middlewares","title":"Writing new middlewares","text":"<p>To add new middlewares, first create a new file like <code>/src/HttpController/Web/Middleware/MyNewMiddleware.php</code>.</p> <p>Then copy-paste this in the new file:</p> <pre><code>&lt;?php declare(strict_types=1);\n\nnamespace Movary\\HttpController\\Web\\Middleware;\n\nclass MyNewMiddleware implements MiddlewareInterface\n{\n    public function __invoke() : ?Response\n    {\n        // Add your own code here\n    }\n}\n</code></pre> <p>Change the class name and you're set to start writing your own middleware! The code in the <code>__invoke()</code> method is the code that will be executed if the middleware is added to a route and the route is visited by an user.</p>"},{"location":"development/structure/#adding-a-new-middleware-to-a-route","title":"Adding a new middleware to a route","text":"<p>To add a middleware to a route, add the middleware class in an array to the <code>$routes-&gt;add()</code> method in a fourth parameter like this:</p> <pre><code>$routes-&gt;add('&lt;HTTPMETHOD&gt;', '/your/url/path', [Web\\Some\\Controller::class, 'Method'], [Web\\Middleware\\MyNewMiddleware::class, Web\\Middleware\\MyNewMiddlewareTwo::class]);\n</code></pre>"},{"location":"development/structure/#http-controllers","title":"HTTP Controllers","text":"<p>The HTTP controllers are all located in <code>/src/HttpController</code>. These are the methods that will be executed when the route is visited.</p> <p>The controllers for the website have the namespace <code>namespace Movary\\HttpController\\Web</code> and the API-related controllers have <code>namespace Movary\\HttpController\\Web</code>.</p>"},{"location":"development/structure/#data-transfer-objects-dto","title":"Data Transfer Objects (DTO)","text":"<p>Data Transfer Objects (DTO) are frequently used in Movary and can be found throughout the whole backend.</p> <p>A DOT is used to transfer data between classes and processes in a statically defined typesafe manner (in opposite to for example arrays).</p> <p>For a different (perhaps better) explanation, visit this Stackoverflow thread</p>"},{"location":"development/structure/#dependency-injections-bootstrapping-and-the-factory","title":"Dependency injections, bootstrapping and the Factory","text":"<p>The basic bootstrapping of the application is configured in the <code>bootstrap.php</code>. </p> <p>The <code>bootstrap.php</code> will create and return a PSR7 confirm ContainerInterface, containing the dynamic and manually configured dependency wiring. This is loaded in the <code>public/index.php</code> when processing a HTTP request or in the <code>bin/console.php</code> when processing cli commands.</p> <p>If you need to wire a dependency manually (e.g. which implementation of an interface to use or depending on a scalar type) extend the definitions array in the <code>bootstrap.php</code> and create a factory method if necessary.</p>"},{"location":"features/emby/","title":"Emby","text":"<p>Integration Under Development</p> <p>This integration feature is currently being worked on and may not be fully functional. Please check back for updates.</p>"},{"location":"features/emby/#webhook-scrobbler","title":"Webhook (Scrobbler)","text":""},{"location":"features/emby/#description","title":"Description","text":"<p>Automatically add new Emby movie plays to Pathary. This uses the Emby webhook feature.</p> <p>Info</p> <p>To use webhooks in Emby an active Emby Premiere license is required.</p>"},{"location":"features/emby/#instruction","title":"Instruction","text":"<ul> <li>Generate a webhook url in Pathary for your user on the Emby integration settings page (<code>/settings/integrations/emby</code>)</li> <li>Add the generated url as a webhook to your Emby server to start scrobbling</li> </ul> <p>Tip</p> <p>Keep your webhook url private to prevent abuse.</p>"},{"location":"features/imdb-rating/","title":"IMDb Rating","text":""},{"location":"features/imdb-rating/#description","title":"Description","text":"<p>Update the IMDb rating of all local movies.  Movies without IMDb ratings or updated the longest time ago are prioritized.</p> <p>Info</p> <p>Pathary scrapes the IMDb website for the ratings. Changes to the IMDb website structure can break the scraping and have to be fixed. This happens from time to time. Please report problems so that this can be quickly handled.</p>"},{"location":"features/imdb-rating/#command","title":"Command","text":"<pre><code>php bin/console.php imdb:sync\n</code></pre>"},{"location":"features/imdb-rating/#interesting-flags","title":"Interesting flags","text":"<ul> <li><code>--help</code>   Detailed information about the command</li> <li><code>--hours</code>   Number of hours required to have elapsed since last sync</li> <li><code>--threshold</code>   Maximum number of movies to sync</li> <li><code>--movieIds</code>   Comma separated string of movie ids to force sync for</li> <li><code>--never-synced</code>   Use to sync only movies which were never synced before</li> </ul>"},{"location":"features/imdb-rating/#example","title":"Example","text":"<p>Update ratings for the first 30 movies which were not updated in the last 24 hours ago <pre><code>php bin/console.php imdb:sync` --hours 24 --threshold 30\n</code></pre></p>"},{"location":"features/jellyfin/","title":"Jellyfin","text":"<p>Integration Under Development</p> <p>This integration feature is currently being worked on and may not be fully functional. Please check back for updates.</p>"},{"location":"features/jellyfin/#webhook-scrobbler","title":"Webhook (Scrobbler)","text":""},{"location":"features/jellyfin/#description","title":"Description","text":"<p>Automatically add new Jellyin movie plays to Pathary.</p> <p>Info</p> <p>Requires the webhook plugin to be installed and active in Jellyfin.</p>"},{"location":"features/jellyfin/#instruction","title":"Instruction","text":"<ul> <li>Generate a webhook url in Pathary for your user on the Jellyfin integration settings page (<code>/settings/integrations/jellyfin</code>)</li> <li>Add the generated url in the Jellyfin webhook plugin as a <code>Generic Destination</code> and activate only:<ul> <li>Notification Type =&gt; \"Playback Stop\"</li> <li>User Filter =&gt; Choose your user</li> <li>Item Type =&gt; \"Movies\" + \"Send All Properties (ignores template)\"</li> </ul> </li> </ul> <p>Tip</p> <p>Keep your webhook url private to prevent abuse.</p>"},{"location":"features/jellyfin/#authentication","title":"Authentication","text":"<p>Some features require access to protected personal Jellyfin data. You can authenticate Pathary against Jellyfin on the Jellyfin integration settings page (<code>/settings/integrations/jellyfin</code>).</p> <p>Info</p> <p>Requires the server configuration JELLYFIN_DEVICE_ID to be set.</p> <p>During the authentication process a Jellyfin access token is generated and stored in Pathary. This token will be used in all further Jellyfin API requests. When an authentication is removed from Pathary, the token will be deleted in Pathary and the Jellyfin server.</p>"},{"location":"features/jellyfin/#sync","title":"Sync","text":"<p>General notes:</p> <ul> <li>Movies are matched via tmdb id. Movies without a tmdb id in Jellyfin are ignored.</li> <li>Movies will be updated in all Jellyfin libraries.</li> <li>Backup your Jellyfin database regularly in case something goes wrong!</li> </ul>"},{"location":"features/jellyfin/#automatic-sync","title":"Automatic sync","text":"<p>You can keep your Jellyfin libraries automatically up to date with your latest Pathary watch history changes.</p> <p>Info</p> <p>Jellyfin authentication is required.  </p> <p>If the automatic sync is enabled (e.g. on <code>/settings/integrations/jellyfin</code>) new watch dates added to Pathary are automatically pushed as plays to Jellyfin. If a movie has its last watch date removed in Pathary it is set to unwatched in Jellyfin.</p>"},{"location":"features/jellyfin/#export","title":"Export","text":""},{"location":"features/jellyfin/#description_1","title":"Description","text":"<p>You can export your Pathary watch dates as plays to Jellyfin.</p> <p>Info</p> <p>Jellyfin authentication is required.  </p> <p>Pathary will compare its movie watch dates against the Jellyfin movie plays. Movies not marked as watched in Jellyfin but with watch dates in Pathary are marked as watched and get the latest watch date set as the last play date. Movies already marked as watched are updated with the latest watch date as the last play date if the dates are not the same.</p>"},{"location":"features/jellyfin/#cli-command","title":"CLI command","text":"<pre><code>php bin/console.php jellyfin:export &lt;userId&gt;\n</code></pre>"},{"location":"features/jellyfin/#import","title":"Import","text":""},{"location":"features/jellyfin/#description_2","title":"Description","text":"<p>You can import your Jellyfin plays as Pathary watch dates.</p> <p>Info</p> <p>Jellyfin authentication is required.  </p> <p>Pathary will compare the Jellyfin movie plays against its movie watch dates. Movies with multiple plays in Jellyfin are handled as one watch date, using the date of the latest play. Watch dates are added to Pathary if they are missing, existing watch dates are not changed. </p>"},{"location":"features/jellyfin/#cli-command_1","title":"CLI command","text":"<pre><code>php bin/console.php jellyfin:import &lt;userId&gt;\n</code></pre>"},{"location":"features/kodi/","title":"Kodi","text":"<p>Integration Under Development</p> <p>This integration feature is currently being worked on and may not be fully functional. Please check back for updates.</p>"},{"location":"features/kodi/#webhook-scrobbler","title":"Webhook (Scrobbler)","text":""},{"location":"features/kodi/#description","title":"Description","text":"<p>Automatically add new Kodi movie plays to Pathary.</p> <p>Info</p> <p>Only Kodi movies with tmdb ids can be logged to Pathary.</p>"},{"location":"features/kodi/#instruction","title":"Instruction","text":"<ul> <li>Generate a webhook url in Pathary for your user on the Kodi integration settings page (<code>/settings/integrations/kodi</code>)</li> <li>Install the Movary Addon in Kodi</li> <li>Enter the generated Pathary webhook url in the Kodi Addon settings</li> <li>Enable the Addon in the Kodi Addon settings</li> </ul>"},{"location":"features/letterboxd/","title":"Letterboxd","text":"<p>Integration Under Development</p> <p>This integration feature is currently being worked on and may not be fully functional. Please check back for updates.</p>"},{"location":"features/letterboxd/#import","title":"Import","text":"<p>You can import your watch history and ratings from Letterboxd to Pathary.</p> <p>Export your data from Letterboxd here. You will receive a ZIP archive containing multiple CSV files. The <code>diary.csv</code> contains your watch dates and the and the <code>ratings.csv</code> your ratings. Visit the Pathary settings page <code>/settings/integrations/letterboxd</code> to import these files to Pathary.</p> <p>Info</p> <ul> <li>Ratings are only imported for movies already existing in Pathary (import the diary.csv first).</li> <li>The import only adds watch dates or ratings missing in Pathary and it will not overwrite existing data.</li> <li>Importing hundreds or thousands of movies for the first time can take a few minutes.</li> </ul>"},{"location":"features/letterboxd/#export","title":"Export","text":"<p>You can export your watch dates and ratings from Pathary to Letterboxd. </p> <p>Visit <code>/settings/integrations/letterboxd</code> to export your watch dates and ratings. The export will generate a ZIP archive containing one or multiple CSV files.  You have to upload all CSV file on Letterboxd to completely import your data. Letterboxd enforces a max file size limit which can make it necessary for Pathary to split your data into multiple files. </p> <p>More info about how the Letterbox import works can be found here.</p>"},{"location":"features/locations/","title":"Locations","text":""},{"location":"features/locations/#description","title":"Description","text":"<p>Locations (e.g. a cinema) can be set for a play.</p> <p>Each user maintains a personal collection of available locations. The locations can be managed in the user settings at <code>/settings/account/locations</code>. A location can be marked as a cinema.</p> <p>When a users visibility is not set to private, others can see if a location is set for a play but not which exact location.</p> <p>Info</p> <p>This feature is optional and can be disabled. </p> <p>Disabling keeps the current data, but hides all locations UI elements.</p>"},{"location":"features/movies-and-tmdb/","title":"Movies and TMDB","text":"<p>This page covers how Pathary manages movie data and integrates with The Movie Database (TMDB).</p>"},{"location":"features/movies-and-tmdb/#overview","title":"Overview","text":"<p>Pathary uses TMDB as its primary source for movie metadata: - Movie titles, descriptions, and release dates - Poster images - Cast and crew information - Genre classifications</p>"},{"location":"features/movies-and-tmdb/#tmdb-api-key","title":"TMDB API Key","text":"<p>A TMDB API key is required. Get one at: https://www.themoviedb.org/settings/api</p> <pre><code>TMDB_API_KEY=your_api_key_here\n</code></pre>"},{"location":"features/movies-and-tmdb/#movie-entity","title":"Movie Entity","text":"<p>File: <code>src/Domain/Movie/MovieEntity.php</code></p> <p>Key fields:</p> Field Type Description <code>id</code> int Internal Pathary ID <code>tmdb_id</code> int TMDB movie ID <code>imdb_id</code> string IMDb ID (e.g., <code>tt1234567</code>) <code>title</code> string Display title <code>original_title</code> string Original language title <code>overview</code> string Plot summary <code>release_date</code> Date Release date <code>runtime</code> int Duration in minutes <code>tmdb_poster_path</code> string TMDB poster URL path <code>poster_path</code> string Cached local poster path"},{"location":"features/movies-and-tmdb/#tmdb-search","title":"TMDB Search","text":""},{"location":"features/movies-and-tmdb/#search-flow","title":"Search Flow","text":"<pre><code>User enters search query\n        \u2193\nGET /search?query=...\n        \u2193\nSearchController::search()\n        \u2193\nTmdbApi::searchMovies($query)\n        \u2193\nTMDB API: /search/movie\n        \u2193\nResults displayed in UI\n</code></pre>"},{"location":"features/movies-and-tmdb/#search-implementation","title":"Search Implementation","text":"<p>File: <code>src/Api/Tmdb/TmdbApi.php</code></p> <pre><code>public function searchMovies(string $query, int $page = 1) : array\n{\n    $response = $this-&gt;client-&gt;get('/search/movie', [\n        'query' =&gt; [\n            'query' =&gt; $query,\n            'page' =&gt; $page,\n            'language' =&gt; $this-&gt;language,\n        ],\n    ]);\n\n    return json_decode($response-&gt;getBody()-&gt;getContents(), true);\n}\n</code></pre>"},{"location":"features/movies-and-tmdb/#api-search-endpoint","title":"API Search Endpoint","text":"<pre><code>GET /api/movies/search?query=inception\n</code></pre> <p>File: <code>src/HttpController/Api/MovieSearchController.php</code></p>"},{"location":"features/movies-and-tmdb/#adding-movies","title":"Adding Movies","text":""},{"location":"features/movies-and-tmdb/#add-from-search-results","title":"Add From Search Results","text":"<pre><code>User clicks \"Add\" on search result\n        \u2193\nPOST /tmdb/movie/{tmdbId}/add\n        \u2193\nTmdbMovieController::add()\n        \u2193\nTmdbApi::getMovie($tmdbId)\n        \u2193\nMovieRepository::create($movieData)\n        \u2193\nRedirect to movie page\n</code></pre>"},{"location":"features/movies-and-tmdb/#add-implementation","title":"Add Implementation","text":"<p>File: <code>src/HttpController/Web/TmdbMovieController.php</code></p> <pre><code>public function add(Request $request) : Response\n{\n    $tmdbId = (int)$request-&gt;getRouteParameters()['tmdbId'];\n    $userId = $this-&gt;authenticationService-&gt;getCurrentUserId();\n\n    // Fetch from TMDB\n    $tmdbMovie = $this-&gt;tmdbApi-&gt;getMovie($tmdbId);\n\n    // Create local movie record\n    $movie = $this-&gt;movieApi-&gt;createFromTmdb($tmdbMovie);\n\n    // Add to user's watch history\n    $this-&gt;movieHistoryApi-&gt;create($movie-&gt;getId(), $userId, Date::createNow());\n\n    return Response::createSeeOther('/movie/' . $movie-&gt;getId());\n}\n</code></pre>"},{"location":"features/movies-and-tmdb/#tmdb-data-sync","title":"TMDB Data Sync","text":""},{"location":"features/movies-and-tmdb/#movie-data-refresh","title":"Movie Data Refresh","text":"<pre><code>GET /movies/{id}/refresh-tmdb\n</code></pre> <p>File: <code>src/HttpController/Web/Movie/MovieController.php</code></p> <pre><code>public function refreshTmdbData(Request $request) : Response\n{\n    $movieId = (int)$request-&gt;getRouteParameters()['id'];\n\n    $this-&gt;syncMovieService-&gt;syncMovie($movieId);\n\n    return Response::createSeeOther('/movie/' . $movieId);\n}\n</code></pre>"},{"location":"features/movies-and-tmdb/#sync-service","title":"Sync Service","text":"<p>File: <code>src/Service/Tmdb/SyncMovie.php</code></p> <p>Updates: - Basic metadata (title, overview, runtime) - Cast and crew - Genres - Production companies - Poster images</p>"},{"location":"features/movies-and-tmdb/#image-handling","title":"Image Handling","text":""},{"location":"features/movies-and-tmdb/#image-urls","title":"Image URLs","text":"<p>TMDB images are served from their CDN: <pre><code>https://image.tmdb.org/t/p/{size}/{path}\n</code></pre></p> <p>Sizes: <code>w92</code>, <code>w154</code>, <code>w185</code>, <code>w342</code>, <code>w500</code>, <code>w780</code>, <code>original</code></p>"},{"location":"features/movies-and-tmdb/#image-caching","title":"Image Caching","text":"<p>File: <code>src/Service/ImageCacheService.php</code></p> <p>Enable caching: <pre><code>TMDB_ENABLE_IMAGE_CACHING=1\n</code></pre></p> <p>When enabled, images are downloaded to <code>storage/images/</code> and served locally.</p>"},{"location":"features/movies-and-tmdb/#image-url-service","title":"Image URL Service","text":"<p>File: <code>src/Service/ImageUrlService.php</code></p> <pre><code>public function replacePosterPathWithImageSrcUrl(array $movies) : array\n{\n    foreach ($movies as &amp;$movie) {\n        if ($movie['tmdb_poster_path'] !== null) {\n            $movie['poster_src'] = $this-&gt;generatePosterUrl($movie['tmdb_poster_path']);\n        }\n    }\n    return $movies;\n}\n</code></pre>"},{"location":"features/movies-and-tmdb/#tmdb-client","title":"TMDB Client","text":"<p>File: <code>src/Api/Tmdb/TmdbClient.php</code></p> <pre><code>class TmdbClient\n{\n    private const string BASE_URL = 'https://api.themoviedb.org/3';\n\n    public function get(string $endpoint, array $options = []) : ResponseInterface\n    {\n        $options['query']['api_key'] = $this-&gt;apiKey;\n\n        return $this-&gt;httpClient-&gt;request('GET', self::BASE_URL . $endpoint, $options);\n    }\n}\n</code></pre>"},{"location":"features/movies-and-tmdb/#data-flow-diagram","title":"Data Flow Diagram","text":"<pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                          TMDB API                               \u2502\n\u2502                  api.themoviedb.org/3                           \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                             \u2502\n                             \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                      TmdbClient                                 \u2502\n\u2502              src/Api/Tmdb/TmdbClient.php                        \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                             \u2502\n                             \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                       TmdbApi                                   \u2502\n\u2502               src/Api/Tmdb/TmdbApi.php                          \u2502\n\u2502                                                                 \u2502\n\u2502   searchMovies()  getMovie()  getPerson()  getCredits()         \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                             \u2502\n                             \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                   Service Layer                                 \u2502\n\u2502                                                                 \u2502\n\u2502   SyncMovie    MovieApi    GroupMovieService                    \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                             \u2502\n                             \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                  MovieRepository                                \u2502\n\u2502          src/Domain/Movie/MovieRepository.php                   \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                             \u2502\n                             \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                      Database                                   \u2502\n\u2502              movie, movie_genre, movie_cast, etc.               \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"features/movies-and-tmdb/#related-tables","title":"Related Tables","text":"Table Content <code>movie</code> Core movie data <code>movie_genre</code> Genre associations <code>movie_cast</code> Actor associations <code>movie_crew</code> Director/crew associations <code>genre</code> Genre definitions <code>person</code> Actor/director data"},{"location":"features/movies-and-tmdb/#error-handling","title":"Error Handling","text":""},{"location":"features/movies-and-tmdb/#api-errors","title":"API Errors","text":"<p>File: <code>src/Api/Tmdb/Exception/</code></p> Exception Cause <code>TmdbAuthorizationError</code> Invalid API key <code>TmdbResourceNotFound</code> Movie not found on TMDB"},{"location":"features/movies-and-tmdb/#rate-limiting","title":"Rate Limiting","text":"<p>TMDB has rate limits (~50 requests/second). The application doesn't currently implement rate limiting, but high-volume operations (bulk sync) should be throttled.</p>"},{"location":"features/movies-and-tmdb/#cli-commands","title":"CLI Commands","text":""},{"location":"features/movies-and-tmdb/#sync-all-movies","title":"Sync All Movies","text":"<pre><code>docker exec pathary-app php bin/console.php tmdb:movie:sync\n</code></pre>"},{"location":"features/movies-and-tmdb/#sync-person-data","title":"Sync Person Data","text":"<pre><code>docker exec pathary-app php bin/console.php tmdb:person:sync\n</code></pre>"},{"location":"features/movies-and-tmdb/#related-pages","title":"Related Pages","text":"<ul> <li>Ratings and Comments] - User ratings for movies</li> <li>Database] - Movie table schema</li> <li>Frontend and UI] - Movie display templates</li> </ul> <p>\u2190 Back to Wiki Home</p>"},{"location":"features/netflix/","title":"Netflix","text":"<p>Integration Under Development</p> <p>This integration feature is currently being worked on and may not be fully functional. Please check back for updates.</p>"},{"location":"features/netflix/#import","title":"Import","text":"<p>You can import your watch history from Netflix to Pathary.</p> <p>Go to Netflix and find your history, scroll to the bottom of the page and click the <code>Download all</code> link. You will receive a CSV file containing your watch history.  Upload the downloaded CSV file to Pathary at <code>/settings/integrations/netflix</code> to verify and edit the import data.  Start the import with the <code>Import data</code> button.</p>"},{"location":"features/plex/","title":"Plex","text":"<p>Integration Under Development</p> <p>This integration feature is currently being worked on and may not be fully functional. Please check back for updates.</p>"},{"location":"features/plex/#webhook-scrobbler","title":"Webhook (Scrobbler)","text":""},{"location":"features/plex/#description","title":"Description","text":"<p>Automatically add new Plex movie plays and ratings to Pathary.</p> <p>Info</p> <p>To use the required webhooks feature in Plex an active Plex Pass subscription is neceessary.</p>"},{"location":"features/plex/#instruction","title":"Instruction","text":"<ul> <li>Generate a webhook url in Pathary for your user on the Plex integration settings page (<code>/settings/integrations/plex</code>)</li> <li>Add the generated url as a webhook to your Plex server to start scrobbling</li> </ul> <p>You can select what you want to scrobble (movie plays and/or ratings) via the \"Scrobble Options\" checkboxes on the settings page.</p> <p>Tip</p> <p>Keep your webhook url private to prevent abuse.</p>"},{"location":"features/plex/#authentication","title":"Authentication","text":"<p>Some features require access to protected personal Plex data. You can authenticate Pathary against Plex on the Plex integration settings page (<code>/settings/integrations/plex</code>).</p> <p>Info</p> <p>Requires the server configuration PLEX_IDENTIFIER to be set.</p> <p>During the authentication process a Plex access token is generated and stored in Pathary.  This token will be used in all further Plex API requests. When an authentication is removed from Pathary, the token will be deleted only in Pathary.</p> <p>Info</p> <p>Removing the authentication only deletes the token stored in Pathary itself. The token still exists in Plex. To invalidate the access token in Plex, go to your Plex settings at: Account -&gt; Authorized devices -&gt; Click on the red cross for the entry \"Pathary\"</p>"},{"location":"features/plex/#watchlist-import","title":"Watchlist import","text":""},{"location":"features/plex/#description_1","title":"Description","text":"<p>Import missing movies from your Plex Watchlist to your Pathary Watchlist. Missing movies imported to the Pathary Watchlist are put at the beginning of the list in the same order as they are in Plex.</p> <p>Info</p> <p>Plex authentication is required.</p>"},{"location":"features/plex/#instruction_1","title":"Instruction","text":""},{"location":"features/plex/#web-ui","title":"Web UI","text":"<p>You can schedule import jobs and see the status/history of past jobs on the Plex integration settings page (<code>/settings/integrations/plex</code>).</p>"},{"location":"features/plex/#command","title":"Command","text":"<p>You can directly trigger an import via CLI</p> <pre><code>php bin/console.php plex:watchlist:import --userId=&lt;id&gt;\n</code></pre> <p>Tip</p> <p>You could create a cronjob to regularly import your watchlist to keep up to date automatically. </p>"},{"location":"features/radarr/","title":"Radarr","text":"<p>Integration Under Development</p> <p>This integration feature is currently being worked on and may not be fully functional. Please check back for updates.</p>"},{"location":"features/radarr/#radarr-list","title":"Radarr list","text":""},{"location":"features/radarr/#description","title":"Description","text":"<p>You can set up Radarr to automatically import movies added to your Pathary watchlist via the Radarr lists import feature.</p>"},{"location":"features/radarr/#instruction","title":"Instruction","text":"<ul> <li>Generate the feed url in Pathary on the Radarr integration settings page (<code>/settings/integrations/radarr</code>)</li> <li>Go to your Radarr Settings and select \"Lists\"</li> <li>Click on the plus to add a new list</li> <li>In the section Advanced List select \"StevenLu Custom\"</li> <li>Copy the Pathary feed url to the \"URL\" input in Radarr and save</li> </ul> <p>Feel free to change any other settings of the StevenLu list, it doesn't affect Pathary or the watchlist.</p>"},{"location":"features/ratings-and-comments/","title":"Ratings and Comments","text":"<p>This page covers Pathary's unique popcorn rating system and how ratings are stored and displayed.</p>"},{"location":"features/ratings-and-comments/#popcorn-rating-scale","title":"Popcorn Rating Scale","text":"<p>Pathary uses a 1-7 popcorn scale instead of traditional 5 or 10-star ratings:</p> Rating Meaning 1 Terrible 2 Bad 3 Below average 4 Average 5 Good 6 Great 7 Masterpiece <p>Visual representation: \ud83c\udf7f\ud83c\udf7f\ud83c\udf7f\ud83c\udf7f\ud83c\udf7f\ud83c\udf7f\ud83c\udf7f</p>"},{"location":"features/ratings-and-comments/#rating-data-model","title":"Rating Data Model","text":""},{"location":"features/ratings-and-comments/#table-movie_user_rating","title":"Table: movie_user_rating","text":"<p>File: <code>db/migrations/mysql/20251214000000_AddWatchedDateAndLocationToMovieUserRating.php</code></p> <pre><code>CREATE TABLE movie_user_rating (\n    movie_id INT UNSIGNED NOT NULL,\n    user_id INT UNSIGNED NOT NULL,\n    rating TINYINT,                    -- Legacy 1-10 rating\n    rating_popcorn TINYINT UNSIGNED,   -- Popcorn 1-7 rating\n    comment TEXT,                      -- User's review\n    watched_year SMALLINT UNSIGNED,    -- When watched (year)\n    watched_month TINYINT UNSIGNED,    -- When watched (month, optional)\n    watched_day TINYINT UNSIGNED,      -- When watched (day, optional)\n    location_id TINYINT UNSIGNED,      -- Where watched\n    created_at TIMESTAMP,\n    updated_at TIMESTAMP,\n    PRIMARY KEY (movie_id, user_id)\n);\n</code></pre>"},{"location":"features/ratings-and-comments/#location-options","title":"Location Options","text":"ID Label 1 Cinema 2 At Home 3 Other <p>File: <code>src/HttpController/Web/RateMovieController.php</code></p> <pre><code>public const int LOCATION_CINEMA = 1;\npublic const int LOCATION_AT_HOME = 2;\npublic const int LOCATION_OTHER = 3;\n\npublic const array LOCATION_LABELS = [\n    self::LOCATION_CINEMA =&gt; 'Cinema',\n    self::LOCATION_AT_HOME =&gt; 'At Home',\n    self::LOCATION_OTHER =&gt; 'Other',\n];\n</code></pre>"},{"location":"features/ratings-and-comments/#rating-submission","title":"Rating Submission","text":""},{"location":"features/ratings-and-comments/#submit-rating-flow","title":"Submit Rating Flow","text":"<pre><code>User submits rating form\n        \u2193\nPOST /movie/{id}/rate\n        \u2193\nRateMovieController::rate()\n        \u2193\nMovieRepository::upsertUserRatingWithComment()\n        \u2193\nRedirect to movie page\n</code></pre>"},{"location":"features/ratings-and-comments/#controller-implementation","title":"Controller Implementation","text":"<p>File: <code>src/HttpController/Web/RateMovieController.php</code></p> <pre><code>public function rate(Request $request) : Response\n{\n    $movieId = (int)$request-&gt;getRouteParameters()['id'];\n    $userId = $this-&gt;authenticationService-&gt;getCurrentUserId();\n    $postData = $request-&gt;getPostParameters();\n\n    // Parse rating (0 means unrated)\n    $ratingValue = isset($postData['rating_popcorn']) ? (int)$postData['rating_popcorn'] : 0;\n    $ratingPopcorn = ($ratingValue &gt;= 1 &amp;&amp; $ratingValue &lt;= 7)\n        ? PopcornRating::create($ratingValue)\n        : null;\n\n    // Parse comment\n    $comment = isset($postData['comment']) &amp;&amp; trim($postData['comment']) !== ''\n        ? trim($postData['comment'])\n        : null;\n\n    // Parse watched date (partial date support)\n    $watchedYear = $this-&gt;parseIntOrNull($postData['watched_year'] ?? null);\n    $watchedMonth = $this-&gt;parseIntOrNull($postData['watched_month'] ?? null);\n    $watchedDay = $this-&gt;parseIntOrNull($postData['watched_day'] ?? null);\n\n    // Validate date hierarchy\n    if ($watchedDay !== null &amp;&amp; $watchedMonth === null) {\n        $watchedDay = null;\n    }\n    if ($watchedMonth !== null &amp;&amp; $watchedYear === null) {\n        $watchedMonth = null;\n        $watchedDay = null;\n    }\n\n    // Parse location\n    $locationId = $this-&gt;parseIntOrNull($postData['location_id'] ?? null);\n\n    // Save rating\n    $this-&gt;movieRepository-&gt;upsertUserRatingWithComment(\n        $movieId, $userId, $ratingPopcorn, $comment,\n        $watchedYear, $watchedMonth, $watchedDay, $locationId,\n    );\n\n    return Response::createSeeOther('/movie/' . $movieId . '#ratings');\n}\n</code></pre>"},{"location":"features/ratings-and-comments/#partial-date-support","title":"Partial Date Support","text":"<p>Users can record when they watched a movie with varying precision:</p> Precision Example Display Full date 14.12.2024 Month + Year 12.2024 Year only 2024 <p>Template logic (<code>templates/public/movie_detail.twig</code>):</p> <pre><code>{% if rating.watched_day and rating.watched_month %}\n    {{ '%02d'|format(rating.watched_day) }}.{{ '%02d'|format(rating.watched_month) }}.{{ rating.watched_year }}\n{% elseif rating.watched_month %}\n    {{ '%02d'|format(rating.watched_month) }}.{{ rating.watched_year }}\n{% else %}\n    {{ rating.watched_year }}\n{% endif %}\n</code></pre>"},{"location":"features/ratings-and-comments/#delete-rating","title":"Delete Rating","text":""},{"location":"features/ratings-and-comments/#delete-flow","title":"Delete Flow","text":"<pre><code>User clicks delete button\n        \u2193\nPOST /movie/{id}/rate/delete\n        \u2193\nRateMovieController::deleteRating()\n        \u2193\nMovieRepository::deleteUserRating()\n        \u2193\nRedirect to movie page\n</code></pre> <p>File: <code>src/HttpController/Web/RateMovieController.php</code></p> <pre><code>public function deleteRating(Request $request) : Response\n{\n    $movieId = (int)$request-&gt;getRouteParameters()['id'];\n    $userId = $this-&gt;authenticationService-&gt;getCurrentUserId();\n\n    $this-&gt;movieRepository-&gt;deleteUserRating($movieId, $userId);\n\n    return Response::createSeeOther('/movie/' . $movieId . '#ratings');\n}\n</code></pre>"},{"location":"features/ratings-and-comments/#global-rating-calculation","title":"Global Rating Calculation","text":"<p>Pathary calculates an average rating across all users.</p>"},{"location":"features/ratings-and-comments/#groupmovieservice","title":"GroupMovieService","text":"<p>File: <code>src/Service/GroupMovieService.php</code></p> <pre><code>public function getMovieGroupStats(int $movieId) : array\n{\n    $ratingStats = $this-&gt;dbConnection-&gt;fetchAssociative(\n        &lt;&lt;&lt;SQL\n        SELECT\n            AVG(rating_popcorn) AS avg_popcorn,\n            COUNT(rating_popcorn) AS rating_count,\n            MAX(updated_at) AS last_rating_activity\n        FROM movie_user_rating\n        WHERE movie_id = ? AND rating_popcorn IS NOT NULL\n        SQL,\n        [$movieId],\n    );\n\n    return [\n        'avg_popcorn' =&gt; round((float)$ratingStats['avg_popcorn'], 1),\n        'rating_count' =&gt; (int)$ratingStats['rating_count'],\n        'last_activity_at' =&gt; $ratingStats['last_rating_activity'],\n    ];\n}\n</code></pre>"},{"location":"features/ratings-and-comments/#individual-ratings","title":"Individual Ratings","text":"<pre><code>public function getMovieIndividualRatings(int $movieId) : array\n{\n    $ratings = $this-&gt;dbConnection-&gt;fetchAllAssociative(\n        &lt;&lt;&lt;SQL\n        SELECT\n            u.name AS user_name,\n            mur.rating_popcorn,\n            mur.comment,\n            mur.watched_year,\n            mur.watched_month,\n            mur.watched_day,\n            mur.location_id,\n            COALESCE(mur.updated_at, mur.created_at) AS updated_at\n        FROM movie_user_rating mur\n        JOIN user u ON u.id = mur.user_id\n        WHERE mur.movie_id = ?\n        SQL,\n        [$movieId],\n    );\n\n    shuffle($ratings); // Randomize order\n    return $ratings;\n}\n</code></pre>"},{"location":"features/ratings-and-comments/#ui-components","title":"UI Components","text":""},{"location":"features/ratings-and-comments/#rating-form","title":"Rating Form","text":"<p>File: <code>templates/public/movie_detail.twig</code></p> <p>The rating form uses a 3-column layout: 1. Left: Popcorn rating selector 2. Middle: Watched date (3 dropdowns) 3. Right: Location dropdown</p> <pre><code>&lt;div class=\"rating-form-row\"&gt;\n    &lt;div class=\"rating-form-col\"&gt;\n        &lt;label&gt;Rating&lt;/label&gt;\n        {% include 'components/popcorn_rating.twig' %}\n    &lt;/div&gt;\n\n    &lt;div class=\"rating-form-divider\"&gt;&lt;/div&gt;\n\n    &lt;div class=\"rating-form-col\"&gt;\n        &lt;label&gt;Watched Date&lt;/label&gt;\n        &lt;div class=\"date-dropdowns\"&gt;\n            &lt;select name=\"watched_day\"&gt;...&lt;/select&gt;\n            &lt;select name=\"watched_month\"&gt;...&lt;/select&gt;\n            &lt;select name=\"watched_year\"&gt;...&lt;/select&gt;\n        &lt;/div&gt;\n    &lt;/div&gt;\n\n    &lt;div class=\"rating-form-divider\"&gt;&lt;/div&gt;\n\n    &lt;div class=\"rating-form-col\"&gt;\n        &lt;label&gt;Location&lt;/label&gt;\n        &lt;select name=\"location_id\"&gt;...&lt;/select&gt;\n    &lt;/div&gt;\n&lt;/div&gt;\n</code></pre>"},{"location":"features/ratings-and-comments/#popcorn-rating-widget","title":"Popcorn Rating Widget","text":"<p>File: <code>templates/components/popcorn_rating.twig</code></p> <p>Interactive rating selector using buttons:</p> <pre><code>&lt;div class=\"popcorn-rating popcorn-rating--input\"&gt;\n    &lt;input type=\"hidden\" name=\"rating_popcorn\" value=\"{{ valueInt }}\"&gt;\n    {% for i in 1..7 %}\n        &lt;button type=\"button\"\n                class=\"popcorn-rating__item {{ i &lt;= valueInt ? 'popcorn-on' : 'popcorn-off' }}\"\n                data-value=\"{{ i }}\"&gt;\n            \ud83c\udf7f\n        &lt;/button&gt;\n    {% endfor %}\n&lt;/div&gt;\n</code></pre>"},{"location":"features/ratings-and-comments/#rating-display","title":"Rating Display","text":"<p>Individual ratings are shown in cards:</p> <pre><code>&lt;div class=\"rating-card\"&gt;\n    &lt;div class=\"rating-card-header\"&gt;\n        &lt;span class=\"rating-user-name\"&gt;{{ rating.user_name }}&lt;/span&gt;\n        &lt;div class=\"popcorn-rating popcorn-rating--small\"&gt;\n            {% for i in 1..7 %}\n                &lt;span class=\"{{ i &lt;= rating.rating_popcorn ? 'popcorn-on' : 'popcorn-off' }}\"&gt;\ud83c\udf7f&lt;/span&gt;\n            {% endfor %}\n        &lt;/div&gt;\n    &lt;/div&gt;\n    {% if rating.comment %}\n        &lt;p class=\"rating-comment\"&gt;\"{{ rating.comment }}\"&lt;/p&gt;\n    {% endif %}\n    &lt;div class=\"rating-meta\"&gt;\n        {% if rating.watched_year %}\n            &lt;span&gt;&lt;i class=\"bi bi-calendar-event\"&gt;&lt;/i&gt; {{ watchedDateDisplay }}&lt;/span&gt;\n        {% endif %}\n        {% if rating.location_id %}\n            &lt;span&gt;&lt;i class=\"bi bi-geo-alt\"&gt;&lt;/i&gt; {{ locationLabel }}&lt;/span&gt;\n        {% endif %}\n    &lt;/div&gt;\n&lt;/div&gt;\n</code></pre>"},{"location":"features/ratings-and-comments/#javascript","title":"JavaScript","text":""},{"location":"features/ratings-and-comments/#date-dropdown-logic","title":"Date Dropdown Logic","text":"<p>File: <code>templates/public/movie_detail.twig</code> (inline script)</p> <pre><code>function updateDateDropdowns() {\n    const year = yearSelect.value;\n    const month = monthSelect.value;\n\n    // Month requires year\n    if (!year) {\n        monthSelect.disabled = true;\n        monthSelect.value = '';\n        daySelect.disabled = true;\n        daySelect.value = '';\n    } else {\n        monthSelect.disabled = false;\n        if (!month) {\n            daySelect.disabled = true;\n            daySelect.value = '';\n        } else {\n            daySelect.disabled = false;\n            updateDayOptions(parseInt(year), parseInt(month));\n        }\n    }\n}\n\nfunction updateDayOptions(year, month) {\n    const daysInMonth = new Date(year, month, 0).getDate();\n    // Update day dropdown options...\n}\n</code></pre>"},{"location":"features/ratings-and-comments/#css-styling","title":"CSS Styling","text":"<p>File: <code>templates/public/movie_detail.twig</code> (style block)</p> <pre><code>.rating-form-row {\n    display: flex;\n    gap: 0;\n}\n\n.rating-form-col {\n    flex: 1;\n    padding: 0 1rem;\n}\n\n.rating-form-divider {\n    width: 2px;\n    background: linear-gradient(180deg, transparent, var(--accent-purple), transparent);\n    box-shadow: 0 0 8px rgba(111, 45, 189, 0.3);\n}\n\n.popcorn-rating__item.popcorn-on {\n    opacity: 1;\n}\n\n.popcorn-rating__item.popcorn-off {\n    opacity: 0.3;\n}\n</code></pre>"},{"location":"features/ratings-and-comments/#related-pages","title":"Related Pages","text":"<ul> <li>Database] - Rating table schema</li> <li>Movies and TMDB] - Movie data</li> <li>Frontend and UI] - UI components</li> </ul> <p>\u2190 Back to Wiki Home</p>"},{"location":"features/tmdb-data/","title":"TMDB Data","text":""},{"location":"features/tmdb-data/#introduction","title":"Introduction","text":"<p>The primary source for information about movies, persons etc. is TMDB. Make sure you have set a valid TMDB api key, e.g. via environment variable (<code>TMDB_API_KEY</code>) or in the admin server settings UI.</p> <p>Tip</p> <p>Execute the metadata sync and image cache commands regularly, e.g. via cronjobs, to keep your application data up to date.</p>"},{"location":"features/tmdb-data/#movie-person-data","title":"Movie &amp; Person data","text":""},{"location":"features/tmdb-data/#description","title":"Description","text":"<p>Update local movie or person information with the latest data from TMDB.</p>"},{"location":"features/tmdb-data/#commands","title":"Commands","text":"<pre><code>php bin/console.php tmdb:movie:sync\nphp bin/console.php tmdb:person:sync\n</code></pre>"},{"location":"features/tmdb-data/#important-flags","title":"Important flags","text":"<ul> <li><code>--help</code>   Detailed information about the command</li> <li><code>--hours</code>   Only update movies/persons which were last synced X hours or longer ago</li> <li><code>--threshold</code>   Maximum number of movies/person to sync for this run</li> </ul>"},{"location":"features/tmdb-data/#example","title":"Example","text":"<p>Update information for the first 50 movies which were updated at least 48 hours ago.  <pre><code>php bin/console.php tmdb:movie:sync` --hours 48 --threshold 50\n</code></pre></p>"},{"location":"features/tmdb-data/#image-cache","title":"Image Cache","text":""},{"location":"features/tmdb-data/#description_1","title":"Description","text":"<p>Enable by setting environment variable <code>TMDB_ENABLE_IMAGE_CACHING</code> to <code>1</code>.</p> <p>To prevent rate limit issues with the TMDB api you should cache TMDB images. This will store a local copy of the images in the <code>storage</code> directory and use this image instead of the original one from TMDB. Make sure you persist the content of the <code>storage</code> directory to keep data e.g. when restarting docker container.</p>"},{"location":"features/tmdb-data/#commands_1","title":"Commands","text":"<pre><code>php bin/console.php tmdb:imageCache:refresh\nphp bin/console.php tmdb:imageCache:delete\n</code></pre>"},{"location":"features/tmdb-data/#import-personal-user-ratings","title":"Import personal User Ratings","text":"<p>There is no native integration to import the personal movie ratings of a tmdb user at the moment. However, you can use third party tools like TMDBToMovary to work around this limitation. </p>"},{"location":"features/trakt/","title":"Trakt TV","text":"<p>Integration Under Development</p> <p>This integration feature is currently being worked on and may not be fully functional. Please check back for updates.</p>"},{"location":"features/trakt/#trakttv-api-access","title":"Trakt.tv API Access","text":"<p>Pathary needs a Trakt username and Client ID to access its api. You can configure them in Pathary via the user settings page at <code>/settings/integrations/trakt</code> or via cli (user update command).</p>"},{"location":"features/trakt/#how-to-get-a-client-id","title":"How to get a Client ID","text":"<p>Go to your trakt.tv application settings and create an application for Pathary. Trakt requires a redirect uri which is not used by Pathary, you can enter a placeholder like <code>http://pathary</code>: </p> <p>You should be able to see your Client ID now on your applications page: </p> <p>Enter the Client ID and your username in Pathary, verify the access and save your changes. </p>"},{"location":"features/trakt/#import","title":"Import","text":""},{"location":"features/trakt/#description","title":"Description","text":"<p>You can import your watch history and ratings from Trakt.</p> <p>The import will only add data missing in Pathary on default, it will not overwrite or remove existing data.</p> <p>The import can be triggered via the user settings page at <code>/settings/integrations/trakt</code> or via cli.</p> <p>Info</p> <p>Importing hundreds or thousands of movies for the first time can take a few minutes.</p> <p>Warning</p> <p>Currently Pathary only supports import from public Trakt accounts. Make sure your account is not set to private during the import.</p>"},{"location":"features/trakt/#cli-command","title":"CLI Command","text":"<pre><code>php bin/console.php trakt:import\n</code></pre>"},{"location":"features/trakt/#interesting-flags","title":"Interesting flags","text":"<ul> <li><code>--userId</code>   User to import data to</li> <li><code>--ratings</code>   Import Trakt ratings</li> <li><code>--history</code>   Import Trakt watch history (plays)</li> <li><code>--overwrite</code>   Use if you want to overwrite the local data with the data coming from Trakt</li> <li><code>--ignore-cache</code>   Use if you want to force import everything regardless if there was a change since the last import</li> </ul>"},{"location":"features/trakt/#example","title":"Example","text":"<p>Import history and ratings for user with id 1 and overwrite locally existing data</p> <pre><code>php bin/console.php trakt:import --userId=1 --ratings --history --overwrite\n</code></pre>"},{"location":"install/docker/","title":"Docker (recommended)","text":""},{"location":"install/docker/#introduction","title":"Introduction","text":"<p>It is recommended to host Pathary with the official Docker image from GitHub Container Registry.</p> <p>Warning</p> <p>After the initial installation and every update containing database changes the database migrations must be executed:</p> <p><code>php bin/console.php database:migration:migrate</code></p> <p>Missing database migrations can cause critical errors!</p> <p>Info</p> <p>The docker images automatically runs the missing database migrations on start up. To stop this behavior set the environment variable <code>DATABASE_DISABLE_AUTO_MIGRATION=1</code></p>"},{"location":"install/docker/#image-tags","title":"Image tags","text":"<ul> <li><code>latest</code> Default image. Latest stable version and recommended for the average user</li> <li><code>main</code> Latest build from main branch</li> <li><code>vX.Y.Z</code> There is a tag for every individual version</li> <li><code>sha-XXXXXXX</code> Specific commit builds</li> </ul>"},{"location":"install/docker/#storage-permissions","title":"Storage permissions","text":"<p>The <code>/app/storage</code> directory is used to store all created files (e.g. logs and images). It should be persisted outside the container and Pathary needs read/write access to it.</p> <p>The easiest way to do this are managed docker volumes (used in the examples below).</p> <p>Info</p> <p>If you bind a local mount, make sure the directory exists before you start the container and that it has the necessary permissions/ownership.</p>"},{"location":"install/docker/#docker-secrets","title":"Docker secrets","text":"<p>Docker secrets can be used for all environment variables, just append <code>_FILE</code> to the environment variable name. Secrets are used as a fallback for not existing environment variables. Make sure to not set the environment variable without the <code>_FILE</code> suffix if you want to use a secret.</p> <p>For more info on Docker secrets, read the official Docker documentation.</p>"},{"location":"install/docker/#examples","title":"Examples","text":"<p>All examples include the environment variable <code>TMDB_API_KEY</code> (get a key here). It is not strictly required to be set here but recommend. Many features of the application will not work correctly without it.</p>"},{"location":"install/docker/#with-sqlite","title":"With SQLite","text":"<p>This is the easiest setup and especially recommend for beginners</p> <pre><code>$ docker volume create pathary-storage\n$ docker run --rm -d \\\n  --name pathary \\\n  -p 80:80 \\\n  -e TMDB_API_KEY=\"&lt;tmdb_key&gt;\" \\\n  -e DATABASE_MODE=\"sqlite\" \\\n  -v pathary-storage:/app/storage \\\n  ghcr.io/benjaminkomen/pathary:latest\n</code></pre>"},{"location":"install/docker/#with-mysql","title":"With MySQL","text":"<pre><code>$ docker volume create pathary-storage\n$ docker run --rm -d \\\n  --name pathary \\\n  -p 80:80 \\\n  -e TMDB_API_KEY=\"&lt;tmdb_key&gt;\" \\\n  -e DATABASE_MODE=\"mysql\" \\\n  -e DATABASE_MYSQL_HOST=\"&lt;host&gt;\" \\\n  -e DATABASE_MYSQL_NAME=\"&lt;db_name&gt;\" \\\n  -e DATABASE_MYSQL_USER=\"&lt;db_user&gt;\" \\\n  -e DATABASE_MYSQL_PASSWORD=\"&lt;db_password&gt;\" \\\n  -v pathary-storage:/app/storage \\\n  ghcr.io/benjaminkomen/pathary:latest\n</code></pre>"},{"location":"install/docker/#docker-composeyml-with-mysql","title":"docker-compose.yml with MySQL","text":"<pre><code>services:\n  pathary:\n    image: ghcr.io/benjaminkomen/pathary:latest\n    container_name: pathary\n    ports:\n      - \"80:80\"\n    environment:\n      TMDB_API_KEY: \"&lt;tmdb_key&gt;\"\n      DATABASE_MODE: \"mysql\"\n      DATABASE_MYSQL_HOST: \"mysql\"\n      DATABASE_MYSQL_NAME: \"pathary\"\n      DATABASE_MYSQL_USER: \"pathary_user\"\n      DATABASE_MYSQL_PASSWORD: \"pathary_password\"\n    volumes:\n      - pathary-storage:/app/storage\n\n  mysql:\n    image: mysql:8.0\n    environment:\n      MYSQL_DATABASE: \"pathary\"\n      MYSQL_USER: \"pathary_user\"\n      MYSQL_PASSWORD: \"pathary_password\"\n      MYSQL_ROOT_PASSWORD: \"&lt;mysql_root_password&gt;\"\n    volumes:\n      - pathary-db:/var/lib/mysql\n\nvolumes:\n  pathary-db:\n  pathary-storage:\n</code></pre>"},{"location":"install/docker/#docker-composeyml-with-mysql-and-secrets","title":"docker-compose.yml with MySQL and secrets","text":"<pre><code>services:\n  pathary:\n    image: ghcr.io/benjaminkomen/pathary:latest\n    container_name: pathary\n    ports:\n      - \"80:80\"\n    environment:\n      TMDB_API_KEY_FILE: /run/secrets/tmdb_key\n      DATABASE_MODE: \"mysql\"\n      DATABASE_MYSQL_HOST: \"mysql\"\n      DATABASE_MYSQL_NAME: \"pathary\"\n      DATABASE_MYSQL_USER: \"pathary_user\"\n      DATABASE_MYSQL_PASSWORD_FILE: /run/secrets/mysql_password\n    volumes:\n      - pathary-storage:/app/storage\n    secrets:\n      - tmdb_key\n      - mysql_password\n\n  mysql:\n    image: mysql:8.0\n    environment:\n      MYSQL_DATABASE: \"pathary\"\n      MYSQL_USER: \"pathary_user\"\n      MYSQL_PASSWORD_FILE: /run/secrets/mysql_password\n      MYSQL_ROOT_PASSWORD_FILE: /run/secrets/mysql_root_password\n    volumes:\n      - pathary-db:/var/lib/mysql\n    secrets:\n      - mysql_root_password\n      - mysql_password\n\nsecrets:\n  mysql_root_password:\n    file: /path/to/docker/secret/mysql_root_password\n  mysql_password:\n    file: /path/to/docker/secret/mysql_password\n  tmdb_key:\n    file: /path/to/docker/secret/tmdb_key\n\nvolumes:\n  pathary-db:\n  pathary-storage:\n</code></pre>"},{"location":"install/manual/","title":"Manual","text":""},{"location":"install/manual/#system-requirements","title":"System requirements","text":"<ul> <li>PHP 8.4 (FPM) + extensions:<ul> <li>php84-pdo</li> <li>php84-pdo_mysql</li> <li>php84-pdo_sqlite</li> <li>php84-mbstring</li> <li>php84-sqlite3</li> <li>php84-simplexml</li> <li>php84-pecl-imagick</li> </ul> </li> <li>git</li> <li>composer</li> <li>web server (e.g. nginx)</li> <li>supervisor or cron for job processing</li> </ul>"},{"location":"install/manual/#setup","title":"Setup","text":""},{"location":"install/manual/#application","title":"Application","text":"<ol> <li> <p>Clone the repository <pre><code>git clone https://github.com/benjaminmue/pathary.git .\n</code></pre></p> </li> <li> <p>Install composer dependencies (recommended to install after every update) <pre><code>composer install --no-dev\n</code></pre></p> </li> <li> <p>Create (and edit) your environment configuration <pre><code>cp .env.example .env\n</code></pre></p> </li> <li> <p>Create necessary symlink between the storage and public/storage <pre><code>php bin/console.php storage:link\n</code></pre></p> </li> <li> <p>Run the database migrations <pre><code>php bin/console.php database:migration:migrate\n</code></pre></p> </li> </ol> <p>Info</p> <p>Make sure that the permissions on the <code>storage</code> directory are correct and set to writable for the php (fpm) user</p>"},{"location":"install/manual/#web-server","title":"Web server","text":"<p>See <code>build/config/conf.d/default.conf</code> as an example nginx server configuration.</p> <p>Use the <code>public</code> directory as the document root of the web server.</p>"},{"location":"install/manual/#job-processing","title":"Job processing","text":"<p>The <code>jobs:process</code> cli command has to be executed to keep the Pathary data up to date and process all background jobs.</p> <p>Here are two recommended ways.</p>"},{"location":"install/manual/#supervisor","title":"Supervisor","text":"<p>Supervisor manages a process to execute the cli command contentiously.  </p> <p>Example config:</p> <pre><code>[program:movary]\ncommand=/usr/local/bin/php /app/bin/console.php jobs:process\nnumprocs=1\nuser=movary\nautostart=true\nautorestart=true\nstartsecs=1\nstartretries=10\nstdout_logfile=/dev/stdout\nstdout_logfile_maxbytes=0\nstderr_logfile=/dev/stderr\nstderr_logfile_maxbytes=0\n</code></pre>"},{"location":"install/manual/#cron","title":"Cron","text":"<p>Use a cronjob to process jobs in at least 1 minute intervals.</p> <p>Example config:</p> <pre><code>* * * * * usr/local/bin/php /app/bin/console.php jobs:process\n</code></pre>"},{"location":"issues/","title":"GitHub Issues - Manual Creation Guide","text":"<p>The audit found issues that should be tracked. Since GitHub CLI (<code>gh</code>) is not available, use these commands to create the issues manually.</p>"},{"location":"issues/#prerequisites","title":"Prerequisites","text":"<ol> <li>Install GitHub CLI: https://cli.github.com/</li> <li>Authenticate: <code>gh auth login</code></li> </ol>"},{"location":"issues/#commands-to-create-issues","title":"Commands to Create Issues","text":""},{"location":"issues/#1-security-audit-findings","title":"1. Security Audit Findings","text":"<pre><code>gh issue create \\\n  --title \"Security audit findings\" \\\n  --label \"security\" \\\n  --body-file docs/issues/security-audit-findings.md\n</code></pre>"},{"location":"issues/#2-performance-audit-findings","title":"2. Performance Audit Findings","text":"<pre><code>gh issue create \\\n  --title \"Performance audit findings\" \\\n  --label \"performance\" \\\n  --body-file docs/issues/performance-audit-findings.md\n</code></pre>"},{"location":"issues/#3-general-improvements-backlog","title":"3. General Improvements Backlog","text":"<pre><code>gh issue create \\\n  --title \"General improvements backlog\" \\\n  --label \"enhancement\" \\\n  --body-file docs/issues/general-improvements-backlog.md\n</code></pre>"},{"location":"issues/#alternative-manual-web-creation","title":"Alternative: Manual Web Creation","text":"<p>If you prefer to create issues via the GitHub web interface:</p> <ol> <li>Go to: https://github.com/benjaminmue/pathary/issues/new</li> <li>Copy the content from each <code>.md</code> file in this directory</li> <li>Set appropriate labels</li> </ol>"},{"location":"issues/#files-in-this-directory","title":"Files in This Directory","text":"<ul> <li><code>security-audit-findings.md</code> - 4 security findings (1 Medium, 3 Low)</li> <li><code>performance-audit-findings.md</code> - 4 performance findings</li> <li><code>general-improvements-backlog.md</code> - 5 improvement suggestions</li> <li><code>README.md</code> - This file</li> </ul>"},{"location":"issues/#full-audit-report","title":"Full Audit Report","text":"<p>See <code>../audit-report.txt</code> for the complete audit report with all findings.</p>"},{"location":"issues/general-improvements-backlog/","title":"General Improvements Backlog","text":""},{"location":"issues/general-improvements-backlog/#summary","title":"Summary","text":"Priority Count High 0 Medium 1 Low 4"},{"location":"issues/general-improvements-backlog/#medium-priority","title":"Medium Priority","text":""},{"location":"issues/general-improvements-backlog/#imp-001-inconsistent-naming-movary-vs-pathary","title":"IMP-001: Inconsistent Naming (Movary vs Pathary)","text":"<p>Priority: Medium Effort: High (if full rename) or Low (if documented)</p> <p>Affected Files: - <code>composer.json:2</code> - Package name is <code>leepe/movary</code> - All <code>src/</code> files - Namespace is <code>Movary\\</code> - <code>docs/openapi.json</code> - References \"Movary\" throughout - <code>.env.example</code> - References movary.org docs - GitHub workflow files - Various configuration files</p> <p>Description: The project was forked from Movary and rebranded as Pathary, but the internal PHP namespace and many references still use \"Movary\". This causes confusion for contributors and users.</p> <p>Metrics: - 1,654 occurrences of \"Movary\" across 409 PHP/Twig files - All PHP classes use <code>namespace Movary\\...</code></p> <p>Options:</p> <p>Option A: Full Rename (High Effort) 1. Update composer.json package name 2. Rename all namespaces from <code>Movary\\</code> to <code>Pathary\\</code> 3. Update autoloader configuration 4. Update all <code>use</code> statements 5. Update OpenAPI spec 6. Update tests</p> <p>Option B: Document Current State (Low Effort) 1. Add README section explaining naming history 2. Keep internal namespace as <code>Movary</code> for backwards compatibility 3. Only use \"Pathary\" for user-facing branding 4. Update documentation to clarify</p> <p>Recommended: Option B initially, with Option A as future milestone</p>"},{"location":"issues/general-improvements-backlog/#low-priority","title":"Low Priority","text":""},{"location":"issues/general-improvements-backlog/#imp-002-remove-or-implement-csrftokenservice","title":"IMP-002: Remove or Implement CsrfTokenService","text":"<p>Priority: Low Effort: Low</p> <p>Affected Files: - <code>src/Service/CsrfTokenService.php</code></p> <p>Description: The CSRF token service is fully implemented but never used anywhere in the codebase. This is dead code that either should be: 1. Implemented throughout the application (see Security Findings) 2. Removed to reduce confusion</p> <p>Recommended: Implement CSRF protection (links to Security audit SEC-001)</p>"},{"location":"issues/general-improvements-backlog/#imp-003-improve-default-credentials-warning","title":"IMP-003: Improve Default Credentials Warning","text":"<p>Priority: Low Effort: Low</p> <p>Affected Files: - <code>docker-compose.yml:23-25, 37-39</code> - <code>README.md</code></p> <p>Description: Default database credentials are <code>movary</code>/<code>movary</code> which might be overlooked in production deployments.</p> <p>Current: <pre><code>DATABASE_MYSQL_USER: \"${MYSQL_USER:-movary}\"\nDATABASE_MYSQL_PASSWORD: \"${MYSQL_PASSWORD:-movary}\"\n</code></pre></p> <p>Recommended Fix: 1. Add warning comment in docker-compose.yml: <pre><code># WARNING: Change these default credentials in production!\nDATABASE_MYSQL_PASSWORD: \"${MYSQL_PASSWORD:-CHANGE_ME_IN_PRODUCTION}\"\n</code></pre></p> <ol> <li>Add security note to README installation section</li> </ol>"},{"location":"issues/general-improvements-backlog/#imp-004-update-openapi-specification","title":"IMP-004: Update OpenAPI Specification","text":"<p>Priority: Low Effort: Medium</p> <p>Affected Files: - <code>docs/openapi.json</code></p> <p>Description: The OpenAPI specification: 1. Still references \"Movary\" branding 2. May not include newer API endpoints 3. Missing documentation for rating system changes (popcorn scale, watched_date, location)</p> <p>Recommended Fix: 1. Update title and descriptions to \"Pathary\" 2. Audit all routes in <code>settings/routes.php</code> against OpenAPI spec 3. Add schemas for new rating fields:    - <code>watched_year</code>, <code>watched_month</code>, <code>watched_day</code>    - <code>location_id</code> with enum values    - <code>rating_popcorn</code> (1-7 scale)</p>"},{"location":"issues/general-improvements-backlog/#imp-005-document-new-features","title":"IMP-005: Document New Features","text":"<p>Priority: Low Effort: Low</p> <p>Affected Files: - <code>docs/</code> directory</p> <p>Description: Recent features lack user documentation: - Popcorn rating system (1-7 scale) - Partial date support for \"watched date\" - Location tracking (Cinema, At Home, Other) - Profile image upload - Delete rating functionality</p> <p>Recommended Fix: Create or update documentation pages: 1. <code>docs/features/ratings.md</code> - Rating system explanation 2. <code>docs/features/watch-history.md</code> - Date and location tracking 3. <code>docs/user-guide/profile.md</code> - Profile management</p>"},{"location":"issues/general-improvements-backlog/#future-considerations","title":"Future Considerations","text":""},{"location":"issues/general-improvements-backlog/#consider-typescript-migration-for-frontend-js","title":"Consider: TypeScript Migration for Frontend JS","text":"<p>Files: <code>public/js/*.js</code></p> <p>The project uses vanilla JavaScript with some inline scripts in templates. As the frontend grows, consider: - Extracting inline scripts to separate files - Adding TypeScript for type safety - Using a build system (Vite, esbuild) for bundling</p>"},{"location":"issues/general-improvements-backlog/#consider-api-versioning","title":"Consider: API Versioning","text":"<p>Files: <code>settings/routes.php</code></p> <p>Current API routes are unversioned (<code>/api/authentication/login</code>). Consider: - Adding version prefix (<code>/api/v1/...</code>) - Planning deprecation strategy for breaking changes</p>"},{"location":"issues/general-improvements-backlog/#consider-automated-testing-for-ui","title":"Consider: Automated Testing for UI","text":"<p>Files: <code>tests/</code></p> <p>Current tests focus on unit tests. Consider adding: - Integration tests for API endpoints - Browser tests for critical user flows (login, rating)</p>"},{"location":"issues/general-improvements-backlog/#prioritized-backlog","title":"Prioritized Backlog","text":"ID Item Priority Effort Dependencies IMP-001 Document Movary/Pathary naming Medium Low None IMP-002 Implement CSRF protection Low Medium SEC-001 IMP-003 Default credentials warning Low Low None IMP-004 Update OpenAPI spec Low Medium None IMP-005 Document new features Low Low None"},{"location":"issues/performance-audit-findings/","title":"Performance Audit Findings","text":""},{"location":"issues/performance-audit-findings/#summary","title":"Summary","text":"Priority Count Quick wins 1 Medium effort 2 Database/Index 1"},{"location":"issues/performance-audit-findings/#quick-wins","title":"Quick Wins","text":""},{"location":"issues/performance-audit-findings/#perf-003-add-pagination-to-rating-lists","title":"PERF-003: Add Pagination to Rating Lists","text":"<p>Severity: Low Effort: Low</p> <p>Affected Files: - <code>src/Service/GroupMovieService.php:113-136</code></p> <p>Description: The <code>getMovieIndividualRatings()</code> method returns ALL ratings for a movie without any pagination or limit. For popular movies with many ratings, this could cause slow page loads.</p> <p>Current Code: <pre><code>public function getMovieIndividualRatings(int $movieId): array\n{\n    $ratings = $this-&gt;dbConnection-&gt;fetchAllAssociative(\n        &lt;&lt;&lt;SQL\n        SELECT u.name AS user_name, mur.rating_popcorn, mur.comment, ...\n        FROM movie_user_rating mur\n        JOIN user u ON u.id = mur.user_id\n        WHERE mur.movie_id = ?\n        SQL,\n        [$movieId],\n    );\n    shuffle($ratings);\n    return $ratings;\n}\n</code></pre></p> <p>Recommended Fix: Add a reasonable default limit: <pre><code>public function getMovieIndividualRatings(int $movieId, int $limit = 50): array\n{\n    // Add LIMIT ? to query\n    // Add pagination UI if needed\n}\n</code></pre></p>"},{"location":"issues/performance-audit-findings/#medium-effort-items","title":"Medium Effort Items","text":""},{"location":"issues/performance-audit-findings/#perf-001-refactor-subqueries-to-joins-in-movie-list","title":"PERF-001: Refactor Subqueries to JOINs in Movie List","text":"<p>Severity: Medium Effort: Medium</p> <p>Affected Files: - <code>src/Service/GroupMovieService.php:222-250</code></p> <p>Description: The <code>getAllMovies()</code> method uses correlated subqueries for calculating <code>avg_popcorn</code> and <code>own_rating</code> per movie. These subqueries execute once per row in the result set, which is inefficient for large movie libraries.</p> <p>Current Query Pattern: <pre><code>SELECT m.id, m.title,\n    (SELECT AVG(mur.rating_popcorn)\n     FROM movie_user_rating mur\n     WHERE mur.movie_id = m.id AND mur.rating_popcorn IS NOT NULL) AS avg_popcorn,\n    (SELECT mur2.rating_popcorn\n     FROM movie_user_rating mur2\n     WHERE mur2.movie_id = m.id AND mur2.user_id = ?) AS own_rating\nFROM movie m\nJOIN movie_user_watch_dates muwd ON muwd.movie_id = m.id\n...\n</code></pre></p> <p>Recommended Fix: Refactor to use LEFT JOINs with GROUP BY: <pre><code>SELECT m.id, m.title,\n    AVG(mur.rating_popcorn) AS avg_popcorn,\n    MAX(CASE WHEN mur.user_id = ? THEN mur.rating_popcorn END) AS own_rating\nFROM movie m\nJOIN movie_user_watch_dates muwd ON muwd.movie_id = m.id\nLEFT JOIN movie_user_rating mur ON mur.movie_id = m.id\nGROUP BY m.id\n...\n</code></pre></p>"},{"location":"issues/performance-audit-findings/#perf-004-add-caching-for-aggregate-statistics","title":"PERF-004: Add Caching for Aggregate Statistics","text":"<p>Severity: Low Effort: Medium</p> <p>Affected Files: - <code>src/Service/GroupMovieService.php:65-95</code></p> <p>Description: <code>getMovieGroupStats()</code> recalculates average ratings and counts on every page view. For frequently accessed movies (e.g., popular films), this creates unnecessary database load.</p> <p>Current Implementation: <pre><code>public function getMovieGroupStats(int $movieId): array\n{\n    $ratingStats = $this-&gt;dbConnection-&gt;fetchAssociative(\n        'SELECT AVG(rating_popcorn), COUNT(rating_popcorn), MAX(updated_at)\n         FROM movie_user_rating WHERE movie_id = ?',\n        [$movieId],\n    );\n    // ... returns stats\n}\n</code></pre></p> <p>Recommended Fix Options:</p> <ol> <li> <p>In-memory cache with TTL: <pre><code>// Using a simple cache service\n$cacheKey = \"movie_stats_{$movieId}\";\nif ($cached = $this-&gt;cache-&gt;get($cacheKey)) {\n    return $cached;\n}\n$stats = $this-&gt;calculateStats($movieId);\n$this-&gt;cache-&gt;set($cacheKey, $stats, 300); // 5 min TTL\nreturn $stats;\n</code></pre></p> </li> <li> <p>Denormalized columns: Add <code>avg_rating_cached</code> and <code>rating_count_cached</code> columns to the <code>movie</code> table, updated via triggers or on rating save.</p> </li> </ol>"},{"location":"issues/performance-audit-findings/#databaseindex-suggestions","title":"Database/Index Suggestions","text":""},{"location":"issues/performance-audit-findings/#perf-002-add-index-on-movie_user_ratingmovie_id","title":"PERF-002: Add Index on movie_user_rating.movie_id","text":"<p>Severity: Medium Effort: Low (migration only)</p> <p>Affected Tables: - <code>movie_user_rating</code></p> <p>Description: The <code>movie_user_rating</code> table has a composite primary key <code>(movie_id, user_id)</code>, but many queries filter or aggregate by <code>movie_id</code> alone. While MySQL can use a composite index for prefix lookups, an explicit single-column index may improve query planning.</p> <p>Queries that would benefit: <pre><code>-- Average rating calculation\nSELECT AVG(rating_popcorn) FROM movie_user_rating WHERE movie_id = ?\n\n-- Individual ratings list\nSELECT * FROM movie_user_rating WHERE movie_id = ?\n\n-- Rating count\nSELECT COUNT(*) FROM movie_user_rating WHERE movie_id = ?\n</code></pre></p> <p>Recommended Fix: Create a migration to add the index: <pre><code>// db/migrations/mysql/20251215000000_AddMovieIdIndexToRatings.php\npublic function up(): void\n{\n    $this-&gt;execute(\n        'CREATE INDEX idx_movie_user_rating_movie ON movie_user_rating(movie_id)'\n    );\n}\n\npublic function down(): void\n{\n    $this-&gt;execute(\n        'DROP INDEX idx_movie_user_rating_movie ON movie_user_rating'\n    );\n}\n</code></pre></p> <p>Expected Impact: - Faster movie detail page loads (rating aggregation) - Faster movie list sorting by rating - Minimal storage overhead</p>"},{"location":"issues/performance-audit-findings/#summary-table","title":"Summary Table","text":"ID Finding Effort Impact Priority PERF-002 Add movie_id index Low High 1 PERF-001 Refactor subqueries Medium High 2 PERF-003 Add pagination Low Medium 3 PERF-004 Add caching Medium Medium 4"},{"location":"issues/performance-audit-findings/#monitoring-recommendations","title":"Monitoring Recommendations","text":"<p>Consider adding query logging in development to identify slow queries: <pre><code>// In bootstrap.php or Factory.php\n$config-&gt;setSQLLogger(new \\Doctrine\\DBAL\\Logging\\DebugStack());\n</code></pre></p> <p>Or use MySQL's slow query log: <pre><code>slow_query_log = 1\nslow_query_log_file = /var/log/mysql/slow.log\nlong_query_time = 1\n</code></pre></p>"},{"location":"issues/security-audit-findings/","title":"Security Audit Findings","text":""},{"location":"issues/security-audit-findings/#summary","title":"Summary","text":"Severity Count Critical 0 High 0 Medium 1 Low 3"},{"location":"issues/security-audit-findings/#findings","title":"Findings","text":""},{"location":"issues/security-audit-findings/#sec-001-missing-csrf-protection-on-state-changing-forms","title":"SEC-001: Missing CSRF Protection on State-Changing Forms","text":"<p>Severity: Medium</p> <p>Affected Files: - <code>templates/public/movie_detail.twig:473-536</code> (rating form) - <code>templates/page/settings-*.html.twig</code> (all settings forms) - <code>src/HttpController/Web/RateMovieController.php:30-96</code> - <code>src/HttpController/Web/ProfileController.php</code> (profile update)</p> <p>Description: The application has a <code>CsrfTokenService</code> (<code>src/Service/CsrfTokenService.php</code>) that generates and validates CSRF tokens using <code>hash_equals()</code> for timing-safe comparison. However, this service is not injected or used in any controller. All POST forms lack CSRF token validation, making them vulnerable to Cross-Site Request Forgery attacks.</p> <p>An attacker could craft a malicious page that submits forms on behalf of authenticated users (e.g., changing ratings, updating profiles, deleting data).</p> <p>Proof: <pre><code>grep -r \"CsrfTokenService\\|validateToken\" src/HttpController/\n# Returns no matches - service exists but is unused\n</code></pre></p> <p>Recommended Fix:</p> <ol> <li>Inject <code>CsrfTokenService</code> into controllers that handle POST/PUT/DELETE requests</li> <li>Generate token in templates: <pre><code>&lt;input type=\"hidden\" name=\"_csrf_token\" value=\"{{ csrf_token() }}\"&gt;\n</code></pre></li> <li>Validate in controllers: <pre><code>public function __construct(\n    private readonly CsrfTokenService $csrfTokenService,\n    // ...\n) {}\n\npublic function rate(Request $request): Response\n{\n    $postData = $request-&gt;getPostParameters();\n    if (!$this-&gt;csrfTokenService-&gt;validateToken($postData['_csrf_token'] ?? null)) {\n        return Response::createForbidden('Invalid CSRF token');\n    }\n    // ... rest of logic\n}\n</code></pre></li> <li>Create Twig extension to expose <code>csrf_token()</code> function</li> </ol>"},{"location":"issues/security-audit-findings/#sec-002-dynamic-order-by-clauses","title":"SEC-002: Dynamic ORDER BY Clauses","text":"<p>Severity: Low</p> <p>Affected Files: - <code>src/Service/GroupMovieService.php:211-217</code> - <code>src/Domain/Movie/MovieRepository.php:132, 272, 418, 1012</code> - <code>src/Domain/Movie/Watchlist/MovieWatchlistRepository.php:248</code></p> <p>Description: Several database queries construct ORDER BY clauses dynamically. While currently protected by <code>match</code> statements and whitelisting, this pattern requires vigilance to prevent SQL injection if modified incorrectly.</p> <p>Current Protection (GroupMovieService.php:206-217): <pre><code>// Sort order is binary validated\n$sortOrderSql = strtoupper($sortOrder) === 'ASC' ? 'ASC' : 'DESC';\n\n// Sort field uses safe match statement\n$orderByClause = match ($sortBy) {\n    'title' =&gt; \"LOWER(m.title) $sortOrderSql\",\n    'release_date' =&gt; \"m.release_date IS NULL, m.release_date $sortOrderSql\",\n    'global_rating' =&gt; \"avg_popcorn IS NULL, avg_popcorn $sortOrderSql\",\n    'own_rating' =&gt; \"own_rating IS NULL, own_rating $sortOrderSql\",\n    default =&gt; \"last_added_at $sortOrderSql\",\n};\n</code></pre></p> <p>Recommended Fix: - Continue using <code>match</code>/<code>switch</code> statements with explicit whitelisted values - Add code comments explaining security implications - Consider creating a dedicated <code>SortBuilder</code> class that enforces whitelist validation</p>"},{"location":"issues/security-audit-findings/#sec-003-auth-token-in-cookie","title":"SEC-003: Auth Token in Cookie","text":"<p>Severity: Low</p> <p>Affected Files: - <code>src/Domain/User/Service/Authentication.php:247-257</code></p> <p>Description: Authentication tokens are stored directly in cookies. While proper security flags are set (HttpOnly, Secure, SameSite=Lax), the raw token is transmitted rather than a secondary identifier.</p> <p>Mitigations Already in Place: - <code>token_hash</code> column exists for server-side comparison - Session regeneration on login prevents session fixation - Proper cookie security flags</p> <p>Recommended Fix: Consider using a session ID that maps to the token hash server-side, rather than transmitting tokens in cookies. This adds defense in depth if cookies are ever exposed.</p>"},{"location":"issues/security-audit-findings/#sec-004-error-logging-may-contain-sensitive-paths","title":"SEC-004: Error Logging May Contain Sensitive Paths","text":"<p>Severity: Low</p> <p>Affected Files: - <code>public/index.php:67-73</code></p> <p>Description: Exception handlers log full stack traces which may contain sensitive file paths. Users see generic error pages, but log files could leak information if accessed.</p> <p>Recommended Fix: - Ensure log files have restricted access permissions (0640 or stricter) - Consider sanitizing or truncating stack traces in production - Avoid logging request bodies that may contain credentials</p>"},{"location":"issues/security-audit-findings/#positive-security-findings","title":"Positive Security Findings","text":"<p>The following security measures are already implemented:</p> <ul> <li>Security Headers: CSP, X-Frame-Options, X-Content-Type-Options, Referrer-Policy</li> <li>Session Security: Regeneration on login, HttpOnly/Secure/SameSite cookies</li> <li>SQL Injection Protection: Parameterized queries throughout</li> <li>File Upload Security: MIME validation, size limits, random filenames, path traversal protection</li> <li>Password Security: Proper hashing with <code>password_verify()</code></li> <li>Dependency Security: <code>composer audit</code> shows no vulnerabilities</li> </ul>"},{"location":"issues/security-audit-findings/#suggested-fixes-priority","title":"Suggested Fixes Priority","text":"<ol> <li>High: Implement CSRF protection using existing <code>CsrfTokenService</code></li> <li>Medium: Document ORDER BY whitelist pattern for future developers</li> <li>Low: Review log file permissions and access controls</li> </ol>"},{"location":"operations/logging-and-troubleshooting/","title":"Logging and Troubleshooting","text":"<p>This page covers Pathary's logging system and common troubleshooting scenarios.</p>"},{"location":"operations/logging-and-troubleshooting/#logging-architecture","title":"Logging Architecture","text":"<p>Pathary uses Monolog for structured logging with multiple output handlers.</p>"},{"location":"operations/logging-and-troubleshooting/#log-handlers","title":"Log Handlers","text":"<p>File: <code>src/Factory.php</code></p> <pre><code>public static function createLogger(ContainerInterface $container, Config $config) : LoggerInterface\n{\n    $logger = new Logger('movary');\n\n    // Always log to stdout (for Docker)\n    $logger-&gt;pushHandler(self::createLoggerStreamHandlerStdout($container, $config));\n\n    // Optionally log to file\n    $enableFileLogging = $config-&gt;getAsBool('LOG_ENABLE_FILE_LOGGING', self::DEFAULT_ENABLE_FILE_LOGGING);\n    if ($enableFileLogging === true) {\n        $logger-&gt;pushHandler(self::createLoggerStreamHandlerFile($container, $config));\n    }\n\n    return $logger;\n}\n</code></pre> <p>Output destinations: | Handler | Destination | Default | |---------|-------------|---------| | Stdout | <code>php://stdout</code> | Always enabled | | File | <code>storage/logs/app.log</code> | Enabled by default |</p>"},{"location":"operations/logging-and-troubleshooting/#log-configuration","title":"Log Configuration","text":""},{"location":"operations/logging-and-troubleshooting/#environment-variables","title":"Environment Variables","text":"<pre><code># Log level: debug, info, notice, warning, error, critical, alert, emergency\nLOG_LEVEL=warning\n\n# Include stack traces in logs (useful for debugging)\nLOG_ENABLE_STACKTRACE=0\n\n# Write logs to file (in addition to stdout)\nLOG_ENABLE_FILE_LOGGING=1\n</code></pre>"},{"location":"operations/logging-and-troubleshooting/#log-levels","title":"Log Levels","text":"Level Use Case <code>debug</code> Detailed debugging (very verbose) <code>info</code> Informational messages <code>notice</code> Normal but significant events <code>warning</code> Warning conditions (default) <code>error</code> Error conditions <code>critical</code> Critical conditions <code>alert</code> Action must be taken immediately <code>emergency</code> System is unusable"},{"location":"operations/logging-and-troubleshooting/#log-format","title":"Log Format","text":"<p>File: <code>src/Factory.php</code></p> <pre><code>public static function createLineFormatter(ContainerInterface $container, Config $config) : LineFormatter\n{\n    $enableStackTrace = $config-&gt;getAsBool('LOG_ENABLE_STACKTRACE', self::DEFAULT_LOG_ENABLE_STACKTRACE);\n\n    $formatter = new LineFormatter(null, null, true, true);\n    $formatter-&gt;includeStacktraces($enableStackTrace);\n\n    return $formatter;\n}\n</code></pre> <p>Log format example: <pre><code>[2025-12-14T15:30:00.000000+00:00] movary.EMERGENCY: Error message {\"exception\":\"...\"} []\n</code></pre></p>"},{"location":"operations/logging-and-troubleshooting/#log-locations","title":"Log Locations","text":""},{"location":"operations/logging-and-troubleshooting/#container-paths","title":"Container Paths","text":"Path Content <code>/app/storage/logs/app.log</code> Application log file Docker stdout Container log stream"},{"location":"operations/logging-and-troubleshooting/#volume-mount","title":"Volume Mount","text":"<pre><code>volumes:\n  - pathary-storage:/app/storage\n</code></pre> <p>Logs are persisted in the <code>pathary-storage</code> volume under <code>logs/</code>.</p>"},{"location":"operations/logging-and-troubleshooting/#viewing-logs","title":"Viewing Logs","text":""},{"location":"operations/logging-and-troubleshooting/#docker-container-logs-stdout","title":"Docker Container Logs (stdout)","text":"<pre><code># View all logs\ndocker logs pathary\n\n# Follow logs in real-time\ndocker logs -f pathary\n\n# Show last 100 lines\ndocker logs --tail 100 pathary\n\n# Show logs since timestamp\ndocker logs --since \"2025-12-14T10:00:00\" pathary\n</code></pre>"},{"location":"operations/logging-and-troubleshooting/#application-log-file","title":"Application Log File","text":"<pre><code># View log file (inside container)\ndocker exec pathary cat /app/storage/logs/app.log\n\n# Tail log file in real-time\ndocker exec pathary tail -f /app/storage/logs/app.log\n\n# Search logs for errors\ndocker exec pathary grep -i error /app/storage/logs/app.log\n\n# View last 50 lines\ndocker exec pathary tail -n 50 /app/storage/logs/app.log\n</code></pre>"},{"location":"operations/logging-and-troubleshooting/#docker-compose","title":"Docker Compose","text":"<pre><code># View logs for all services\ndocker compose logs\n\n# Follow logs\ndocker compose logs -f\n\n# View specific service\ndocker compose logs pathary\n</code></pre>"},{"location":"operations/logging-and-troubleshooting/#error-handling","title":"Error Handling","text":""},{"location":"operations/logging-and-troubleshooting/#global-exception-handler","title":"Global Exception Handler","text":"<p>File: <code>public/index.php</code></p> <pre><code>try {\n    // Route handling...\n} catch (Throwable $t) {\n    $container-&gt;get(LoggerInterface::class)-&gt;emergency($t-&gt;getMessage(), ['exception' =&gt; $t]);\n\n    if (str_starts_with($uri, '/api') === false) {\n        $response = $container-&gt;get(ErrorController::class)-&gt;renderInternalServerError();\n    }\n}\n</code></pre> <p>All uncaught exceptions are: 1. Logged at EMERGENCY level with full exception context 2. Displayed as a 500 error page (web) or empty response (API)</p>"},{"location":"operations/logging-and-troubleshooting/#error-pages","title":"Error Pages","text":"<p>File: <code>src/HttpController/Web/ErrorController.php</code></p> Status Template Controller Method 404 <code>templates/page/404.html.twig</code> <code>renderNotFound()</code> 500 <code>templates/page/500.html.twig</code> <code>renderInternalServerError()</code>"},{"location":"operations/logging-and-troubleshooting/#common-500-error-causes","title":"Common 500 Error Causes","text":""},{"location":"operations/logging-and-troubleshooting/#1-database-connection-failed","title":"1. Database Connection Failed","text":"<p>Symptoms: 500 error on all pages</p> <p>Log message: <pre><code>SQLSTATE[HY000] [2002] Connection refused\n</code></pre></p> <p>Solutions: <pre><code># Check database container is running\ndocker ps | grep mysql\n\n# Check database connection settings\ndocker exec pathary env | grep DATABASE\n\n# Test MySQL connection\ndocker exec pathary-mysql mysql -u pathary -p -e \"SELECT 1\"\n</code></pre></p>"},{"location":"operations/logging-and-troubleshooting/#2-migration-failed","title":"2. Migration Failed","text":"<p>Symptoms: 500 error after update</p> <p>Log message: <pre><code>Migration failed: Table 'x' doesn't exist\n</code></pre></p> <p>Solutions: <pre><code># Check migration status\ndocker exec pathary php bin/console.php database:migration:status\n\n# Re-run migrations\ndocker exec pathary php bin/console.php database:migration:migrate\n\n# Check for SQL errors in logs\ndocker logs pathary | grep -i migration\n</code></pre></p>"},{"location":"operations/logging-and-troubleshooting/#3-missing-tmdb-api-key","title":"3. Missing TMDB API Key","text":"<p>Symptoms: 500 error on search or movie pages</p> <p>Log message: <pre><code>TMDB API key not configured\n</code></pre></p> <p>Solutions: <pre><code># Verify environment variable\ndocker exec pathary env | grep TMDB\n\n# Check .env file\ncat .env | grep TMDB_API_KEY\n</code></pre></p>"},{"location":"operations/logging-and-troubleshooting/#4-permission-errors","title":"4. Permission Errors","text":"<p>Symptoms: 500 error on file operations</p> <p>Log message: <pre><code>Permission denied: /app/storage/...\n</code></pre></p> <p>Solutions: <pre><code># Fix storage permissions\ndocker exec pathary chown -R www-data:www-data /app/storage\ndocker exec pathary chmod -R 755 /app/storage\n</code></pre></p>"},{"location":"operations/logging-and-troubleshooting/#5-memory-exhausted","title":"5. Memory Exhausted","text":"<p>Symptoms: 500 error on large operations</p> <p>Log message: <pre><code>Allowed memory size of X bytes exhausted\n</code></pre></p> <p>Solutions: <pre><code># Increase PHP memory limit\ndocker exec pathary php -d memory_limit=512M bin/console.php ...\n</code></pre></p>"},{"location":"operations/logging-and-troubleshooting/#debugging-techniques","title":"Debugging Techniques","text":""},{"location":"operations/logging-and-troubleshooting/#enable-debug-logging","title":"Enable Debug Logging","text":"<pre><code>LOG_LEVEL=debug\nLOG_ENABLE_STACKTRACE=1\n</code></pre> <p>Then restart the container: <pre><code>docker compose restart pathary\n</code></pre></p>"},{"location":"operations/logging-and-troubleshooting/#check-php-errors","title":"Check PHP Errors","text":"<pre><code># View PHP-FPM error log\ndocker exec pathary cat /var/log/php-fpm-error.log\n\n# Check Nginx error log\ndocker exec pathary cat /var/log/nginx/error.log\n</code></pre>"},{"location":"operations/logging-and-troubleshooting/#interactive-shell","title":"Interactive Shell","text":"<pre><code># Get shell access to container\ndocker exec -it pathary /bin/sh\n\n# Run PHP commands\ndocker exec -it pathary php -a\n</code></pre>"},{"location":"operations/logging-and-troubleshooting/#test-database-query","title":"Test Database Query","text":"<pre><code># MySQL\ndocker exec pathary-mysql mysql -u pathary -p pathary -e \"SELECT COUNT(*) FROM movie\"\n\n# SQLite\ndocker exec pathary sqlite3 /app/storage/movary.sqlite \"SELECT COUNT(*) FROM movie\"\n</code></pre>"},{"location":"operations/logging-and-troubleshooting/#troubleshooting-checklist","title":"Troubleshooting Checklist","text":""},{"location":"operations/logging-and-troubleshooting/#container-wont-start","title":"Container Won't Start","text":"<ol> <li>Check logs: <code>docker logs pathary</code></li> <li>Verify environment variables in <code>.env</code></li> <li>Check volume permissions</li> <li>Ensure port 80 is available</li> </ol>"},{"location":"operations/logging-and-troubleshooting/#blank-white-page","title":"Blank White Page","text":"<ol> <li>Check <code>LOG_LEVEL=debug</code> is set</li> <li>View logs: <code>docker logs pathary</code></li> <li>Check PHP-FPM is running: <code>docker exec pathary ps aux | grep php</code></li> <li>Verify Nginx is running: <code>docker exec pathary ps aux | grep nginx</code></li> </ol>"},{"location":"operations/logging-and-troubleshooting/#authentication-issues","title":"Authentication Issues","text":"<ol> <li>Clear browser cookies</li> <li>Check <code>user_auth_token</code> table</li> <li>Verify session cookie configuration</li> <li>Check for HTTPS/HTTP mismatch with <code>APPLICATION_URL</code></li> </ol>"},{"location":"operations/logging-and-troubleshooting/#image-not-loading","title":"Image Not Loading","text":"<ol> <li>Check TMDB API key is valid</li> <li>Verify image caching setting: <code>TMDB_ENABLE_IMAGE_CACHING</code></li> <li>Check storage permissions on <code>/app/storage/images</code></li> </ol>"},{"location":"operations/logging-and-troubleshooting/#slow-performance","title":"Slow Performance","text":"<ol> <li>Enable MySQL (SQLite is slower for large datasets)</li> <li>Check for N+1 queries in logs</li> <li>Monitor container resources: <code>docker stats pathary</code></li> </ol>"},{"location":"operations/logging-and-troubleshooting/#health-check","title":"Health Check","text":""},{"location":"operations/logging-and-troubleshooting/#basic-health-test","title":"Basic Health Test","text":"<pre><code># Check if web server responds\ncurl -f http://localhost:8080/ || echo \"FAILED\"\n\n# Check container health\ndocker inspect pathary --format='{{.State.Health.Status}}'\n</code></pre>"},{"location":"operations/logging-and-troubleshooting/#docker-compose-health-check","title":"Docker Compose Health Check","text":"<pre><code>services:\n  pathary:\n    healthcheck:\n      test: [\"CMD\", \"curl\", \"-f\", \"http://localhost/\"]\n      interval: 30s\n      timeout: 10s\n      retries: 3\n</code></pre>"},{"location":"operations/logging-and-troubleshooting/#log-rotation","title":"Log Rotation","text":"<p>Application logs can grow large. Implement rotation:</p>"},{"location":"operations/logging-and-troubleshooting/#logrotate-configuration","title":"Logrotate Configuration","text":"<pre><code># /etc/logrotate.d/pathary\n/app/storage/logs/*.log {\n    daily\n    rotate 7\n    compress\n    missingok\n    notifempty\n    copytruncate\n}\n</code></pre>"},{"location":"operations/logging-and-troubleshooting/#manual-cleanup","title":"Manual Cleanup","text":"<pre><code># Truncate log file\ndocker exec pathary truncate -s 0 /app/storage/logs/app.log\n\n# Remove old logs\ndocker exec pathary find /app/storage/logs -name \"*.log\" -mtime +7 -delete\n</code></pre>"},{"location":"operations/logging-and-troubleshooting/#related-pages","title":"Related Pages","text":"<ul> <li>Deployment] - Production setup</li> <li>Getting Started] - Initial configuration</li> <li>Database] - Database troubleshooting</li> <li>Migrations] - Migration issues</li> </ul> <p>\u2190 Back to Wiki Home</p>"},{"location":"security/SECRET-SCANNING/","title":"Secret Scanning and Pre-Commit Hooks","text":"<p>This document explains how to prevent accidental commits of API keys, passwords, and other sensitive data in the Pathary repository.</p>"},{"location":"security/SECRET-SCANNING/#overview","title":"Overview","text":"<p>The repository includes a secret scanning tool (<code>scripts/secret-scan.sh</code>) that automatically detects: - Hardcoded API keys (TMDB, GitHub, AWS) - Passwords and authentication tokens - Database connection strings - Private keys - Tracked environment files</p>"},{"location":"security/SECRET-SCANNING/#quick-start","title":"Quick Start","text":""},{"location":"security/SECRET-SCANNING/#running-the-scanner-manually","title":"Running the Scanner Manually","text":"<pre><code># Scan for secrets in tracked files\n./scripts/secret-scan.sh\n\n# Verbose mode (shows skipped files)\n./scripts/secret-scan.sh --verbose\n\n# Run self-test to verify scanner works\n./scripts/secret-scan.sh --self-test\n</code></pre> <p>The scanner will: - \u2705 Check for tracked .env files (except .env.example) - \u2705 Detect hardcoded API keys, passwords, tokens - \u2705 Find untracked secret files not in .gitignore - \u2705 Exit with code 1 if secrets are found (CI-friendly)</p>"},{"location":"security/SECRET-SCANNING/#installing-pre-commit-hook-recommended","title":"Installing Pre-Commit Hook (Recommended)","text":"<p>To automatically scan for secrets before every commit:</p> <pre><code># Create the pre-commit hook\ncat &gt; .git/hooks/pre-commit &lt;&lt; 'EOF'\n#!/bin/bash\n# Pathary Pre-Commit Secret Scanner\n\necho \"Running secret scanner...\"\n./scripts/secret-scan.sh\n\nif [ $? -ne 0 ]; then\n    echo \"\"\n    echo \"\u274c Commit blocked: Secrets detected!\"\n    echo \"Fix the issues above before committing.\"\n    exit 1\nfi\n\necho \"\u2705 No secrets detected\"\nexit 0\nEOF\n\n# Make it executable\nchmod +x .git/hooks/pre-commit\n</code></pre>"},{"location":"security/SECRET-SCANNING/#installing-pre-push-hook-optional-extra-safety","title":"Installing Pre-Push Hook (Optional Extra Safety)","text":"<p>For an additional safety net before pushing:</p> <pre><code># Create the pre-push hook\ncat &gt; .git/hooks/pre-push &lt;&lt; 'EOF'\n#!/bin/bash\n# Pathary Pre-Push Secret Scanner\n\necho \"Running final secret scan before push...\"\n./scripts/secret-scan.sh\n\nif [ $? -ne 0 ]; then\n    echo \"\"\n    echo \"\u274c Push blocked: Secrets detected!\"\n    echo \"Fix the issues above before pushing.\"\n    exit 1\nfi\n\necho \"\u2705 Safe to push\"\nexit 0\nEOF\n\n# Make it executable\nchmod +x .git/hooks/pre-push\n</code></pre>"},{"location":"security/SECRET-SCANNING/#what-files-are-protected","title":"What Files Are Protected","text":"<p>The <code>.gitignore</code> file prevents these from being committed: - <code>.env</code>, <code>.env.local</code>, <code>.env.*.local</code> - Environment variables - <code>docker-compose.local.yml</code> - Local docker configs with hardcoded credentials - <code>http-client.env.json</code> - HTTP client test credentials - <code>*.sql</code>, <code>*.dump</code>, <code>*.backup</code> - Database dumps - <code>*.log</code> - Log files that might contain secrets</p>"},{"location":"security/SECRET-SCANNING/#patterns-detected","title":"Patterns Detected","text":"<p>The scanner looks for these patterns:</p> Pattern Description Example <code>TMDB_API_KEY</code> TMDB API keys <code>TMDB_API_KEY=\"abc123...\"</code> <code>API_KEY</code> Generic API keys <code>API_KEY=\"longkey123\"</code> <code>GITHUB_TOKEN</code> GitHub tokens <code>ghp_xxxx</code> or <code>github_pat_xxxx</code> <code>AWS_KEY</code> AWS access keys <code>AKIA...</code> <code>PRIVATE_KEY</code> SSH/TLS keys <code>BEGIN PRIVATE KEY</code> <code>PASSWORD_HARDCODED</code> Hardcoded passwords <code>PASSWORD=\"secret123\"</code> <code>BEARER_TOKEN</code> Bearer tokens <code>Authorization: Bearer xxx</code> <code>DATABASE_URL</code> Database URLs <code>mysql://user:pass@host</code>"},{"location":"security/SECRET-SCANNING/#remediation-steps","title":"Remediation Steps","text":""},{"location":"security/SECRET-SCANNING/#if-secrets-are-found-in-tracked-files","title":"If Secrets Are Found in Tracked Files","text":"<ol> <li> <p>Untrack the file without deleting it: <pre><code>git rm --cached &lt;file&gt;\n</code></pre></p> </li> <li> <p>Add to .gitignore: <pre><code>echo \"&lt;file&gt;\" &gt;&gt; .gitignore\n</code></pre></p> </li> <li> <p>Commit the changes: <pre><code>git add .gitignore\ngit commit -m \"chore: untrack file with secrets\"\n</code></pre></p> </li> </ol>"},{"location":"security/SECRET-SCANNING/#for-hardcoded-secrets-in-code","title":"For Hardcoded Secrets in Code","text":"<ol> <li> <p>Replace with environment variable references: <pre><code>// Before (BAD)\n$apiKey = \"abc123def456\";\n\n// After (GOOD)\n$apiKey = getenv('TMDB_API_KEY');\n</code></pre></p> </li> <li> <p>Move actual values to <code>.env.local</code>: <pre><code># Create .env.local (never committed)\necho \"TMDB_API_KEY=your_actual_key_here\" &gt; .env.local\n</code></pre></p> </li> <li> <p>Use environment variable pattern in docker-compose: <pre><code># Good - uses environment variable with fallback\nTMDB_API_KEY: \"${TMDB_API_KEY:-XXXXX}\"\n\n# Bad - hardcoded value\nTMDB_API_KEY: \"abc123def456\"\n</code></pre></p> </li> </ol>"},{"location":"security/SECRET-SCANNING/#if-secrets-were-already-committed","title":"If Secrets Were Already Committed","text":"<p>\u26a0\ufe0f Important: Once a secret is committed to git history, consider it compromised.</p> <ol> <li> <p>Rotate/regenerate the secret immediately (get a new API key, change password, etc.)</p> </li> <li> <p>Remove from git history (advanced):    <pre><code># Using git-filter-repo (recommended)\ngit filter-repo --path &lt;file-with-secret&gt; --invert-paths\n\n# Or using BFG Repo-Cleaner\nbfg --delete-files &lt;file-with-secret&gt;\n</code></pre></p> </li> <li> <p>Force push (coordinate with team):    <pre><code>git push --force-with-lease\n</code></pre></p> </li> </ol>"},{"location":"security/SECRET-SCANNING/#uninstalling-hooks","title":"Uninstalling Hooks","text":"<pre><code># Remove pre-commit hook\nrm .git/hooks/pre-commit\n\n# Remove pre-push hook\nrm .git/hooks/pre-push\n</code></pre>"},{"location":"security/SECRET-SCANNING/#cicd-integration","title":"CI/CD Integration","text":"<p>The scanner can be used in GitHub Actions:</p> <pre><code>- name: Scan for secrets\n  run: |\n    ./scripts/secret-scan.sh\n    if [ $? -ne 0 ]; then\n      echo \"::error::Secrets detected in repository\"\n      exit 1\n    fi\n</code></pre>"},{"location":"security/SECRET-SCANNING/#false-positives","title":"False Positives","text":"<p>The scanner may flag test fixtures or example files. To exclude:</p> <ol> <li>Name files with <code>.example</code>, <code>.sample</code>, or <code>.template</code> suffix</li> <li> <p>These are automatically excluded</p> </li> <li> <p>For test passwords:</p> </li> <li>Use obviously fake values: <code>password123</code>, <code>dummy_key</code>, <code>test_password</code></li> <li> <p>The scanner excludes these patterns</p> </li> <li> <p>Update the scanner exclusions:</p> </li> <li>Edit <code>scripts/secret-scan.sh</code> if needed</li> <li>Add patterns to the exclusion lists</li> </ol>"},{"location":"security/SECRET-SCANNING/#support","title":"Support","text":"<p>For issues or questions: - Review this documentation - Check the Security Audit Report - Run <code>./scripts/secret-scan.sh --self-test</code> to verify functionality</p>"},{"location":"security/authentication-and-sessions/","title":"Authentication and Sessions","text":"<p>This page covers how Pathary handles user authentication, sessions, and security.</p>"},{"location":"security/authentication-and-sessions/#overview","title":"Overview","text":"<p>Pathary supports two authentication methods: 1. Web Sessions - Cookie-based for browser users 2. API Tokens - Header-based for API clients</p>"},{"location":"security/authentication-and-sessions/#web-login-flow","title":"Web Login Flow","text":""},{"location":"security/authentication-and-sessions/#1-login-page-request","title":"1. Login Page Request","text":"<pre><code>GET /login\n    \u2193\nAuthenticationController::renderLoginPage()\n    \u2193\nRenders templates/page/login.html.twig\n</code></pre>"},{"location":"security/authentication-and-sessions/#2-login-submission","title":"2. Login Submission","text":"<pre><code>POST /api/authentication/token\n    \u2193\nApi\\AuthenticationController::createToken()\n    \u2193\nAuthentication::login()\n    \u2193\nSets cookie + returns token\n</code></pre>"},{"location":"security/authentication-and-sessions/#3-authentication-service","title":"3. Authentication Service","text":"<p>File: <code>src/Domain/User/Service/Authentication.php</code></p> <pre><code>public function login(\n    string $email,\n    string $password,\n    bool $rememberMe,\n    string $deviceName,\n    string $userAgent,\n    ?int $userTotpInput = null,\n) : array {\n    // Verify credentials\n    $user = $this-&gt;findUserAndVerifyAuthentication($email, $password, $userTotpInput);\n\n    // Create expiration (1 day or 10 years for \"remember me\")\n    $authTokenExpirationDate = $this-&gt;createExpirationDate();\n    if ($rememberMe === true) {\n        $authTokenExpirationDate = $this-&gt;createExpirationDate(3650); // 10 years\n    }\n\n    // Generate and store token\n    $token = $this-&gt;setAuthenticationToken($user-&gt;getId(), $deviceName, $userAgent, $authTokenExpirationDate);\n\n    // Set cookie for web clients\n    if ($deviceName === CreateUserController::PATHARY_WEB_CLIENT) {\n        $this-&gt;setAuthenticationCookieAndNewSession($user-&gt;getId(), $token, $authTokenExpirationDate);\n    }\n\n    return ['user' =&gt; $user, 'token' =&gt; $token];\n}\n</code></pre>"},{"location":"security/authentication-and-sessions/#cookie-configuration","title":"Cookie Configuration","text":"<p>File: <code>src/Domain/User/Service/Authentication.php:247-257</code></p> <pre><code>setcookie(\n    'id',                              // Cookie name\n    $token,                            // Auth token value\n    [\n        'expires' =&gt; $expirationTimestamp,\n        'path' =&gt; '/',\n        'secure' =&gt; $isSecure,         // HTTPS only when available\n        'httponly' =&gt; true,            // No JavaScript access\n        'samesite' =&gt; 'Lax',           // CSRF protection\n    ],\n);\n</code></pre>"},{"location":"security/authentication-and-sessions/#security-properties","title":"Security Properties","text":"Property Value Purpose <code>httponly</code> <code>true</code> Prevents XSS token theft <code>secure</code> Auto-detected HTTPS-only when behind SSL <code>samesite</code> <code>Lax</code> CSRF protection <code>path</code> <code>/</code> Available site-wide"},{"location":"security/authentication-and-sessions/#session-management","title":"Session Management","text":""},{"location":"security/authentication-and-sessions/#session-start","title":"Session Start","text":"<p>File: <code>src/HttpController/Web/Middleware/StartSession.php</code></p> <p>Sessions are started automatically for web requests.</p>"},{"location":"security/authentication-and-sessions/#session-regeneration","title":"Session Regeneration","text":"<p>On login, session IDs are regenerated to prevent session fixation:</p> <pre><code>public function setAuthenticationCookieAndNewSession(int $userId, string $token, DateTime $expirationDate) : void\n{\n    $this-&gt;sessionWrapper-&gt;destroy();\n    $this-&gt;sessionWrapper-&gt;start();\n    $this-&gt;sessionWrapper-&gt;regenerateId();  // Prevent session fixation\n\n    // Set cookie and session data...\n    $this-&gt;sessionWrapper-&gt;set('userId', $userId);\n}\n</code></pre>"},{"location":"security/authentication-and-sessions/#token-storage","title":"Token Storage","text":"<p>Auth tokens are stored in the <code>user_auth_token</code> table:</p> Column Type Description <code>id</code> INT Primary key <code>user_id</code> INT User reference <code>token</code> VARCHAR(64) Random token <code>token_hash</code> VARCHAR(64) SHA-256 hash of token <code>expiration_date</code> DATETIME When token expires <code>device_name</code> VARCHAR(256) Client identifier <code>user_agent</code> TEXT Browser/client info <code>created_at</code> TIMESTAMP Creation time <code>last_used_at</code> DATETIME Last authentication"},{"location":"security/authentication-and-sessions/#token-lookup","title":"Token Lookup","text":"<p>The system looks up tokens by hash for security:</p> <pre><code>// UserRepository.php\n$this-&gt;dbConnection-&gt;fetchAssociative(\n    'SELECT * FROM user_auth_token WHERE token_hash = ? OR token = ?',\n    [$tokenHash, $token],\n);\n</code></pre>"},{"location":"security/authentication-and-sessions/#two-factor-authentication-2fa","title":"Two-Factor Authentication (2FA)","text":"<p>Pathary provides comprehensive 2FA with TOTP, recovery codes, and trusted device support.</p>"},{"location":"security/authentication-and-sessions/#overview_1","title":"Overview","text":"<p>The 2FA system includes: - TOTP Authentication - Compatible with authenticator apps - Recovery Codes - 10 single-use backup codes - Trusted Devices - Skip 2FA for 30 days on trusted devices - Security Audit Log - Track all security events</p> <p>For complete 2FA documentation, see: - Two-Factor Authentication - Detailed guide to all 2FA features</p>"},{"location":"security/authentication-and-sessions/#enable-2fa","title":"Enable 2FA","text":"<p>Users can enable 2FA from their security settings:</p> <pre><code>Profile \u2192 Security Tab \u2192 Enable 2FA\n</code></pre> <p>Routes: <pre><code>POST /profile/security/totp/enable      # Generate QR code\nPOST /profile/security/totp/verify      # Verify and save TOTP\nPOST /profile/security/totp/disable     # Disable 2FA\n</code></pre></p>"},{"location":"security/authentication-and-sessions/#login-with-2fa","title":"Login with 2FA","text":"<p>When 2FA is enabled, users must provide either: 1. A 6-digit code from their authenticator app, OR 2. A recovery code</p> <p>Optional: Users can check \"Trust this device\" to skip 2FA for 30 days.</p> <p>File: <code>src/Domain/User/Service/Authentication.php:findUserAndVerifyAuthentication()</code></p> <pre><code>public function findUserAndVerifyAuthentication(\n    string $email,\n    string $password,\n    ?int $userTotpCode = null,\n    ?string $recoveryCode = null,\n    ?string $deviceToken = null,\n) : UserEntity {\n    // Verify password first\n    $user = $this-&gt;repository-&gt;findUserByEmail($email);\n    if ($this-&gt;userApi-&gt;isValidPassword($user-&gt;getId(), $password) === false) {\n        throw InvalidPassword::create();\n    }\n\n    // Check if device is trusted\n    if ($deviceToken !== null) {\n        if ($this-&gt;trustedDeviceService-&gt;isDeviceTrusted($user-&gt;getId(), $deviceToken)) {\n            return $user;  // Skip 2FA\n        }\n    }\n\n    // Check if TOTP is required\n    $totpUri = $this-&gt;userApi-&gt;findTotpUri($user-&gt;getId());\n    if ($totpUri !== null) {\n        // Require either TOTP code or recovery code\n        if ($userTotpCode === null &amp;&amp; $recoveryCode === null) {\n            throw MissingTotpCode::create();\n        }\n\n        // Verify TOTP code\n        if ($userTotpCode !== null) {\n            if ($this-&gt;twoFactorAuthenticationApi-&gt;verifyTotpUri($user-&gt;getId(), $userTotpCode) === false) {\n                throw InvalidTotpCode::create();\n            }\n        }\n\n        // Verify recovery code\n        if ($recoveryCode !== null) {\n            if ($this-&gt;recoveryCodeService-&gt;verifyAndConsumeCode($user-&gt;getId(), $recoveryCode) === false) {\n                throw InvalidRecoveryCode::create();\n            }\n        }\n    }\n\n    return $user;\n}\n</code></pre>"},{"location":"security/authentication-and-sessions/#api-authentication","title":"API Authentication","text":""},{"location":"security/authentication-and-sessions/#token-creation","title":"Token Creation","text":"<pre><code>curl -X POST https://pathary.example.com/api/authentication/token \\\n  -H \"Content-Type: application/json\" \\\n  -H \"X-Movary-Client: my-app\" \\\n  -d '{\"email\":\"user@example.com\",\"password\":\"secret\"}'\n</code></pre>"},{"location":"security/authentication-and-sessions/#using-api-token","title":"Using API Token","text":"<pre><code>curl https://pathary.example.com/api/users/john/history/movies \\\n  -H \"X-Movary-Token: your_token_here\"\n</code></pre>"},{"location":"security/authentication-and-sessions/#required-headers","title":"Required Headers","text":"Header Required Description <code>X-Movary-Client</code> Yes (login) Client identifier <code>X-Movary-Token</code> Yes (API calls) Authentication token"},{"location":"security/authentication-and-sessions/#reverse-proxy-considerations","title":"Reverse Proxy Considerations","text":"<p>When running behind a reverse proxy, ensure these headers are forwarded:</p> <pre><code>proxy_set_header Host $host;\nproxy_set_header X-Real-IP $remote_addr;\nproxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\nproxy_set_header X-Forwarded-Proto $scheme;\n</code></pre>"},{"location":"security/authentication-and-sessions/#https-detection","title":"HTTPS Detection","text":"<p>The application detects HTTPS from: 1. <code>$_SERVER['HTTPS']</code> set to <code>on</code> 2. <code>X-Forwarded-Proto: https</code> header</p> <p>This affects: - Cookie <code>secure</code> flag - Generated URLs</p>"},{"location":"security/authentication-and-sessions/#logout","title":"Logout","text":""},{"location":"security/authentication-and-sessions/#web-logout","title":"Web Logout","text":"<pre><code>POST /api/authentication/token (DELETE method)\n</code></pre> <p>File: <code>src/Domain/User/Service/Authentication.php:209-235</code></p> <pre><code>public function logout() : void\n{\n    $token = filter_input(INPUT_COOKIE, 'id');\n\n    if ($token !== '') {\n        // Delete token from database\n        $this-&gt;deleteToken($token);\n\n        // Clear cookie\n        setcookie('id', '', [\n            'expires' =&gt; 1,  // Past timestamp\n            'path' =&gt; '/',\n            'secure' =&gt; $isSecure,\n            'httponly' =&gt; true,\n            'samesite' =&gt; 'Lax',\n        ]);\n    }\n\n    // Destroy and restart session\n    $this-&gt;sessionWrapper-&gt;destroy();\n    $this-&gt;sessionWrapper-&gt;start();\n}\n</code></pre>"},{"location":"security/authentication-and-sessions/#security-headers","title":"Security Headers","text":"<p>File: <code>public/index.php:13-20</code></p> <p>Applied to all responses:</p> <pre><code>$securityHeaders = [\n    'X-Content-Type-Options' =&gt; 'nosniff',\n    'X-Frame-Options' =&gt; 'SAMEORIGIN',\n    'Referrer-Policy' =&gt; 'strict-origin-when-cross-origin',\n    'Permissions-Policy' =&gt; 'accelerometer=(), camera=(), ...',\n    'Content-Security-Policy' =&gt; \"default-src 'self'; ...\",\n];\n</code></pre>"},{"location":"security/authentication-and-sessions/#related-pages","title":"Related Pages","text":"<ul> <li>Two-Factor Authentication - Comprehensive 2FA guide</li> <li>Password Policy and Security - Password requirements</li> <li>Routing and Controllers - Route authentication middleware</li> <li>Database - Token storage schema</li> <li>Deployment - Reverse proxy configuration</li> </ul> <p>\u2190 Back to Wiki Home</p>"},{"location":"security/password-policy-and-security/","title":"Password Policy and Security","text":"<p>Pathary enforces a comprehensive password policy to ensure account security.</p>"},{"location":"security/password-policy-and-security/#password-requirements","title":"Password Requirements","text":"<p>All passwords must meet the following criteria:</p> Requirement Value Minimum Length 10 characters Uppercase Letters At least 1 (A-Z) Lowercase Letters At least 1 (a-z) Numbers At least 1 (0-9) Special Characters At least 1 (!@#$%^&amp;*()_+-=[]{};\\':\"|,.&lt;&gt;/?)"},{"location":"security/password-policy-and-security/#enforcement-points","title":"Enforcement Points","text":"<p>Password policy is enforced at:</p> <ol> <li>User Registration - <code>/create-user</code></li> <li>Password Change - <code>/profile/security/password</code></li> <li>Admin User Creation - CLI command <code>bin/console.php user:create</code></li> <li>Profile Updates - Any password modification</li> </ol> <p>Files: - <code>src/Domain/User/Service/Validator.php</code> - Core validation logic - <code>src/Domain/User/Exception/PasswordPolicyViolation.php</code> - Policy violation exception</p>"},{"location":"security/password-policy-and-security/#validation-logic","title":"Validation Logic","text":"<p>File: <code>src/Domain/User/Service/Validator.php:validatePassword()</code></p> <pre><code>public function validatePassword(string $password) : void\n{\n    if (strlen($password) &lt; 10) {\n        throw PasswordPolicyViolation::create(\n            'Password must be at least 10 characters long'\n        );\n    }\n\n    if (!preg_match('/[A-Z]/', $password)) {\n        throw PasswordPolicyViolation::create(\n            'Password must contain at least one uppercase letter'\n        );\n    }\n\n    if (!preg_match('/[a-z]/', $password)) {\n        throw PasswordPolicyViolation::create(\n            'Password must contain at least one lowercase letter'\n        );\n    }\n\n    if (!preg_match('/[0-9]/', $password)) {\n        throw PasswordPolicyViolation::create(\n            'Password must contain at least one number'\n        );\n    }\n\n    if (!preg_match('/[^A-Za-z0-9]/', $password)) {\n        throw PasswordPolicyViolation::create(\n            'Password must contain at least one special character'\n        );\n    }\n}\n</code></pre>"},{"location":"security/password-policy-and-security/#frontend-validation","title":"Frontend Validation","text":""},{"location":"security/password-policy-and-security/#real-time-feedback","title":"Real-Time Feedback","text":"<p>Password inputs include real-time validation with visual feedback showing which requirements are met.</p> <p>File: <code>public/js/profile-security.js</code></p> <pre><code>function updatePasswordRequirements(password) {\n    const requirements = {\n        length: password.length &gt;= 10,\n        uppercase: /[A-Z]/.test(password),\n        lowercase: /[a-z]/.test(password),\n        number: /[0-9]/.test(password),\n        special: /[^A-Za-z0-9]/.test(password)\n    };\n\n    // Update UI indicators\n    document.getElementById('req-length').classList.toggle('met', requirements.length);\n    document.getElementById('req-uppercase').classList.toggle('met', requirements.uppercase);\n    // ... etc\n}\n</code></pre>"},{"location":"security/password-policy-and-security/#visual-indicators","title":"Visual Indicators","text":"<p>File: <code>templates/page/settings-account-security.html.twig</code></p> <p>Requirements are displayed as a checklist: <pre><code>&lt;ul class=\"password-requirements\"&gt;\n    &lt;li id=\"req-length\" class=\"requirement\"&gt;\n        &lt;i class=\"bi bi-check-circle\"&gt;&lt;/i&gt; At least 10 characters\n    &lt;/li&gt;\n    &lt;li id=\"req-uppercase\" class=\"requirement\"&gt;\n        &lt;i class=\"bi bi-check-circle\"&gt;&lt;/i&gt; One uppercase letter (A-Z)\n    &lt;/li&gt;\n    &lt;li id=\"req-lowercase\" class=\"requirement\"&gt;\n        &lt;i class=\"bi bi-check-circle\"&gt;&lt;/i&gt; One lowercase letter (a-z)\n    &lt;/li&gt;\n    &lt;li id=\"req-number\" class=\"requirement\"&gt;\n        &lt;i class=\"bi bi-check-circle\"&gt;&lt;/i&gt; One number (0-9)\n    &lt;/li&gt;\n    &lt;li id=\"req-special\" class=\"requirement\"&gt;\n        &lt;i class=\"bi bi-check-circle\"&gt;&lt;/i&gt; One special character (!@#$%...)\n    &lt;/li&gt;\n&lt;/ul&gt;\n</code></pre></p> <p>CSS styling: <pre><code>.password-requirements .requirement {\n    color: var(--bs-secondary);\n}\n\n.password-requirements .requirement.met {\n    color: var(--bs-success);\n}\n\n.password-requirements .requirement.met i {\n    color: var(--bs-success);\n}\n</code></pre></p>"},{"location":"security/password-policy-and-security/#password-storage","title":"Password Storage","text":"<p>Passwords are hashed using PHP's <code>password_hash()</code> with <code>PASSWORD_DEFAULT</code>:</p> <pre><code>$hashedPassword = password_hash($password, PASSWORD_DEFAULT);\n</code></pre> <p>As of PHP 8.0+, <code>PASSWORD_DEFAULT</code> uses bcrypt with a cost factor of 10.</p> <p>Storage: - Passwords are never stored in plain text - Hashes are stored in the <code>user.password</code> column as <code>VARCHAR(255)</code> - Password verification uses <code>password_verify()</code> with timing-attack resistance</p>"},{"location":"security/password-policy-and-security/#changing-your-password","title":"Changing Your Password","text":""},{"location":"security/password-policy-and-security/#via-web-interface","title":"Via Web Interface","text":"<pre><code>Profile \u2192 Security Tab \u2192 Password section \u2192 Change Password\n</code></pre> <p>Route: <code>POST /profile/security/password</code></p> <p>File: <code>src/HttpController/Web/ProfileSecurityController.php:changePassword()</code></p> <p>Steps: 1. Enter current password 2. Enter new password (must meet policy) 3. Confirm new password 4. Submit form</p> <p>On success: - Password is updated in database - Security audit log entry is created - Success message is displayed</p>"},{"location":"security/password-policy-and-security/#via-cli","title":"Via CLI","text":"<p>Administrators can reset passwords via CLI:</p> <pre><code>docker compose exec app php bin/console.php user:create \\\n  --email user@example.com \\\n  --password \"NewSecurePass123!\" \\\n  --name \"Username\"\n</code></pre> <p>Password policy is enforced for CLI operations as well.</p> <p>File: <code>src/Command/UserCreate.php</code></p>"},{"location":"security/password-policy-and-security/#password-hashing-strength","title":"Password Hashing Strength","text":"<p>Pathary uses bcrypt with these characteristics:</p> Property Value Algorithm bcrypt (Blowfish) Cost Factor 10 (2^10 = 1,024 iterations) Salt Automatically generated (22 characters, base64) Hash Length 60 characters Format <code>$2y$10$[22-char-salt][31-char-hash]</code>"},{"location":"security/password-policy-and-security/#upgrade-path","title":"Upgrade Path","text":"<p>If PHP version is upgraded and <code>PASSWORD_DEFAULT</code> changes (e.g., to Argon2), existing passwords will continue to work. On next login, passwords can be re-hashed with the new algorithm using <code>password_needs_rehash()</code>.</p>"},{"location":"security/password-policy-and-security/#security-best-practices","title":"Security Best Practices","text":""},{"location":"security/password-policy-and-security/#for-users","title":"For Users","text":"<ol> <li>Use a Password Manager - Generate and store strong, unique passwords</li> <li>Never Reuse Passwords - Each service should have its own password</li> <li>Enable 2FA - Add an extra layer of security beyond passwords</li> <li>Change Passwords Periodically - Especially if you suspect compromise</li> </ol>"},{"location":"security/password-policy-and-security/#for-administrators","title":"For Administrators","text":"<ol> <li>Enforce 2FA - Require 2FA for all users, especially admins</li> <li>Monitor Audit Logs - Review security events regularly</li> <li>Set Strong Example - Use strong passwords yourself</li> <li>Educate Users - Share password best practices with your group</li> </ol>"},{"location":"security/password-policy-and-security/#failed-login-protection","title":"Failed Login Protection","text":"<p>Pathary includes rate limiting for login attempts:</p> Threshold Lockout Duration 5 failed attempts 15 minutes <p>File: <code>src/Domain/User/Service/Authentication.php</code></p> <p>Failed attempts are tracked per email address and reset upon successful login.</p>"},{"location":"security/password-policy-and-security/#related-pages","title":"Related Pages","text":"<ul> <li>Two-Factor Authentication - TOTP, recovery codes, trusted devices</li> <li>Authentication and Sessions - Login flow and session management</li> <li>Database - User table schema</li> </ul> <p>\u2190 Back to Wiki Home</p>"},{"location":"security/two-factor-authentication/","title":"Two-Factor Authentication (2FA)","text":"<p>Pathary provides comprehensive Two-Factor Authentication using Time-based One-Time Passwords (TOTP), along with recovery codes and trusted device management.</p>"},{"location":"security/two-factor-authentication/#overview","title":"Overview","text":"<p>Pathary's 2FA system includes: - TOTP Authentication - Compatible with authenticator apps (Google Authenticator, Authy, 1Password, etc.) - Recovery Codes - 10 single-use backup codes for account recovery - Trusted Devices - Option to trust devices for 30 days - Security Audit Log - Track all security events</p>"},{"location":"security/two-factor-authentication/#enabling-2fa","title":"Enabling 2FA","text":""},{"location":"security/two-factor-authentication/#step-1-navigate-to-security-settings","title":"Step 1: Navigate to Security Settings","text":"<pre><code>Profile \u2192 Security Tab \u2192 Two-Factor Authentication section\n</code></pre>"},{"location":"security/two-factor-authentication/#step-2-generate-qr-code","title":"Step 2: Generate QR Code","text":"<ol> <li>Click \"Enable 2FA\"</li> <li>A QR code will be displayed</li> <li>Scan the QR code with your authenticator app</li> </ol> <p>File: <code>src/HttpController/Web/ProfileSecurityController.php:enableTotp()</code></p> <p>The system generates a secret key using: <pre><code>$totpSecret = $this-&gt;twoFactorAuthenticationApi-&gt;generateTotpSecret();\n$totpUri = $this-&gt;twoFactorAuthenticationApi-&gt;buildTotpUri($user-&gt;getName(), $totpSecret);\n</code></pre></p>"},{"location":"security/two-factor-authentication/#step-3-verify-totp-code","title":"Step 3: Verify TOTP Code","text":"<ol> <li>Enter the 6-digit code from your authenticator app</li> <li>Click \"Verify and Enable\"</li> </ol> <p>File: <code>src/HttpController/Web/ProfileSecurityController.php:verifyAndSaveTotp()</code></p> <p>Upon successful verification: - TOTP is enabled for your account - 10 recovery codes are automatically generated - You'll see a confirmation modal with recovery codes</p>"},{"location":"security/two-factor-authentication/#recovery-codes","title":"Recovery Codes","text":"<p>Recovery codes are single-use backup codes that allow you to log in if you lose access to your authenticator app.</p>"},{"location":"security/two-factor-authentication/#initial-generation","title":"Initial Generation","text":"<p>When you enable 2FA, 10 recovery codes are automatically generated and displayed in a modal with the following features: - Confirmation Required: You must check \"I have saved these codes\" AND enter one of the codes to confirm - Security: Codes are hashed using bcrypt before storage - Progressive UI: Shows step-by-step progress through confirmation</p> <p>File: <code>src/Domain/User/Service/RecoveryCodeService.php:generateRecoveryCodes()</code></p> <pre><code>public function generateRecoveryCodes(int $userId) : array\n{\n    // Generate 10 random codes\n    for ($i = 0; $i &lt; 10; $i++) {\n        $code = $this-&gt;generateRandomCode();\n        $codes[] = $code;\n\n        // Hash and store\n        $this-&gt;repository-&gt;create($userId, password_hash($code, PASSWORD_DEFAULT));\n    }\n\n    return $codes;\n}\n</code></pre>"},{"location":"security/two-factor-authentication/#regenerating-recovery-codes","title":"Regenerating Recovery Codes","text":"<p>You can regenerate all recovery codes at any time:</p> <pre><code>Profile \u2192 Security Tab \u2192 Recovery Codes section \u2192 Regenerate Codes\n</code></pre> <p>Warning: Regenerating codes will invalidate all previous codes.</p> <p>Route: <code>POST /profile/security/recovery-codes/regenerate</code></p>"},{"location":"security/two-factor-authentication/#using-recovery-codes","title":"Using Recovery Codes","text":"<p>When logging in with 2FA enabled: 1. Enter your email and password 2. Click \"Use Recovery Code\" instead of entering authenticator code 3. Enter one of your recovery codes 4. The code will be consumed and cannot be used again</p> <p>File: <code>src/Domain/User/Service/Authentication.php:login()</code></p> <pre><code>// Check if recovery code is provided\nif ($recoveryCode !== null) {\n    if ($this-&gt;recoveryCodeService-&gt;verifyAndConsumeCode($user-&gt;getId(), $recoveryCode) === false) {\n        throw InvalidRecoveryCode::create();\n    }\n}\n</code></pre>"},{"location":"security/two-factor-authentication/#recovery-code-storage","title":"Recovery Code Storage","text":"<p>Recovery codes are stored in the <code>recovery_codes</code> table:</p> Column Type Description <code>id</code> INT Primary key <code>user_id</code> INT User reference <code>code_hash</code> VARCHAR(255) Bcrypt hash of code <code>used</code> BOOLEAN Whether code has been used <code>created_at</code> TIMESTAMP Creation time <code>used_at</code> DATETIME When code was used (nullable) <p>Migration: <code>db/migrations/*/20251217120000_CreateRecoveryCodesTable.php</code></p>"},{"location":"security/two-factor-authentication/#trusted-devices","title":"Trusted Devices","text":"<p>Trusted devices allow you to bypass 2FA for 30 days on specific devices you mark as trusted.</p>"},{"location":"security/two-factor-authentication/#trusting-a-device","title":"Trusting a Device","text":"<p>When logging in with 2FA: 1. Enter your authenticator code or recovery code 2. Check \"Trust this device for 30 days\" 3. Complete login</p> <p>File: <code>src/Domain/User/Service/TrustedDeviceService.php:createTrustedDevice()</code></p> <p>A secure cookie is set: <pre><code>setcookie(\n    'trusted_device',\n    $deviceToken,\n    [\n        'expires' =&gt; time() + (30 * 24 * 60 * 60),  // 30 days\n        'path' =&gt; '/',\n        'secure' =&gt; true,\n        'httponly' =&gt; true,\n        'samesite' =&gt; 'Lax',\n    ],\n);\n</code></pre></p>"},{"location":"security/two-factor-authentication/#device-limits","title":"Device Limits","text":"<ul> <li>Maximum of 10 trusted devices per user</li> <li>Oldest devices are automatically removed when limit is reached</li> <li>Device tokens are 256-bit random strings, hashed with <code>PASSWORD_DEFAULT</code></li> </ul>"},{"location":"security/two-factor-authentication/#managing-trusted-devices","title":"Managing Trusted Devices","text":"<p>View and manage trusted devices in your security settings:</p> <pre><code>Profile \u2192 Security Tab \u2192 Trusted Devices section\n</code></pre> <p>You can see: - Device name (parsed from user agent) - Last used date - Creation date</p> <p>Actions: - Revoke Single Device: <code>POST /profile/security/trusted-devices/{deviceId}/revoke</code> - Revoke All Devices: <code>POST /profile/security/trusted-devices/revoke-all</code></p> <p>File: <code>src/Util/DeviceNameParser.php</code> parses user agents to friendly names: - Chrome on Windows \u2192 \"Chrome (Windows)\" - Safari on iPhone \u2192 \"Safari (iPhone)\" - Firefox on macOS \u2192 \"Firefox (macOS)\"</p>"},{"location":"security/two-factor-authentication/#trusted-device-storage","title":"Trusted Device Storage","text":"<p>Trusted devices are stored in the <code>trusted_devices</code> table:</p> Column Type Description <code>id</code> INT Primary key <code>user_id</code> INT User reference <code>device_token</code> VARCHAR(64) Random token <code>device_token_hash</code> VARCHAR(255) Password hash of token <code>device_name</code> VARCHAR(256) Parsed device name <code>user_agent</code> TEXT Full user agent string <code>created_at</code> TIMESTAMP When device was trusted <code>last_used_at</code> DATETIME Last login from device <code>expires_at</code> DATETIME When trust expires (30 days) <p>Migration: <code>db/migrations/*/20251217120001_CreateTrustedDevicesTable.php</code></p>"},{"location":"security/two-factor-authentication/#security-audit-log","title":"Security Audit Log","text":"<p>All security events are logged in the <code>security_audit_log</code> table for monitoring and forensics.</p>"},{"location":"security/two-factor-authentication/#logged-events","title":"Logged Events","text":"Event Type Description <code>2fa_enabled</code> User enabled 2FA <code>2fa_disabled</code> User disabled 2FA <code>2fa_verified</code> Successful 2FA login <code>2fa_failed</code> Failed 2FA attempt <code>recovery_code_used</code> Recovery code used for login <code>recovery_codes_regenerated</code> New recovery codes generated <code>trusted_device_added</code> Device marked as trusted <code>trusted_device_revoked</code> Trusted device revoked <code>password_changed</code> Password changed"},{"location":"security/two-factor-authentication/#viewing-audit-log","title":"Viewing Audit Log","text":"<pre><code>Profile \u2192 Security Tab \u2192 Security Activity section\n</code></pre> <p>Route: <code>GET /profile/security/events</code></p> <p>Events are displayed with: - Event type - Timestamp - Device information - IP address (if available)</p> <p>File: <code>src/Domain/User/Service/SecurityAuditService.php</code></p> <pre><code>public function logEvent(\n    int $userId,\n    string $eventType,\n    ?string $deviceName = null,\n    ?string $ipAddress = null,\n    ?array $metadata = null\n) : void {\n    $this-&gt;repository-&gt;create(\n        $userId,\n        $eventType,\n        $deviceName,\n        $ipAddress,\n        $metadata ? json_encode($metadata) : null\n    );\n}\n</code></pre>"},{"location":"security/two-factor-authentication/#login-flow-with-2fa","title":"Login Flow with 2FA","text":""},{"location":"security/two-factor-authentication/#without-trusted-device","title":"Without Trusted Device","text":"<pre><code>1. Enter email + password\n2. Submit login form\n3. If 2FA enabled:\n   a. Show 2FA code input\n   b. Enter authenticator code OR recovery code\n   c. Optionally check \"Trust this device\"\n4. Complete login\n</code></pre>"},{"location":"security/two-factor-authentication/#with-trusted-device","title":"With Trusted Device","text":"<pre><code>1. Enter email + password\n2. Submit login form\n3. System checks for valid trusted_device cookie\n4. If valid and not expired:\n   \u2192 Skip 2FA verification\n5. Complete login immediately\n</code></pre> <p>File: <code>src/Domain/User/Service/Authentication.php:findUserAndVerifyAuthentication()</code></p> <pre><code>// Check if device is trusted\nif ($this-&gt;trustedDeviceService-&gt;isDeviceTrusted($user-&gt;getId(), $deviceToken)) {\n    // Skip 2FA verification\n    return $user;\n}\n\n// Otherwise, require 2FA\nif ($totpUri !== null) {\n    if ($userTotpCode === null &amp;&amp; $recoveryCode === null) {\n        throw MissingTotpCode::create();\n    }\n    // Verify TOTP or recovery code...\n}\n</code></pre>"},{"location":"security/two-factor-authentication/#disabling-2fa","title":"Disabling 2FA","text":"<p>To disable 2FA:</p> <pre><code>Profile \u2192 Security Tab \u2192 Two-Factor Authentication section \u2192 Disable 2FA\n</code></pre> <p>Route: <code>POST /profile/security/totp/disable</code></p> <p>Effects: - TOTP secret is removed - All recovery codes are deleted - All trusted devices are revoked - Audit log entry is created</p> <p>File: <code>src/HttpController/Web/ProfileSecurityController.php:disableTotp()</code></p>"},{"location":"security/two-factor-authentication/#template-files","title":"Template Files","text":"File Purpose <code>templates/page/login.html.twig</code> Login form with 2FA code input and mode switching <code>templates/public/profile-security.twig</code> Security settings page with 2FA management <code>public/js/login.js</code> Login form JavaScript with 2FA handling <code>public/js/profile-security.js</code> Security settings JavaScript with recovery code confirmation"},{"location":"security/two-factor-authentication/#api-routes","title":"API Routes","text":"Method Route Purpose POST <code>/profile/security/totp/enable</code> Generate TOTP QR code POST <code>/profile/security/totp/verify</code> Verify and save TOTP POST <code>/profile/security/totp/disable</code> Disable 2FA POST <code>/profile/security/recovery-codes/regenerate</code> Regenerate recovery codes POST <code>/profile/security/trusted-devices/{deviceId}/revoke</code> Revoke single device POST <code>/profile/security/trusted-devices/revoke-all</code> Revoke all devices GET <code>/profile/security/events</code> Get security audit log"},{"location":"security/two-factor-authentication/#best-practices","title":"Best Practices","text":"<ol> <li>Enable 2FA for all accounts, especially admin accounts</li> <li>Save recovery codes in a secure location (password manager, encrypted file)</li> <li>Trust devices carefully - only trust your personal devices</li> <li>Review audit log periodically for suspicious activity</li> <li>Regenerate recovery codes if you suspect they've been compromised</li> <li>Revoke trusted devices when selling/disposing of hardware</li> </ol>"},{"location":"security/two-factor-authentication/#related-pages","title":"Related Pages","text":"<ul> <li>Authentication and Sessions - Login and session management</li> <li>Password Policy and Security - Password requirements</li> <li>Database - Security-related table schemas</li> </ul> <p>\u2190 Back to Wiki Home</p>"}]}